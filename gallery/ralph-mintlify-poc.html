<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ralph Pattern | Claude Code Documentation</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- GSAP for scroll-sync -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

  <!-- Tailwind Config with Design Tokens -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bg-base': '#ffffff',
            'bg-subtle': '#fafafa',
            'bg-muted': '#f4f4f5',
            'text-primary': '#18181b',
            'text-secondary': '#3f3f46',
            'text-muted': '#71717a',
            'accent': '#0D9373',
            'accent-light': '#10b981',
            'accent-bg': '#ecfdf5',
            'border': '#e4e4e7',
            // Activity Zone content type colors
            'az-invariant': '#3b82f6',    // Blue
            'az-effect': '#f59e0b',       // Amber
            'az-composition': '#8b5cf6',  // Purple
            'az-frontier': '#ef4444',     // Red
            'az-warstory': '#10b981',     // Green
            'az-alternative': '#6b7280',  // Gray
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['Fira Code', 'monospace'],
          },
        },
      },
    }
  </script>

  <style>
    /* Base Styles */
    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      scroll-padding-top: 80px;
    }

    [id] {
      scroll-margin-top: 80px;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: #ffffff;
      color: #18181b;
      line-height: 1.7;
    }

    /* Three Panel Layout */
    .three-panel-layout {
      min-height: 100vh;
      position: relative;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #ffffff;
      border-bottom: 1px solid #e4e4e7;
      z-index: 100;
      display: flex;
      align-items: center;
      padding: 0 24px;
    }

    /* Left Navigation - 240px fixed */
    .left-nav {
      position: fixed;
      top: 56px;
      left: 0;
      width: 240px;
      height: calc(100vh - 56px);
      border-right: 1px solid #e4e4e7;
      background: #ffffff;
      overflow-y: auto;
      padding: 16px 0;
      z-index: 40;
    }

    .nav-section {
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 500;
      color: #3f3f46;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s;
    }

    .nav-section-header:hover {
      background: #f4f4f5;
    }

    .nav-section-header.active {
      color: #0D9373;
      background: #ecfdf5;
    }

    .nav-item {
      display: block;
      padding: 6px 12px 6px 44px;
      font-size: 14px;
      color: #71717a;
      text-decoration: none;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .nav-item:hover {
      color: #3f3f46;
      background: #f4f4f5;
    }

    .nav-item.active {
      color: #0D9373;
      background: #ecfdf5;
    }

    .nav-children {
      display: none;
      overflow: hidden;
    }

    .nav-children.expanded {
      display: block;
    }

    .nav-chevron {
      transition: transform 0.2s;
    }

    .nav-section.expanded .nav-chevron {
      transform: rotate(90deg);
    }

    /* Main Content - Flexible, margins for fixed sidebars */
    /* Activity Zone now 480px for better proportion */
    .main-content {
      margin-left: 240px;
      margin-right: 480px;
      margin-top: 56px;
      padding: 48px 48px;
      min-width: 400px;
    }

    /* Activity Zone - 480px fixed (proportional to main, less than main) */
    .activity-zone {
      position: fixed;
      top: 56px;
      right: 0;
      width: 480px;
      height: calc(100vh - 56px);
      border-left: 1px dashed #e4e4e7;
      background: #fafafa;
      overflow-y: auto;
      padding: 24px 20px;
      z-index: 40;
    }

    /* Responsive: Hide Activity Zone below 1400px */
    @media (max-width: 1400px) {
      .activity-zone {
        display: none;
      }
      .main-content {
        margin-right: 0;
        padding: 40px 32px;
      }
    }

    /* Responsive: Hide Left Nav below 768px */
    @media (max-width: 768px) {
      .left-nav {
        display: none;
      }
      .left-nav.open {
        display: block;
        position: fixed;
        top: 56px;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ffffff;
        z-index: 50;
        overflow-y: auto;
      }
      .main-content {
        margin-left: 0;
        padding: 24px 16px;
        min-width: auto;
      }
    }

    /* Resizer - Draggable divider between Main Panel and Activity Zone */
    .resizer {
      position: fixed;
      top: 56px;
      right: 480px;
      width: 6px;
      height: calc(100vh - 56px);
      cursor: col-resize;
      background: transparent;
      z-index: 50;
      transition: background 0.15s ease;
    }

    .resizer:hover {
      background: rgba(13, 147, 115, 0.15);
    }

    .resizer.active {
      background: rgba(13, 147, 115, 0.25);
    }

    /* Prevent text selection during resize */
    body.resizing {
      user-select: none;
      cursor: col-resize !important;
    }

    body.resizing * {
      cursor: col-resize !important;
    }

    /* Hide resizer when Activity Zone is hidden (responsive) */
    @media (max-width: 1400px) {
      .resizer {
        display: none;
      }
    }

    /* Activity Zone Items */
    .activity-item {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      background: #ffffff;
      border: 1px solid #e4e4e7;
      font-size: 14px;
      line-height: 1.6;
      opacity: 0.5;
      transition: all 0.3s ease;
    }

    .activity-item.active {
      opacity: 1;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .activity-item:hover {
      opacity: 1;
    }

    .activity-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Activity Zone content type borders */
    .activity-item.invariant { border-left: 4px solid #3b82f6; }
    .activity-item.effect { border-left: 4px solid #f59e0b; }
    .activity-item.composition { border-left: 4px solid #8b5cf6; }
    .activity-item.frontier { border-left: 4px solid #ef4444; }
    .activity-item.warstory { border-left: 4px solid #10b981; }
    .activity-item.alternative { border-left: 4px solid #6b7280; }

    /* Main Content Components */

    /* Section titles with number */
    .section-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: #0D9373;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      border-radius: 50%;
      margin-right: 12px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 600;
      color: #18181b;
      margin-bottom: 20px;
      margin-top: 56px;
      display: flex;
      align-items: center;
    }

    .section-title:first-child {
      margin-top: 0;
    }

    /* Essence Box (15 words) */
    .essence-box {
      background: linear-gradient(135deg, #18181b 0%, #27272a 100%);
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 40px;
    }

    .essence-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #10b981;
      margin-bottom: 12px;
    }

    .essence-text {
      font-size: 22px;
      font-weight: 500;
      color: #ffffff;
      line-height: 1.4;
    }

    /* Core Abstraction Box */
    .core-abstraction {
      background: #fafafa;
      border: 1px solid #e4e4e7;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 40px;
    }

    .core-philosophy {
      font-size: 16px;
      color: #3f3f46;
      margin-bottom: 16px;
      font-style: italic;
    }

    .core-code {
      background: #18181b;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 16px;
      overflow-x: auto;
    }

    .core-code code {
      font-family: 'Fira Code', monospace;
      font-size: 15px;
      color: #10b981;
      white-space: nowrap;
    }

    .core-anchor {
      font-size: 14px;
      color: #71717a;
      text-align: center;
    }

    /* Design Decision Box */
    .decision-box {
      background: #ffffff;
      border: 1px solid #e4e4e7;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .decision-why {
      font-size: 16px;
      font-weight: 600;
      color: #0D9373;
      margin-bottom: 12px;
    }

    .decision-reasoning {
      font-size: 14px;
      color: #3f3f46;
      margin-bottom: 16px;
    }

    .decision-implication {
      background: #f4f4f5;
      border-radius: 8px;
      padding: 16px;
    }

    .decision-implication-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: #71717a;
      margin-bottom: 8px;
    }

    /* Code Blocks */
    .code-block {
      background: #18181b;
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 24px;
      position: relative;
      overflow-x: auto;
    }

    .code-block pre {
      margin: 0;
      font-family: 'Fira Code', monospace;
      font-size: 13px;
      color: #e4e4e7;
      line-height: 1.6;
    }

    .code-block .comment { color: #6b7280; }
    .code-block .keyword { color: #c084fc; }
    .code-block .string { color: #10b981; }
    .code-block .variable { color: #60a5fa; }

    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #3f3f46;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s;
    }

    .copy-btn:hover {
      background: #52525b;
    }

    /* Path Steps */
    .path-container {
      background: #fafafa;
      border: 1px solid #e4e4e7;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 40px;
    }

    .path-step {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .path-step:last-child {
      margin-bottom: 0;
    }

    .path-number {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      background: #0D9373;
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .path-content {
      flex: 1;
      font-size: 14px;
      color: #3f3f46;
    }

    .path-content code {
      background: #e4e4e7;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Fira Code', monospace;
      font-size: 13px;
    }

    /* Gotcha Box */
    .gotcha-box {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-left: 4px solid #f59e0b;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .gotcha-title {
      font-weight: 600;
      color: #92400e;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gotcha-detail {
      font-size: 14px;
      color: #78350f;
      margin-bottom: 8px;
    }

    .gotcha-detail strong {
      color: #92400e;
    }

    /* What's Hard Box */
    .hard-box {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-left: 4px solid #ef4444;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .hard-title {
      font-weight: 600;
      color: #991b1b;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hard-detail {
      font-size: 14px;
      color: #7f1d1d;
      margin-bottom: 8px;
    }

    /* When To Use Grid */
    .when-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 40px;
    }

    @media (max-width: 900px) {
      .when-grid {
        grid-template-columns: 1fr;
      }
    }

    .when-use {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      border-radius: 12px;
      padding: 24px;
    }

    .when-not {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 12px;
      padding: 24px;
    }

    .when-title {
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .when-use .when-title { color: #166534; }
    .when-not .when-title { color: #991b1b; }

    .when-item {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .when-use .when-item { color: #166534; }
    .when-not .when-item { color: #991b1b; }

    /* Mobile Menu Button */
    .mobile-menu-btn {
      display: none;
      padding: 8px;
      background: none;
      border: none;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: flex;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #fafafa;
    }

    ::-webkit-scrollbar-thumb {
      background: #d4d4d8;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1aa;
    }

    /* Keyboard shortcut hint */
    .kbd {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      background: #f4f4f5;
      border: 1px solid #e4e4e7;
      border-radius: 4px;
      font-family: 'Fira Code', monospace;
      font-size: 12px;
      color: #71717a;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
      <i data-lucide="menu" class="w-5 h-5 text-text-secondary"></i>
    </button>
    <div class="flex items-center gap-3">
      <i data-lucide="terminal" class="w-5 h-5 text-accent"></i>
      <span class="font-semibold text-text-primary">Claude Code</span>
    </div>
    <div class="flex-1 flex justify-center">
      <button class="flex items-center gap-2 px-4 py-2 bg-bg-muted rounded-lg text-text-muted text-sm hover:bg-border transition-colors">
        <i data-lucide="search" class="w-4 h-4"></i>
        <span>Search documentation...</span>
        <span class="kbd">Cmd+K</span>
      </button>
    </div>
    <div class="flex items-center gap-4">
      <a href="#" class="text-sm text-text-muted hover:text-text-primary transition-colors">Support</a>
      <button class="p-2 hover:bg-bg-muted rounded-lg transition-colors" aria-label="Toggle theme">
        <i data-lucide="sun" class="w-4 h-4 text-text-muted"></i>
      </button>
    </div>
  </header>

  <div class="three-panel-layout">
    <!-- Left Navigation -->
    <nav class="left-nav" id="leftNav">
      <div class="px-4 mb-4">
        <span class="text-xs font-semibold text-text-muted uppercase tracking-wider">Ralph Pattern</span>
      </div>

      <!-- Essence -->
      <div class="nav-section expanded" data-section="essence">
        <div class="nav-section-header active" onclick="toggleSection(this)">
          <i data-lucide="zap" class="w-4 h-4"></i>
          <span>Essence</span>
          <i data-lucide="chevron-right" class="w-4 h-4 nav-chevron ml-auto"></i>
        </div>
        <div class="nav-children expanded">
          <a href="#essence" class="nav-item active">The 15-Word Summary</a>
        </div>
      </div>

      <!-- Core Abstraction -->
      <div class="nav-section expanded" data-section="core">
        <div class="nav-section-header" onclick="toggleSection(this)">
          <i data-lucide="box" class="w-4 h-4"></i>
          <span>Core Abstraction</span>
          <i data-lucide="chevron-right" class="w-4 h-4 nav-chevron ml-auto"></i>
        </div>
        <div class="nav-children expanded">
          <a href="#core-abstraction" class="nav-item">Philosophy + Code</a>
        </div>
      </div>

      <!-- Design Decisions -->
      <div class="nav-section expanded" data-section="decisions">
        <div class="nav-section-header" onclick="toggleSection(this)">
          <i data-lucide="lightbulb" class="w-4 h-4"></i>
          <span>Design Decisions</span>
          <i data-lucide="chevron-right" class="w-4 h-4 nav-chevron ml-auto"></i>
        </div>
        <div class="nav-children expanded">
          <a href="#why-fresh-context" class="nav-item">Why Fresh Context?</a>
          <a href="#why-external-state" class="nav-item">Why External State?</a>
          <a href="#why-small-tasks" class="nav-item">Why Small Tasks?</a>
        </div>
      </div>

      <!-- File Structure -->
      <div class="nav-section" data-section="files">
        <div class="nav-section-header" onclick="toggleSection(this)">
          <i data-lucide="folder" class="w-4 h-4"></i>
          <span>File Structure</span>
          <i data-lucide="chevron-right" class="w-4 h-4 nav-chevron ml-auto"></i>
        </div>
        <div class="nav-children">
          <a href="#file-structure" class="nav-item">The 4 Files</a>
          <a href="#ralph-sh" class="nav-item">ralph.sh</a>
          <a href="#prompt-md" class="nav-item">prompt.md</a>
          <a href="#prd-json" class="nav-item">prd.json</a>
        </div>
      </div>

      <!-- Path of a Task -->
      <div class="nav-section" data-section="path">
        <div class="nav-section-header" onclick="toggleSection(this)">
          <i data-lucide="git-branch" class="w-4 h-4"></i>
          <span>Path of a Task</span>
          <i data-lucide="chevron-right" class="w-4 h-4 nav-chevron ml-auto"></i>
        </div>
        <div class="nav-children">
          <a href="#path" class="nav-item">The Flow</a>
        </div>
      </div>

      <!-- Gotchas -->
      <div class="nav-section" data-section="gotchas">
        <div class="nav-section-header" onclick="toggleSection(this)">
          <i data-lucide="alert-triangle" class="w-4 h-4"></i>
          <span>Gotchas</span>
          <i data-lucide="chevron-right" class="w-4 h-4 nav-chevron ml-auto"></i>
        </div>
        <div class="nav-children">
          <a href="#gotchas" class="nav-item">Practical Problems</a>
        </div>
      </div>

      <!-- What's Hard -->
      <div class="nav-section" data-section="hard">
        <div class="nav-section-header" onclick="toggleSection(this)">
          <i data-lucide="flame" class="w-4 h-4"></i>
          <span>What's Hard</span>
          <i data-lucide="chevron-right" class="w-4 h-4 nav-chevron ml-auto"></i>
        </div>
        <div class="nav-children">
          <a href="#hard" class="nav-item">Real Complexity</a>
        </div>
      </div>

      <!-- When to Use -->
      <div class="nav-section" data-section="when">
        <div class="nav-section-header" onclick="toggleSection(this)">
          <i data-lucide="check-circle" class="w-4 h-4"></i>
          <span>When to Use</span>
          <i data-lucide="chevron-right" class="w-4 h-4 nav-chevron ml-auto"></i>
        </div>
        <div class="nav-children">
          <a href="#when" class="nav-item">Decision Criteria</a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Section 1: ESSENCE -->
      <section id="essence" data-activity="essence">
        <div class="essence-box">
          <div class="essence-label">Essence (15 words)</div>
          <div class="essence-text">Ralph loops fresh Claude instances with external state for autonomous overnight development.</div>
        </div>
      </section>

      <!-- Section 2: CORE ABSTRACTION + IMPLEMENTATION -->
      <section id="core-abstraction" data-activity="core">
        <h2 class="section-title">
          <span class="section-number">2</span>
          The Core Abstraction
        </h2>

        <div class="core-abstraction">
          <div class="core-philosophy">"Context degrades with tokens. Files persist."</div>

          <div class="core-code">
            <button class="copy-btn" onclick="copyCode(this, 'while :; do cat PROMPT.md | claude ; done')">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <code>while :; do cat PROMPT.md | claude ; done</code>
          </div>

          <div class="core-anchor">That's the whole pattern. Everything else is scaffolding.</div>
        </div>

        <p class="text-text-secondary mb-6">
          Each iteration spawns a NEW Claude instance. No memory of previous runs. The agent reads its context fresh from files (PROMPT.md, prd.json, progress.txt), does ONE task, writes results back to files, and exits. The bash loop restarts it.
        </p>

        <p class="text-text-secondary mb-6">
          This is counterintuitive. Surely accumulated context is valuable? No. After ~80K tokens, LLM quality degrades. "Context rot" means the model forgets early instructions, contradicts itself, loses track of goals. Fresh context beats accumulated context.
        </p>
      </section>

      <!-- Section 3: DESIGN DECISIONS -->
      <section id="why-fresh-context" data-activity="decisions">
        <h2 class="section-title">
          <span class="section-number">3</span>
          Design Decisions
        </h2>

        <div class="decision-box">
          <div class="decision-why">WHY FRESH CONTEXT?</div>
          <div class="decision-reasoning">
            At 80K tokens, Claude's quality degrades. Instructions get lost. The model contradicts itself. This is "context rot"—a fundamental limitation of transformer attention.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              Kill and restart. Don't try to extend sessions. If iteration 20 produces worse code than iteration 5, your context is rotting. The fix is to restart, not debug.
            </div>
          </div>
        </div>

        <div class="decision-box" id="why-external-state">
          <div class="decision-why">WHY EXTERNAL STATE?</div>
          <div class="decision-reasoning">
            If each iteration is a fresh Claude with no memory, how does progress persist? Through files. Git commits, prd.json (task tracking), progress.txt (learnings). The filesystem IS the memory.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              Never rely on "Claude remembering" something. If it's not in a file, it doesn't exist. progress.txt must be append-only. prd.json must be updated after each task. Every learning must be persisted.
            </div>
          </div>
        </div>

        <div class="decision-box" id="why-small-tasks">
          <div class="decision-why">WHY SMALL TASKS?</div>
          <div class="decision-reasoning">
            Each task must complete in ONE iteration (one context window). If a task is too big, Claude loses track mid-task and produces broken code. Small tasks = verifiable units = reliable progress.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              If you can't describe a task in 2-3 sentences, split it. "Build auth system" → "Add users table", "Add auth middleware", "Add login form", "Add session handling". Each is one iteration.
            </div>
          </div>
        </div>
      </section>

      <!-- Section 4: FILE STRUCTURE -->
      <section id="file-structure" data-activity="files">
        <h2 class="section-title">
          <span class="section-number">4</span>
          The File Structure
        </h2>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre>project/
<span class="comment">├── scripts/ralph/           # The Ralph system</span>
│   ├── ralph.sh             <span class="comment"># The loop engine</span>
│   ├── prompt.md            <span class="comment"># Instructions per iteration</span>
│   ├── prd.json             <span class="comment"># Task board (external state)</span>
│   └── progress.txt         <span class="comment"># Learnings log (append-only)</span>
└── CLAUDE.md                <span class="comment"># Project context (optional)</span></pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="ralph-sh">ralph.sh — The Loop Engine</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre><span class="comment">#!/bin/bash</span>
<span class="keyword">set</span> -e

<span class="variable">MAX_ITERATIONS</span>=<span class="variable">${1:-10}</span>
<span class="variable">SCRIPT_DIR</span>="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

<span class="keyword">echo</span> <span class="string">"Starting Ralph"</span>

<span class="keyword">for</span> i <span class="keyword">in</span> $(seq 1 $MAX_ITERATIONS); <span class="keyword">do</span>
  <span class="keyword">echo</span> <span class="string">"=== Iteration $i ==="</span>

  OUTPUT=$(cat "$SCRIPT_DIR/prompt.md" \
    | claude --dangerously-skip-permissions 2>&1 \
    | tee /dev/stderr) || true

  <span class="keyword">if</span> <span class="keyword">echo</span> "$OUTPUT" | grep -q <span class="string">"&lt;promise&gt;COMPLETE&lt;/promise&gt;"</span>; <span class="keyword">then</span>
    <span class="keyword">echo</span> <span class="string">"Done!"</span>
    <span class="keyword">exit</span> 0
  <span class="keyword">fi</span>

  sleep 2
<span class="keyword">done</span>

<span class="keyword">echo</span> <span class="string">"Max iterations reached"</span>
<span class="keyword">exit</span> 1</pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="prompt-md">prompt.md — Agent Instructions</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre><span class="comment"># Ralph Agent Instructions</span>

<span class="comment">## Your Task</span>

1. Read `scripts/ralph/prd.json`
2. Read `scripts/ralph/progress.txt` (check Codebase Patterns first)
3. Pick highest priority story where `passes: false`
4. Implement that ONE story
5. Run typecheck and tests
6. Commit: `feat: [ID] - [Title]`
7. Update prd.json: `passes: true`
8. APPEND learnings to progress.txt

<span class="comment">## Stop Condition</span>

If ALL stories pass, reply:
&lt;promise&gt;COMPLETE&lt;/promise&gt;

Otherwise end normally.</pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="prd-json">prd.json — Task Board</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre>{
  <span class="string">"project"</span>: <span class="string">"My Feature"</span>,
  <span class="string">"branchName"</span>: <span class="string">"ralph/my-feature"</span>,
  <span class="string">"userStories"</span>: [
    {
      <span class="string">"id"</span>: <span class="string">"US-001"</span>,
      <span class="string">"title"</span>: <span class="string">"Add users table schema"</span>,
      <span class="string">"acceptanceCriteria"</span>: [
        <span class="string">"Migration creates users table"</span>,
        <span class="string">"npm run typecheck passes"</span>,
        <span class="string">"npm run test passes"</span>
      ],
      <span class="string">"priority"</span>: 1,
      <span class="string">"passes"</span>: <span class="keyword">false</span>
    },
    {
      <span class="string">"id"</span>: <span class="string">"US-002"</span>,
      <span class="string">"title"</span>: <span class="string">"Add auth middleware"</span>,
      <span class="string">"acceptanceCriteria"</span>: [
        <span class="string">"Middleware checks session"</span>,
        <span class="string">"npm run typecheck passes"</span>
      ],
      <span class="string">"priority"</span>: 2,
      <span class="string">"passes"</span>: <span class="keyword">false</span>
    }
  ]
}</pre>
        </div>
      </section>

      <!-- Section 5: PATH OF A TASK -->
      <section id="path" data-activity="path">
        <h2 class="section-title">
          <span class="section-number">5</span>
          The Path of a Task
        </h2>

        <p class="text-text-secondary mb-6">
          Follow a task through the system to see how the pieces connect:
        </p>

        <div class="path-container">
          <div class="path-step">
            <div class="path-number">1</div>
            <div class="path-content">You write <code>PROMPT.md</code> with task instructions and <code>prd.json</code> with stories</div>
          </div>
          <div class="path-step">
            <div class="path-number">2</div>
            <div class="path-content">Bash executes <code>ralph.sh</code> — the loop begins</div>
          </div>
          <div class="path-step">
            <div class="path-number">3</div>
            <div class="path-content">New Claude instance spawns (fresh context, zero memory)</div>
          </div>
          <div class="path-step">
            <div class="path-number">4</div>
            <div class="path-content">Claude reads <code>prd.json</code>, finds first <code>passes: false</code> task</div>
          </div>
          <div class="path-step">
            <div class="path-number">5</div>
            <div class="path-content">Claude reads <code>progress.txt</code> for previous learnings</div>
          </div>
          <div class="path-step">
            <div class="path-number">6</div>
            <div class="path-content">Claude implements the task, writes code</div>
          </div>
          <div class="path-step">
            <div class="path-number">7</div>
            <div class="path-content">Claude runs tests: <code>npm run typecheck && npm test</code></div>
          </div>
          <div class="path-step">
            <div class="path-number">8</div>
            <div class="path-content">If tests pass: Claude marks <code>passes: true</code>, commits, appends to <code>progress.txt</code></div>
          </div>
          <div class="path-step">
            <div class="path-number">9</div>
            <div class="path-content">If tests fail: Claude tries to fix, or iteration ends (next iteration retries)</div>
          </div>
          <div class="path-step">
            <div class="path-number">10</div>
            <div class="path-content">Claude exits. Bash restarts loop with fresh Claude.</div>
          </div>
          <div class="path-step">
            <div class="path-number">11</div>
            <div class="path-content">Repeat until all tasks pass OR max iterations reached</div>
          </div>
          <div class="path-step">
            <div class="path-number">12</div>
            <div class="path-content">Final Claude outputs <code>&lt;promise&gt;COMPLETE&lt;/promise&gt;</code>, loop exits</div>
          </div>
        </div>
      </section>

      <!-- Section 6: GOTCHAS -->
      <section id="gotchas" data-activity="gotchas">
        <h2 class="section-title">
          <span class="section-number">6</span>
          Gotchas
        </h2>

        <p class="text-text-secondary mb-6">
          Real problems you'll hit, with concrete numbers and fixes:
        </p>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            progress.txt grows unbounded
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> After ~50 iterations, Claude spends more tokens reading than thinking</div>
          <div class="gotcha-detail"><strong>Threshold:</strong> >20KB progress.txt starts degrading quality</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Truncate to last 10 entries between runs. Move permanent learnings to AGENTS.md.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            "APPEND" gets ignored
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> progress.txt keeps getting overwritten, losing learnings</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Model interprets "update" as "replace"</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Use "APPEND" in CAPS in prompt.md. The capitalization matters.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Stuck loop (same task repeating)
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> Same task attempted 3+ times with no progress</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Task impossible OR verification failing for external reasons</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Add stuck detection (check git commits). If same HEAD for 3 iterations, exit. Then manually investigate.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            UI claimed complete but visually broken
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> Tests pass but the UI is obviously wrong</div>
          <div class="gotcha-detail"><strong>Cause:</strong> No visual verification in acceptance criteria</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Add Playwright verification. "Verify at localhost:3000 using dev-browser skill."</div>
        </div>
      </section>

      <!-- Section 7: WHAT'S HARD -->
      <section id="hard" data-activity="hard">
        <h2 class="section-title">
          <span class="section-number">7</span>
          What's Hard
        </h2>

        <p class="text-text-secondary mb-6">
          These are fundamental tensions, not bugs to fix:
        </p>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Context Rot vs. Memory Loss
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Fresh context avoids rot but loses learnings. progress.txt helps but grows unbounded. No perfect solution exists.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Quality drops in late iterations (rot), OR early iterations repeat mistakes from archived runs (memory loss).</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Keep progress.txt under 20KB. Start fresh runs from AGENTS.md (permanent), not progress.txt (session). Accept that some re-learning is the cost of fresh context.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Verification Dependency
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Ralph only works if acceptance criteria are verifiable. But not everything can be verified automatically.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Tasks marked "complete" that aren't actually complete. Garbage compounding across iterations.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Don't use Ralph for subjective tasks. Use HOTL (Human On The Loop) variant for tasks requiring judgment. Accept that some domains (design, UX) aren't Ralph-suitable.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Task Decomposition Skill
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Ralph's success depends on your ability to decompose features into iteration-sized tasks. This is a skill, not a formula.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Tasks too big → context overflow. Tasks too small → overhead dominates. Wrong order → broken dependencies.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Start with HOTL Ralph to learn task sizing. Review progress.txt after runs to see what worked. Expect to get better over time.</div>
        </div>
      </section>

      <!-- Section 8: WHEN TO USE -->
      <section id="when" data-activity="when">
        <h2 class="section-title">
          <span class="section-number">8</span>
          When to Use / When Not
        </h2>

        <div class="when-grid">
          <div class="when-use">
            <div class="when-title">
              <i data-lucide="check" class="w-5 h-5"></i>
              USE RALPH WHEN
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Tasks have verifiable acceptance criteria (can detect completion)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Overnight execution is acceptable (fresh context needs restarts)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Feature can be split into &lt;30min subtasks (fits context window)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>You have tests/typecheck as verification layer</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>You want to "ship while you sleep"</span>
            </div>
          </div>

          <div class="when-not">
            <div class="when-title">
              <i data-lucide="x" class="w-5 h-5"></i>
              DON'T USE RALPH WHEN
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Subjective quality goals ("make it pretty") → Human judgment</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Security-critical code → HOTL Ralph with human gates</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Need real-time parallelism → CC Mirror</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Exploratory work with no defined end → Single Claude session</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Legacy code without tests → Add tests first</span>
            </div>
          </div>
        </div>
      </section>

    </main>

    <!-- Resizer between Main Panel and Activity Zone -->
    <div class="resizer" data-resizer="activity-zone" aria-label="Resize activity panel"></div>

    <!-- Activity Zone -->
    <aside class="activity-zone" id="activityZone">
      <div class="text-xs font-semibold text-text-muted uppercase tracking-wider mb-4">Operational Intelligence</div>

      <!-- ESSENCE SECTION -->
      <div class="activity-item invariant" data-section="essence">
        <div class="activity-label" style="color: #3b82f6;">
          <i data-lucide="link-2" class="w-4 h-4"></i>
          Invariant Connection
        </div>
        <div class="font-medium text-text-primary mb-2">INV-003: External state > internal memory</div>
        <div class="text-text-secondary text-sm">
          Ralph, Gas Town, CC Mirror all share this principle. Memory in files, not context. If you understand this invariant, you understand all three patterns.
        </div>
      </div>

      <div class="activity-item warstory" data-section="essence">
        <div class="activity-label" style="color: #10b981;">
          <i data-lucide="user" class="w-4 h-4"></i>
          War Story
        </div>
        <div class="font-medium text-text-primary mb-2">Ryan Carson: 14 iterations, ~$10-15</div>
        <div class="text-text-secondary text-sm">
          Untangle Legal Agent. 6 user stories, ran overnight. All completed by morning. "Learnings compound. By story 10, Ralph knew our patterns."
        </div>
      </div>

      <!-- CORE SECTION -->
      <div class="activity-item effect" data-section="core">
        <div class="activity-label" style="color: #f59e0b;">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          Second-Order Effect
        </div>
        <div class="font-medium text-text-primary mb-2">At ~80K tokens, quality inverts</div>
        <div class="text-text-secondary text-sm">
          Early iterations: more context = better output. After 80K: more context = worse output. The relationship flips. This is why fresh context wins.
        </div>
      </div>

      <!-- DECISIONS SECTION -->
      <div class="activity-item invariant" data-section="decisions">
        <div class="activity-label" style="color: #3b82f6;">
          <i data-lucide="link-2" class="w-4 h-4"></i>
          Invariant Connection
        </div>
        <div class="font-medium text-text-primary mb-2">INV-001: Context is a constraint, not just a resource</div>
        <div class="text-text-secondary text-sm">
          This principle explains both "why fresh context" (avoid rot) and "why small tasks" (fit window). Two design decisions, one underlying truth.
        </div>
      </div>

      <div class="activity-item composition" data-section="decisions">
        <div class="activity-label" style="color: #8b5cf6;">
          <i data-lucide="layers" class="w-4 h-4"></i>
          Composition Case
        </div>
        <div class="font-medium text-text-primary mb-2">Ralph + Opus 4.5</div>
        <div class="text-text-secondary text-sm">
          <strong>Works well:</strong> Stronger reasoning = fewer iterations needed.<br>
          <strong>Gotcha:</strong> Higher cost per iteration. Run the math: 10 Opus iterations vs 25 Sonnet iterations.
        </div>
      </div>

      <!-- FILES SECTION -->
      <div class="activity-item warstory" data-section="files">
        <div class="activity-label" style="color: #10b981;">
          <i data-lucide="user" class="w-4 h-4"></i>
          War Story
        </div>
        <div class="font-medium text-text-primary mb-2">Matt Pocock: Playwright verification</div>
        <div class="text-text-secondary text-sm">
          AI Hero Video Editor. "Claude used Playwright to verify the UI actually rendered correctly." Visual verification caught bugs tests missed.
        </div>
      </div>

      <div class="activity-item composition" data-section="files">
        <div class="activity-label" style="color: #8b5cf6;">
          <i data-lucide="layers" class="w-4 h-4"></i>
          Composition Case
        </div>
        <div class="font-medium text-text-primary mb-2">Ralph + Playwright</div>
        <div class="text-text-secondary text-sm">
          <strong>Works:</strong> Visual verification catches UI bugs.<br>
          <strong>Danger:</strong> Browser context consumes tokens. Put Playwright in subagents to protect main context window.
        </div>
      </div>

      <!-- PATH SECTION -->
      <div class="activity-item effect" data-section="path">
        <div class="activity-label" style="color: #f59e0b;">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          Second-Order Effect
        </div>
        <div class="font-medium text-text-primary mb-2">Learnings compound non-linearly</div>
        <div class="text-text-secondary text-sm">
          Iteration 1-3: slow, learning codebase. Iteration 4-8: accelerating, patterns emerging. Iteration 9+: fast, progress.txt paying off. Don't judge Ralph by iteration 2.
        </div>
      </div>

      <!-- GOTCHAS SECTION -->
      <div class="activity-item frontier" data-section="gotchas">
        <div class="activity-label" style="color: #ef4444;">
          <i data-lucide="flask-conical" class="w-4 h-4"></i>
          Research Frontier
        </div>
        <div class="font-medium text-text-primary mb-2">UNSOLVED: Optimal compaction window</div>
        <div class="text-text-secondary text-sm">
          When should progress.txt be compacted? After N iterations? After K bytes? Optimal varies by project. Current best practice: manual compaction when quality degrades.
        </div>
      </div>

      <div class="activity-item effect" data-section="gotchas">
        <div class="activity-label" style="color: #f59e0b;">
          <i data-lucide="trending-up" class="w-4 h-4"></i>
          Second-Order Effect
        </div>
        <div class="font-medium text-text-primary mb-2">Errors compound faster than learnings</div>
        <div class="text-text-secondary text-sm">
          Without verification, one bad commit poisons all future iterations. Matt Pocock: "If you don't do this, you're hamstringing future agent runs with bad code."
        </div>
      </div>

      <!-- HARD SECTION -->
      <div class="activity-item frontier" data-section="hard">
        <div class="activity-label" style="color: #ef4444;">
          <i data-lucide="flask-conical" class="w-4 h-4"></i>
          Research Frontier
        </div>
        <div class="font-medium text-text-primary mb-2">UNSOLVED: Stuck detection threshold</div>
        <div class="text-text-secondary text-sm">
          How many iterations without progress = stuck? 3? 5? Too low = false positives. Too high = wasted tokens. Nobody has definitive answer yet.
        </div>
      </div>

      <div class="activity-item warstory" data-section="hard">
        <div class="activity-label" style="color: #10b981;">
          <i data-lucide="user" class="w-4 h-4"></i>
          War Story
        </div>
        <div class="font-medium text-text-primary mb-2">Molly Cantillon: Jmail, 18M users</div>
        <div class="text-text-secondary text-sm">
          Built overnight with Ralph loops. Epstein files search. Example of "autonomous department" pattern at scale. Proof that Ralph works for production systems.
        </div>
      </div>

      <!-- WHEN SECTION -->
      <div class="activity-item alternative" data-section="when">
        <div class="activity-label" style="color: #6b7280;">
          <i data-lucide="arrow-right" class="w-4 h-4"></i>
          Alternative Paths
        </div>
        <div class="font-medium text-text-primary mb-2">If Ralph isn't right for your use case</div>
        <div class="text-text-secondary text-sm">
          <strong>Need parallelism?</strong> → CC Mirror<br>
          <strong>Need human review gates?</strong> → HOTL Ralph<br>
          <strong>Need content, not code?</strong> → Ralph Wiggum Marketer<br>
          <strong>Need debugging?</strong> → Single Claude session
        </div>
      </div>

      <div class="activity-item composition" data-section="when">
        <div class="activity-label" style="color: #8b5cf6;">
          <i data-lucide="layers" class="w-4 h-4"></i>
          Composition Case
        </div>
        <div class="font-medium text-text-primary mb-2">Ralph + Git Worktrees</div>
        <div class="text-text-secondary text-sm">
          <strong>For parallel features:</strong> Each Ralph in its own worktree, same repo. Merge results after overnight run. Ryan Carson: "3 simultaneous Ralph instances."
        </div>
      </div>

    </aside>
  </div>

  <script>
    /**
     * PanelResizer - Handles draggable panel dividers
     *
     * Designed for extraction to standalone module.
     * Auto-initializes on elements with [data-resizer] attribute.
     */
    class PanelResizer {
      constructor(resizerEl, config = {}) {
        this.resizer = resizerEl;
        this.config = {
          storageKey: 'panel-activity-zone-width',
          minWidth: 280,
          maxWidth: 900,  // Allow generous expansion
          defaultWidth: 480,
          ...config
        };

        this.isResizing = false;
        this.startX = 0;
        this.startWidth = 0;

        // Elements
        this.activityZone = document.querySelector('.activity-zone');
        this.mainContent = document.querySelector('.main-content');

        // Bind methods
        this.onMouseDown = this.onMouseDown.bind(this);
        this.onMouseMove = this.onMouseMove.bind(this);
        this.onMouseUp = this.onMouseUp.bind(this);

        this.init();
      }

      init() {
        // Restore saved width
        this.restoreWidth();

        // Attach mousedown listener
        this.resizer.addEventListener('mousedown', this.onMouseDown);
      }

      onMouseDown(e) {
        if (e.button !== 0) return; // Left click only

        this.isResizing = true;
        this.startX = e.clientX;
        this.startWidth = this.activityZone.offsetWidth;

        // Visual feedback
        this.resizer.classList.add('active');
        document.body.classList.add('resizing');

        // Listen on document for full-range movement
        document.addEventListener('mousemove', this.onMouseMove);
        document.addEventListener('mouseup', this.onMouseUp);

        e.preventDefault();
      }

      onMouseMove(e) {
        if (!this.isResizing) return;

        // Calculate new width (dragging left = larger activity zone)
        const delta = this.startX - e.clientX;
        const newWidth = this.startWidth + delta;

        // Apply constraints
        const constrainedWidth = Math.max(
          this.config.minWidth,
          Math.min(this.config.maxWidth, newWidth)
        );

        // Update styles
        this.activityZone.style.width = constrainedWidth + 'px';
        this.mainContent.style.marginRight = constrainedWidth + 'px';
        this.resizer.style.right = constrainedWidth + 'px';
      }

      onMouseUp(e) {
        if (!this.isResizing) return;

        this.isResizing = false;

        // Remove visual feedback
        this.resizer.classList.remove('active');
        document.body.classList.remove('resizing');

        // Clean up listeners
        document.removeEventListener('mousemove', this.onMouseMove);
        document.removeEventListener('mouseup', this.onMouseUp);

        // Persist width
        this.saveWidth();
      }

      saveWidth() {
        const width = this.activityZone.offsetWidth;
        localStorage.setItem(this.config.storageKey, JSON.stringify({
          width,
          timestamp: Date.now()
        }));
      }

      restoreWidth() {
        try {
          const stored = localStorage.getItem(this.config.storageKey);
          if (stored) {
            const { width } = JSON.parse(stored);
            if (width >= this.config.minWidth && width <= this.config.maxWidth) {
              this.activityZone.style.width = width + 'px';
              this.mainContent.style.marginRight = width + 'px';
              this.resizer.style.right = width + 'px';
            }
          }
        } catch (e) {
          console.warn('Failed to restore panel width:', e);
        }
      }

      destroy() {
        this.resizer.removeEventListener('mousedown', this.onMouseDown);
        document.removeEventListener('mousemove', this.onMouseMove);
        document.removeEventListener('mouseup', this.onMouseUp);
      }
    }

    // Auto-initialize resizers on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      const resizers = document.querySelectorAll('[data-resizer]');
      resizers.forEach(resizer => new PanelResizer(resizer));
    });

    // Initialize Lucide icons
    lucide.createIcons();

    // Navigation toggle
    function toggleSection(header) {
      const section = header.closest('.nav-section');
      section.classList.toggle('expanded');
      const children = section.querySelector('.nav-children');
      children.classList.toggle('expanded');
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
      const nav = document.getElementById('leftNav');
      nav.classList.toggle('open');
    }

    // Copy functionality
    function copyCode(btn, text) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Copied!';
        lucide.createIcons();
        setTimeout(() => {
          btn.innerHTML = originalText;
          lucide.createIcons();
        }, 2000);
      });
    }

    function copyCodeBlock(btn) {
      const codeBlock = btn.closest('.code-block');
      const pre = codeBlock.querySelector('pre');
      const text = pre.textContent;
      copyCode(btn, text);
    }

    // Scroll-sync with GSAP ScrollTrigger
    gsap.registerPlugin(ScrollTrigger);

    // Track which sections are in view
    const sections = document.querySelectorAll('[data-activity]');
    const activityItems = document.querySelectorAll('.activity-item');

    sections.forEach(section => {
      ScrollTrigger.create({
        trigger: section,
        start: 'top 40%',
        end: 'bottom 40%',
        onEnter: () => activateSection(section.dataset.activity),
        onEnterBack: () => activateSection(section.dataset.activity),
      });
    });

    function activateSection(sectionName) {
      activityItems.forEach(item => {
        if (item.dataset.section === sectionName) {
          item.classList.add('active');
          gsap.to(item, {
            opacity: 1,
            y: -2,
            boxShadow: '0 4px 12px rgba(0,0,0,0.08)',
            duration: 0.3,
            ease: 'power2.out'
          });
        } else {
          item.classList.remove('active');
          gsap.to(item, {
            opacity: 0.5,
            y: 0,
            boxShadow: 'none',
            duration: 0.3,
            ease: 'power2.out'
          });
        }
      });

      // Update nav active state
      document.querySelectorAll('.nav-section-header').forEach(header => {
        header.classList.remove('active');
      });
      const activeNav = document.querySelector(`[data-section="${sectionName}"] .nav-section-header`);
      if (activeNav) {
        activeNav.classList.add('active');
      }
    }

    // Initialize first section as active
    activateSection('essence');

    // Smooth scroll for nav links
    document.querySelectorAll('.nav-item').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const target = document.querySelector(link.getAttribute('href'));
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
          link.classList.add('active');
        }
      });
    });

    // Brushing interaction - hover activity item highlights related content
    activityItems.forEach(item => {
      item.addEventListener('mouseenter', () => {
        const sectionName = item.dataset.section;
        const relatedSection = document.querySelector(`[data-activity="${sectionName}"]`);
        if (relatedSection) {
          relatedSection.style.backgroundColor = 'rgba(13, 147, 115, 0.05)';
          relatedSection.style.transition = 'background-color 0.3s ease';
        }
      });

      item.addEventListener('mouseleave', () => {
        const sectionName = item.dataset.section;
        const relatedSection = document.querySelector(`[data-activity="${sectionName}"]`);
        if (relatedSection) {
          relatedSection.style.backgroundColor = '';
        }
      });
    });
  </script>
</body>
</html>
