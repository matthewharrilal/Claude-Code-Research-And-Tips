<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Master Playbook</title>
    <style>
        :root {
            --bg-primary: #fefcf3;
            --bg-secondary: #f9f6f0;
            --bg-code: #f0ebe3;
            --text-primary: #3d3d3d;
            --text-heading: #5c4b3a;
            --accent: #2a7d7d;
            --accent-secondary: #4a7c9b;
            --border: #e0d5c5;
            --success: #6b9b7a;
            --warning: #c49052;
            --error: #c97065;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            font-size: 17px;
            line-height: 1.75;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        h1, h2, h3, h4 {
            color: var(--text-heading);
            line-height: 1.3;
            margin-top: 2em;
        }

        h1 {
            font-size: 2.2em;
            border-bottom: 3px solid var(--accent);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        h2 {
            font-size: 1.7em;
            border-bottom: 2px solid var(--border);
            padding-bottom: 12px;
        }

        h3 {
            font-size: 1.35em;
        }

        h4 {
            font-size: 1.15em;
            color: var(--accent);
        }

        a {
            color: var(--accent);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        blockquote {
            margin: 24px 0;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent);
            border-radius: 0 10px 10px 0;
            font-style: italic;
        }

        blockquote strong {
            color: var(--accent);
        }

        code {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 0.9em;
            background: var(--bg-code);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        pre {
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            margin: 20px 0;
        }

        pre code {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.85em;
            line-height: 1.5;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        th {
            background: var(--text-heading);
            color: var(--bg-primary);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
        }

        tr:hover {
            background: var(--bg-primary);
        }

        hr {
            border: none;
            height: 2px;
            background: var(--border);
            margin: 40px 0;
        }

        ul, ol {
            padding-left: 24px;
        }

        li {
            margin: 8px 0;
        }

        .nav {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px 32px;
            margin: 32px 0;
            border: 1px solid var(--border);
        }

        .nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .nav li {
            margin: 0;
        }

        .nav a {
            display: block;
            padding: 10px 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .nav a:hover {
            background: var(--accent);
            color: white;
            text-decoration: none;
            border-color: var(--accent);
        }

        .principle {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px 28px;
            margin: 24px 0;
            border-left: 4px solid var(--accent);
        }

        .principle h4 {
            margin-top: 0;
            color: var(--text-heading);
        }

        .callout {
            background: linear-gradient(135deg, #e8f5f5 0%, #f0f7f7 100%);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 16px 20px;
            margin: 20px 0;
        }

        .callout strong {
            color: var(--accent);
        }

        .warning {
            background: linear-gradient(135deg, #fef3e2 0%, #fef8f0 100%);
            border: 1px solid var(--warning);
        }

        .warning strong {
            color: var(--warning);
        }

        .iron-law {
            background: linear-gradient(135deg, #5c4b3a 0%, #7a6b5a 100%);
            color: var(--bg-primary);
            padding: 24px 32px;
            border-radius: 12px;
            margin: 32px 0;
            text-align: center;
        }

        .iron-law h3 {
            color: var(--bg-primary);
            margin: 0 0 16px 0;
            font-size: 1.4em;
        }

        .iron-law p {
            font-size: 1.1em;
            margin: 8px 0;
        }

        .level-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid var(--border);
        }

        .level-card h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .level-badge {
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .comparison-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin: 24px 0;
        }

        .comparison-box {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .comparison-box.before {
            border-left: 4px solid var(--error);
        }

        .comparison-box.after {
            border-left: 4px solid var(--success);
        }

        .comparison-box h4 {
            margin-top: 0;
        }

        .before h4 {
            color: var(--error);
        }

        .after h4 {
            color: var(--success);
        }

        .ascii-diagram {
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 24px;
            font-family: 'SF Mono', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre;
        }

        .checklist {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }

        .checklist ul {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 8px 0;
            padding-left: 32px;
            position: relative;
        }

        .checklist li::before {
            content: "☐";
            position: absolute;
            left: 0;
            color: var(--accent);
            font-size: 1.2em;
        }

        .toc-part {
            font-weight: 600;
            color: var(--text-heading);
        }

        .subtitle {
            color: var(--accent);
            font-size: 1.1em;
            font-style: italic;
            margin-top: -8px;
        }

        @media (max-width: 768px) {
            body {
                font-size: 16px;
                padding: 24px 16px;
            }

            .nav ul {
                grid-template-columns: 1fr;
            }

            .comparison-table {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Claude Code Master Playbook</h1>

    <blockquote>
        <strong>The Complete Guide to Orchestration, Context Management, and Agent Engineering</strong><br>
        From single sessions to factory-scale autonomous development
    </blockquote>

    <nav class="nav">
        <ul>
            <li><a href="#part-1">Part 1: Foundations</a></li>
            <li><a href="#part-2">Part 2: Capability Progression</a></li>
            <li><a href="#part-3">Part 3: Deep Pattern Mastery</a></li>
            <li><a href="#part-4">Part 4: Transformations</a></li>
            <li><a href="#part-5">Part 5: Pattern Combinations</a></li>
            <li><a href="#part-6">Part 6: Complete Architectures</a></li>
            <li><a href="#part-7">Part 7: Reference</a></li>
        </ul>
    </nav>

    <h2>Who This Playbook Is For</h2>

    <div class="comparison-table">
        <div class="comparison-box before">
            <h4>Your Current State</h4>
            <ul>
                <li>Single long sessions with subagents that overflow context</li>
                <li>Context degrades mid-task, sessions die, progress lost</li>
                <li>Token costs spiraling</li>
                <li>Overwhelmed by options</li>
            </ul>
        </div>
        <div class="comparison-box after">
            <h4>What You'll Learn</h4>
            <ul>
                <li>WHY each pattern works (not just HOW)</li>
                <li>Judgment to choose between approaches</li>
                <li>Manage context while maintaining full depth</li>
                <li>How patterns combine for compounding value</li>
            </ul>
        </div>
    </div>

    <hr>

    <h1 id="part-1">Part 1: Foundations</h1>
    <p class="subtitle">Everything builds on these principles. Understand them first.</p>

    <h2>1.1 The Eight Core Principles</h2>

    <div class="principle">
        <h4>Principle 1: Context Is The Primary Constraint</h4>
        <p><strong>The Reality:</strong> Claude's context window is finite (~200K tokens). Quality degrades as context fills (observable at 60-70%). Long sessions accumulate noise, contradictions, and cruft.</p>
        <p><strong>What This Means:</strong> Every pattern in this playbook ultimately optimizes around context limits. This is THE constraint that shapes everything.</p>
    </div>

    <div class="principle">
        <h4>Principle 2: External State > Internal Memory</h4>
        <p><strong>The Problem:</strong> Claude's "memory" lives only in the context window. When the session ends, everything is lost.</p>
        <p><strong>The Solution:</strong> Store state in files (prd.json, progress.txt, AGENTS.md), in git (commits as memory), and in external tools (Claude-Mem, databases).</p>
    </div>

    <div class="principle">
        <h4>Principle 3: Fresh Context > Extended Sessions</h4>
        <p>Long sessions degrade in quality. Context becomes polluted with false starts, corrections, tangents.</p>
        <p><strong>The Math:</strong></p>
        <pre><code>Quality of 20 five-minute sessions > Quality of one 100-minute session</code></pre>
    </div>

    <div class="iron-law">
        <h3>Principle 4: Orchestrator/Worker Separation</h3>
        <p><strong>The Iron Law:</strong></p>
        <p>Orchestrators coordinate. Workers execute. <strong>Never mix.</strong></p>
    </div>

    <div class="principle">
        <h4>Principle 5: Atomic, Verifiable Tasks</h4>
        <p>"Build the auth system" is too big. "Make it better" can't be verified.</p>
        <p><strong>The Solution:</strong> Break into smallest testable units. Each task has explicit acceptance criteria.</p>
        <pre><code>{
  "title": "Add email validation to login form",
  "acceptanceCriteria": [
    "Validates email format with Zod",
    "Shows error message on invalid email",
    "npm run typecheck passes"
  ]
}</code></pre>
    </div>

    <div class="principle">
        <h4>Principle 6: Quality Gates Before Commit</h4>
        <p>Never mark work as "done" without verification:</p>
        <pre><code>npm run typecheck && npm run test && npm run lint && git commit</code></pre>
    </div>

    <div class="principle">
        <h4>Principle 7: Isolation For Parallel Work</h4>
        <p>Multiple agents editing the same files = merge conflicts. Shared state = race conditions.</p>
        <p><strong>Solution:</strong> Git worktrees for file isolation. Domain-specific Claude instances (Panopticon pattern).</p>
    </div>

    <div class="principle">
        <h4>Principle 8: Explicit Communication Channels</h4>
        <p>Agents can't read minds. Use progress files, structured task definitions (JSON), clear acceptance criteria, and hooks for notifications.</p>
    </div>

    <hr>

    <h2>1.2 Building Blocks: The Primitives</h2>

    <h3>Loop Primitives</h3>
    <pre><code># Bash While Loop
while [ condition ]; do
  # agent iteration
done

# For Loop with Counter
for i in $(seq 1 $MAX_ITERATIONS); do
  # iteration $i
done

# Stop Condition Check
if echo "$OUTPUT" | grep -q "&lt;promise&gt;COMPLETE&lt;/promise&gt;"; then
  exit 0
fi</code></pre>

    <h3>State Primitives</h3>
    <table>
        <tr>
            <th>Type</th>
            <th>Format</th>
            <th>Purpose</th>
        </tr>
        <tr>
            <td>Task List</td>
            <td>prd.json</td>
            <td>Machine-readable task tracking</td>
        </tr>
        <tr>
            <td>Append-Only Log</td>
            <td>progress.txt</td>
            <td>Session learnings</td>
        </tr>
        <tr>
            <td>Git History</td>
            <td>Commits</td>
            <td>State preservation, rollback</td>
        </tr>
    </table>

    <h3>Hook Primitives</h3>
    <pre><code>{
  "hooks": {
    "PostToolUse": [{
      "matcher": "Edit",
      "hooks": [{"type": "command", "command": "prettier --write $FILE"}]
    }]
  }
}</code></pre>

    <hr>

    <h2>1.3 What Fails & Why: Anti-Patterns</h2>

    <div class="callout warning">
        <strong>Anti-Pattern 1: Context Rot</strong><br>
        Single long sessions where quality degrades over time. Claude "forgets" earlier decisions, contradicts itself, gets slower.
        <br><strong>Fix:</strong> Fresh context per iteration + external state.
    </div>

    <div class="callout warning">
        <strong>Anti-Pattern 2: Orchestrators That Write Code</strong><br>
        An orchestrator agent that also tries to implement. Context fills with implementation details, loses big-picture view.
        <br><strong>Fix:</strong> Iron Law: Orchestrators coordinate, workers execute.
    </div>

    <div class="callout warning">
        <strong>Anti-Pattern 3: Workers Spawning Workers</strong><br>
        Leads to infinite recursion risk, loss of control, context explosion.
        <br><strong>Fix:</strong> Workers report back to orchestrator. Only orchestrator spawns.
    </div>

    <div class="callout warning">
        <strong>Anti-Pattern 4: Missing Verification</strong><br>
        Marking tasks complete without checking. Broken code compounds.
        <br><strong>Fix:</strong> Quality gates before commit. Always.
    </div>

    <hr>

    <h1 id="part-2">Part 2: Your Capability Progression</h1>
    <p class="subtitle">Your journey from single sessions to factory-scale development.</p>

    <div class="level-card">
        <h3><span class="level-badge">Level 0</span> Where You Are Now</h3>
        <ul>
            <li>All work happens in one continuous conversation</li>
            <li>Manual approval for every operation</li>
            <li>Context degrades after 60% fill</li>
            <li>90 minutes → session death or burnout</li>
        </ul>
        <p><strong>Pain Points:</strong> Re-explaining context every session. Quality drops near token limits. Session death = lost progress. Must be present entire time. Can't parallelize.</p>
    </div>

    <div class="level-card">
        <h3><span class="level-badge">Level 1</span> First Quick Wins (Week 1)</h3>
        <p><strong>What You Add:</strong> CLAUDE.md + 3-5 slash commands</p>
        <div class="comparison-table">
            <div class="comparison-box before">
                <h4>Before</h4>
                <pre><code>"I need you to review this code.
We're using Next.js 14 with
TypeScript, server actions..."
[5 minutes of context every session]</code></pre>
            </div>
            <div class="comparison-box after">
                <h4>After</h4>
                <pre><code>/review
[Claude already knows your stack]</code></pre>
            </div>
        </div>
        <p><strong>Gains:</strong> ~20% token savings, consistency across sessions, common workflows become one-word commands.</p>
    </div>

    <div class="level-card">
        <h3><span class="level-badge">Level 2</span> Specialization (Week 2)</h3>
        <p><strong>What You Add:</strong> Subagents + Hooks</p>
        <p>Specialized agents with clean, focused contexts: Security reviewer, Test writer, Performance auditor.</p>
        <pre><code>{
  "hooks": {
    "PostToolUse": [{
      "matcher": "Edit",
      "hooks": [{"type": "command", "command": "prettier --write \"$FILE\""}]
    }]
  }
}</code></pre>
    </div>

    <div class="level-card">
        <h3><span class="level-badge">Level 3</span> Autonomy (Week 3-4)</h3>
        <p><strong>What You Add:</strong> Ralph Loop + External memory</p>
        <pre><code>./ralph.sh 25  # Run up to 25 iterations
# Go to sleep
# Wake up to completed feature</code></pre>
        <p><strong>Gains:</strong> Human time: 90 min → 10 min. Fresh context every iteration. Sleep shipping features.</p>
    </div>

    <div class="level-card">
        <h3><span class="level-badge">Level 4</span> Reliability (Month 1)</h3>
        <p><strong>What You Add:</strong> Explicit acceptance criteria + Progress tracking + Learning accumulation</p>
        <pre><code>Story 1: PASS (commit: abc123)
Story 2: PASS (commit: def456)
Story 3: FAIL - typecheck error at auth.ts:42
Story 4: PENDING (blocked by Story 3)</code></pre>
        <p><strong>Gains:</strong> Success rate: 60% → 95%. Know exactly where things failed. Compounding knowledge.</p>
    </div>

    <div class="level-card">
        <h3><span class="level-badge">Level 5</span> Parallelism (Month 2)</h3>
        <p><strong>What You Add:</strong> CC Mirror hub-and-spoke + Multiple workers + Model tiering</p>
        <div class="ascii-diagram">Task 1 ─┐
Task 2 ─┼─► [20 minutes total]
Task 3 ─┘
Task 4 (depends on 1-3) → [+5 minutes]</div>
        <p><strong>Gains:</strong> 2-3x faster. Haiku for lookups, Sonnet for coding, Opus for reasoning.</p>
    </div>

    <div class="level-card">
        <h3><span class="level-badge">Level 6</span> True Parallelization (Month 3)</h3>
        <p><strong>What You Add:</strong> Git worktrees + Parallel Ralph loops</p>
        <pre><code>#!/bin/bash
FEATURES=("auth" "payments" "notifications")

for feature in "${FEATURES[@]}"; do
  git worktree add ../wt-$feature $feature-branch
  (cd ../wt-$feature && ./scripts/ralph/ralph.sh 20) &
done
wait</code></pre>
        <p><strong>Gains:</strong> True 3-5x speedup. Multiple features overnight. No conflicts.</p>
    </div>

    <div class="level-card">
        <h3><span class="level-badge">Level 7</span> Factory Scale (Month 6+)</h3>
        <p><strong>What You Add:</strong> Persistent workers + Self-improving systems + Auto-decomposition</p>
        <div class="ascii-diagram">Gas Town Factory
├─ HQ (Management)
│  ├─ Mayor (coordination)
│  ├─ Deacon (monitoring)
│  └─ Dogs (quality gates)
├─ Refinery (auto-decomposition)
└─ Rigs (projects)
   ├─ Witness (observer)
   ├─ Polecats (persistent workers)
   └─ Crew (ephemeral workers)</div>
        <p><strong>Prerequisites:</strong> 100+ hours multi-agent experience. $50-200/day budget tolerance. Comfort with emergence.</p>
    </div>

    <h3>Progression Summary</h3>
    <table>
        <tr>
            <th>Level</th>
            <th>Pattern</th>
            <th>Human Time</th>
            <th>Token Efficiency</th>
        </tr>
        <tr>
            <td>0</td>
            <td>Single Session</td>
            <td>90 min</td>
            <td>Low</td>
        </tr>
        <tr>
            <td>1</td>
            <td>CLAUDE.md</td>
            <td>60 min</td>
            <td>+20%</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Subagents</td>
            <td>45 min</td>
            <td>+30%</td>
        </tr>
        <tr>
            <td>3</td>
            <td>Ralph</td>
            <td>10 min</td>
            <td>+50%</td>
        </tr>
        <tr>
            <td>4</td>
            <td>PRD-driven</td>
            <td>20 min</td>
            <td>+60%</td>
        </tr>
        <tr>
            <td>5</td>
            <td>CC Mirror</td>
            <td>30 min</td>
            <td>+40%</td>
        </tr>
        <tr>
            <td>6</td>
            <td>Worktrees</td>
            <td>15 min</td>
            <td>+70%</td>
        </tr>
        <tr>
            <td>7</td>
            <td>Gas Town</td>
            <td>Minimal</td>
            <td>Variable</td>
        </tr>
    </table>

    <hr>

    <h1 id="part-3">Part 3: Deep Pattern Mastery</h1>
    <p class="subtitle">Go deep on the patterns that matter most.</p>

    <h2>3.1 Context Management: The Invisible Constraint</h2>

    <blockquote>
        "Context rot: LLMs get stupider with more tokens"
    </blockquote>

    <h3>The Degradation Curve</h3>
    <table>
        <tr><th>Context Level</th><th>Quality Impact</th></tr>
        <tr><td>0-50%</td><td style="color: var(--success);">Full capability</td></tr>
        <tr><td>50-70%</td><td style="color: var(--warning);">Slight degradation possible</td></tr>
        <tr><td>70-85%</td><td style="color: var(--warning);">Noticeable quality loss</td></tr>
        <tr><td>85-95%</td><td style="color: var(--error);">Significant degradation</td></tr>
        <tr><td>95%+</td><td style="color: var(--error);">Failure mode</td></tr>
    </table>

    <h3>Strategy 1: Fresh Context Per Iteration</h3>
    <div class="ascii-diagram">┌─────────────────────────────────────────────────────┐
│  Iteration 1 (fresh Claude instance)               │
│  → Read state from files (PRD, progress, git)      │
│  → Pick highest priority incomplete task           │
│  → Implement + verify                              │
│  → Commit if passing                               │
│  → Exit                                            │
└─────────────────────────────────────────────────────┘
              ↓ (no memory carried forward)
┌─────────────────────────────────────────────────────┐
│  Iteration 2 (fresh Claude instance)               │
│  → Read state from files (now updated)             │
│  → Repeat...                                       │
└─────────────────────────────────────────────────────┘</div>

    <h3>Context Budget Quick Reference</h3>
    <div class="ascii-diagram">Total Effective: ~100K tokens
├── System prompt + CLAUDE.md:   ~5K (5%)
├── Codebase context:            ~20K (20%)
├── Current task:                ~2K (2%)
├── Working memory:              ~30K (30%)
├── Tool outputs:                ~20K (20%)
├── Code generation:             ~15K (15%)
└── Buffer for retries:          ~8K (8%)</div>

    <hr>

    <h2>3.2 The Ralph Loop: Complete Implementation</h2>

    <blockquote>
        "Think of the AI agent as an <strong>eager but somewhat dim junior developer (Ralph)</strong> who never sleeps, happily works on one tiny task at a time, commits often, and tells you when it is truly finished."
    </blockquote>

    <h3>Core Implementation</h3>
    <pre><code>#!/bin/bash
set -e
MAX_ITERATIONS=${1:-25}
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

for i in $(seq 1 $MAX_ITERATIONS); do
  echo "=== Iteration $i ==="
  OUTPUT=$(cat "$SCRIPT_DIR/prompt.md" | claude --dangerously-skip-permissions 2>&1)

  if echo "$OUTPUT" | grep -q "&lt;promise&gt;COMPLETE&lt;/promise&gt;"; then
    echo "Done!"
    exit 0
  fi
  sleep 2
done
echo "Max iterations reached"</code></pre>

    <h3>Task Sizing: The Most Critical Factor</h3>
    <div class="callout">
        <strong>"If you can't describe it in 2-3 sentences, it's too big."</strong>
    </div>

    <table>
        <tr><th>Right-Sized</th><th>Too Big (Split These)</th></tr>
        <tr><td>Add a database column + migration</td><td>"Build the entire dashboard"</td></tr>
        <tr><td>Add a UI component to an existing page</td><td>"Add authentication"</td></tr>
        <tr><td>Write tests for one module</td><td>"Create e-commerce flow"</td></tr>
        <tr><td>Implement one API endpoint</td><td>"Refactor the backend"</td></tr>
    </table>

    <h3>Ralph Variants</h3>
    <table>
        <tr><th>Variant</th><th>Purpose</th><th>When to Use</th></tr>
        <tr><td>Basic Ralph</td><td>Standard loop</td><td>Normal features</td></tr>
        <tr><td>AFK Ralph</td><td>Overnight autonomous</td><td>Sleep shipping</td></tr>
        <tr><td>HOTL Ralph</td><td>Human review between</td><td>Security-sensitive</td></tr>
        <tr><td>Compounding Ralph</td><td>Archives past runs</td><td>Long-term projects</td></tr>
        <tr><td>Parallel Ralph</td><td>Git worktrees</td><td>Multi-feature overnight</td></tr>
    </table>

    <hr>

    <h2>3.3 Multi-Agent Architecture</h2>

    <div class="iron-law">
        <h3>The Iron Law of Worker Separation</h3>
        <p>ORCHESTRATORS COORDINATE. WORKERS EXECUTE.</p>
        <p><strong>NEVER MIX.</strong></p>
    </div>

    <table>
        <tr><th>Role</th><th>What They Do</th><th>What They DON'T Do</th></tr>
        <tr><td><strong>Orchestrator</strong></td><td>Decompose tasks, assign workers</td><td>Write code, run commands</td></tr>
        <tr><td><strong>Workers</strong></td><td>Execute specific tasks</td><td>Spawn sub-agents, create tasks</td></tr>
    </table>

    <h3>Architecture Selection</h3>
    <div class="ascii-diagram">SIMPLE <────────────────────────────> COMPLEX

[Ralph Loop]    [CC Mirror]    [Gas Town]
Single agent    Multi-agent    Agent factory
Bash script     Native CC      Role-based</div>

    <h3>Model Selection for Workers</h3>
    <table>
        <tr><th>Model</th><th>Use Case</th></tr>
        <tr><td>Haiku</td><td>Lookups, simple tasks</td></tr>
        <tr><td>Sonnet</td><td>Implementation</td></tr>
        <tr><td>Opus</td><td>Complex reasoning, architecture</td></tr>
    </table>

    <hr>

    <h2>3.4 Domain Isolation: The Panopticon Pattern</h2>

    <p>Running Claude Code as a <strong>swarm of parallel isolated instances</strong>, each owning a distinct life domain.</p>

    <div class="ascii-diagram">~/nox        # Company/product
~/metrics    # Analytics/data
~/email      # Communications
~/growth     # Marketing
~/trades     # Personal finance
~/health     # Fitness/wellness
~/writing    # Content creation
~/personal   # Life admin</div>

    <div class="callout">
        <strong>[+] COMBINES WITH: Ralph Loop</strong> — Each domain can run its own Ralph loop independently.
    </div>

    <hr>

    <h1 id="part-4">Part 4: Transformations (Before/After)</h1>
    <p class="subtitle">See the same task done both ways to understand the value.</p>

    <h2>4.1 Your Transformation: Single Session → Efficient Orchestration</h2>

    <h3>The Task: Build User Authentication Feature</h3>
    <p>Requirements: Login form, Zod validation, server action with bcrypt, database integration, tests.</p>

    <div class="comparison-table">
        <div class="comparison-box before">
            <h4>BEFORE: Single Session with Naive Subagents</h4>
            <pre><code>$ claude

You: Build a login form
Claude: [Writes LoginForm.tsx] [500 tokens]

You: Add email validation
Claude: [Updates with regex] [1,200 tokens]

You: Use Zod instead
Claude: [Rewrites] [2,100 tokens]

You: Use a subagent for database
Claude: [Spawns subagent with ALL context]
[Subagent inherits 3,400 tokens + returns 2,000]
[Main context: 5,800 tokens]

# 60 minutes in, context at 65%...
# Claude starts forgetting earlier decisions

# Session dies at 85% context
# Feature incomplete</code></pre>
            <p><strong>Token Cost:</strong> ~62,000 tokens ($4-8)</p>
            <p><strong>Human Time:</strong> 90 minutes active</p>
            <p><strong>Result:</strong> Incomplete, buggy</p>
        </div>
        <div class="comparison-box after">
            <h4>AFTER: Ralph Pattern</h4>
            <pre><code>prd.json:
{
  "userStories": [
    {"id": "US-001", "title": "Login form"},
    {"id": "US-002", "title": "Zod schema"},
    {"id": "US-003", "title": "Server action"},
    {"id": "US-004", "title": "Tests"}
  ]
}

$ ./ralph.sh 25  # Run at 11 PM

# Wake up to:
- 7 iterations, 7 clean commits
- Each iteration: fresh context (0%)
- Feature: Complete, tested</code></pre>
            <p><strong>Token Cost:</strong> ~27,000 tokens ($2-3)</p>
            <p><strong>Human Time:</strong> 5 minutes setup</p>
            <p><strong>Result:</strong> Complete, tested</p>
        </div>
    </div>

    <h3>Side-by-Side Comparison</h3>
    <table>
        <tr><th>Aspect</th><th>Before</th><th>After</th></tr>
        <tr><td>Human Time</td><td style="color: var(--error);">90 min</td><td style="color: var(--success);">5 min</td></tr>
        <tr><td>Tokens</td><td style="color: var(--error);">62,000</td><td style="color: var(--success);">27,000</td></tr>
        <tr><td>Cost</td><td style="color: var(--error);">$4-8</td><td style="color: var(--success);">$2-3</td></tr>
        <tr><td>Context Health</td><td style="color: var(--error);">85%+ (degraded)</td><td style="color: var(--success);">Fresh each iteration</td></tr>
        <tr><td>Result</td><td style="color: var(--error);">Incomplete</td><td style="color: var(--success);">Complete</td></tr>
    </table>

    <hr>

    <h1 id="part-5">Part 5: Pattern Combinations</h1>
    <p class="subtitle">How patterns work together for compounding value.</p>

    <h2>5.1 Essential Pairwise Combinations</h2>

    <h3>Ralph + Hooks (Multiplicative)</h3>
    <p>Push notifications during AFK runs. Auto-format on every edit.</p>
    <pre><code>{
  "hooks": {
    "PostToolUse": [{
      "matcher": "Edit",
      "hooks": [{"type": "command", "command": "prettier --write $FILE"}]
    }],
    "PreToolUse": [{
      "matcher": "AskUserQuestion",
      "hooks": [{"type": "command", "command": "~/.claude/hooks/notify.sh"}]
    }]
  }
}</code></pre>
    <p><strong>ROI:</strong> 15 min setup. Never miss a blocking question again.</p>

    <h3>Subagents + Git Worktrees (Multiplicative)</h3>
    <p>True parallel development with no merge conflicts.</p>
    <pre><code>git worktree add ../auth-agent feature/auth
git worktree add ../payments-agent feature/payments

(cd ../auth-agent && claude "Implement auth...") &
(cd ../payments-agent && claude "Implement payments...") &
wait</code></pre>
    <div class="callout">
        <strong>This fixes your subagent problem:</strong> Each agent gets fresh context, not inherited pollution.
    </div>

    <h3>progress.txt + AGENTS.md (Compounding)</h3>
    <p>Short-term memory (progress.txt) + Long-term memory (AGENTS.md).</p>
    <div class="ascii-diagram">Session 1: Learns bcrypt needs 12 rounds → progress.txt
Session 5: Distills to AGENTS.md → "Auth: bcrypt 12 rounds"
Session 50: Agent reads AGENTS.md → Uses 12 rounds automatically</div>

    <hr>

    <h2>5.2 Triple Stacks</h2>

    <h3>The Production Multi-Agent Stack</h3>
    <p><strong>Components:</strong> CC Mirror + Git Worktrees + Hooks</p>
    <div class="ascii-diagram">Orchestrator (Opus)
├── Backend Worker (Sonnet) → ../worktrees/backend/
│   └── Hooks: format, notify
├── Frontend Worker (Sonnet) → ../worktrees/frontend/
│   └── Hooks: format, lint
└── Test Worker (Haiku) → ../worktrees/tests/
    └── Hooks: run tests</div>

    <hr>

    <h2>5.3 Anti-Pattern Combinations (What NOT to Do)</h2>
    <table>
        <tr><th>Pattern A</th><th>Pattern B</th><th>Why It Fails</th></tr>
        <tr><td>Naive Subagents</td><td>Large Context</td><td style="color: var(--error);">Inherited pollution</td></tr>
        <tr><td>CC Mirror</td><td>Gas Town</td><td style="color: var(--error);">Competing orchestrators</td></tr>
        <tr><td>Ralph</td><td>No Verification</td><td style="color: var(--error);">Infinite broken loops</td></tr>
        <tr><td>Opus</td><td>Everything</td><td style="color: var(--error);">Budget explosion</td></tr>
    </table>

    <hr>

    <h2>5.4 Implementation Priority</h2>

    <h4>Week 1 (Stop the Bleeding)</h4>
    <ol>
        <li>Create prd.json template (15 min)</li>
        <li>Set up ralph.sh (30 min)</li>
        <li>Add formatting hooks (15 min)</li>
    </ol>

    <h4>Week 2 (Context Discipline)</h4>
    <ol>
        <li>Create progress.txt pattern (10 min)</li>
        <li>Create AGENTS.md (20 min)</li>
        <li>Replace subagents with worktrees (1 hr)</li>
    </ol>

    <h4>Week 3 (Orchestration)</h4>
    <ol>
        <li>Add CC Mirror (2 hrs)</li>
        <li>Implement tiered model selection (30 min)</li>
    </ol>

    <p><strong>Result:</strong> 50-70% cost reduction. Better quality. Ship while sleeping.</p>

    <hr>

    <h1 id="part-6">Part 6: Complete Architectures</h1>
    <p class="subtitle">Visual representations and narrative workflows.</p>

    <h2>6.1 A Day With Ralph: The Overnight Shipping Story</h2>

    <h3>The Setup (6:47 PM, Wednesday)</h3>
    <p>You've been staring at the Jira board for three weeks. The authentication feature keeps slipping. Tonight, that changes.</p>
    <pre><code>cd ~/projects/saas-app
git checkout -b feature/auth-flow
./scripts/ralph/ralph.sh 25 2>&1 | tee ralph.log &</code></pre>
    <p>The loop begins. You grab your jacket and leave.</p>

    <h3>The Night (Automatic)</h3>
    <ul>
        <li><strong>Iteration 1 (6:52 PM):</strong> Fresh Claude instance. Reads prd.json. Implements US-001 (User model). Commits.</li>
        <li><strong>Iteration 2 (7:08 PM):</strong> Fresh context. Reads progress.txt learnings. Implements US-002. Commits.</li>
        <li><strong>Iteration 3-5:</strong> Database, form component, tests. Each fresh. Each committed.</li>
        <li><strong>Iteration 6:</strong> All stories pass. Outputs <code>&lt;promise&gt;COMPLETE&lt;/promise&gt;</code>. Loop exits.</li>
    </ul>

    <h3>The Morning After (7:15 AM, Thursday)</h3>
    <pre><code>git log --oneline feature/auth-flow

a3f2c1d feat(auth): Add protected route middleware
8b4e5f2 feat(auth): Add login form
c7d9a0b feat(auth): Add registration
4e6f8c1 feat(auth): Add login endpoint
9a1b2c3 feat(auth): Add User model</code></pre>
    <p>Five clean commits. CI green. You run the app. It works.</p>
    <p><strong>Three weeks of Jira tickets — shipped while you slept.</strong></p>

    <hr>

    <h2>6.2 ASCII Architecture Diagrams</h2>

    <h3>Pattern Dependency Graph</h3>
    <div class="ascii-diagram">CLAUDE.md ─────────────────────────────────────────┐
    │                                               │
    ├─► Slash Commands ──┐                         │
    ├─► Hooks ───────────┼──► Ralph Loop ──────────┤
    └─► Skills ──────────┘        │                │
                                  ▼                │
                    ┌─────────────────────┐        │
                    │  progress.txt       │        │
                    │  prd.json           │        │
                    └─────────────────────┘        │
                                  │                │
                                  ▼                │
                    ┌─────────────────────┐        │
                    │  Multi-Agent        │◄───────┘
                    │  (CC Mirror)        │
                    └─────────────────────┘</div>

    <h3>Orchestrator/Worker Separation</h3>
    <div class="ascii-diagram">┌─────────────────────────────────────────────────────┐
│  ORCHESTRATOR              WORKERS                   │
│  ───────────               ───────                   │
│  TaskCreate               Read, Write, Edit          │
│  TaskUpdate      ═══►     Bash, Glob, Grep          │
│  TaskGet         Delegates                          │
│  Read (1-2 files)◄═══     Reports results           │
│                                                      │
│  "CONDUCTOR"              "MUSICIANS"                │
│  Never codes              Execute only               │
├─────────────────────────────────────────────────────┤
│  THE IRON LAW: Workers NEVER spawn or create tasks  │
└─────────────────────────────────────────────────────┘</div>

    <hr>

    <h1 id="part-7">Part 7: Reference</h1>
    <p class="subtitle">Quick lookups and decision support.</p>

    <h2>7.1 Pattern Vocabulary</h2>

    <h3>Loop Constructs</h3>
    <table>
        <tr><th>Term</th><th>Definition</th></tr>
        <tr><td><strong>while-loop</strong></td><td>Indefinite iteration until signal</td></tr>
        <tr><td><strong>for-loop</strong></td><td>Bounded iteration with max</td></tr>
        <tr><td><strong>fresh-context</strong></td><td>Zero accumulated context</td></tr>
        <tr><td><strong>stop-condition</strong></td><td><code>&lt;promise&gt;COMPLETE&lt;/promise&gt;</code></td></tr>
    </table>

    <h3>State Containers</h3>
    <table>
        <tr><th>Term</th><th>Location</th><th>Purpose</th></tr>
        <tr><td><strong>progress.txt</strong></td><td>scripts/ralph/</td><td>Session learnings</td></tr>
        <tr><td><strong>prd.json</strong></td><td>scripts/ralph/</td><td>Task tracking</td></tr>
        <tr><td><strong>AGENTS.md</strong></td><td>Project root</td><td>Permanent learnings</td></tr>
        <tr><td><strong>CLAUDE.md</strong></td><td>Project root</td><td>Project context</td></tr>
    </table>

    <h3>Agent Types</h3>
    <table>
        <tr><th>Term</th><th>Role</th></tr>
        <tr><td><strong>orchestrator</strong></td><td>Coordinates, never executes</td></tr>
        <tr><td><strong>worker</strong></td><td>Executes, never coordinates</td></tr>
        <tr><td><strong>polecat</strong></td><td>Persistent named worker (Gas Town)</td></tr>
        <tr><td><strong>crew</strong></td><td>Ephemeral worker (Gas Town)</td></tr>
    </table>

    <hr>

    <h2>7.2 Decision Trees</h2>

    <h3>Which Pattern?</h3>
    <div class="ascii-diagram">Is this a single, simple task?
├─YES→ Single interactive session
└─NO→ Can you walk away (AFK)?
    ├─NO→ CC Mirror (multi-agent)
    └─YES→ Can you write clear acceptance criteria?
         ├─NO→ NOT READY (refine first)
         └─YES→ Need parallelism?
              ├─NO→ Ralph loop
              └─YES→ Parallel Ralph + Worktrees</div>

    <h3>Which Model?</h3>
    <table>
        <tr><th>Task</th><th>Model</th></tr>
        <tr><td>Lookups, formatting</td><td>Haiku</td></tr>
        <tr><td>Implementation</td><td>Sonnet</td></tr>
        <tr><td>Architecture, reasoning</td><td>Opus</td></tr>
        <tr><td>Security-critical</td><td>Opus</td></tr>
    </table>

    <h3>Task Sizing</h3>
    <div class="ascii-diagram">Can you describe it in 2-3 sentences?
├─NO→ SPLIT IT
└─YES→ 100-500 lines changed?
     ├─NO (more)→ SPLIT IT
     └─YES→ GOOD SIZE</div>

    <hr>

    <h2>7.3 Cross-Reference Index</h2>
    <table>
        <tr><th>Pattern</th><th>Combines With</th><th>Conflicts With</th></tr>
        <tr><td>Ralph Loop</td><td>Hooks, Playwright, progress.txt</td><td>Long sessions</td></tr>
        <tr><td>CC Mirror</td><td>Hooks, Worktrees</td><td>Gas Town</td></tr>
        <tr><td>Hooks</td><td>Everything</td><td>YOLO mode</td></tr>
        <tr><td>Worktrees</td><td>Ralph, CC Mirror</td><td>Single-branch</td></tr>
        <tr><td>progress.txt</td><td>Ralph, AGENTS.md</td><td>—</td></tr>
        <tr><td>Panopticon</td><td>Domain-specific tools</td><td>Cross-domain work</td></tr>
    </table>

    <hr>

    <h2>7.4 Configuration Quick Reference</h2>

    <h3>Essential prd.json</h3>
    <pre><code>{
  "project": "Name",
  "branchName": "feature/xxx",
  "userStories": [
    {
      "id": "US-001",
      "title": "Task (2-3 sentences)",
      "acceptanceCriteria": ["Verifiable condition", "npm run typecheck passes"],
      "priority": 1,
      "passes": false
    }
  ]
}</code></pre>

    <h3>Essential ralph.sh</h3>
    <pre><code>#!/bin/bash
MAX_ITERATIONS="${1:-25}"
for (( i=1; i<=$MAX_ITERATIONS; i++ )); do
    OUTPUT=$(cat prompt.md | claude --dangerously-skip-permissions)
    if echo "$OUTPUT" | grep -q "&lt;promise&gt;COMPLETE&lt;/promise&gt;"; then
        exit 0
    fi
done</code></pre>

    <hr>

    <h2>7.5 Before Going Autonomous Checklist</h2>

    <div class="checklist">
        <ul>
            <li>Tasks are atomic (2-3 sentences)</li>
            <li>Dependencies ordered by priority</li>
            <li>Acceptance criteria verifiable</li>
            <li>Every story includes "npm run typecheck passes"</li>
            <li>Git branch created</li>
            <li>progress.txt initialized</li>
            <li>Max iterations set</li>
        </ul>
        <p><strong>If any missing: Stay interactive until ready.</strong></p>
    </div>

    <hr>

    <h2>7.6 The Iron Law (Always Remember)</h2>

    <div class="iron-law">
        <h3>THE IRON LAW</h3>
        <p>An agent that ORCHESTRATES must NEVER directly EXECUTE.</p>
        <p>An agent that EXECUTES must NEVER directly ORCHESTRATE.</p>
    </div>

    <hr>

    <h2>Appendix: Source Files</h2>

    <p>This playbook synthesizes these files from the knowledge base:</p>

    <h4>Foundations</h4>
    <ul>
        <li>principles-core.md</li>
        <li>architecture-primitives.md</li>
        <li>principles-anti-patterns.md</li>
    </ul>

    <h4>Mastery</h4>
    <ul>
        <li>mastery-context-management.md</li>
        <li>mastery-ralph-complete.md</li>
        <li>mastery-multi-agent.md</li>
    </ul>

    <h4>Combinations</h4>
    <ul>
        <li>combinations-pairwise.md</li>
        <li>combinations-triple-plus.md</li>
        <li>combinations-unexplored.md</li>
    </ul>

    <h4>Reference</h4>
    <ul>
        <li>grammar-vocabulary.md</li>
        <li>taxonomy-cross-reference.md</li>
        <li>JUDGMENT-GUIDE.md</li>
    </ul>

    <hr>

    <p style="text-align: center; color: var(--accent); font-style: italic;">
        Generated from 39 synthesis files (~1MB) extracted from Claude Code community knowledge.
    </p>

</body>
</html>
