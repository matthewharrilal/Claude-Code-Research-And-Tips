

<!--
═══════════════════════════════════════════════════════════════════════════════
INLINE THREADING HEADER — Phase 2B
File: docs-spa/content/pages/architecture-primitives/content.html
Tier: C | Batch: 13 | Generated: 2026-02-06

1. WHY THIS EXISTS
Rendered HTML content page for the architecture-primitives synthesis document.

3. STATUS
ACTIVE

5. BUILT ON
Extracted from synthesis/architecture-primitives.md by content extraction scripts.

8. CONSUMED BY
docs-spa/app/(docs)/synthesis/architecture-primitives/page.tsx renders this content via dangerouslySetInnerHTML.

═══════════════════════════════════════════════════════════════════════════════
END INLINE THREADING HEADER
═══════════════════════════════════════════════════════════════════════════════
-->
      <!-- Section 1: ESSENCE -->
      <section id="essence" data-activity="essence">
        <div class="essence-box">
          <div class="essence-label">Essence (15 words)</div>
          <div class="essence-text">Primitives are reusable atomic building blocks that compose into Ralph, Gas Town, and CC Mirror.</div>
        </div>

        <p class="text-text-secondary mb-6">
          <strong>You Are Here:</strong> This is the atomic building block catalog - the LEGO bricks that compose all orchestration patterns. Read this first to understand the individual pieces, then see <code>architecture-composition-rules.md</code> for how they combine into complete patterns.
        </p>
      </section>

      <!-- Section 2: CORE ABSTRACTION -->
      <section id="core-abstraction" data-activity="core">
        <h2 class="section-title">
          <span class="section-number">2</span>
          The Core Abstraction
        </h2>

        <div class="core-abstraction">
          <div class="core-philosophy">"Complex patterns emerge from simple primitives in predictable combinations."</div>

          <div class="core-code">
            <button class="copy-btn" onclick="copyCode(this, 'Primitive + Primitive + ... = Pattern')">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <code>Loop + State + Control + Quality Gate = Ralph</code>
          </div>

          <div class="core-anchor">Every agent pattern is a specific combination of these primitives. Master the primitives, master any pattern.</div>
        </div>

        <p class="text-text-secondary mb-6">
          The agent orchestration landscape looks complex: Ralph, Gas Town, CC Mirror, Panopticon, Orchestra. But underneath, they're all built from the same building blocks. Learn to see these primitives and you can:
        </p>

        <ul class="list-disc list-inside text-text-secondary mb-6 space-y-2">
          <li>Understand any new pattern quickly (decompose it)</li>
          <li>Build custom patterns for your needs (compose them)</li>
          <li>Debug failures systematically (trace to primitive)</li>
          <li>Predict behavior at scale (know primitive limits)</li>
        </ul>

        <h3 class="font-semibold text-lg mb-4">The Seven Primitive Categories</h3>

        <table class="primitive-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>What It Does</th>
              <th>Example</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Loop</strong></td>
              <td>Drives iteration cycles</td>
              <td><code>while :; do claude; done</code></td>
            </tr>
            <tr>
              <td><strong>State</strong></td>
              <td>Persists across iterations</td>
              <td><code>prd.json</code>, <code>progress.txt</code></td>
            </tr>
            <tr>
              <td><strong>Control</strong></td>
              <td>Determines when to stop</td>
              <td>Promise/Stop condition</td>
            </tr>
            <tr>
              <td><strong>Quality Gate</strong></td>
              <td>Verifies before marking done</td>
              <td><code>npm run typecheck</code></td>
            </tr>
            <tr>
              <td><strong>Coordination</strong></td>
              <td>Manages multi-agent work</td>
              <td>TaskCreate, Worker Preamble</td>
            </tr>
            <tr>
              <td><strong>Memory</strong></td>
              <td>Cross-iteration learning</td>
              <td>Git, AGENTS.md, filesystem</td>
            </tr>
            <tr>
              <td><strong>Hook</strong></td>
              <td>Intercepts tool execution</td>
              <td>PreToolUse, PostToolUse</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Section 3: PRIMITIVES CATALOG -->
      <section id="loop-primitives" data-activity="primitives">
        <h2 class="section-title">
          <span class="section-number">3</span>
          Primitives Catalog
        </h2>

        <h3 class="font-semibold text-lg mb-4">Loop Primitives</h3>

        <div class="primitive-card">
          <div class="primitive-name">Basic While Loop</div>
          <div class="primitive-description">Infinite loop that continuously spawns fresh Claude sessions with the same prompt. Each iteration gets a fresh context window, no memory between iterations.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="keyword">while</span> :; <span class="keyword">do</span>
  cat prompt.md | claude
<span class="keyword">done</span></pre>
          </div>
          <div class="primitive-properties">
            <div class="primitive-properties-label">Key Properties</div>
            <ul class="text-sm text-text-secondary space-y-1">
              <li>Fresh context per iteration (no memory)</li>
              <li>Runs forever unless externally stopped</li>
              <li>Relies on external state files for memory</li>
            </ul>
          </div>
          <div class="primitive-used-in">Used in: <span>Ralph (basic)</span> <span>Panopticon cron</span></div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">Iteration-Limited Loop</div>
          <div class="primitive-description">Runs a bounded number of iterations with early exit on completion. Prevents runaway costs.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="variable">MAX_ITERATIONS</span>=${1:-10}

<span class="keyword">for</span> (( i=1; i&lt;=$MAX_ITERATIONS; i++ )); <span class="keyword">do</span>
  <span class="keyword">echo</span> <span class="string">"Iteration $i / $MAX_ITERATIONS"</span>

  claude <span class="string">"$PROMPT"</span> | tee output.txt

  <span class="comment"># Check for early exit</span>
  <span class="keyword">if</span> grep -q <span class="string">"COMPLETE"</span> output.txt; <span class="keyword">then</span>
    <span class="keyword">break</span>
  <span class="keyword">fi</span>
<span class="keyword">done</span></pre>
          </div>
          <div class="primitive-properties">
            <div class="primitive-properties-label">Typical Values</div>
            <ul class="text-sm text-text-secondary space-y-1">
              <li>10-25 for feature development</li>
              <li>50+ for large migrations</li>
              <li>Cost scales linearly with iterations</li>
            </ul>
          </div>
          <div class="primitive-used-in">Used in: <span>Ralph (primary)</span> <span>Marathon Ralph</span> <span>Lisa</span></div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">jq-Based Conditional Loop</div>
          <div class="primitive-description">Loops until all tasks in a JSON file are marked as passed. More semantic than grep for completion detection.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="keyword">while</span> jq <span class="string">'.tasks[] | select(.passes == false)'</span> prd.json | grep -q .; <span class="keyword">do</span>
  claude --chrome -p <span class="string">"$PROMPT"</span>
<span class="keyword">done</span></pre>
          </div>
          <div class="primitive-used-in">Source: @maurice_kleine</div>
        </div>

        <!-- State Primitives -->
        <h3 class="font-semibold text-lg mb-4 mt-8" id="state-primitives">State Primitives</h3>

        <div class="primitive-card">
          <div class="primitive-name">progress.txt (Append-Only Log)</div>
          <div class="primitive-description">Markdown file with dated sections. Append-only - never update previous entries. Two sections: "Codebase Patterns" at top (persistent learnings), entries below (per-iteration).</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># Ralph Progress Log</span>
Started: 2026-01-09

<span class="comment">## Codebase Patterns</span>
- Migrations: Use IF NOT EXISTS
- Types: Export from actions.ts

<span class="comment">## Key Files</span>
- db/schema.ts
- app/auth/actions.ts

---

<span class="comment">## 2026-01-09 - US-001</span>
- What was implemented: Login endpoint
- Files changed: src/api/auth.ts
- <span class="keyword">Learnings:</span>
  - bcrypt needs salt rounds of 12
  - JWT expiry should be configurable
---</pre>
          </div>
          <div class="primitive-properties">
            <div class="primitive-properties-label">Key Properties</div>
            <ul class="text-sm text-text-secondary space-y-1">
              <li>Human-readable, Git-tracked</li>
              <li>Cross-iteration memory via append</li>
              <li>Pattern accumulation over time</li>
            </ul>
          </div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">prd.json (Task Status Tracking)</div>
          <div class="primitive-description">JSON file with userStories array. Each story has id, priority, passes boolean, and acceptanceCriteria.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>{
  <span class="string">"project"</span>: <span class="string">"MyApp"</span>,
  <span class="string">"branchName"</span>: <span class="string">"ralph/feature-auth"</span>,
  <span class="string">"userStories"</span>: [
    {
      <span class="string">"id"</span>: <span class="string">"US-001"</span>,
      <span class="string">"title"</span>: <span class="string">"Create login endpoint"</span>,
      <span class="string">"acceptanceCriteria"</span>: [
        <span class="string">"POST /api/auth/login accepts email + password"</span>,
        <span class="string">"Returns JWT on success"</span>,
        <span class="string">"npm run typecheck passes"</span>
      ],
      <span class="string">"priority"</span>: 1,
      <span class="string">"passes"</span>: <span class="keyword">false</span>
    }
  ]
}</pre>
          </div>
          <table class="primitive-table">
            <thead>
              <tr>
                <th>Field</th>
                <th>Purpose</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>branchName</code></td>
                <td>Git branch for this feature set</td>
              </tr>
              <tr>
                <td><code>priority</code></td>
                <td>Lower number = execute first</td>
              </tr>
              <tr>
                <td><code>passes</code></td>
                <td><code>false</code> = needs work, <code>true</code> = complete</td>
              </tr>
              <tr>
                <td><code>blockedBy</code></td>
                <td>Dependencies (optional)</td>
              </tr>
              <tr>
                <td><code>acceptanceCriteria</code></td>
                <td>Verifiable completion conditions</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Control Primitives -->
        <h3 class="font-semibold text-lg mb-4 mt-8" id="control-primitives">Control Primitives</h3>

        <div class="primitive-card">
          <div class="primitive-name">Promise/Stop Condition</div>
          <div class="primitive-description">Unambiguous signal for completion. XML-style tags for reliability. Searched via grep in shell wrapper.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># In prompt:</span>
If ALL stories pass, reply with:
&lt;promise&gt;COMPLETE&lt;/promise&gt;

<span class="comment"># Detection in loop:</span>
<span class="keyword">if</span> grep -q <span class="string">"&lt;promise&gt;COMPLETE&lt;/promise&gt;"</span> output.txt; <span class="keyword">then</span>
  <span class="keyword">echo</span> <span class="string">"All stories complete!"</span>
  <span class="keyword">exit</span> 0
<span class="keyword">fi</span></pre>
          </div>
          <div class="primitive-properties">
            <div class="primitive-properties-label">Variations</div>
            <ul class="text-sm text-text-secondary space-y-1">
              <li><code>PROMISE COMPLETE HERE</code></li>
              <li><code>&lt;complete/&gt;</code></li>
              <li><code>##DONE##</code></li>
            </ul>
          </div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">Story Selection Logic</div>
          <div class="primitive-description">Priority-ordered selection of next task. Single story per iteration to prevent context overload.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment">## Your Task</span>

1. Read `scripts/ralph/prd.json`
2. Read `scripts/ralph/progress.txt` (check Codebase Patterns first)
3. Pick highest priority story where `passes: false`
4. Implement that ONE story
5. Run typecheck and tests
6. Update prd.json: `passes: true`
7. Append learnings to progress.txt</pre>
          </div>
        </div>

        <!-- Quality Gate Primitives -->
        <h3 class="font-semibold text-lg mb-4 mt-8" id="quality-primitives">Quality Gate Primitives</h3>

        <div class="primitive-card">
          <div class="primitive-name">Typecheck Gate</div>
          <div class="primitive-description">Verifies type safety before marking task complete. Always include in acceptance criteria.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>npm run typecheck
<span class="comment"># or</span>
tsc --noEmit
<span class="comment"># or</span>
pnpm typecheck</pre>
          </div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">Test Gate</div>
          <div class="primitive-description">Runs test suite to verify correctness.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>npm test
<span class="comment"># Run only related tests</span>
npm test -- --findRelatedTests $FILE
<span class="comment"># Run with coverage</span>
npm test -- --coverage --coverageThreshold='{"global":{"lines":80}}'</pre>
          </div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">CI Green Gate</div>
          <div class="primitive-description">Every commit must pass all checks. If ANY fail, do NOT mark story as passed.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>Every commit must pass all checks:
1. npm run typecheck
2. npm run test
3. npm run lint

If ANY fail, do NOT mark story as passed.</pre>
          </div>
          <div class="decision-implication" style="margin-top: 16px;">
            <div class="decision-implication-label">Key Insight (Matt Pocock)</div>
            <div class="text-text-secondary text-sm">
              "If you don't do this, you're hamstringing future agent runs with bad code, and they'll need to bisect to find bugs."
            </div>
          </div>
        </div>

        <!-- Coordination Primitives -->
        <h3 class="font-semibold text-lg mb-4 mt-8" id="coordination-primitives">Coordination Primitives</h3>

        <div class="primitive-card">
          <div class="primitive-name">Worker Preamble Template</div>
          <div class="primitive-description">Constrains worker agents to execution only. Prevents recursion. Must be at VERY START of worker prompt.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>CONTEXT: You are a WORKER agent, not an orchestrator.

RULES:
- Complete ONLY the task described below
- Use tools directly (Read, Write, Edit, Bash, etc.)
- Do NOT spawn sub-agents
- Do NOT call TaskCreate or TaskUpdate
- Report your results with absolute file paths

TASK:
[Your specific task here]</pre>
          </div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">Model Selection Matrix</div>
          <div class="primitive-description">Match model capability to task complexity for cost efficiency.</div>
          <table class="primitive-table">
            <thead>
              <tr>
                <th>Model</th>
                <th>Use Case</th>
                <th>Parallel Capacity</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Haiku</strong></td>
                <td>Errand runner: fetch files, grep, simple lookups</td>
                <td>Spawn 5-10 in parallel</td>
              </tr>
              <tr>
                <td><strong>Sonnet</strong></td>
                <td>Capable worker: structured implementation, following patterns</td>
                <td>3-5 parallel</td>
              </tr>
              <tr>
                <td><strong>Opus</strong></td>
                <td>Complex reasoning, architecture decisions, ambiguous tasks</td>
                <td>1-2 (expensive)</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Memory Primitives -->
        <h3 class="font-semibold text-lg mb-4 mt-8" id="memory-primitives">Memory Primitives</h3>

        <div class="primitive-card">
          <div class="primitive-name">Git as Memory</div>
          <div class="primitive-description">Code changes persist across iterations via version control. Immutable history, diff-based understanding.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># Future agent understands context from git history</span>
git log --oneline -10
git diff HEAD~5</pre>
          </div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">Filesystem as Memory (Panopticon)</div>
          <div class="primitive-description">Each domain has isolated directory that persists agent state. Domain isolation prevents cross-contamination.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>~/nox        <span class="comment"># Company/product</span>
~/metrics    <span class="comment"># Analytics/data</span>
~/email      <span class="comment"># Communications</span>
~/growth     <span class="comment"># Marketing/acquisition</span>
~/trades     <span class="comment"># Personal finance/trading</span>
~/health     <span class="comment"># Fitness/sleep/wellness</span>
~/writing    <span class="comment"># Content creation</span>
~/personal   <span class="comment"># Life admin</span></pre>
          </div>
          <div class="primitive-used-in">Used in: <span>Panopticon</span></div>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">CLAUDE.md Hierarchy</div>
          <div class="primitive-description">Layered memory from enterprise policy to local overrides.</div>
          <div class="composition-diagram">
            <pre>Layer 1: Enterprise Policy
  /Library/Application Support/ClaudeCode/CLAUDE.md

Layer 2: Project Memory
  ./CLAUDE.md or ./.claude/CLAUDE.md

Layer 3: Modular Rules
  ./.claude/rules/*.md

Layer 4: Personal + Local
  ~/.claude/CLAUDE.md (user global)
  ./CLAUDE.local.md (project local, gitignored)</pre>
          </div>
        </div>

        <!-- Hook Primitives -->
        <h3 class="font-semibold text-lg mb-4 mt-8" id="hook-primitives">Hook Primitives</h3>

        <div class="primitive-card">
          <div class="primitive-name">Hook Events</div>
          <div class="primitive-description">Lifecycle events you can intercept for automation.</div>
          <table class="primitive-table">
            <thead>
              <tr>
                <th>Event</th>
                <th>Trigger</th>
                <th>Common Use Cases</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>PreToolUse</code></td>
                <td>Before a tool runs</td>
                <td>Validation, notifications, approval gates</td>
              </tr>
              <tr>
                <td><code>PostToolUse</code></td>
                <td>After a tool completes</td>
                <td>Formatting, linting, logging</td>
              </tr>
              <tr>
                <td><code>SessionStart</code></td>
                <td>When session begins</td>
                <td>Context loading, environment setup</td>
              </tr>
              <tr>
                <td><code>SessionEnd</code></td>
                <td>When session ends</td>
                <td>Cleanup, summary generation</td>
              </tr>
              <tr>
                <td><code>Stop</code></td>
                <td>Exit/completion attempts</td>
                <td>Loop continuation (Ralph)</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="primitive-card">
          <div class="primitive-name">Security Gate Hook</div>
          <div class="primitive-description">Blocks dangerous commands. Exit code 0 = allow, non-zero = block.</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment">#!/bin/bash</span>
<span class="comment"># ~/.claude/hooks/security-gate.sh</span>

<span class="variable">COMMAND</span>=$(echo <span class="string">"$EVENT_DATA"</span> | jq -r '.tool_input.command')

<span class="variable">DANGEROUS_PATTERNS</span>=(
    <span class="string">"rm -rf /"</span>
    <span class="string">"git push --force"</span>
    <span class="string">"DROP TABLE"</span>
    <span class="string">"sudo"</span>
)

<span class="keyword">for</span> pattern <span class="keyword">in</span> <span class="string">"${DANGEROUS_PATTERNS[@]}"</span>; <span class="keyword">do</span>
    <span class="keyword">if</span> [[ <span class="string">"$COMMAND"</span> == *<span class="string">"$pattern"</span>* ]]; <span class="keyword">then</span>
        <span class="keyword">echo</span> <span class="string">"BLOCKED: Dangerous command pattern"</span> &gt;&amp;2
        <span class="keyword">exit</span> 1  <span class="comment"># Block the operation</span>
    <span class="keyword">fi</span>
<span class="keyword">done</span>

<span class="keyword">exit</span> 0  <span class="comment"># Allow</span></pre>
          </div>
        </div>
      </section>

      <!-- Section 4: COMPOSITION -->
      <section id="composition" data-activity="composition">
        <h2 class="section-title">
          <span class="section-number">4</span>
          How Primitives Compose
        </h2>

        <p class="text-text-secondary mb-6">
          Every major pattern is a specific composition of these primitives. Understanding composition lets you see the pattern's DNA.
        </p>

        <h3 class="font-semibold text-lg mb-4">Ralph Loop = Basic Composition</h3>

        <div class="composition-diagram">
          <pre>                       RALPH LOOP
+-------------------------------------------------------------+
|                                                             |
|  Iteration-Limited Loop                                     |
|       |                                                     |
|       +-- prd.json (State)                                  |
|       |       +-- Tracks: passes: true/false                |
|       |                                                     |
|       +-- Story Selection Logic                             |
|       |       +-- Pick highest priority where passes==false |
|       |                                                     |
|       +-- Quality Gates                                     |
|       |       +-- Typecheck                                 |
|       |       +-- Tests                                     |
|       |                                                     |
|       +-- progress.txt (Memory)                             |
|       |       +-- Append learnings each iteration           |
|       |                                                     |
|       +-- Git Commit                                        |
|       |       +-- Persist code changes                      |
|       |                                                     |
|       +-- Promise/Stop Condition                            |
|               +-- &lt;promise&gt;COMPLETE&lt;/promise&gt;               |
|                                                             |
+-------------------------------------------------------------+</pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8">CC Mirror = Hub-and-Spoke Composition</h3>

        <div class="composition-diagram">
          <pre>                 CC MIRROR ORCHESTRATION
+-------------------------------------------------------------+
|                                                             |
|  +=====================================================+    |
|  |              ORCHESTRATOR (Conductor)               |    |
|  |  Tools: TaskCreate, TaskUpdate, Task (spawn), Read  |    |
|  |  Role: Decompose, delegate, synthesize              |    |
|  +=====================================================+    |
|                          |                                  |
|         +----------------+----------------+                  |
|         |                |                |                  |
|         v                v                v                  |
|   +----------+    +----------+    +----------+              |
|   | Worker 1 |    | Worker 2 |    | Worker 3 |              |
|   | (Haiku)  |    | (Sonnet) |    | (Opus)   |              |
|   +----------+    +----------+    +----------+              |
|        |                |                |                   |
|        +-- Worker Preamble (prevents recursion) --+          |
|                                                             |
|   Coordination: TaskCreate dependencies (blockedBy/blocks)  |
|   Memory: Native task persistence                           |
|                                                             |
+-------------------------------------------------------------+</pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8">Primitive Composition Matrix</h3>

        <table class="primitive-table">
          <thead>
            <tr>
              <th>Pattern</th>
              <th>Loop</th>
              <th>State</th>
              <th>Control</th>
              <th>Quality</th>
              <th>Coordination</th>
              <th>Memory</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Ralph</strong></td>
              <td>Iteration-Limited</td>
              <td>prd.json + progress.txt</td>
              <td>Promise/Stop</td>
              <td>Typecheck + Tests</td>
              <td>Single-agent</td>
              <td>Git + Files</td>
            </tr>
            <tr>
              <td><strong>CC Mirror</strong></td>
              <td>Event-driven</td>
              <td>TaskCreate native</td>
              <td>Task dependencies</td>
              <td>Per-task gates</td>
              <td>Hub-and-spoke</td>
              <td>Task persistence</td>
            </tr>
            <tr>
              <td><strong>Gas Town</strong></td>
              <td>Continuous</td>
              <td>Beads (Git-backed)</td>
              <td>Role-based</td>
              <td>Dogs (watchdogs)</td>
              <td>Factory model</td>
              <td>MCP Agent Mail</td>
            </tr>
            <tr>
              <td><strong>Panopticon</strong></td>
              <td>Cron-scheduled</td>
              <td>Filesystem</td>
              <td>Domain isolation</td>
              <td>Domain-specific</td>
              <td>File handoffs</td>
              <td>Dir per domain</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Section 5: PATH OF SELECTION -->
      <section id="path" data-activity="path">
        <h2 class="section-title">
          <span class="section-number">5</span>
          Path of Primitive Selection
        </h2>

        <p class="text-text-secondary mb-6">
          Follow this path when building or debugging agent systems:
        </p>

        <div class="path-container">
          <div class="path-step">
            <div class="path-number">1</div>
            <div class="path-content">Identify your <strong>iteration model</strong>: Do you need bounded loops (Ralph), event-driven (CC Mirror), or scheduled (Panopticon)?</div>
          </div>
          <div class="path-step">
            <div class="path-number">2</div>
            <div class="path-content">Choose your <strong>state mechanism</strong>: JSON files for simple, native TaskCreate for multi-agent, filesystem for domain isolation</div>
          </div>
          <div class="path-step">
            <div class="path-number">3</div>
            <div class="path-content">Define your <strong>control mechanism</strong>: How does the system know when to stop? Promise signal? All tasks done? Human intervention?</div>
          </div>
          <div class="path-step">
            <div class="path-number">4</div>
            <div class="path-content">Add <strong>quality gates</strong>: What must pass before marking done? Tests? Typecheck? Visual verification?</div>
          </div>
          <div class="path-step">
            <div class="path-number">5</div>
            <div class="path-content">Design <strong>memory strategy</strong>: How do learnings persist? Append-only log? Git history? AGENTS.md?</div>
          </div>
          <div class="path-step">
            <div class="path-number">6</div>
            <div class="path-content">Add <strong>coordination</strong> if multi-agent: Worker preambles? Model selection? Dependency management?</div>
          </div>
          <div class="path-step">
            <div class="path-number">7</div>
            <div class="path-content">Install <strong>hooks</strong> for automation: Notifications? Formatting? Security gates?</div>
          </div>
          <div class="path-step">
            <div class="path-number">8</div>
            <div class="path-content">Test each primitive in isolation before composing. A broken primitive breaks the whole pattern.</div>
          </div>
        </div>
      </section>

      <!-- Section 6: GOTCHAS -->
      <section id="gotchas" data-activity="gotchas">
        <h2 class="section-title">
          <span class="section-number">6</span>
          Gotchas
        </h2>

        <p class="text-text-secondary mb-6">
          Real problems you'll hit when working with primitives:
        </p>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            progress.txt gets overwritten instead of appended
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> Previous iteration learnings disappear; file contains only latest entry</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Using <code>&gt;</code> (overwrite) instead of <code>&gt;&gt;</code> (append) in shell commands</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Always use <code>&gt;&gt;</code> for progress.txt. CAPS "APPEND" in prompt helps LLM compliance.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            prd.json becomes invalid JSON
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> jq fails to parse; agent can't read task state</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Manual editing introduced syntax errors, or agent output malformed JSON</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Validate with <code>jq . prd.json</code>. Keep backups before each iteration. Use jq for updates instead of manual editing.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Hook doesn't fire
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> Expected automation doesn't run; no notification sent</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Hook configuration in wrong location or incorrect event name</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Verify hook is in correct settings file. Check event name matches exactly. Test script independently. Ensure execute permissions.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Completion signal not detected
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> Loop runs indefinitely even though agent outputs completion signal</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Signal format mismatch or grep not searching correct file</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Verify exact signal format matches between prompt and grep. Ensure output is captured to the file grep is searching.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Worker preamble ignored
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> Worker behaves like orchestrator; spawns subagents; uses wrong tools</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Preamble placed after task description or too weak</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Place preamble at the VERY START of worker prompt. Use explicit prohibition language with "CANNOT", "MUST".</div>
        </div>
      </section>

      <!-- Section 7: WHAT'S HARD -->
      <section id="hard" data-activity="hard">
        <h2 class="section-title">
          <span class="section-number">7</span>
          What's Hard
        </h2>

        <p class="text-text-secondary mb-6">
          These are fundamental tensions in primitive design:
        </p>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Primitive Granularity
          </div>
          <div class="hard-detail"><strong>The tension:</strong> More granular primitives are more composable but harder to understand in isolation. Less granular primitives are easier to use but less flexible.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Too granular - boilerplate explosion. Too coarse - can't customize for edge cases.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Start with coarse primitives (copy whole Ralph loop). Decompose only when you need to customize specific parts.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            State Synchronization
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Multiple state files (prd.json, progress.txt, git) can get out of sync. No transactional guarantees.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Task marked done in prd.json but code not committed. Learnings in progress.txt but task failed.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Order operations carefully: code change -&gt; test -&gt; commit -&gt; update prd.json -&gt; append progress. Always update prd.json LAST.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Composition Debugging
          </div>
          <div class="hard-detail"><strong>The tension:</strong> When a composed pattern fails, hard to know which primitive caused it. Failures cascade.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> "It just doesn't work" - can't isolate problem. Fixes in one primitive break another.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Test primitives in isolation first. Add logging at primitive boundaries. Build incrementally, not all at once.</div>
        </div>
      </section>

      <!-- Section 8: WHEN TO USE -->
      <section id="when" data-activity="when">
        <h2 class="section-title">
          <span class="section-number">8</span>
          Primitive Selection Guide
        </h2>

        <h3 class="font-semibold text-lg mb-4">For overnight feature development:</h3>
        <ul class="list-disc list-inside text-text-secondary mb-6 space-y-2">
          <li><strong>Loop:</strong> Iteration-Limited (prevent runaway costs)</li>
          <li><strong>State:</strong> prd.json + progress.txt</li>
          <li><strong>Control:</strong> Promise/Stop condition</li>
          <li><strong>Quality:</strong> Typecheck + Tests mandatory</li>
        </ul>

        <h3 class="font-semibold text-lg mb-4">For parallel life automation:</h3>
        <ul class="list-disc list-inside text-text-secondary mb-6 space-y-2">
          <li><strong>Loop:</strong> Cron scheduling</li>
          <li><strong>State:</strong> Filesystem per domain</li>
          <li><strong>Control:</strong> Domain isolation</li>
          <li><strong>Communication:</strong> File-based handoffs</li>
        </ul>

        <h3 class="font-semibold text-lg mb-4">For complex multi-agent work:</h3>
        <ul class="list-disc list-inside text-text-secondary mb-6 space-y-2">
          <li><strong>Coordination:</strong> TaskCreate with dependencies</li>
          <li><strong>Preambles:</strong> Worker Preamble mandatory</li>
          <li><strong>Model:</strong> Model Selection Matrix</li>
          <li><strong>Memory:</strong> Native task persistence</li>
        </ul>

        <h3 class="font-semibold text-lg mb-4">For safe autonomous operation:</h3>
        <ul class="list-disc list-inside text-text-secondary mb-6 space-y-2">
          <li><strong>Hooks:</strong> Security Gate hooks</li>
          <li><strong>Isolation:</strong> Docker containers</li>
          <li><strong>Limits:</strong> Max Iteration Guard</li>
          <li><strong>Recovery:</strong> Checkpoint state</li>
        </ul>

        <div class="when-grid">
          <div class="when-use">
            <div class="when-title">
              <i data-lucide="check" class="w-5 h-5"></i>
              GOOD FIT FOR PRIMITIVES
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Building custom patterns for unique workflows</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Debugging why an existing pattern fails</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Understanding tradeoffs between patterns</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Teaching others how agent systems work</span>
            </div>
          </div>

          <div class="when-not">
            <div class="when-title">
              <i data-lucide="x" class="w-5 h-5"></i>
              JUST COPY A PATTERN
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Standard feature development (just use Ralph)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>First-time agent user (start with proven patterns)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Time pressure (compose later, ship now)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Team adoption (consistency over customization)</span>
            </div>
          </div>
        </div>
      </section>

    