<!--
═══════════════════════════════════════════════════════════════════════════════
INLINE THREADING HEADER — Phase 2B
File: docs-spa/content/pages/mastery-context-management/content.html
Tier: C | Batch: 12 | Generated: 2026-02-06

1. WHY THIS EXISTS
Rendered HTML content page for the mastery-context-management synthesis document.

3. STATUS
ACTIVE

5. BUILT ON
Extracted from synthesis/mastery-context-management.md by content extraction scripts.

8. CONSUMED BY
docs-spa/app/(docs)/synthesis/mastery-context-management/page.tsx renders this content via dangerouslySetInnerHTML.

═══════════════════════════════════════════════════════════════════════════════
END INLINE THREADING HEADER
═══════════════════════════════════════════════════════════════════════════════
-->

      <!-- Section 1: ESSENCE -->
      <section id="essence" data-activity="essence">
        <div class="essence-box">
          <div class="essence-label">Essence (15 words)</div>
          <div class="essence-text">Context is finite. Fresh context beats extended sessions. External state beats internal memory.</div>
        </div>
      </section>

      <!-- Section 2: CORE ABSTRACTION + IMPLEMENTATION -->
      <section id="core-abstraction" data-activity="core">
        <h2 class="section-title">
          <span class="section-number">2</span>
          The Core Abstraction
        </h2>

        <div class="core-abstraction">
          <div class="core-philosophy">"The agent remembers nothing. The filesystem remembers everything."</div>

          <div class="core-code">
            <button class="copy-btn" onclick="copyCode(this, 'CLAUDE.md + prd.json + progress.txt + git = persistent memory')">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <code>CLAUDE.md + prd.json + progress.txt + git = persistent memory</code>
          </div>

          <div class="core-anchor">This is the complete memory architecture. Claude is stateless; files are the state.</div>
        </div>

        <p class="text-text-secondary mb-6">
          Every optimization pattern in Claude Code ultimately addresses the same fundamental limitation: <strong>context window exhaustion</strong>. Claude's context window (~200K tokens, ~100K effective for quality work) is a hard ceiling that shapes every workflow decision.
        </p>

        <div id="context-rot">
          <h3 class="font-semibold text-lg mb-4">Context Rot: The Brutal Reality</h3>

          <blockquote class="border-l-4 border-accent pl-4 italic text-text-secondary mb-6">
            "Context rot: LLMs get stupider with more tokens"<br>
            <span class="text-sm">-- @mattpocockuk</span>
          </blockquote>

          <table class="context-table">
            <thead>
              <tr>
                <th>Context Level</th>
                <th>Quality Impact</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>0-50%</td>
                <td>Full capability</td>
              </tr>
              <tr>
                <td>50-70%</td>
                <td class="warning">Slight degradation possible</td>
              </tr>
              <tr>
                <td>70-85%</td>
                <td class="danger">Noticeable quality loss</td>
              </tr>
              <tr>
                <td>85-95%</td>
                <td class="danger">Significant degradation, instructions forgotten</td>
              </tr>
              <tr>
                <td>95%+</td>
                <td class="critical">Failure mode - hallucinations, contradictions, amnesia</td>
              </tr>
            </tbody>
          </table>

          <h4 class="font-semibold mb-3">What Context Rot Looks Like</h4>
          <ol class="list-decimal list-inside text-text-secondary mb-6 space-y-2">
            <li><strong>Repetition</strong> - Claude starts repeating earlier statements</li>
            <li><strong>Amnesia</strong> - Forgets work done 10 minutes ago</li>
            <li><strong>Instruction Drift</strong> - CLAUDE.md directives ignored</li>
            <li><strong>Truncation</strong> - Code cut off mid-function</li>
            <li><strong>Hallucination</strong> - References files that don't exist</li>
            <li><strong>False Completion</strong> - Marks tasks done without verification</li>
          </ol>
        </div>
      </section>

      <!-- Section 3: DESIGN DECISIONS -->
      <section id="why-fresh-context" data-activity="decisions">
        <h2 class="section-title">
          <span class="section-number">3</span>
          Design Decisions
        </h2>

        <div class="decision-box">
          <div class="decision-why">WHY FRESH CONTEXT?</div>
          <div class="decision-reasoning">
            At 80K tokens, Claude's quality degrades. Instructions get lost. The model contradicts itself. This is "context rot" - a fundamental limitation of transformer attention mechanisms, not a bug to fix.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              <strong>Kill and restart.</strong> Don't try to extend sessions. Each iteration spawns a NEW Claude instance with NO memory of previous work. Continuity comes from: Git history, prd.json, progress.txt. If iteration 20 produces worse code than iteration 5, your context is rotting. The fix is to restart, not debug.
            </div>
          </div>
        </div>

        <div class="decision-box" id="why-external-state">
          <div class="decision-why">WHY EXTERNAL STATE?</div>
          <div class="decision-reasoning">
            If each iteration is a fresh Claude with no memory, how does progress persist? Through files. Git commits, prd.json (task tracking), progress.txt (learnings). The filesystem IS the memory. Memory is external. The agent is stateless. This isn't a bug - it's the architecture that enables reliability.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              Never rely on "Claude remembering" something. <strong>If it's not in a file, it doesn't exist.</strong> progress.txt must be append-only. prd.json must be updated after each task. Every learning must be persisted to be useful.
            </div>
          </div>
        </div>

        <div class="decision-box" id="why-files">
          <div class="decision-why">WHY FILES OVER IN-CONTEXT MEMORY?</div>
          <div class="decision-reasoning">
            Files don't degrade. Files don't get summarized lossy. Files can be queried with <code>jq</code>. Files survive session crashes. Files can be version controlled. In-context memory gets compressed, summarized, forgotten, contradicted.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              Every piece of critical state belongs in one of three places: CLAUDE.md (project context), prd.json (task state), or progress.txt (learnings). If you're tempted to "tell Claude something to remember," write it to a file instead.
            </div>
          </div>
        </div>
      </section>

      <!-- Section 4: THE 5 STRATEGIES -->
      <section id="strategies" data-activity="strategies">
        <h2 class="section-title">
          <span class="section-number">4</span>
          The 5 Context Management Strategies
        </h2>

        <div class="strategy-card" id="strategy-fresh">
          <div class="strategy-header">
            <div class="strategy-number">1</div>
            <div class="strategy-title">Fresh Context Per Iteration</div>
          </div>
          <div class="strategy-description">
            Spawn a new agent instance for each task. No memory pollution. Clean slate always. This is the Ralph pattern's core insight.
          </div>

          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment">#!/bin/bash</span>
<span class="keyword">set</span> -e
MAX_ITERATIONS=<span class="variable">${1:-25}</span>

<span class="keyword">for</span> (( i=1; i&lt;=$MAX_ITERATIONS; i++ )); <span class="keyword">do</span>
  <span class="keyword">echo</span> <span class="string">"Iteration $i / $MAX_ITERATIONS"</span>

  claude <span class="string">"Review plans/prd.json and progress.txt.
    Pick ONE task with passes: false.
    Implement it. Run tests.
    If passing, mark passes: true and commit.
    Append learnings to progress.txt.
    If ALL tasks complete, output: &lt;promise&gt;COMPLETE&lt;/promise&gt;"</span> | tee output.txt

  <span class="keyword">if</span> grep -q <span class="string">"&lt;promise&gt;COMPLETE&lt;/promise&gt;"</span> output.txt; <span class="keyword">then</span>
    <span class="keyword">echo</span> <span class="string">"All tasks complete!"</span>
    <span class="keyword">break</span>
  <span class="keyword">fi</span>
<span class="keyword">done</span></pre>
          </div>

          <div class="checkpoint-box">
            <div class="checkpoint-title">
              <i data-lucide="check-circle" class="w-4 h-4"></i>
              Key Rules
            </div>
            <div class="checkpoint-content">
              <ul class="list-disc list-inside space-y-1">
                <li>Set <code>max-iterations</code> as safety limit (never infinite)</li>
                <li>Size tasks to complete in ONE iteration</li>
                <li>Use <code>&lt;promise&gt;COMPLETE&lt;/promise&gt;</code> as termination signal</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="strategy-card" id="strategy-files">
          <div class="strategy-header">
            <div class="strategy-number">2</div>
            <div class="strategy-title">File-Based External State</div>
          </div>
          <div class="strategy-description">
            Store ALL state in files. The agent reconstructs context by reading, not by remembering.
          </div>

          <h4 class="font-semibold mb-3">The Three Core Files</h4>

          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># progress.txt - Append-Only Learning Log</span>
<span class="comment"># Purpose: Memory across iterations. Notes for "the next agent."</span>

---

## Iteration 1 (2026-01-09 10:00)
- <span class="keyword">Completed:</span> US-001 - Database schema created
- <span class="keyword">Learned:</span> Use .optional() with Zod for nullable fields
- <span class="keyword">Blocker:</span> None
- <span class="keyword">Next:</span> US-002 priority

---

## Iteration 2 (2026-01-09 10:15)
- <span class="keyword">Completed:</span> US-002 - API endpoint
- <span class="keyword">Learned:</span> Rate limiting needs 60s cooldown
- <span class="keyword">Issue:</span> Had to adjust Zod schema
- <span class="keyword">Pattern discovered:</span> Always test edge cases first</pre>
          </div>

          <div class="gotcha-box">
            <div class="gotcha-title">
              <i data-lucide="alert-triangle" class="w-4 h-4"></i>
              Critical Rule: APPEND ONLY
            </div>
            <div class="gotcha-detail">
              Never edit previous entries in progress.txt. Each iteration adds to history; none modify it.
            </div>
          </div>

          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment">// prd.json - Task State Tracking</span>
<span class="comment">// Purpose: Machine-readable task board with explicit pass/fail status</span>
{
  <span class="string">"project"</span>: <span class="string">"MyFeature"</span>,
  <span class="string">"branchName"</span>: <span class="string">"feature/user-auth"</span>,
  <span class="string">"userStories"</span>: [
    {
      <span class="string">"id"</span>: <span class="string">"US-001"</span>,
      <span class="string">"title"</span>: <span class="string">"Add users table with email and password_hash"</span>,
      <span class="string">"acceptanceCriteria"</span>: [
        <span class="string">"Column 'email' exists with unique constraint"</span>,
        <span class="string">"Column 'password_hash' is not null"</span>,
        <span class="string">"npm run typecheck passes"</span>
      ],
      <span class="string">"priority"</span>: <span class="number">1</span>,
      <span class="string">"passes"</span>: <span class="keyword">true</span>,
      <span class="string">"notes"</span>: <span class="string">"Completed iteration 1"</span>
    },
    {
      <span class="string">"id"</span>: <span class="string">"US-002"</span>,
      <span class="string">"title"</span>: <span class="string">"Create login endpoint"</span>,
      <span class="string">"acceptanceCriteria"</span>: [
        <span class="string">"POST /api/auth/login returns JWT on valid credentials"</span>,
        <span class="string">"Returns 401 on invalid credentials"</span>,
        <span class="string">"npm run test passes"</span>
      ],
      <span class="string">"priority"</span>: <span class="number">2</span>,
      <span class="string">"passes"</span>: <span class="keyword">false</span>
    }
  ]
}</pre>
          </div>

          <p class="text-text-secondary text-sm mb-4">
            <strong>Why JSON over Markdown:</strong> Deterministic parsing, explicit <code>passes: true/false</code> state, can be queried with <code>jq</code>, less ambiguous for LLM updates.
          </p>
        </div>

        <div class="strategy-card" id="strategy-git">
          <div class="strategy-header">
            <div class="strategy-number">3</div>
            <div class="strategy-title">Git as Memory</div>
          </div>
          <div class="strategy-description">
            Git history is the ultimate external memory. Code changes persist across agent resets.
          </div>

          <h4 class="font-semibold mb-3">What Git Provides</h4>
          <ol class="list-decimal list-inside text-text-secondary mb-6 space-y-2">
            <li><strong>Commits as Checkpoints</strong> - Each iteration's work is preserved</li>
            <li><strong>Diff as Context</strong> - Agent can read what changed</li>
            <li><strong>History as Narrative</strong> - Sequence of changes tells the story</li>
            <li><strong>Rollback as Safety</strong> - Bad changes can be reverted</li>
          </ol>

          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># Git Worktrees for Parallel Agents</span>
<span class="comment"># When running multiple agents simultaneously:</span>

<span class="comment"># Create isolated worktrees</span>
git worktree add ../wt-backend feature/backend
git worktree add ../wt-frontend feature/frontend

<span class="comment"># Run parallel Ralph loops</span>
(cd ../wt-backend &amp;&amp; ./ralph.sh 20) &amp;
(cd ../wt-frontend &amp;&amp; ./ralph.sh 20) &amp;
wait

<span class="comment"># Merge results</span>
git merge wt-backend wt-frontend</pre>
          </div>

          <p class="text-text-secondary text-sm">
            <strong>Benefits:</strong> True isolation (no file conflicts), shared git history, can run on separate machines.
          </p>
        </div>

        <div class="strategy-card" id="strategy-external">
          <div class="strategy-header">
            <div class="strategy-number">4</div>
            <div class="strategy-title">External Memory Systems</div>
          </div>
          <div class="strategy-description">
            Database-backed persistent memory that outlives individual sessions. For long-term projects with compound learning.
          </div>

          <h4 class="font-semibold mb-3">Claude-Mem: Semantic Memory Plugin</h4>

          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># Installation</span>
/plugin marketplace add thedotmack/claude-mem
/plugin install claude-mem
<span class="comment"># Restart Claude Code</span>

<span class="comment"># Configuration (~/.claude-mem/settings.json)</span>
{
  <span class="string">"ai_model"</span>: <span class="string">"claude-3-opus-20240229"</span>,
  <span class="string">"context_injection_rules"</span>: {
    <span class="string">"auto_inject"</span>: <span class="keyword">true</span>,
    <span class="string">"max_tokens"</span>: <span class="number">5000</span>
  }
}</pre>
          </div>

          <p class="text-text-secondary text-sm mb-4">
            <strong>How It Works:</strong> Lifecycle hooks log all session events to SQLite. Agent-SDK generates semantic summaries (~50-100 tokens per session). 3-layer retrieval system (search, timeline, full details). Auto-inject relevant context into new sessions.
          </p>

          <table class="context-table">
            <thead>
              <tr>
                <th>When External Memory Helps</th>
                <th>When External Memory Hurts</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Long-term projects (compound learning)</td>
                <td>Fresh start needed (stale injection)</td>
              </tr>
              <tr>
                <td>Repetitive patterns ("I've done this before")</td>
                <td>Changed codebase (outdated patterns)</td>
              </tr>
              <tr>
                <td>Complex debugging (remember attempts)</td>
                <td>Different project (cross-contamination)</td>
              </tr>
              <tr>
                <td>Team knowledge (shared learnings)</td>
                <td>Token budget tight (injection costs)</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="strategy-card" id="strategy-compaction">
          <div class="strategy-header">
            <div class="strategy-number">5</div>
            <div class="strategy-title">Compaction and Optimization</div>
          </div>
          <div class="strategy-description">
            Strategically compress context to extend working capacity. Use sparingly - compaction is lossy.
          </div>

          <h4 class="font-semibold mb-3">When Compaction Helps</h4>
          <ul class="list-disc list-inside text-text-secondary mb-4 space-y-1">
            <li><strong>Approaching 60-70% context</strong> - Preemptive cleanup</li>
            <li><strong>Exploratory work</strong> - After browsing many files</li>
            <li><strong>Debugging sessions</strong> - Error messages accumulate</li>
            <li><strong>Long conversations</strong> - Before quality degrades</li>
          </ul>

          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># Compaction Commands</span>
/compact              <span class="comment"># Compress current context</span>
/reset                <span class="comment"># Full reset (last resort)</span></pre>
          </div>

          <div class="hard-box">
            <div class="hard-title">
              <i data-lucide="flame" class="w-4 h-4"></i>
              Compaction is LOSSY
            </div>
            <div class="hard-detail">
              Details get summarized. Instructions may be lost. Prefer fresh context via Ralph loops over repeated compaction.
            </div>
          </div>

          <h4 class="font-semibold mb-3 mt-6">Subagent Token Isolation</h4>
          <blockquote class="border-l-4 border-accent pl-4 italic text-text-secondary mb-4">
            "Put costly tools like browser control in subagents to protect your main context window tokens"<br>
            <span class="text-sm">-- @TendiesOfWisdom</span>
          </blockquote>

          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># Main agent stays lean</span>
main_agent.delegate(
    task=<span class="string">"Test login flow in browser"</span>,
    subagent=<span class="string">"playwright-worker"</span>,
    return_summary_only=<span class="keyword">True</span>  <span class="comment"># Don't bring full output back</span>
)</pre>
          </div>

          <p class="text-text-secondary text-sm">
            <strong>Key insight:</strong> Subagents have their own context window. Only their summary returns to main context.
          </p>
        </div>
      </section>

      <!-- Section 5: DECISION FLOW -->
      <section id="decision-tree" data-activity="path">
        <h2 class="section-title">
          <span class="section-number">5</span>
          Decision Flow
        </h2>

        <p class="text-text-secondary mb-6">
          Follow this tree to select the right context management strategy:
        </p>

        <div class="path-container">
          <div class="path-step">
            <div class="path-number">1</div>
            <div class="path-content"><strong>START:</strong> "I need to work on X with Claude Code"</div>
          </div>
          <div class="path-step">
            <div class="path-number">2</div>
            <div class="path-content">Is X a single, small task (&lt; 30 min)?<br>
              <span class="text-accent">YES</span> -&gt; Single session, no special context management<br>
              <span class="text-red-500">NO</span> -&gt; Continue
            </div>
          </div>
          <div class="path-step">
            <div class="path-number">3</div>
            <div class="path-content">Will X span multiple sessions?<br>
              <span class="text-accent">YES</span> -&gt; Use file-based state (prd.json + progress.txt)<br>
              <span class="text-red-500">NO</span> -&gt; Consider fresh context per iteration anyway
            </div>
          </div>
          <div class="path-step">
            <div class="path-number">4</div>
            <div class="path-content">Is X truly long-running (hours/overnight)?<br>
              <span class="text-accent">YES</span> -&gt; Full Ralph loop with external state<br>
              <span class="text-red-500">NO</span> -&gt; May not need automation
            </div>
          </div>
          <div class="path-step">
            <div class="path-number">5</div>
            <div class="path-content">Do I need to run multiple agents in parallel?<br>
              <span class="text-accent">YES</span> -&gt; Git worktrees + parallel Ralph loops<br>
              <span class="text-red-500">NO</span> -&gt; Single agent workflow
            </div>
          </div>
          <div class="path-step">
            <div class="path-number">6</div>
            <div class="path-content">Does this project have long-term knowledge to preserve?<br>
              <span class="text-accent">YES</span> -&gt; Consider Claude-Mem or structured archives<br>
              <span class="text-red-500">NO</span> -&gt; Fresh context patterns sufficient
            </div>
          </div>
          <div class="path-step">
            <div class="path-number">7</div>
            <div class="path-content"><strong>END:</strong> Select appropriate strategy</div>
          </div>
        </div>

        <div class="budget-box" id="context-budget">
          <div class="budget-title">
            <i data-lucide="calculator" class="w-4 h-4"></i>
            Recommended Context Budget (~100K Effective)
          </div>
          <div class="budget-item">
            <span class="budget-label">System prompt + CLAUDE.md</span>
            <span class="budget-value">~5K (5%)</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Codebase context</span>
            <span class="budget-value">~20K (20%)</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Current task</span>
            <span class="budget-value">~2K (2%)</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Working memory</span>
            <span class="budget-value">~30K (30%)</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Tool outputs</span>
            <span class="budget-value">~20K (20%)</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Code generation</span>
            <span class="budget-value">~15K (15%)</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Buffer for retries</span>
            <span class="budget-value">~8K (8%)</span>
          </div>
        </div>

        <h4 class="font-semibold mb-3">Per-Activity Token Estimates</h4>
        <table class="context-table">
          <thead>
            <tr>
              <th>Activity</th>
              <th>Tokens</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Read file (50 lines)</td>
              <td>~1K</td>
            </tr>
            <tr>
              <td>Git diff (small)</td>
              <td>~500</td>
            </tr>
            <tr>
              <td>Test output</td>
              <td>~2K</td>
            </tr>
            <tr>
              <td>Error message</td>
              <td>~500</td>
            </tr>
            <tr>
              <td>MCP tool call</td>
              <td>~1K overhead</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Section 6: GOTCHAS -->
      <section id="gotchas" data-activity="gotchas">
        <h2 class="section-title">
          <span class="section-number">6</span>
          Gotchas
        </h2>

        <p class="text-text-secondary mb-6">
          Real problems you'll hit, with concrete numbers and fixes:
        </p>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            progress.txt growing unbounded
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> After ~50 iterations, Claude spends more tokens reading than thinking</div>
          <div class="gotcha-detail"><strong>Threshold:</strong> &gt;20KB progress.txt starts degrading quality</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Truncate to last 10 entries between runs. Move permanent learnings to AGENTS.md.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            "APPEND" gets ignored
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> progress.txt keeps getting overwritten, losing learnings</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Model interprets "update" as "replace"</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Use "APPEND" in CAPS in prompt.md. The capitalization matters.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            prd.json in inconsistent state
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> Tasks marked done that aren't, passes field not updating</div>
          <div class="gotcha-detail"><strong>Cause:</strong> JSON parsing/writing issues, or agent confusion</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Validate with <code>jq . plans/prd.json</code>, fix manually, or regenerate from git history.</div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Git history not being used as context
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> Agent doesn't know what was already done, repeats work</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Not instructed to read git history</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Add to prompt: "Before starting: 1. Run git log --oneline -10. 2. Run git diff HEAD~3. 3. Don't repeat already-completed work."</div>
        </div>

        <div id="warning-signs">
          <h3 class="font-semibold text-lg mb-4 mt-8">Context Rot Warning Signs</h3>
          <table class="context-table">
            <thead>
              <tr>
                <th>Sign</th>
                <th>Severity</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Repeating earlier statements</td>
                <td class="warning">Medium</td>
                <td>Monitor closely</td>
              </tr>
              <tr>
                <td>Instructions ignored</td>
                <td class="danger">High</td>
                <td>Compact or reset</td>
              </tr>
              <tr>
                <td>Forgetting recent changes</td>
                <td class="danger">High</td>
                <td>Start fresh session</td>
              </tr>
              <tr>
                <td>Contradictory responses</td>
                <td class="critical">Critical</td>
                <td>Reset immediately</td>
              </tr>
              <tr>
                <td>Hallucinated files</td>
                <td class="critical">Critical</td>
                <td>Reset + verify state</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Section 7: WHAT'S HARD -->
      <section id="hard" data-activity="hard">
        <h2 class="section-title">
          <span class="section-number">7</span>
          What's Hard
        </h2>

        <p class="text-text-secondary mb-6">
          These are fundamental tensions, not bugs to fix:
        </p>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Context Rot vs. Memory Loss
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Fresh context avoids rot but loses learnings. progress.txt helps but grows unbounded. No perfect solution exists.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Quality drops in late iterations (rot), OR early iterations repeat mistakes from archived runs (memory loss).</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Keep progress.txt under 20KB. Start fresh runs from AGENTS.md (permanent), not progress.txt (session). Accept that some re-learning is the cost of fresh context.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            The 200K/100K Gap
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Claude has 200K token context window, but quality degrades significantly after 100K. You have half the context you think you have.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> "I thought I had plenty of room" followed by quality collapse.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Budget for 100K effective. Monitor usage with Claude HUD. Plan compaction or session restart at 60-70%.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Compaction Information Loss
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Compaction frees tokens but loses detail. You can't predict what will be lost.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> After /compact, Claude missing key information you expected it to remember.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Before compacting, externalize important state to files. Prefer fresh context over compaction when possible.</div>
        </div>

        <div class="philosophy-stack">
          <div class="philosophy-item">
            <div class="philosophy-level">Foundation</div>
            <div class="philosophy-text">Stateless Agent, Stateful Environment - The agent remembers nothing. The filesystem remembers everything.</div>
          </div>
          <div class="philosophy-item">
            <div class="philosophy-level">Architecture</div>
            <div class="philosophy-text">External Memory Over Internal - Git history &gt; conversation history. Files &gt; context window. Commits &gt; compaction.</div>
          </div>
          <div class="philosophy-item">
            <div class="philosophy-level">Operation</div>
            <div class="philosophy-text">Fresh Context Over Extended Sessions - New instances &gt; long conversations. Clean slate &gt; accumulated pollution.</div>
          </div>
          <div class="philosophy-item">
            <div class="philosophy-level">Protection</div>
            <div class="philosophy-text">Monitor and Reset - Track context usage. Compact before degradation. Reset when compromised.</div>
          </div>
        </div>
      </section>

      <!-- Section 8: WHEN TO USE -->
      <section id="when" data-activity="when">
        <h2 class="section-title">
          <span class="section-number">8</span>
          When to Use Each Strategy
        </h2>

        <div class="when-grid">
          <div class="when-use">
            <div class="when-title">
              <i data-lucide="check" class="w-5 h-5"></i>
              USE FRESH CONTEXT WHEN
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Long-running autonomous work (hours/overnight)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Quality must remain consistent across many tasks</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Tasks can be sized to fit one context window</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>You have verifiable acceptance criteria</span>
            </div>
          </div>

          <div class="when-not">
            <div class="when-title">
              <i data-lucide="x" class="w-5 h-5"></i>
              USE SINGLE SESSION WHEN
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Quick task (&lt;30 minutes)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Exploratory debugging (need context of attempts)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Interactive collaboration (human in tight loop)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Tasks that don't decompose well</span>
            </div>
          </div>
        </div>

        <div id="tradeoffs">
          <h3 class="font-semibold text-lg mb-4">Tradeoff Matrix</h3>
          <table class="context-table">
            <thead>
              <tr>
                <th>Strategy</th>
                <th>Freshness</th>
                <th>Continuity</th>
                <th>Complexity</th>
                <th>Best For</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Single Session</strong></td>
                <td>High</td>
                <td>None</td>
                <td>Low</td>
                <td>Quick tasks</td>
              </tr>
              <tr>
                <td><strong>Fresh Context / Ralph</strong></td>
                <td>High</td>
                <td>Via files</td>
                <td>Medium</td>
                <td>Features, long work</td>
              </tr>
              <tr>
                <td><strong>File-Based State</strong></td>
                <td>High</td>
                <td>High</td>
                <td>Medium</td>
                <td>Multi-session projects</td>
              </tr>
              <tr>
                <td><strong>Git as Memory</strong></td>
                <td>High</td>
                <td>High</td>
                <td>Low</td>
                <td>All projects</td>
              </tr>
              <tr>
                <td><strong>Claude-Mem</strong></td>
                <td>Medium</td>
                <td>Very High</td>
                <td>High</td>
                <td>Long-term projects</td>
              </tr>
              <tr>
                <td><strong>Compaction</strong></td>
                <td>Medium</td>
                <td>Medium</td>
                <td>Low</td>
                <td>Session extension</td>
              </tr>
              <tr>
                <td><strong>Subagent Delegation</strong></td>
                <td>High</td>
                <td>N/A</td>
                <td>High</td>
                <td>Expensive operations</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="checkpoint-box mt-8">
          <div class="checkpoint-title">
            <i data-lucide="book-open" class="w-4 h-4"></i>
            The 10 Context Management Commandments
          </div>
          <div class="checkpoint-content">
            <ol class="list-decimal list-inside space-y-2">
              <li><strong>Context is finite.</strong> Treat it like a precious resource.</li>
              <li><strong>Fresh &gt; Extended.</strong> New instances beat long sessions.</li>
              <li><strong>Files &gt; Memory.</strong> External state beats internal context.</li>
              <li><strong>Git is your friend.</strong> Commits are checkpoints.</li>
              <li><strong>Size tasks small.</strong> One iteration, one task.</li>
              <li><strong>Monitor always.</strong> Know your context usage.</li>
              <li><strong>Compact early.</strong> 60-70%, not 90%.</li>
              <li><strong>Verify everything.</strong> Tests catch context-rot errors.</li>
              <li><strong>Subagents isolate.</strong> Expensive ops in their own context.</li>
              <li><strong>Archive and learn.</strong> Yesterday's runs teach tomorrow's.</li>
            </ol>
          </div>
        </div>
      </section>

    