
<!--
═══════════════════════════════════════════════════════════════════════════════
INLINE THREADING HEADER — Phase 2B
File: docs-spa/content/pages/grammar-syntax/content.html
Tier: C | Batch: 12 | Generated: 2026-02-06

1. WHY THIS EXISTS
Rendered HTML content page for the grammar-syntax synthesis document.

3. STATUS
ACTIVE

5. BUILT ON
Extracted from synthesis/grammar-syntax.md by content extraction scripts.

8. CONSUMED BY
docs-spa/app/(docs)/synthesis/grammar-syntax/page.tsx renders this content via dangerouslySetInnerHTML.

═══════════════════════════════════════════════════════════════════════════════
END INLINE THREADING HEADER
═══════════════════════════════════════════════════════════════════════════════
-->

      <!-- Section 1: ESSENCE -->
      <section id="essence" data-activity="essence">
        <div class="essence-box">
          <div class="essence-label">Essence (15 words)</div>
          <div class="essence-text">A formal grammar for composing agentic patterns. Valid syntax prevents runtime failures.</div>
        </div>
      </section>

      <!-- Section 2: CORE ABSTRACTION + IMPLEMENTATION -->
      <section id="core-abstraction" data-activity="core">
        <h2 class="section-title">
          <span class="section-number">2</span>
          The Core Abstraction
        </h2>

        <div class="core-abstraction">
          <div class="core-philosophy">"Grammar defines how primitives combine. If it compiles, it runs."</div>

          <div class="core-code">
            <button class="copy-btn" onclick="copyCode(this, 'pattern ::= primitive | sequential | parallel | nested | conditional | loop')">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <code>pattern ::= primitive | sequential | parallel | nested | conditional | loop</code>
          </div>

          <div class="core-anchor">Every valid agent system is a composition of these six forms.</div>
        </div>

        <p class="text-text-secondary mb-6">
          Think of <code>grammar-vocabulary.md</code> as the dictionary (what words mean) and this document as the grammar rules (how to form sentences). If you combine primitives wrong, you get a syntax error that manifests as a runtime failure.
        </p>

        <h3 class="font-semibold text-lg mb-4 mt-8">The Six Composition Operators</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre><span class="comment"># Sequential: A completes, then B starts with A's output</span>
Task <span class="operator">→</span> Test <span class="operator">→</span> Commit

<span class="comment"># Parallel: A and B execute simultaneously, independently</span>
Worker1 <span class="operator">||</span> Worker2 <span class="operator">||</span> Worker3

<span class="comment"># Nested: B operates within A's context/lifecycle</span>
Ralph <span class="operator">⊃</span> (Task <span class="operator">→</span> Test <span class="operator">→</span> Commit)

<span class="comment"># Conditional: Branch based on predicate</span>
passes<span class="operator">?</span> <span class="operator">→</span> next <span class="operator">:</span> retry

<span class="comment"># Loop: Repeat until termination condition</span>
<span class="keyword">while</span> has_tasks: (fetch <span class="operator">→</span> execute <span class="operator">→</span> verify)

<span class="comment"># Fork-Join: Split, execute parallel, merge</span>
<span class="symbol">⋔</span>(worker1 <span class="operator">||</span> worker2) <span class="operator">→</span> <span class="symbol">⋀</span>(merge_results)</pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="operator-reference">Operator Quick Reference</h3>

        <table class="operator-table">
          <thead>
            <tr>
              <th>Operator</th>
              <th>Symbol</th>
              <th>Meaning</th>
              <th>Key Constraint</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Sequential</td>
              <td><code>→</code></td>
              <td>A then B</td>
              <td>A must complete successfully</td>
            </tr>
            <tr>
              <td>Parallel</td>
              <td><code>||</code></td>
              <td>A and B concurrently</td>
              <td>Must be independent</td>
            </tr>
            <tr>
              <td>Nested</td>
              <td><code>⊃</code></td>
              <td>A contains B</td>
              <td>B lifecycle within A lifecycle</td>
            </tr>
            <tr>
              <td>Conditional</td>
              <td><code>?:</code></td>
              <td>If X then A else B</td>
              <td>Exactly one branch executes</td>
            </tr>
            <tr>
              <td>Loop</td>
              <td><code>while</code></td>
              <td>Repeat until condition</td>
              <td>Must terminate</td>
            </tr>
            <tr>
              <td>Fork-Join</td>
              <td><code>⋔⋀</code></td>
              <td>Split and merge</td>
              <td>Defined merge strategy</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Section 3: DESIGN DECISIONS -->
      <section id="why-formal-grammar" data-activity="decisions">
        <h2 class="section-title">
          <span class="section-number">3</span>
          Design Decisions
        </h2>

        <div class="decision-box">
          <div class="decision-why">WHY FORMAL GRAMMAR?</div>
          <div class="decision-reasoning">
            Ad-hoc agent compositions fail at runtime in unpredictable ways. A formal grammar catches invalid compositions at design time. If your pattern doesn't fit the grammar, it either needs refactoring or the grammar needs extension.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              Before implementing, express your design in composition operators. If you can't, you have a hidden complexity that will manifest as bugs. The grammar is a design validation tool.
            </div>
          </div>
        </div>

        <div class="decision-box" id="why-role-separation">
          <div class="decision-why">WHY STRICT ROLE SEPARATION?</div>
          <div class="decision-reasoning">
            Orchestrators coordinate; workers execute. Mixing these roles creates "God Workers" that accumulate context, lose track of goals, and produce unreliable results. Role confusion is the #1 source of multi-agent failures.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              If an orchestrator is using tools directly, it's doing the worker's job. If a worker is spawning sub-workers, it's doing the orchestrator's job. Violations cascade into system-wide failures.
            </div>
          </div>
        </div>

        <div class="decision-box" id="why-explicit-state">
          <div class="decision-why">WHY EXPLICIT STATE?</div>
          <div class="decision-reasoning">
            Implicit state (memory in context) degrades with tokens. Explicit state (files, databases) persists across restarts. The grammar requires state to be explicitly passed, not implicitly assumed.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              Every pattern must show where state lives. Sequential chains must show context passing. Parallel workers must show isolation mechanism (worktrees). If state isn't visible, it's probably wrong.
            </div>
          </div>
        </div>
      </section>

      <!-- Section 4: VALID COMPOSITIONS (File Structure equivalent) -->
      <section id="valid-compositions" data-activity="files">
        <h2 class="section-title">
          <span class="section-number">4</span>
          Valid Compositions
        </h2>

        <p class="text-text-secondary mb-6">
          These five composition patterns are known to work. Use them as building blocks.
        </p>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="check-circle" class="w-5 h-5 text-accent"></i>
            Pattern 1: Loop + State + Quality
          </div>
          <div class="template-description">Autonomous execution with quality gates (Ralph Core)</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="keyword">while</span> has_tasks:
    task = get_next(state)
    result = execute(task)
    <span class="keyword">if</span> quality_gate(result):
        commit(result)
        update_state(task, DONE)
    <span class="keyword">else</span>:
        update_state(task, FAILED)
        log_failure(result)
    <span class="keyword">if</span> all_complete(state):
        <span class="keyword">break</span></pre>
          </div>
        </div>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="check-circle" class="w-5 h-5 text-accent"></i>
            Pattern 2: Orchestrator + Workers + Coordination
          </div>
          <div class="template-description">Delegated parallel execution (CC Mirror)</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># Orchestrator</span>
tasks = decompose(objective)
<span class="keyword">for</span> task <span class="keyword">in</span> tasks:
    create_subagent(task)

<span class="comment"># Workers (parallel)</span>
workers <span class="operator">||</span> workers <span class="operator">||</span> workers:
    receive(task)
    execute_in_worktree()
    report_completion()

<span class="comment"># Orchestrator</span>
<span class="keyword">await</span> all_complete
merge_results()</pre>
          </div>
        </div>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="check-circle" class="w-5 h-5 text-accent"></i>
            Pattern 3: Nested Loops with Escalation
          </div>
          <div class="template-description">Retry with bounded attempts and human fallback</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="keyword">for</span> task <span class="keyword">in</span> tasks:                    <span class="comment"># Outer: task iteration</span>
    attempts = 0
    <span class="keyword">while</span> attempts &lt; MAX_RETRY:       <span class="comment"># Inner: retry loop</span>
        result = execute(task)
        <span class="keyword">if</span> success(result):
            commit(result)
            <span class="keyword">break</span>
        attempts += 1
        <span class="keyword">if</span> attempts == MAX_RETRY:
            escalate_to_human(task)</pre>
          </div>
        </div>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="check-circle" class="w-5 h-5 text-accent"></i>
            Pattern 4: Conditional Branching with Recovery
          </div>
          <div class="template-description">Graceful degradation with multiple outcomes</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>result = execute(task)
<span class="keyword">if</span> passes_quality_gate(result):
    commit(result)
    proceed_to_next()
<span class="keyword">elif</span> is_recoverable(result.error):
    fix = generate_fix(result.error)
    retry_with(task, fix)
<span class="keyword">else</span>:
    quarantine(task)
    notify_human()
    skip_to_next()</pre>
          </div>
        </div>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="check-circle" class="w-5 h-5 text-accent"></i>
            Pattern 5: Fork-Join Parallel Execution
          </div>
          <div class="template-description">Worktree isolation with sequential merge</div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="symbol">⋔</span> create_worktrees(n=3)
    <span class="operator">||</span> execute_task_a(worktree_1)
    <span class="operator">||</span> execute_task_b(worktree_2)
    <span class="operator">||</span> execute_task_c(worktree_3)
<span class="symbol">⋀</span> merge_all_worktrees()</pre>
          </div>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="templates">Pattern Templates</h3>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="file-code" class="w-5 h-5 text-accent"></i>
            Template 1: Ralph Core (Autonomous Loop)
          </div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>initialize_state(source=PRD)

<span class="keyword">while</span> <span class="keyword">not</span> terminated:
    <span class="comment"># Phase 1: Selection</span>
    task = get_next_task(state, priority=highest_ready)
    <span class="keyword">if</span> task <span class="keyword">is</span> None:
        <span class="keyword">if</span> all_complete(state):
            exit(SUCCESS)
        <span class="keyword">else</span>:
            wait_or_request_unblock()
            <span class="keyword">continue</span>

    <span class="comment"># Phase 2: Execution</span>
    mark_in_progress(task)
    result = execute(task)

    <span class="comment"># Phase 3: Verification</span>
    <span class="keyword">if</span> quality_gate(result):
        commit(result)
        mark_complete(task)
        update_dependencies(task)
    <span class="keyword">else</span>:
        mark_failed(task, result.errors)
        <span class="keyword">if</span> retriable(task):
            schedule_retry(task)
        <span class="keyword">else</span>:
            escalate(task)

    <span class="comment"># Phase 4: Continuation</span>
    persist_state()</pre>
          </div>
        </div>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="file-code" class="w-5 h-5 text-accent"></i>
            Template 2: CC Mirror (Parallel Workers)
          </div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="comment"># Orchestrator</span>
objective = parse_input()
tasks = decompose(objective)
worktrees = create_worktrees(count=len(tasks))

<span class="keyword">for</span> task, worktree <span class="keyword">in</span> zip(tasks, worktrees):
    spawn_worker(task, worktree)

<span class="keyword">while</span> <span class="keyword">not</span> all_complete(workers):
    completed = await_any(workers)
    validate_result(completed)

merge_worktrees(worktrees, strategy=sequential)
cleanup_worktrees()
report_completion()

<span class="comment"># Worker (runs in each worktree)</span>
task = receive()
checkout_branch(task.branch)
execute(task)
commit(task.result)
signal_complete()</pre>
          </div>
        </div>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="file-code" class="w-5 h-5 text-accent"></i>
            Template 3: Retry with Exponential Backoff
          </div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>MAX_ATTEMPTS = 3
BASE_DELAY = 1

<span class="keyword">for</span> attempt <span class="keyword">in</span> range(MAX_ATTEMPTS):
    result = execute(task)

    <span class="keyword">if</span> success(result):
        <span class="keyword">return</span> result

    <span class="keyword">if</span> <span class="keyword">not</span> retriable(result.error):
        <span class="keyword">raise</span> UnrecoverableError(result)

    <span class="keyword">if</span> attempt &lt; MAX_ATTEMPTS - 1:
        delay = BASE_DELAY * (2 ** attempt)
        wait(delay)
        task = refine(task, result.error)

escalate(task, all_attempts=results)</pre>
          </div>
        </div>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="file-code" class="w-5 h-5 text-accent"></i>
            Template 4: State Machine Execution
          </div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre>states = {PENDING, IN_PROGRESS, BLOCKED, DONE, FAILED}
transitions = {
    PENDING: [IN_PROGRESS, BLOCKED],
    IN_PROGRESS: [DONE, FAILED, BLOCKED],
    BLOCKED: [PENDING],  <span class="comment"># After unblock</span>
    DONE: [],            <span class="comment"># Terminal</span>
    FAILED: [PENDING]    <span class="comment"># After retry decision</span>
}

<span class="keyword">def</span> transition(task, new_state):
    <span class="keyword">if</span> new_state <span class="keyword">not</span> <span class="keyword">in</span> transitions[task.state]:
        <span class="keyword">raise</span> InvalidTransition(task.state, new_state)
    task.state = new_state
    persist(task)

<span class="keyword">def</span> execute_state_machine(task):
    transition(task, IN_PROGRESS)
    result = execute(task)
    <span class="keyword">if</span> success(result):
        transition(task, DONE)
    <span class="keyword">elif</span> blocked(result):
        transition(task, BLOCKED)
        notify_blocker(task.blocker)
    <span class="keyword">else</span>:
        transition(task, FAILED)
        handle_failure(task)</pre>
          </div>
        </div>

        <div class="template-box">
          <div class="template-title">
            <i data-lucide="file-code" class="w-5 h-5 text-accent"></i>
            Template 5: Hierarchical Decomposition
          </div>
          <div class="code-block">
            <button class="copy-btn" onclick="copyCodeBlock(this)">
              <i data-lucide="copy" class="w-3 h-3"></i>
              Copy
            </button>
            <pre><span class="keyword">def</span> execute_hierarchical(objective, depth=0, max_depth=3):
    <span class="keyword">if</span> depth &gt;= max_depth:
        <span class="keyword">return</span> execute_atomic(objective)

    <span class="keyword">if</span> is_atomic(objective):
        <span class="keyword">return</span> execute_atomic(objective)

    subtasks = decompose(objective)
    results = []

    <span class="keyword">for</span> subtask <span class="keyword">in</span> subtasks:
        result = execute_hierarchical(subtask, depth+1, max_depth)
        results.append(result)

        <span class="keyword">if</span> <span class="keyword">not</span> success(result):
            <span class="comment"># Decide: continue, retry, or abort</span>
            <span class="keyword">if</span> critical(subtask):
                abort(objective, failed_at=subtask)

    <span class="keyword">return</span> aggregate(results)</pre>
          </div>
        </div>
      </section>

      <!-- Section 5: PATH OF VALIDATION -->
      <section id="path" data-activity="path">
        <h2 class="section-title">
          <span class="section-number">5</span>
          Syntax Validation Checklist
        </h2>

        <p class="text-text-secondary mb-6">
          Use this checklist to verify your pattern composition is syntactically valid before implementation.
        </p>

        <div class="checklist">
          <div class="checklist-title">
            <i data-lucide="shield-check" class="w-5 h-5 text-accent"></i>
            Role Separation
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-1">
            <label for="check-1">Orchestrators only coordinate (no tool use)</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-2">
            <label for="check-2">Workers only execute (no task creation)</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-3">
            <label for="check-3">Clear handoff points between roles</label>
          </div>
        </div>

        <div class="checklist">
          <div class="checklist-title">
            <i data-lucide="database" class="w-5 h-5 text-accent"></i>
            State Management
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-4">
            <label for="check-4">State is explicitly defined and persisted</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-5">
            <label for="check-5">State transitions are valid (use state machine)</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-6">
            <label for="check-6">Parallel workers have isolated state (worktrees)</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-7">
            <label for="check-7">Shared state only modified at sync points</label>
          </div>
        </div>

        <div class="checklist">
          <div class="checklist-title">
            <i data-lucide="repeat" class="w-5 h-5 text-accent"></i>
            Loop Integrity
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-8">
            <label for="check-8">Every loop has a termination condition</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-9">
            <label for="check-9">Termination is reachable (not infinitely blocked)</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-10">
            <label for="check-10">Progress is made each iteration</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-11">
            <label for="check-11">State is persisted across iterations (resume capability)</label>
          </div>
        </div>

        <div class="checklist">
          <div class="checklist-title">
            <i data-lucide="git-fork" class="w-5 h-5 text-accent"></i>
            Parallel Safety
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-12">
            <label for="check-12">Parallel units are independent</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-13">
            <label for="check-13">No shared mutable state during parallel execution</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-14">
            <label for="check-14">Clear fork and join points</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-15">
            <label for="check-15">Merge strategy defined for joining</label>
          </div>
        </div>

        <div class="checklist">
          <div class="checklist-title">
            <i data-lucide="shield" class="w-5 h-5 text-accent"></i>
            Quality Gates
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-16">
            <label for="check-16">Gates precede irreversible actions</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-17">
            <label for="check-17">Clear pass/fail criteria</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-18">
            <label for="check-18">Failure paths defined</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="check-19">
            <label for="check-19">No commits before verification</label>
          </div>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="formal-grammar">Formal Grammar (EBNF)</h3>

        <div class="grammar-box">
          <pre><span class="nonterminal">pattern</span>     <span class="punctuation">::=</span> <span class="nonterminal">primitive</span> <span class="punctuation">|</span> <span class="nonterminal">composition</span>
<span class="nonterminal">primitive</span>   <span class="punctuation">::=</span> <span class="terminal">task</span> <span class="punctuation">|</span> <span class="terminal">state</span> <span class="punctuation">|</span> <span class="terminal">quality_gate</span> <span class="punctuation">|</span> <span class="terminal">human_checkpoint</span>
<span class="nonterminal">composition</span> <span class="punctuation">::=</span> <span class="nonterminal">sequential</span> <span class="punctuation">|</span> <span class="nonterminal">parallel</span> <span class="punctuation">|</span> <span class="nonterminal">nested</span> <span class="punctuation">|</span> <span class="nonterminal">conditional</span> <span class="punctuation">|</span> <span class="nonterminal">loop</span>

<span class="nonterminal">sequential</span>  <span class="punctuation">::=</span> <span class="nonterminal">pattern</span> <span class="terminal">'→'</span> <span class="nonterminal">pattern</span>
<span class="nonterminal">parallel</span>    <span class="punctuation">::=</span> <span class="nonterminal">pattern</span> <span class="terminal">'||'</span> <span class="nonterminal">pattern</span>
<span class="nonterminal">nested</span>      <span class="punctuation">::=</span> <span class="nonterminal">pattern</span> <span class="terminal">'⊃'</span> <span class="terminal">'('</span> <span class="nonterminal">pattern</span> <span class="terminal">')'</span>
<span class="nonterminal">conditional</span> <span class="punctuation">::=</span> <span class="nonterminal">predicate</span> <span class="terminal">'?'</span> <span class="nonterminal">pattern</span> <span class="terminal">':'</span> <span class="nonterminal">pattern</span>
<span class="nonterminal">loop</span>        <span class="punctuation">::=</span> <span class="terminal">'while'</span> <span class="nonterminal">predicate</span> <span class="terminal">':'</span> <span class="nonterminal">pattern</span>
              <span class="punctuation">|</span> <span class="terminal">'for'</span> <span class="nonterminal">iterator</span> <span class="terminal">':'</span> <span class="nonterminal">pattern</span>

<span class="nonterminal">predicate</span>   <span class="punctuation">::=</span> <span class="nonterminal">quality_check</span> <span class="punctuation">|</span> <span class="nonterminal">state_check</span> <span class="punctuation">|</span> <span class="nonterminal">completion_check</span>
<span class="nonterminal">quality_check</span>    <span class="punctuation">::=</span> <span class="terminal">'passes('</span> <span class="nonterminal">result</span> <span class="terminal">')'</span>
<span class="nonterminal">state_check</span>      <span class="punctuation">::=</span> <span class="terminal">'has_tasks('</span> <span class="nonterminal">state</span> <span class="terminal">')'</span> <span class="punctuation">|</span> <span class="terminal">'all_complete('</span> <span class="nonterminal">state</span> <span class="terminal">')'</span>
<span class="nonterminal">completion_check</span> <span class="punctuation">::=</span> <span class="terminal">'done'</span> <span class="punctuation">|</span> <span class="terminal">'timeout'</span> <span class="punctuation">|</span> <span class="terminal">'interrupted'</span>

<span class="nonterminal">fork_join</span>   <span class="punctuation">::=</span> <span class="terminal">'⋔'</span> <span class="nonterminal">parallel_group</span> <span class="terminal">'→'</span> <span class="terminal">'⋀'</span> <span class="nonterminal">merge_strategy</span>
<span class="nonterminal">parallel_group</span> <span class="punctuation">::=</span> <span class="nonterminal">pattern</span> <span class="punctuation">(</span><span class="terminal">'||'</span> <span class="nonterminal">pattern</span><span class="punctuation">)*</span>
<span class="nonterminal">merge_strategy</span> <span class="punctuation">::=</span> <span class="terminal">'sequential'</span> <span class="punctuation">|</span> <span class="terminal">'octopus'</span> <span class="punctuation">|</span> <span class="terminal">'resolve_conflicts'</span></pre>
        </div>
      </section>

      <!-- Section 6: SYNTAX ERRORS (GOTCHAS) -->
      <section id="gotchas" data-activity="gotchas">
        <h2 class="section-title">
          <span class="section-number">6</span>
          Invalid Compositions (Syntax Errors)
        </h2>

        <p class="text-text-secondary mb-6">
          These patterns compile but fail at runtime. If your design matches any of these, refactor before implementing.
        </p>

        <div class="error-box">
          <div class="error-title">
            <i data-lucide="x-circle" class="w-4 h-4"></i>
            Error 1: Worker ⊃ TaskCreate
          </div>
          <div class="error-content">
            <strong>Invalid:</strong> Worker spawning sub-workers<br><br>
            <code style="background: #18181b; color: #ef4444; padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0;">worker: tasks = decompose(objective); spawn_subworker(t)</code>
            <br>
            <strong>Why Invalid:</strong> Workers execute single tasks; they don't decompose or coordinate. Coordination is the orchestrator's role.
          </div>
          <div class="error-fix">
            <div class="error-fix-label">Fix</div>
            <div class="text-sm text-text-secondary">Split: orchestrator decomposes and assigns; worker receives and executes.</div>
          </div>
        </div>

        <div class="error-box">
          <div class="error-title">
            <i data-lucide="x-circle" class="w-4 h-4"></i>
            Error 2: Orchestrator + Direct Tool Use
          </div>
          <div class="error-content">
            <strong>Invalid:</strong> Orchestrator using tools directly<br><br>
            <code style="background: #18181b; color: #ef4444; padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0;">orchestrator: code = write_code(); tests = run_tests()</code>
            <br>
            <strong>Why Invalid:</strong> Orchestrators coordinate and delegate; they don't use tools directly. This conflates orchestration with execution.
          </div>
          <div class="error-fix">
            <div class="error-fix-label">Fix</div>
            <div class="text-sm text-text-secondary">Orchestrator creates plan, assigns to worker, awaits completion.</div>
          </div>
        </div>

        <div class="error-box">
          <div class="error-title">
            <i data-lucide="x-circle" class="w-4 h-4"></i>
            Error 3: Parallel with Shared Mutable State
          </div>
          <div class="error-content">
            <strong>Invalid:</strong> Parallel workers modifying same state<br><br>
            <code style="background: #18181b; color: #ef4444; padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0;">shared_state = {}; || worker1: shared_state['a'] = x; || worker2: shared_state['b'] = y</code>
            <br>
            <strong>Why Invalid:</strong> Race conditions and undefined behavior. Parallel execution requires isolation.
          </div>
          <div class="error-fix">
            <div class="error-fix-label">Fix</div>
            <div class="text-sm text-text-secondary">Each worker returns isolated result; merge at join point.</div>
          </div>
        </div>

        <div class="error-box">
          <div class="error-title">
            <i data-lucide="x-circle" class="w-4 h-4"></i>
            Error 4: Loop Without Termination
          </div>
          <div class="error-content">
            <strong>Invalid:</strong> Infinite loop with no exit condition<br><br>
            <code style="background: #18181b; color: #ef4444; padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0;">while True: task = get_next(); execute(task)  # No exit!</code>
            <br>
            <strong>Why Invalid:</strong> Infinite loops exhaust resources and never complete. Burns API costs forever.
          </div>
          <div class="error-fix">
            <div class="error-fix-label">Fix</div>
            <div class="text-sm text-text-secondary">Add termination: <code>while has_tasks(state)</code> + <code>if all_complete(state): break</code></div>
          </div>
        </div>

        <div class="error-box">
          <div class="error-title">
            <i data-lucide="x-circle" class="w-4 h-4"></i>
            Error 5: Sequential with No Context Passing
          </div>
          <div class="error-content">
            <strong>Invalid:</strong> Sequential chain with no data flow<br><br>
            <code style="background: #18181b; color: #ef4444; padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0;">task_a → task_b → task_c  # No output flows between them</code>
            <br>
            <strong>Why Invalid:</strong> Sequential composition implies data flow. Without it, there's no reason for ordering.
          </div>
          <div class="error-fix">
            <div class="error-fix-label">Fix</div>
            <div class="text-sm text-text-secondary">Either pass context: <code>result_b = task_b(context=result_a)</code>, or use parallel if truly independent.</div>
          </div>
        </div>

        <div class="error-box">
          <div class="error-title">
            <i data-lucide="x-circle" class="w-4 h-4"></i>
            Error 6: Nested Without Lifecycle Respect
          </div>
          <div class="error-content">
            <strong>Invalid:</strong> Inner pattern outlives outer<br><br>
            <code style="background: #18181b; color: #ef4444; padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0;">outer: { inner: long_running_task() } # outer exits before inner completes</code>
            <br>
            <strong>Why Invalid:</strong> Orphaned inner processes create undefined state. Inner patterns must complete within outer's lifecycle.
          </div>
          <div class="error-fix">
            <div class="error-fix-label">Fix</div>
            <div class="text-sm text-text-secondary">Add explicit synchronization: <code>await inner.complete</code></div>
          </div>
        </div>

        <div class="error-box">
          <div class="error-title">
            <i data-lucide="x-circle" class="w-4 h-4"></i>
            Error 7: Quality Gate After Commit
          </div>
          <div class="error-content">
            <strong>Invalid:</strong> Checking quality after irreversible action<br><br>
            <code style="background: #18181b; color: #ef4444; padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0;">execute(task); commit(result); if quality_gate(result): proceed()  # Too late!</code>
            <br>
            <strong>Why Invalid:</strong> Quality gates must precede irreversible actions. Checking after commit is pointless.
          </div>
          <div class="error-fix">
            <div class="error-fix-label">Fix</div>
            <div class="text-sm text-text-secondary">Reorder: <code>if quality_gate(result): commit(result)</code></div>
          </div>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="antipatterns">Anti-Pattern Reference</h3>

        <table class="antipattern-table">
          <thead>
            <tr>
              <th>Anti-Pattern</th>
              <th>Symptom</th>
              <th>Resolution</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>God Worker</td>
              <td>Worker does coordination</td>
              <td>Split into orchestrator + worker</td>
            </tr>
            <tr>
              <td>Phantom State</td>
              <td>State not persisted</td>
              <td>Add explicit persistence</td>
            </tr>
            <tr>
              <td>Runaway Loop</td>
              <td>Never terminates</td>
              <td>Add termination condition</td>
            </tr>
            <tr>
              <td>Race Condition</td>
              <td>Parallel + shared state</td>
              <td>Isolate with worktrees</td>
            </tr>
            <tr>
              <td>Late Gate</td>
              <td>Quality check after commit</td>
              <td>Move gate before commit</td>
            </tr>
            <tr>
              <td>Orphan Process</td>
              <td>Inner outlives outer</td>
              <td>Await inner completion</td>
            </tr>
            <tr>
              <td>Silent Failure</td>
              <td>Error swallowed</td>
              <td>Add error handling path</td>
            </tr>
            <tr>
              <td>Infinite Retry</td>
              <td>Unbounded retry loop</td>
              <td>Add max attempts</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Section 7: WHAT'S HARD -->
      <section id="hard" data-activity="hard">
        <h2 class="section-title">
          <span class="section-number">7</span>
          What's Hard
        </h2>

        <p class="text-text-secondary mb-6">
          These are fundamental tensions in pattern composition, not bugs to fix.
        </p>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Pattern Expressibility vs. Grammar Constraints
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Some valid patterns don't fit the grammar. Either the pattern needs refactoring, or the grammar needs extension. There's no formula for knowing which.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Your design feels right but can't be expressed in composition operators. Or it can be expressed but the expression is awkward.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Start with template patterns. If your design deviates significantly, question whether the deviation is essential or accidental complexity.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Isolation vs. Coordination Overhead
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Parallel execution requires isolation (worktrees, separate contexts). But isolation creates merge overhead and coordination complexity.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Merge conflicts at join points. Workers stepping on each other's changes. Coordination messages dominating execution time.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Choose tasks that are naturally isolated (different files, different modules). Accept that some parallelism isn't worth the merge cost.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Termination Detection
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Loops must terminate, but "completion" is often subjective. When is a task "done"? When tests pass? When the human approves?</div>
          <div class="hard-detail"><strong>Symptoms:</strong> Loops that run forever because "done" is ambiguous. Or loops that exit too early because the termination condition is too shallow.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Make termination conditions explicit and verifiable. "All tests pass" is verifiable. "Code is good" is not.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            State Explosion in Complex Compositions
          </div>
          <div class="hard-detail"><strong>The tension:</strong> As compositions grow, state management grows exponentially. Nested loops with conditionals create combinatorial state spaces.</div>
          <div class="hard-detail"><strong>Symptoms:</strong> State machine becomes too complex to reason about. Edge cases multiply. Recovery paths become impossible to test.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Keep compositions shallow. Three levels of nesting is usually the maximum manageable. Flatten aggressively.</div>
        </div>
      </section>

      <!-- Section 8: WHEN TO USE -->
      <section id="when" data-activity="when">
        <h2 class="section-title">
          <span class="section-number">8</span>
          When to Use / When Not
        </h2>

        <div class="when-grid">
          <div class="when-use">
            <div class="when-title">
              <i data-lucide="check" class="w-5 h-5"></i>
              USE THIS GRAMMAR WHEN
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Designing multi-agent systems (need composition rules)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Building autonomous loops (need termination guarantees)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Debugging pattern failures (check against syntax rules)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Communicating designs to others (shared vocabulary)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Validating before implementation (catch errors early)</span>
            </div>
          </div>

          <div class="when-not">
            <div class="when-title">
              <i data-lucide="x" class="w-5 h-5"></i>
              DON'T USE THIS GRAMMAR WHEN
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Simple single-agent tasks (overhead not worth it)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Exploratory work (grammar is for known patterns)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>One-off scripts (grammar is for repeatable patterns)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Real-time systems (grammar assumes batch processing)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Novel patterns not yet understood (grammar codifies known-good)</span>
            </div>
          </div>
        </div>
      </section>

    