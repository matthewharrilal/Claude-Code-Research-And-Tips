<!-- ═══════════════════════════════════════════════════════════════════════
     INLINE THREADING HEADER — Phase 2B
     File: docs-spa/app/showcase/explorations/density/DD-004-layers.html
     Tier: A | Batch: 3 | Generated: 2026-02-06
     ═══════════════════════════════════════════════════════════════════════

1. WHY THIS EXISTS

   DD-004-layers.html is the fourth density exploration, implementing
   the GEOLOGICAL pattern — layered information strata that provide
   distinct expert and novice reading paths through the same content.
   It is the widest-research-base file in the DD series, grounded in
   6 R3 findings including 3 rated EXEMPLARY. It receives lessons from
   DD-003 (stronger inter-element connections, visible callouts) and
   feeds lessons forward to DD-005 (visual system at top, multiple
   usage paths). It scored 35/40 with 100% soul compliance.

2. WHAT IT IMPLEMENTS

   | Aspect               | Implementation                              |
   |----------------------|---------------------------------------------|
   | Pattern              | GEOLOGICAL (layered information strata)     |
   | Score                | 35/40                                       |
   | Soul compliance      | 100% — all 5 locked token families          |
   | Lines                | 1099 (longest DD file)                      |
   | Lesson chain in      | DD-003 "Stronger inter-element connections,  |
   |                      | visible callouts"                            |
   | Lesson chain out     | DD-005 "Visual system at top, multiple       |
   |                      | usage paths"                                 |
   | Finding generated    | DD-F-004 (GEOLOGICAL pattern)               |
   | Research base        | 6 R3 findings (3 EXEMPLARY)                 |

3. IDENTITY CARD

   | Field               | Value                                        |
   |---------------------|----------------------------------------------|
   | Canonical name      | DD-004-layers.html                           |
   | Pattern             | GEOLOGICAL                                   |
   | Tier                | A (validated, INCLUDE)                       |
   | Score               | 35/40                                        |
   | Finding ID          | DD-F-004                                     |
   | Lines               | 1099                                         |
   | Blast radius        | MEDIUM (~5-7 inbound references)             |
   | Soul compliance     | 100%                                         |
   | Thread status       | YES / no gaps                                |

4. SOUL TOKENS — LOCKED VALUES (verify against file)

   These tokens appear in the :root block starting at line 18:

   | Token               | Value               | Line   | Status  |
   |---------------------|---------------------|--------|---------|
   | --color-primary     | #E83025             | 20     | LOCKED  |
   | --color-background  | #FEF9F5             | 21     | LOCKED  |
   | --color-text        | #1A1A1A             | 22     | LOCKED  |
   | --font-display      | 'Instrument Serif'  | 28     | LOCKED  |
   | --font-body         | 'Inter'             | 29     | LOCKED  |
   | --font-mono         | 'JetBrains Mono'    | 30     | LOCKED  |
   | --border-radius     | 0                   | 33     | LOCKED  |
   | --box-shadow        | none                | 34     | LOCKED  |

   Source of truth: DESIGN-TOKEN-SUMMARY.md

5. BUILT ON (provenance chain)

   | Source                       | Role                          | Key Values                                           |
   |------------------------------|-------------------------------|------------------------------------------------------|
   | R3-010                       | Research finding               | Geological Model — layered information strata        |
   | R3-012                       | Research finding               | Density variation techniques                         |
   | R3-024                       | Research finding               | Content-appropriate density mapping                  |
   | R3-044                       | Research finding (EXEMPLARY)   | Highest-rated density research                       |
   | R3-045                       | Research finding (EXEMPLARY)   | Highest-rated density research                       |
   | R3-046                       | Research finding (EXEMPLARY)   | Highest-rated density research                       |
   | DD-003-islands.html          | Predecessor (lesson chain)     | "Stronger inter-element connections,                 |
   |                              |                                | visible callouts"                                    |
   | DESIGN-TOKEN-SUMMARY.md      | Locked token source            | Complete :root block (lines 18-58)                   |

6. MUST HONOR (constraints)

   - DD-003 LESSONS: CSS comment at line 16 cites "Stronger inter-
     element connections, visible callouts" — these must be visibly
     implemented in the artifact.
   - SOUL COMPLIANCE: All 5 token families locked (colors, typography,
     geometry, spacing, accents). border-radius: 0, box-shadow: none.
   - GEOLOGICAL LAYERING: Content must present distinct information
     strata for different audience levels (expert vs novice paths).
   - LESSON CHAIN FORWARD: DD-004 lessons feed DD-005 — the outgoing
     lesson is "Visual system at top, multiple usage paths."
   - 3 EXEMPLARY FINDINGS: R3-044, R3-045, R3-046 must be visibly
     implemented in the artifact.
   - DESIGN-TOKEN-SUMMARY.md: The :root block must match exactly.

7. THREADING MAP

   ┌─────────────────────────────────────────────────────────────┐
   │                   INCOMING THREADS                          │
   ├─────────────────────────────────────────────────────────────┤
   │ DESIGN-TOKEN-SUMMARY.md ──────────→ :root block (L18-58)   │
   │ R3-010, R3-012, R3-024 ──────────→ pattern foundations     │
   │ R3-044, R3-045, R3-046 ──────────→ EXEMPLARY techniques    │
   │ DD-003-islands.html ─────────────→ lesson chain (L16 CSS)  │
   ├─────────────────────────────────────────────────────────────┤
   │                   OUTGOING THREADS                          │
   ├─────────────────────────────────────────────────────────────┤
   │ DD-F-004 ────────────→ DD-outbound-findings.md             │
   │ GEOLOGICAL 35/40 ────→ density-patterns.md                 │
   │ pattern entry ───────→ PATTERN-INDEX.md                    │
   │ lesson chain ────────→ DD-005-rivers.html (CSS comment)    │
   │ audit row ───────────→ RETROACTIVE-AUDIT-DD-001-006.md     │
   │ perceptual score ────→ DD-REAUDIT-PERCEPTUAL-SYNTHESIS.md  │
   │ pipeline ref ────────→ BACKBONE.md                         │
   └─────────────────────────────────────────────────────────────┘

8. CONSUMERS (who depends on this file)

   | Consumer                              | What They Take              |
   |---------------------------------------|-----------------------------|
   | DD-outbound-findings.md               | DD-F-004 GEOLOGICAL finding |
   | density-patterns.md                   | GEOLOGICAL pattern, 35/40   |
   | PATTERN-INDEX.md                      | GEOLOGICAL in pattern list  |
   | RETROACTIVE-AUDIT-DD-001-006.md       | Cross-matrix audit row      |
   | DD-REAUDIT-PERCEPTUAL-SYNTHESIS.md    | Perceptual scoring data     |
   | BACKBONE.md                           | Pipeline narrative ref      |
   | DD-005-rivers.html                    | Lesson chain: "Visual       |
   |                                       | system at top, multiple     |
   |                                       | usage paths"                |
   | OD-004-confidence.html                | Primary GEOLOGICAL source — confidence-level stratification (established/emerging/exploratory) validates DD-F-004 GEOLOGICAL pattern |
   | OD-006-creative.html                  | Emergent synthesis — references DD-004 GEOLOGICAL in periodic table; certainty layering in meta-content sections |

9. RESEARCH DEBT & OPEN QUESTIONS

   - DEBT-1: Widest research base (6 findings) but no per-finding
     application mapping exists. Which specific HTML elements
     implement R3-010 vs R3-044 vs R3-046?
   - DEBT-2: 3 EXEMPLARY findings (R3-044, R3-045, R3-046) — it is
     unclear which specific elements implement each finding.
   - DEBT-3: Longest file at 1099 lines — the density of content
     may itself need validation against GEOLOGICAL principles.
   - DEBT-4: DD-003 lesson citation ("Stronger inter-element
     connections, visible callouts") has no verification checklist
     confirming these are actually implemented.
   - DEBT-5: The GEOLOGICAL metaphor (expert vs novice layers)
     needs clearer documentation of how layers map to audience
     levels in the actual HTML structure.

10. DIAGNOSTIC QUESTIONS

   Q1: Does the :root block (L18-58) match DESIGN-TOKEN-SUMMARY.md
       exactly? (Verify all token values character-for-character.)
   Q2: Is DD-F-004 defined in DD-outbound-findings.md with the
       GEOLOGICAL pattern attribution?
   Q3: Does the CSS comment at line 16 cite DD-003 lessons?
       (Verify incoming lesson chain is intact.)
   Q4: Does DD-005-rivers.html's CSS comment cite DD-004 lessons?
       (Verify outgoing lesson chain is intact.)
   Q5: Are geological strata visually distinguishable as separate
       information layers when viewed in a browser?

     ═══════════════════════════════════════════════════════════════════════ -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DD-004: Density Layers</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    /* ═══════════════════════════════════════════════════════════════════════════
       LOCKED DESIGN TOKENS — From DESIGN-TOKEN-SUMMARY.md
       DD-003 Lessons: Stronger inter-element connections, visible callouts
       ═══════════════════════════════════════════════════════════════════════════ */
    :root {
      /* Colors */
      --color-primary: #E83025;
      --color-background: #FEF9F5;
      --color-text: #1A1A1A;
      --color-text-secondary: #666666;
      --color-border: #E0D5C5;
      --color-border-subtle: #F0EBE3;

      /* Typography */
      --font-display: 'Instrument Serif', Georgia, serif;
      --font-body: 'Inter', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', monospace;

      /* Geometry — LOCKED */
      --border-radius: 0;
      --box-shadow: none;

      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;
      --space-20: 80px;
      --space-24: 96px;

      /* Callout Accents */
      --accent-blue: #4A90D9;
      --accent-green: #4A9D6B;
      --accent-amber: #D97706;
      --accent-purple: #7C3AED;
      --accent-coral: #C97065;

      /* Standardized Border */
      --border-left-width: 4px;

      /* Layer-Specific Colors (Geological Model) */
      --layer-atmosphere: rgba(254, 249, 245, 0.95);  /* Nearly transparent */
      --layer-surface: #FFFFFF;                        /* Clean white */
      --layer-topsoil: #F7F4F0;                        /* Warm light */
      --layer-subsoil: #F0EBE3;                        /* Tan tint */
      --layer-bedrock: #1E1E1E;                        /* Deep dark */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-body);
      background: var(--color-background);
      color: var(--color-text);
      line-height: 1.7;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       EXPLORATION HEADER
       ═══════════════════════════════════════════════════════════════════════════ */
    .exploration-header {
      border-bottom: 3px solid var(--color-primary);
      padding: var(--space-6);
      background: white;
      margin-bottom: var(--space-16);
    }

    .exploration-id {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--color-primary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: var(--space-2);
    }

    .exploration-title {
      font-family: var(--font-display);
      font-size: 32px;
      font-style: italic;
      margin-bottom: var(--space-3);
    }

    .exploration-hypothesis {
      font-size: 14px;
      color: var(--color-text-secondary);
      max-width: 600px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       PAGE CONTAINER
       ═══════════════════════════════════════════════════════════════════════════ */
    .page-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 var(--space-6);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       GEOLOGICAL LAYER SYSTEM
       Research: R-3 Insight #5 (Geological Model), #6 (Z-Index Priority)

       Layers (top to bottom):
       - ATMOSPHERE: Decorative, lowest density (context/ambient)
       - SURFACE: Headlines, primary actions (low density, high priority)
       - TOPSOIL: Summaries, key points (medium density)
       - SUBSOIL: Detailed content, explanations (medium-high density)
       - BEDROCK: Reference, code, raw data (maximum density)

       Visual depth achieved through:
       - Background color intensity
       - Border thickness
       - Typography weight
       - Spacing compression
       ═══════════════════════════════════════════════════════════════════════════ */

    /* LAYER INDICATOR — Shows current depth */
    .layer-indicator {
      font-family: var(--font-mono);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--color-text-secondary);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }

    .layer-depth {
      display: flex;
      gap: 2px;
    }

    .layer-depth__bar {
      width: 6px;
      height: 12px;
      background: var(--color-border);
    }

    .layer-depth__bar--active {
      background: var(--color-primary);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       ATMOSPHERE LAYER — Contextual background, lowest density
       Floats above content, provides ambient framing
       ═══════════════════════════════════════════════════════════════════════════ */
    .layer-atmosphere {
      background: var(--layer-atmosphere);
      padding: var(--space-20) var(--space-8);
      margin-bottom: var(--space-6);
      position: relative;
    }

    .layer-atmosphere__context {
      font-family: var(--font-display);
      font-size: 15px;
      font-style: italic;
      color: var(--color-text-secondary);
      max-width: 550px;
      line-height: 1.8;
    }

    .layer-atmosphere__breadcrumb {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--color-border);
      margin-bottom: var(--space-3);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       SURFACE LAYER — Headlines, primary navigation, sparse
       ═══════════════════════════════════════════════════════════════════════════ */
    .layer-surface {
      background: var(--layer-surface);
      border-left: var(--border-left-width) solid var(--color-primary);
      padding: var(--space-10) var(--space-8);
      margin-bottom: var(--space-6);
    }

    .layer-surface__title {
      font-family: var(--font-display);
      font-size: 36px;
      font-style: italic;
      margin-bottom: var(--space-4);
      line-height: 1.2;
    }

    .layer-surface__subtitle {
      font-size: 16px;
      color: var(--color-text-secondary);
      max-width: 500px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       TOPSOIL LAYER — Summaries, key points, medium density
       ═══════════════════════════════════════════════════════════════════════════ */
    .layer-topsoil {
      background: var(--layer-topsoil);
      border-left: var(--border-left-width) solid var(--color-border);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
    }

    .layer-topsoil__section-title {
      font-family: var(--font-display);
      font-size: 22px;
      font-style: italic;
      margin-bottom: var(--space-4);
    }

    .layer-topsoil__content {
      font-size: 15px;
      max-width: 65ch;
    }

    .layer-topsoil__content p {
      margin-bottom: var(--space-3);
    }

    /* Key Points Grid — Medium density, scannable */
    .topsoil-keypoints {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-4);
      margin-top: var(--space-5);
    }

    @media (max-width: 768px) {
      .topsoil-keypoints {
        grid-template-columns: 1fr;
      }
    }

    .topsoil-keypoint {
      border-top: 2px solid var(--color-border);
      padding-top: var(--space-3);
    }

    .topsoil-keypoint__label {
      font-family: var(--font-mono);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    .topsoil-keypoint__value {
      font-family: var(--font-display);
      font-size: 18px;
      font-style: italic;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       SUBSOIL LAYER — Detailed explanations, medium-high density
       ═══════════════════════════════════════════════════════════════════════════ */
    .layer-subsoil {
      background: var(--layer-subsoil);
      border-left: var(--border-left-width) solid var(--color-text-secondary);
      padding: var(--space-5);
      margin-bottom: var(--space-6);
    }

    .layer-subsoil__title {
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-4);
    }

    .layer-subsoil__content {
      font-size: 14px;
      line-height: 1.7;
    }

    .layer-subsoil__content p {
      margin-bottom: var(--space-3);
    }

    /* Subsoil Detail List — Denser information */
    .subsoil-details {
      margin-top: var(--space-4);
    }

    .subsoil-detail {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: var(--space-3);
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--color-border);
      font-size: 13px;
    }

    .subsoil-detail:last-child {
      border-bottom: none;
    }

    .subsoil-detail__key {
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    .subsoil-detail__value {
      color: var(--color-text);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       BEDROCK LAYER — Reference, code, maximum density
       ═══════════════════════════════════════════════════════════════════════════ */
    .layer-bedrock {
      background: var(--layer-bedrock);
      border-left: var(--border-left-width) solid var(--color-primary);
      margin-bottom: var(--space-6);
    }

    .layer-bedrock__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) var(--space-4);
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .layer-bedrock__filename {
      font-family: var(--font-mono);
      font-size: 12px;
      color: #888;
    }

    .layer-bedrock__copy {
      font-family: var(--font-body);
      font-size: 11px;
      color: var(--color-primary);
      padding: var(--space-1) var(--space-2);
      border: 1px solid var(--color-primary);
      background: transparent;
      cursor: pointer;
    }

    .layer-bedrock__content {
      padding: var(--space-4);
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.6;
      color: #F5F0EB;
      overflow-x: auto;
    }

    .layer-bedrock__content .comment { color: #6A9955; }
    .layer-bedrock__content .keyword { color: #569CD6; }
    .layer-bedrock__content .string { color: #CE9178; }
    .layer-bedrock__content .function { color: #DCDCAA; }
    .layer-bedrock__content .variable { color: #9CDCFE; }

    /* ═══════════════════════════════════════════════════════════════════════════
       LAYER COMPOSITE — Showing multiple layers together
       ═══════════════════════════════════════════════════════════════════════════ */
    .layer-composite {
      margin-bottom: var(--space-12);
    }

    .layer-composite__label {
      font-family: var(--font-mono);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--color-text-secondary);
      padding: var(--space-3) var(--space-6);
      background: var(--color-background);
      border-left: 3px solid var(--color-primary);
      margin-bottom: var(--space-4);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       CALLOUTS — Positioned by layer context
       ═══════════════════════════════════════════════════════════════════════════ */

    /* Essence — Atmosphere layer (floats, contextual) */
    .callout-essence {
      border-left: var(--border-left-width) solid var(--accent-amber);
      background: rgba(217, 119, 6, 0.08);
      padding: var(--space-5);
      margin: var(--space-4) 0;
    }

    .callout-essence__label {
      font-family: var(--font-body);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent-amber);
      margin-bottom: var(--space-2);
    }

    .callout-essence__content {
      font-family: var(--font-display);
      font-size: 17px;
      font-style: italic;
      line-height: 1.7;
    }

    /* Tip — Subsoil layer (practical detail) */
    .callout-tip {
      border-left: var(--border-left-width) solid var(--accent-green);
      background: rgba(74, 157, 107, 0.08);
      padding: var(--space-4);
      margin: var(--space-4) 0;
    }

    .callout-tip__label {
      font-family: var(--font-body);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent-green);
      margin-bottom: var(--space-2);
    }

    .callout-tip__content {
      font-size: 14px;
    }

    /* Gotcha — Subsoil layer (warning detail) */
    .callout-gotcha {
      border-left: var(--border-left-width) solid var(--accent-coral);
      background: rgba(201, 112, 101, 0.08);
      padding: var(--space-4);
      margin: var(--space-4) 0;
    }

    .callout-gotcha__label {
      font-family: var(--font-body);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent-coral);
      margin-bottom: var(--space-2);
    }

    .callout-gotcha__content {
      font-size: 14px;
    }

    /* Info — Topsoil layer (contextual info) */
    .callout-info {
      border-left: var(--border-left-width) solid var(--accent-blue);
      background: rgba(74, 144, 217, 0.08);
      padding: var(--space-4);
      margin: var(--space-4) 0;
    }

    .callout-info__label {
      font-family: var(--font-body);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent-blue);
      margin-bottom: var(--space-2);
    }

    .callout-info__content {
      font-size: 14px;
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       DEPTH TRANSITION — Visual marker between layers
       ═══════════════════════════════════════════════════════════════════════════ */
    .depth-transition {
      height: var(--space-6);
      display: flex;
      align-items: center;
      padding: 0 var(--space-6);
    }

    .depth-transition__line {
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, var(--color-border), transparent);
    }

    .depth-transition__label {
      font-family: var(--font-mono);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--color-border);
      padding: 0 var(--space-3);
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       FILE TREE — Subsoil density
       ═══════════════════════════════════════════════════════════════════════════ */
    .file-tree {
      background: var(--layer-subsoil);
      border-left: var(--border-left-width) solid var(--accent-blue);
      padding: var(--space-4);
      margin: var(--space-4) 0;
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.6;
      white-space: pre;
    }

    .file-tree__label {
      font-family: var(--font-body);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent-blue);
      margin-bottom: var(--space-2);
      display: block;
    }

    .file-tree .folder { color: var(--accent-blue); }
    .file-tree .file { color: var(--color-text); }

    /* ═══════════════════════════════════════════════════════════════════════════
       STACKED LAYERS VISUALIZATION
       Shows the geological metaphor visually
       ═══════════════════════════════════════════════════════════════════════════ */
    .stacked-layers {
      display: flex;
      flex-direction: column;
      margin: var(--space-8) 0;
    }

    .stacked-layer {
      padding: var(--space-3) var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: 13px;
    }

    .stacked-layer__name {
      font-family: var(--font-mono);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      width: 100px;
    }

    .stacked-layer__density {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--color-text-secondary);
    }

    .stacked-layer--atmosphere {
      background: var(--layer-atmosphere);
      border-left: 2px solid var(--color-border-subtle);
    }

    .stacked-layer--surface {
      background: var(--layer-surface);
      border-left: 3px solid var(--color-primary);
    }

    .stacked-layer--topsoil {
      background: var(--layer-topsoil);
      border-left: 3px solid var(--color-border);
    }

    .stacked-layer--subsoil {
      background: var(--layer-subsoil);
      border-left: 3px solid var(--color-text-secondary);
    }

    .stacked-layer--bedrock {
      background: var(--layer-bedrock);
      border-left: 3px solid var(--color-primary);
      color: #F5F0EB;
    }

    .stacked-layer--bedrock .stacked-layer__density {
      color: #888;
    }

  </style>
</head>
<body>

  <!-- EXPLORATION HEADER -->
  <header class="exploration-header">
    <div class="exploration-id">DD-004 — Density Exploration</div>
    <h1 class="exploration-title">Density Layers</h1>
    <p class="exploration-hypothesis">
      <strong>Hypothesis:</strong> Information density can be stratified into distinct layers
      like geological strata — Atmosphere, Surface, Topsoil, Subsoil, Bedrock — each with
      appropriate density for its depth. Users drill down into density by choice.
      Applying R-3 Geological Model (Insight #5).
    </p>
  </header>

  <main class="page-container">

    <!-- ═══════════════════════════════════════════════════════════════════════
         LAYER VISUALIZATION — Showing the concept
         ═══════════════════════════════════════════════════════════════════════ -->
    <div class="stacked-layers">
      <div class="stacked-layer stacked-layer--atmosphere">
        <span class="stacked-layer__name">Atmosphere</span>
        <span class="stacked-layer__density">Minimal density — ambient context</span>
      </div>
      <div class="stacked-layer stacked-layer--surface">
        <span class="stacked-layer__name">Surface</span>
        <span class="stacked-layer__density">Low density — headlines, navigation</span>
      </div>
      <div class="stacked-layer stacked-layer--topsoil">
        <span class="stacked-layer__name">Topsoil</span>
        <span class="stacked-layer__density">Medium density — summaries, key points</span>
      </div>
      <div class="stacked-layer stacked-layer--subsoil">
        <span class="stacked-layer__name">Subsoil</span>
        <span class="stacked-layer__density">Medium-high density — details, explanations</span>
      </div>
      <div class="stacked-layer stacked-layer--bedrock">
        <span class="stacked-layer__name">Bedrock</span>
        <span class="stacked-layer__density">Maximum density — reference, code, raw data</span>
      </div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════════════════
         COMPOSITE 1: Full Layer Stack (API Documentation Example)
         ═══════════════════════════════════════════════════════════════════════ -->
    <div class="layer-composite">
      <div class="layer-composite__label">Example: API Documentation with Full Layer Stack</div>

      <!-- ATMOSPHERE — Context framing -->
      <div class="layer-atmosphere">
        <div class="layer-indicator">
          <div class="layer-depth">
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
          </div>
          Atmosphere Layer
        </div>
        <div class="layer-atmosphere__breadcrumb">API Reference → Authentication → OAuth 2.0</div>
        <p class="layer-atmosphere__context">
          OAuth 2.0 is the industry-standard protocol for authorization. This section covers
          implementing OAuth flows in your application, from simple access tokens to complex
          multi-tenant scenarios.
        </p>
      </div>

      <!-- SURFACE — Primary headline -->
      <div class="layer-surface">
        <div class="layer-indicator">
          <div class="layer-depth">
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
          </div>
          Surface Layer
        </div>
        <h1 class="layer-surface__title">Authorization Code Flow</h1>
        <p class="layer-surface__subtitle">
          The most secure OAuth flow for server-side applications. Exchanges a temporary
          code for access tokens without exposing credentials to the browser.
        </p>
      </div>

      <!-- TOPSOIL — Key points, scannable -->
      <div class="layer-topsoil">
        <div class="layer-indicator">
          <div class="layer-depth">
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
          </div>
          Topsoil Layer
        </div>
        <h2 class="layer-topsoil__section-title">Flow Overview</h2>
        <div class="layer-topsoil__content">
          <p>
            The authorization code flow involves three parties: your application, the user,
            and the authorization server. It's a two-step process that keeps secrets secure.
          </p>
        </div>
        <div class="topsoil-keypoints">
          <div class="topsoil-keypoint">
            <div class="topsoil-keypoint__label">Security Level</div>
            <div class="topsoil-keypoint__value">Highest</div>
          </div>
          <div class="topsoil-keypoint">
            <div class="topsoil-keypoint__label">Best For</div>
            <div class="topsoil-keypoint__value">Server Apps</div>
          </div>
          <div class="topsoil-keypoint">
            <div class="topsoil-keypoint__label">Complexity</div>
            <div class="topsoil-keypoint__value">Moderate</div>
          </div>
        </div>

        <div class="callout-info">
          <div class="callout-info__label">Note</div>
          <div class="callout-info__content">
            This flow requires a server-side component. For single-page applications without
            a backend, see the PKCE extension section below.
          </div>
        </div>
      </div>

      <!-- SUBSOIL — Detailed steps -->
      <div class="layer-subsoil">
        <div class="layer-indicator">
          <div class="layer-depth">
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
          </div>
          Subsoil Layer
        </div>
        <h3 class="layer-subsoil__title">Implementation Steps</h3>
        <div class="layer-subsoil__content">
          <p>
            Follow these steps to implement the authorization code flow. Each step must
            complete successfully before proceeding to the next.
          </p>
        </div>

        <div class="subsoil-details">
          <div class="subsoil-detail">
            <span class="subsoil-detail__key">1. Redirect User</span>
            <span class="subsoil-detail__value">Send user to authorization endpoint with client_id, redirect_uri, scope, and state parameters</span>
          </div>
          <div class="subsoil-detail">
            <span class="subsoil-detail__key">2. User Authenticates</span>
            <span class="subsoil-detail__value">User logs in and approves requested permissions at the authorization server</span>
          </div>
          <div class="subsoil-detail">
            <span class="subsoil-detail__key">3. Receive Code</span>
            <span class="subsoil-detail__value">Authorization server redirects back with temporary authorization code</span>
          </div>
          <div class="subsoil-detail">
            <span class="subsoil-detail__key">4. Exchange Code</span>
            <span class="subsoil-detail__value">Server-side POST to token endpoint exchanges code for access + refresh tokens</span>
          </div>
          <div class="subsoil-detail">
            <span class="subsoil-detail__key">5. Store Tokens</span>
            <span class="subsoil-detail__value">Securely store tokens server-side; never expose to client</span>
          </div>
        </div>

        <div class="callout-tip">
          <div class="callout-tip__label">Tip</div>
          <div class="callout-tip__content">
            Always verify the <code>state</code> parameter matches what you sent. This prevents
            CSRF attacks. Generate a cryptographically random string for each request.
          </div>
        </div>

        <div class="callout-gotcha">
          <div class="callout-gotcha__label">Gotcha</div>
          <div class="callout-gotcha__content">
            Authorization codes are single-use and expire quickly (typically 10 minutes).
            Exchange them immediately — don't store them for later.
          </div>
        </div>

        <div class="file-tree">
          <span class="file-tree__label">Required Endpoints</span><span class="folder">OAuth Server</span>
├── <span class="file">/authorize</span>      <span style="color: #888"># Step 1: User redirect</span>
├── <span class="file">/token</span>          <span style="color: #888"># Step 4: Code exchange</span>
└── <span class="file">/userinfo</span>       <span style="color: #888"># Optional: Get user data</span>

<span class="folder">Your Server</span>
├── <span class="file">/login</span>          <span style="color: #888"># Initiates flow</span>
└── <span class="file">/callback</span>       <span style="color: #888"># Receives code</span></div>
      </div>

      <!-- BEDROCK — Code, maximum density -->
      <div class="layer-bedrock">
        <div class="layer-indicator" style="padding: var(--space-3) var(--space-4); color: #888;">
          <div class="layer-depth">
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
          </div>
          Bedrock Layer
        </div>
        <div class="layer-bedrock__header">
          <span class="layer-bedrock__filename">auth/oauth.ts</span>
          <button class="layer-bedrock__copy">Copy</button>
        </div>
        <div class="layer-bedrock__content">
<span class="keyword">import</span> { <span class="variable">OAuth2Client</span> } <span class="keyword">from</span> <span class="string">'google-auth-library'</span>;

<span class="keyword">const</span> <span class="variable">client</span> = <span class="keyword">new</span> <span class="function">OAuth2Client</span>({
  <span class="variable">clientId</span>: <span class="variable">process</span>.<span class="variable">env</span>.<span class="variable">OAUTH_CLIENT_ID</span>,
  <span class="variable">clientSecret</span>: <span class="variable">process</span>.<span class="variable">env</span>.<span class="variable">OAUTH_CLIENT_SECRET</span>,
  <span class="variable">redirectUri</span>: <span class="string">'https://app.example.com/callback'</span>
});

<span class="comment">// Step 1: Generate authorization URL</span>
<span class="keyword">export function</span> <span class="function">getAuthUrl</span>(<span class="variable">state</span>: <span class="keyword">string</span>): <span class="keyword">string</span> {
  <span class="keyword">return</span> <span class="variable">client</span>.<span class="function">generateAuthUrl</span>({
    <span class="variable">access_type</span>: <span class="string">'offline'</span>,
    <span class="variable">scope</span>: [<span class="string">'openid'</span>, <span class="string">'email'</span>, <span class="string">'profile'</span>],
    <span class="variable">state</span>,
    <span class="variable">prompt</span>: <span class="string">'consent'</span>
  });
}

<span class="comment">// Step 4: Exchange code for tokens</span>
<span class="keyword">export async function</span> <span class="function">exchangeCode</span>(<span class="variable">code</span>: <span class="keyword">string</span>) {
  <span class="keyword">const</span> { <span class="variable">tokens</span> } = <span class="keyword">await</span> <span class="variable">client</span>.<span class="function">getToken</span>(<span class="variable">code</span>);
  <span class="variable">client</span>.<span class="function">setCredentials</span>(<span class="variable">tokens</span>);
  <span class="keyword">return</span> <span class="variable">tokens</span>;
}
        </div>
      </div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════════════════
         DEPTH TRANSITION
         ═══════════════════════════════════════════════════════════════════════ -->
    <div class="depth-transition">
      <div class="depth-transition__line"></div>
      <span class="depth-transition__label">Pattern Reflection</span>
      <div class="depth-transition__line" style="transform: scaleX(-1);"></div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════════════════
         ESSENCE — Pattern insight
         ═══════════════════════════════════════════════════════════════════════ -->
    <div class="callout-essence" style="max-width: 700px; margin: var(--space-12) auto;">
      <div class="callout-essence__label">Key Insight</div>
      <div class="callout-essence__content">
        You've just experienced density layering: from the atmospheric breadcrumb context,
        through the clean surface headline, past the scannable topsoil summary, into the
        detailed subsoil steps, and finally to the bedrock code reference. Each layer
        serves a different reading mode — you choose how deep to drill.
      </div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════════════════
         COMPOSITE 2: Selective Layers (Skip middle layers)
         ═══════════════════════════════════════════════════════════════════════ -->
    <div class="layer-composite">
      <div class="layer-composite__label">Example: Expert Path (Surface → Bedrock)</div>

      <div class="layer-surface">
        <div class="layer-indicator">
          <div class="layer-depth">
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
          </div>
          Surface → Bedrock (Expert)
        </div>
        <h1 class="layer-surface__title">Token Refresh</h1>
        <p class="layer-surface__subtitle">
          When access tokens expire, use the refresh token to get a new one.
        </p>
      </div>

      <div class="layer-bedrock">
        <div class="layer-bedrock__header">
          <span class="layer-bedrock__filename">auth/refresh.ts</span>
          <button class="layer-bedrock__copy">Copy</button>
        </div>
        <div class="layer-bedrock__content">
<span class="keyword">export async function</span> <span class="function">refreshAccessToken</span>(<span class="variable">refreshToken</span>: <span class="keyword">string</span>) {
  <span class="variable">client</span>.<span class="function">setCredentials</span>({ <span class="variable">refresh_token</span>: <span class="variable">refreshToken</span> });

  <span class="keyword">const</span> { <span class="variable">credentials</span> } = <span class="keyword">await</span> <span class="variable">client</span>.<span class="function">refreshAccessToken</span>();
  <span class="keyword">return</span> <span class="variable">credentials</span>.<span class="variable">access_token</span>;
}
        </div>
      </div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════════════════
         COMPOSITE 3: Novice Path (More middle layers)
         ═══════════════════════════════════════════════════════════════════════ -->
    <div class="layer-composite">
      <div class="layer-composite__label">Example: Novice Path (Full Explanatory Stack)</div>

      <div class="layer-atmosphere">
        <div class="layer-indicator">
          <div class="layer-depth">
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
          </div>
          Atmosphere — Context
        </div>
        <p class="layer-atmosphere__context">
          Before implementing token refresh, understand why tokens expire in the first place.
          Short-lived access tokens limit the damage if one is compromised.
        </p>
      </div>

      <div class="layer-topsoil">
        <div class="layer-indicator">
          <div class="layer-depth">
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar"></div>
          </div>
          Topsoil — Key Concept
        </div>
        <h2 class="layer-topsoil__section-title">Why Tokens Expire</h2>
        <div class="layer-topsoil__content">
          <p>
            Access tokens are deliberately short-lived (typically 1 hour). If stolen, they
            can only be misused briefly. Refresh tokens are long-lived but should never
            leave your server.
          </p>
        </div>
        <div class="topsoil-keypoints">
          <div class="topsoil-keypoint">
            <div class="topsoil-keypoint__label">Access Token</div>
            <div class="topsoil-keypoint__value">~1 hour</div>
          </div>
          <div class="topsoil-keypoint">
            <div class="topsoil-keypoint__label">Refresh Token</div>
            <div class="topsoil-keypoint__value">~30 days</div>
          </div>
          <div class="topsoil-keypoint">
            <div class="topsoil-keypoint__label">Storage</div>
            <div class="topsoil-keypoint__value">Server only</div>
          </div>
        </div>
      </div>

      <div class="layer-subsoil">
        <div class="layer-indicator">
          <div class="layer-depth">
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar layer-depth__bar--active"></div>
            <div class="layer-depth__bar"></div>
          </div>
          Subsoil — Details
        </div>
        <h3 class="layer-subsoil__title">When to Refresh</h3>
        <div class="layer-subsoil__content">
          <p>
            Don't wait for API errors. Proactively check token expiration before making
            requests. Most tokens include an <code>expires_at</code> timestamp.
          </p>
        </div>

        <div class="subsoil-details">
          <div class="subsoil-detail">
            <span class="subsoil-detail__key">Check Timing</span>
            <span class="subsoil-detail__value">Refresh when token has &lt;5 minutes remaining</span>
          </div>
          <div class="subsoil-detail">
            <span class="subsoil-detail__key">Handle Failure</span>
            <span class="subsoil-detail__value">If refresh fails, redirect user to re-authenticate</span>
          </div>
          <div class="subsoil-detail">
            <span class="subsoil-detail__key">Race Conditions</span>
            <span class="subsoil-detail__value">Use mutex/lock when refreshing to prevent duplicate requests</span>
          </div>
        </div>

        <div class="callout-gotcha">
          <div class="callout-gotcha__label">Gotcha</div>
          <div class="callout-gotcha__content">
            Some providers rotate refresh tokens on each use. Always store the new refresh
            token returned from a refresh request, not just the access token.
          </div>
        </div>
      </div>
    </div>

  </main>

  <!--
    ═══════════════════════════════════════════════════════════════════════════
    DENSITY LAYERS PATTERN SUMMARY
    ═══════════════════════════════════════════════════════════════════════════

    LAYER SYSTEM (Geological Model from R-3 Insight #5):

    Layer 1 — ATMOSPHERE (Click Depth 0)
    - Background: Nearly transparent (#FEF9F5 at 95% opacity)
    - Border: Subtle 2px
    - Typography: Italic display, secondary color
    - Content: Breadcrumbs, ambient context, framing
    - Density: MINIMAL

    Layer 2 — SURFACE (Click Depth 0)
    - Background: Clean white
    - Border: 4px primary red
    - Typography: Large display serif
    - Content: Headlines, primary navigation
    - Density: LOW

    Layer 3 — TOPSOIL (Click Depth 1)
    - Background: Warm light (#F7F4F0)
    - Border: 4px border color
    - Typography: Medium display headings, body text
    - Content: Summaries, key points, info callouts
    - Density: MEDIUM

    Layer 4 — SUBSOIL (Click Depth 1-2)
    - Background: Tan tint (#F0EBE3)
    - Border: 4px secondary text color
    - Typography: Sans-serif, smaller sizes
    - Content: Detailed steps, tips, gotchas, file trees
    - Density: MEDIUM-HIGH

    Layer 5 — BEDROCK (Click Depth 2+)
    - Background: Deep dark (#1E1E1E)
    - Border: 4px primary red
    - Typography: Monospace
    - Content: Code, raw data, reference material
    - Density: MAXIMUM

    RESEARCH APPLIED:
    - R-3 Insight #5: Information stratifies like geological layers
    - R-3 Insight #6: Z-index inversely correlates with density
    - R-3 Insight #7: Progressive disclosure creates density gradients
    - R-3 Insight #27: Density potential (how much MORE dense something could become)
    - R-3 Insight #28: Density inheritance (context affects perceived density)

    VISUAL DEPTH SIGNALS:
    - Background intensity increases with depth
    - Border weight indicates layer importance
    - Typography compresses with depth
    - Spacing tightens with depth
    - Layer indicators show current depth

    USAGE PATTERNS:
    1. Full Stack — All 5 layers for comprehensive documentation
    2. Expert Path — Surface + Bedrock (skip explanatory layers)
    3. Novice Path — More Topsoil + Subsoil (extra context)

    DD-003 LESSONS APPLIED:
    - Stronger inter-element connections (layer indicators throughout)
    - More visible callout backgrounds (8% opacity vs 5%)
    - Meaningful separators (depth transition component)
    - Thematic headers (layer composite labels)
    ═══════════════════════════════════════════════════════════════════════════
  -->

</body>
</html>
