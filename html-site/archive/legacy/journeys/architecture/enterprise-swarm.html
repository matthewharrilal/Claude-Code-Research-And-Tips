<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enterprise &amp; Swarm - Claude Code Knowledge Base</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
</head>
<body>
  <div class="page-with-sidebar">
    <!-- Sidebar navigation -->
    <nav class="sidebar">
      <button class="sidebar-close" aria-label="Close sidebar">&times;</button>
      <div class="sidebar-header">
        <h2 class="sidebar-title"><a href="../../index.html">Claude Code KB</a></h2>
      </div>
      <ul class="sidebar-nav">
        <li class="nav-section">
          <div class="nav-section-title">Start Here</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../../start-here/index.html">Overview</a></li>
            <li class="nav-page"><a href="../../start-here/master-playbook.html">Master Playbook</a></li>
            <li class="nav-page"><a href="../../start-here/judgment-guide.html">Judgment Guide</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Foundations</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../../foundations/index.html">Overview</a></li>
            <li class="nav-page"><a href="../../foundations/principles/core.html">Core Principles</a></li>
            <li class="nav-page"><a href="../../foundations/architecture/complexity-ladder.html">Complexity Ladder</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Mental Models Journey</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../mental-models/index.html">Overview</a></li>
            <li class="nav-page"><a href="../mental-models/core-models.html">Core Models (1-10)</a></li>
            <li class="nav-page"><a href="../mental-models/advanced-models.html">Advanced Models (11-16)</a></li>
            <li class="nav-page"><a href="../mental-models/practice-heuristics.html">Practice &amp; Heuristics</a></li>
          </ul>
        </li>
        <li class="nav-section open">
          <div class="nav-section-title">Architecture Journey</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="index.html">Overview</a></li>
            <li class="nav-page"><a href="decision-framework.html">Decision Framework</a></li>
            <li class="nav-page"><a href="core-patterns.html">Core Patterns</a></li>
            <li class="nav-page current"><a href="enterprise-swarm.html">Enterprise &amp; Swarm</a></li>
            <li class="nav-page"><a href="context-composition.html">Context &amp; Composition</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Implementation Journey</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../implementation/index.html">Overview</a></li>
            <li class="nav-page"><a href="../implementation/context-state.html">Context &amp; State</a></li>
            <li class="nav-page"><a href="../implementation/ralph-production.html">Ralph Production</a></li>
            <li class="nav-page"><a href="../implementation/hooks-enterprise.html">Hooks &amp; Enterprise</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Operations Journey</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../operations/index.html">Overview</a></li>
            <li class="nav-page"><a href="../operations/monitoring-cost.html">Monitoring &amp; Cost</a></li>
            <li class="nav-page"><a href="../operations/security-checklists.html">Security &amp; Checklists</a></li>
            <li class="nav-page"><a href="../operations/incident-response.html">Incident Response</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Reference</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../foundations/invariants-reference.html">Invariants Reference</a></li>
            <li class="nav-page"><a href="../../reference/index.html">Full Reference</a></li>
            <li class="nav-page"><a href="../../reference/cost-analysis.html">Cost Analysis</a></li>
          </ul>
        </li>
      </ul>
    </nav>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay"></div>

    <!-- Main content -->
    <main class="main-content">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href="../../index.html">Home</a>
        <span class="breadcrumb-separator">/</span>
        <a href="../index.html">Journeys</a>
        <span class="breadcrumb-separator">/</span>
        <a href="index.html">Architecture</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">Enterprise &amp; Swarm</span>
      </nav>

      <!-- Page meta -->
      <div class="page-meta">
        <span class="page-meta-item">~38 min read</span>
      </div>

      <h1>Enterprise &amp; Swarm Architecture</h1>

      <div class="context-box you-are-here">
        <h3>You Are Here</h3>
        <p><strong>What this covers:</strong> Enterprise-scale deployment patterns including maturity models, compliance architecture, self-learning swarms (SONA), mesh topologies, and production infrastructure implementations.</p>
        <p><strong>Scale focus:</strong> 30-100+ agent systems with compliance, cost management, and self-learning capabilities.</p>
        <p><strong>Where this fits:</strong></p>
        <pre class="ascii-diagram">ARCHITECTURE JOURNEY
    |
    +-- Decision Framework (which pattern?)
    |
    +-- Core Patterns (basic patterns)
    |
    +-- **YOU ARE HERE: Enterprise &amp; Swarm** (scaling up)
    |
    +-- Context &amp; Composition (combining patterns)</pre>
      </div>

      <p>This page covers enterprise-scale deployment patterns including maturity models, compliance architecture, self-learning swarms (SONA), and production infrastructure implementations.</p>

      <!-- Woven Summary: Swarm Topologies Overview -->
      <div class="context-box" style="border-left-color: #2a7d7d; margin: 2rem 0;">
        <h3>Understanding Swarm Topologies</h3>
        <p>Enterprise swarms organize agents through four primary topologies, each optimized for different coordination patterns. <strong>Hierarchical (Queen/Worker)</strong> provides clear command structure for large-scale operations with Byzantine fault tolerance. <strong>Mesh/P2P</strong> eliminates single points of failure through gossip protocols. <strong>Star</strong> excels at coordination-heavy workloads with a central hub. <strong>Ring</strong> is optimal for pipeline processing where work flows sequentially.</p>

        <p>The key insight is that topology selection should match your coordination requirements. Most organizations start with hierarchical (simpler to reason about) and migrate to mesh only when fault tolerance requirements demand it.</p>

        <div class="decision-table">
          <table>
            <thead>
              <tr>
                <th>Topology</th>
                <th>Scale</th>
                <th>Fault Tolerance</th>
                <th>Best For</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Hierarchical</td>
                <td>64+ agents</td>
                <td>Byzantine (33%)</td>
                <td>Clear structure, large teams</td>
              </tr>
              <tr>
                <td>Mesh</td>
                <td>20-100+</td>
                <td>No SPOF</td>
                <td>High availability needs</td>
              </tr>
              <tr>
                <td>Star</td>
                <td>5-20</td>
                <td>Hub failure = total</td>
                <td>Coordination-heavy</td>
              </tr>
              <tr>
                <td>Ring</td>
                <td>3-10</td>
                <td>One failure stops flow</td>
                <td>Pipeline processing</td>
              </tr>
            </tbody>
          </table>
        </div>

        <p><a href="../../synthesis/architecture-swarm-topologies.html" class="full-guide-link">Full Guide: Swarm Topologies Reference</a></p>
      </div>

      <!-- Woven Summary: Enterprise Orchestration Comparison -->
      <div class="context-box" style="border-left-color: #c49052; margin: 2rem 0;">
        <h3>Enterprise Orchestration Tools Compared</h3>
        <p>At enterprise scale, you have several orchestration options beyond Claude Code's native capabilities. <strong>claude-flow</strong> provides the SONA self-learning swarm with ReasoningBank pattern storage and Q-Learning routing. <strong>Gas Town</strong> offers the full agent factory with 7 specialized roles. <strong>CC Mirror</strong> enables hub-and-spoke with native Task API integration. <strong>Custom orchestration</strong> via the Agent SDK gives maximum flexibility.</p>

        <p><strong>Selection Criteria:</strong></p>
        <ul>
          <li><strong>Need self-learning?</strong> Go claude-flow SONA</li>
          <li><strong>Need role specialization?</strong> Go Gas Town</li>
          <li><strong>Need simple multi-agent?</strong> Go CC Mirror</li>
          <li><strong>Need full control?</strong> Go Agent SDK custom</li>
        </ul>

        <p><a href="../../synthesis/compare-enterprise-orchestration.html" class="full-guide-link">Full Guide: Enterprise Orchestration Comparison</a></p>
      </div>

      <!-- Woven Summary: Cost Economics -->
      <div class="context-box" style="border-left-color: #6b9b7a; margin: 2rem 0;">
        <h3>Enterprise Cost Economics</h3>
        <p>At enterprise scale, cost management becomes critical. The key insight is that <strong>semantic caching can reduce costs by 30-40%</strong> when similar queries are frequent, and <strong>model routing can achieve 5-10x cost savings</strong> by matching task complexity to model tier (Opus for architecture, Sonnet for implementation, Haiku for lookups).</p>

        <p>A typical enterprise swarm (30-50 agents) costs $1,500-2,500/day without optimization. With aggressive caching, model routing, and WASM acceleration for deterministic operations, this can drop to $500-1,000/day while maintaining quality.</p>

        <div class="code-block">
          <button class="copy-btn">Copy</button>
          <pre>Cost Optimization Stack:
1. LiteLLM semantic cache  = -30% baseline cost
2. Model routing (Q-Learn) = -40% from smart selection
3. Agent Booster WASM      = -85% for deterministic ops
4. Budget alerts 50/75/90% = Prevents overruns

Combined: 60-70% cost reduction at enterprise scale</pre>
        </div>

        <p><a href="../../synthesis/cost-economics-enterprise.html" class="full-guide-link">Full Guide: Enterprise Cost Economics</a></p>
      </div>

      <h2>Enterprise Maturity Model</h2>

      <p>Organizations adopt Claude Code through predictable maturity stages:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|              ENTERPRISE MATURITY MODEL                       |
|                                                              |
|  Level   Capability          Key Indicators                 |
|  ==========================================================  |
|                                                              |
|  L4      SELF-OPTIMIZING     ML routing, adaptive scaling,  |
|          Scale               Byzantine FT, SONA             |
|            |                                                 |
|            | UNLOCK: SONA agents, ReasoningBank configured  |
|            v                                                 |
|  L3      ENTERPRISE          Compliance ledger, audit       |
|          Governance          trails, HITL gates, BMAD       |
|            |                                                 |
|            | UNLOCK: BMAD-METHOD adopted, SOC 2 ready       |
|            v                                                 |
|  L2      DEPARTMENT          Per-user quotas, fallbacks,    |
|          Control             LiteLLM proxy                  |
|            |                                                 |
|            | UNLOCK: LiteLLM deployed, budgets configured   |
|            v                                                 |
|  L1      TEAM                API key per team, manual       |
|          Shared              monitoring                      |
|            |                                                 |
|            | UNLOCK: Multiple developers, shared API key    |
|            v                                                 |
|  L0      EXPERIMENTAL        Single developer, ad-hoc       |
|          Solo                No cost tracking               |
|                                                              |
|  ENTERPRISE THRESHOLD: L2+ requires all patterns below      |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h2>Enterprise Stack Architecture</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|              ENTERPRISE CLAUDE STACK                         |
|                                                              |
|  LAYER 5: METHODOLOGY                                        |
|  +--&gt; BMAD-METHOD for governance, compliance, audit          |
|      +--&gt; Compliance ledger (SOC 2, HIPAA, GDPR)            |
|                                                              |
|  LAYER 4: SELF-OPTIMIZATION                                  |
|  +--&gt; claude-flow SONA + ReasoningBank                       |
|      +--&gt; Q-Learning router, pattern learning                |
|                                                              |
|  LAYER 3: ORCHESTRATION                                      |
|  +--&gt; claude-flow for multi-agent coordination               |
|  +--&gt; Skills system for modular capabilities                 |
|      +--&gt; 64+ agents, Byzantine FT                           |
|                                                              |
|  LAYER 2: GATEWAY                                            |
|  +--&gt; LiteLLM Proxy for cost, caching, fallbacks             |
|      +--&gt; 7 cache backends, semantic caching                 |
|      +--&gt; Provider failover chain                            |
|                                                              |
|  LAYER 1: PROVIDERS                                          |
|  +--&gt; Anthropic Direct + AWS Bedrock + Vertex AI             |
|      +--&gt; Automatic failover on provider outage              |
|                                                              |
|  LAYER 0: EXECUTION                                          |
|  +--&gt; Claude Code / OpenCode                                 |
|      +--&gt; Git snapshotting for error recovery                |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h2>Enterprise Cost Management</h2>

      <h3>Three-Level Budget Control</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|              BUDGET CONTROL HIERARCHY                        |
|                                                              |
|  +-----------------------------------------------------+    |
|  |  GLOBAL BUDGET (Organization)                        |    |
|  |  litellm.max_budget = $10,000/month                 |    |
|  |                                                      |    |
|  |  +-----------------------------------------------+  |    |
|  |  |  TEAM BUDGET (Per virtual key)                |  |    |
|  |  |  sk-proj-engineering: $5,000/month            |  |    |
|  |  |  sk-proj-research: $3,000/month               |  |    |
|  |  |                                               |  |    |
|  |  |  +---------------------------------------+   |  |    |
|  |  |  |  USER BUDGET (Per individual)         |   |  |    |
|  |  |  |  user_alice: $500/week                |   |  |    |
|  |  |  |  user_bob: $500/week                  |   |  |    |
|  |  |  +---------------------------------------+   |  |    |
|  |  +-----------------------------------------------+  |    |
|  +-----------------------------------------------------+    |
|                                                              |
|  ENFORCEMENT:                                                |
|  - Pre-call check: if cost &lt; budget, allow                  |
|  - Post-call update: track actual cost                      |
|  - Overage handling: alert, throttle, or block              |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h3>LiteLLM Enterprise Configuration</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre># litellm_enterprise_config.yaml
model_list:
  - model_name: claude-opus
    litellm_params:
      model: claude-sonnet-4-20250514
      api_key: ${ANTHROPIC_API_KEY}
      max_budget: 2000
      budget_duration: daily
  - model_name: claude-sonnet
    litellm_params:
      model: claude-sonnet-4-20250514
      max_budget: 800
  - model_name: claude-haiku
    litellm_params:
      model: claude-3-haiku-20240307
      max_budget: 100
  # Fallback chain
  - model_name: claude-opus-bedrock
    litellm_params:
      model: bedrock/anthropic.claude-3-opus-20240229-v1:0
      aws_region_name: us-east-1

litellm_settings:
  cache: true
  cache_params:
    type: qdrant  # 30%+ semantic cache hit rate
    similarity_threshold: 0.95
  budget_duration: daily
  max_budget: 5000
  fallback_models:
    claude-opus: ["claude-opus-bedrock"]</pre>
      </div>

      <h3>Agent Booster WASM (Cost Optimization)</h3>

      <p>For deterministic operations, skip the LLM entirely:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|              AGENT BOOSTER WASM                              |
|                                                              |
|  +-----------------+        +-----------------+             |
|  |  LLM Path       |        |  WASM Path      |             |
|  |  (expensive)    |        |  (free)         |             |
|  |                 |        |                 |             |
|  |  Complex        |        |  Simple file    |             |
|  |  reasoning      |        |  edits (regex)  |             |
|  |  tasks          |        |                 |             |
|  |                 |        |  Code format    |             |
|  |  Multi-step     |        |                 |             |
|  |  planning       |        |  Template       |             |
|  |                 |        |  instantiation  |             |
|  |  Cost: $$$      |        |                 |             |
|  |  Latency: 2-5s  |        |  Config updates |             |
|  |                 |        |                 |             |
|  |                 |        |  Cost: $0       |             |
|  |                 |        |  Latency: &lt;1ms  |             |
|  +-----------------+        +-----------------+             |
|                                                              |
|  IMPACT:                                                     |
|  - 85% API cost savings for simple operations               |
|  - 250% extension of Claude Code usage                      |
|  - Sub-millisecond execution                                |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h2>Enterprise Compliance Architecture</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|              COMPLIANCE LEDGER ARCHITECTURE                  |
|                                                              |
|  Every action is Git-tracked:                               |
|                                                              |
|  +--&gt; Requirements changes        -&gt; PRD commit history       |
|  +--&gt; Architecture decisions      -&gt; ADR documents            |
|  +--&gt; Code changes               -&gt; Standard git log          |
|  +--&gt; Approval gates             -&gt; PR reviews                |
|  +--&gt; Test results               -&gt; CI/CD artifacts           |
|                                                              |
|  Compliance frameworks supported:                            |
|  +--&gt; SOC 2 Type II                                          |
|  +--&gt; HIPAA                                                   |
|  +--&gt; GDPR                                                    |
|  +--&gt; ISO 27001                                              |
|                                                              |
|  Audit extraction:                                           |
|  +--&gt; git log --format=json | compliance-report              |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h3>Enterprise Deployment Checklist</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>LAYER 0: OpenCode + LSP grounding + git snapshots
LAYER 2: LiteLLM with budget alerts at 50%, 75%, 90%
LAYER 3: claude-flow Queen/Worker + AgentDB
LAYER 4: ReasoningBank with EWC++ (95%+ retention)</pre>
      </div>

      <details class="troubleshoot">
        <summary>Enterprise infrastructure problems</summary>
        <div class="troubleshoot-content">
          <table>
            <tr>
              <th>Symptom</th>
              <th>Cause</th>
              <th>Recovery</th>
            </tr>
            <tr>
              <td>LiteLLM 429 errors</td>
              <td>Budget exhausted</td>
              <td>Check spend; increase limits</td>
            </tr>
            <tr>
              <td>OpenCode blocks edits</td>
              <td>LSP false positives</td>
              <td>Check logs; disable BlockEdit</td>
            </tr>
            <tr>
              <td>claude-flow timeouts</td>
              <td>AgentDB issues</td>
              <td>Verify PostgreSQL connectivity</td>
            </tr>
            <tr>
              <td>Bad patterns in ReasoningBank</td>
              <td>Low reward threshold</td>
              <td>Increase minRewardScore</td>
            </tr>
          </table>
        </div>
      </details>

      <h2>Self-Learning Swarm (SONA)</h2>

      <p>Enable agents to share knowledge and improve collectively over time.</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|              SELF-LEARNING SWARM (SONA)                      |
|                                                              |
|  +----------------------------------------------------+     |
|  |                  ReasoningBank                      |     |
|  |              (Unified Learning Repository)          |     |
|  |                                                     |     |
|  |  Stores:                                            |     |
|  |  - Problem signatures (what kind of task?)         |     |
|  |  - Solution patterns (how was it solved?)          |     |
|  |  - Reward scores (how well did it work?)           |     |
|  |  - Application count (how often used?)             |     |
|  +----------------------+-----------------------------+     |
|                         |                                    |
|         +---------------+---------------+                   |
|         |               |               |                    |
|         v               v               v                    |
|    +---------+    +---------+    +---------+               |
|    | SONA 1  |    | SONA 2  |    | SONA N  |               |
|    | Agent   |    | Agent   |    | Agent   |               |
|    |         |    |         |    |         |               |
|    |PRE-TASK:|    |PRE-TASK:|    |PRE-TASK:|               |
|    | Search  |    | Search  |    | Search  |               |
|    | Bank    |    | Bank    |    | Bank    |               |
|    |         |    |         |    |         |               |
|    |EXECUTE: |    |EXECUTE: |    |EXECUTE: |               |
|    | Apply   |    | Apply   |    | Apply   |               |
|    | Pattern |    | Pattern |    | Pattern |               |
|    |         |    |         |    |         |               |
|    |POST:    |    |POST:    |    |POST:    |               |
|    | Store + |    | Store + |    | Store + |               |
|    | Share   |    | Share   |    | Share   |               |
|    +---------+    +---------+    +---------+               |
|                                                              |
|  LEARNING LOOP:                                              |
|  1. RETRIEVE: Search for similar past problems              |
|  2. JUDGE: Score relevance of found patterns                |
|  3. DISTILL: Extract applicable approach                    |
|  4. APPLY: Use pattern in current task                      |
|  5. STORE: Record outcome with reward signal                |
|                                                              |
|  METRICS:                                                    |
|  - 66 SONA agents coordinating                              |
|  - Sub-millisecond learning (&lt;0.05ms)                       |
|  - EWC++ preserves 95%+ knowledge during learning           |
|  - MicroLoRA: 128x parameter compression                    |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h3>SONA Agent Implementation</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>// sona_agent.ts - Full SONA implementation with claude-flow
import { Agent, ReasoningBank, AgentDB, Q_Learning } from 'claude-flow';

interface SONAConfig {
  agentDbUrl: string;
  reasoningBankPath: string;
  litellmProxy: string;
  minRewardScore: number;  // Typically 0.7
}

class SONAAgent extends Agent {
  private reasoningBank: ReasoningBank;
  private qLearning: Q_Learning;
  private agentDb: AgentDB;

  constructor(config: SONAConfig) {
    super();

    // AgentDB for coordination (~61us per query)
    this.agentDb = new AgentDB({
      connectionString: config.agentDbUrl,
      vectorDimensions: 1536,
      indexType: 'ivfflat',  // ~16,400 QPS
    });

    // ReasoningBank for cross-agent learning
    this.reasoningBank = new ReasoningBank({
      storagePath: config.reasoningBankPath,
      ewcPlusEnabled: true,  // 95%+ knowledge retention
      microLoRAEnabled: true,  // 128x parameter compression
    });

    // Q-Learning for adaptive routing (&lt;0.05ms decisions)
    this.qLearning = new Q_Learning({
      learningRate: 0.1,
      discountFactor: 0.95,
      explorationRate: 0.1,
    });
  }

  async executeTask(task: Task): Promise&lt;Result&gt; {
    // PRE-TASK: Search ReasoningBank for similar problems
    const patterns = await this.reasoningBank.search({
      problemSignature: this.computeSignature(task),
      limit: 5,
      minScore: 0.7,
    });

    // Select model via Q-Learning router
    const model = this.qLearning.selectAction(task.complexity);

    // EXECUTE: Apply best pattern (or explore new approach)
    const result = await this.execute(task, patterns, model);

    // POST: Store outcome if reward &gt; threshold
    if (result.reward &gt; this.config.minRewardScore) {
      await this.reasoningBank.store({
        problemSignature: this.computeSignature(task),
        solutionPattern: result.approach,
        rewardScore: result.reward,
        model: model,
      });

      // Update Q-Learning with reward
      this.qLearning.update(task.complexity, model, result.reward);
    }

    return result;
  }
}</pre>
      </div>

      <h2>Swarm Topologies</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|              SWARM TOPOLOGIES                                |
|                                                              |
|  HIERARCHICAL                 MESH                          |
|  ------------                 ----                          |
|       +-----+              +----+   +----+                  |
|       |Queen|              | A  |&lt;-&gt;| B  |                  |
|       +--+--+              +--+-+   +-+--+                  |
|     +----+----+               |       |                     |
|     |    |    |               v       v                     |
|    W1   W2   W3            +----+   +----+                  |
|                            | C  |&lt;-&gt;| D  |                  |
|  Best: Clear structure     +----+   +----+                  |
|        Large scale         Best: High availability          |
|                                 No SPOF                     |
|                                                              |
|  STAR                         RING                          |
|  ----                         ----                          |
|      W1   W2                 +----+                         |
|        \ /                   | A  |--+                      |
|        Hub                   +--+-+  |                      |
|        / \                      |    |                     |
|      W3   W4                 +--v-+  |                     |
|                              | B  |  |                     |
|  Best: Coordination-heavy    +--+-+  |                     |
|                                 |    |                     |
|                              +--v-+  |                     |
|                              | C  |--+                     |
|                              +----+                         |
|                              Best: Pipeline processing      |
|                                                              |
|  ADAPTIVE                                                    |
|  --------                                                    |
|  Auto-switches topology based on:                           |
|  - Workload pattern detection                               |
|  - Agent availability                                        |
|  - Latency requirements                                      |
|  - Fault tolerance needs                                     |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h2>Mesh/Peer-to-Peer (Decentralized Coordination)</h2>

      <p>Mesh architecture removes the central orchestrator entirely. Agents coordinate through gossip protocols and message passing.</p>

      <h3>Architecture Diagram</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>    +---------+     +---------+
    | Agent A |&lt;---&gt;| Agent B |
    +----+----+     +----+----+
         |               |
         v               v
    +---------+     +---------+
    | Agent C |&lt;---&gt;| Agent D |
    +---------+     +---------+

    Communication: Async message passing
    Coordination: Gossip protocol
    State: Eventually consistent</pre>
      </div>

      <h3>When to Use Mesh Over Hub-Spoke</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Factor</th>
              <th>Hub-Spoke</th>
              <th>Mesh</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Agent count</td>
              <td>5-20</td>
              <td>20-100+</td>
            </tr>
            <tr>
              <td>Fault tolerance</td>
              <td>Single point of failure</td>
              <td>No SPOF</td>
            </tr>
            <tr>
              <td>Coordination overhead</td>
              <td>Centralized</td>
              <td>Distributed</td>
            </tr>
            <tr>
              <td>Complexity</td>
              <td>Simpler</td>
              <td>More complex</td>
            </tr>
            <tr>
              <td>Consistency</td>
              <td>Strong</td>
              <td>Eventual</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3>Message Protocol</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>type AgentMessage struct {
    From      string
    To        string // "*" for broadcast
    Type      string // "task", "result", "heartbeat", "claim"
    Payload   json.RawMessage
    Timestamp time.Time
    TTL       int // hops remaining
}

// Advisory reservation prevents double-work
type Reservation struct {
    TaskID    string
    AgentID   string
    ExpiresAt time.Time
}</pre>
      </div>

      <h3>Trade-offs</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Benefit</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>No single point of failure</td>
              <td>Complex coordination logic</td>
            </tr>
            <tr>
              <td>Horizontal scaling</td>
              <td>Harder to debug</td>
            </tr>
            <tr>
              <td>Autonomous agents</td>
              <td>Eventual consistency only</td>
            </tr>
            <tr>
              <td>Fault tolerant</td>
              <td>Gossip protocol overhead</td>
            </tr>
            <tr>
              <td>Works across network partitions</td>
              <td>No global ordering guarantees</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Performance Benchmarks</h2>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th>Value</th>
              <th>Context</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Task execution</td>
              <td>2.8-4.4x faster</td>
              <td>Than baseline single-agent</td>
            </tr>
            <tr>
              <td>Swarm spawning</td>
              <td>10-20x batch acceleration</td>
              <td>For parallel task creation</td>
            </tr>
            <tr>
              <td>Vector search</td>
              <td>~61us per query</td>
              <td>16,400 QPS on AgentDB</td>
            </tr>
            <tr>
              <td>SWE-Bench</td>
              <td>84.8% solve rate</td>
              <td>Industry-leading</td>
            </tr>
            <tr>
              <td>Q-Learning routing</td>
              <td>&lt;0.05ms</td>
              <td>Adaptive task routing</td>
            </tr>
            <tr>
              <td>Learning retention</td>
              <td>95%+</td>
              <td>EWC++ knowledge preservation</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>LiteLLM Configuration for Swarm Scale</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre># litellm_swarm_config.yaml - Optimized for 30-100+ agents
model_list:
  - model_name: swarm-opus
    litellm_params:
      model: claude-sonnet-4-20250514
      max_budget: 100  # Per-agent daily limit
      budget_duration: daily
      rpm_limit: 50   # Rate limit per agent
      tpm_limit: 50000

  - model_name: swarm-sonnet
    litellm_params:
      model: claude-sonnet-4-20250514
      max_budget: 40
      rpm_limit: 100
      tpm_limit: 100000

  - model_name: swarm-haiku
    litellm_params:
      model: claude-3-haiku-20240307
      max_budget: 10
      rpm_limit: 200
      tpm_limit: 200000

litellm_settings:
  # Semantic caching critical at swarm scale
  cache: true
  cache_params:
    type: qdrant
    host: ${QDRANT_HOST}
    port: 6333
    similarity_threshold: 0.92  # Slightly lower for higher hit rate

  # Budget enforcement prevents runaway swarms
  budget_duration: daily
  max_budget: 3000  # Total swarm daily cap

  # Swarm-specific callbacks
  callbacks: ["langfuse", "prometheus", "budget_alert"]

  # Aggressive retry with fallback
  num_retries: 5
  retry_after: 1
  fallback_models:
    swarm-opus: ["swarm-sonnet", "swarm-haiku"]
    swarm-sonnet: ["swarm-haiku"]

router_settings:
  routing_strategy: least-busy  # Distribute load across models
  enable_pre_call_check: true
  cooldown_time: 10  # Fast recovery for swarm throughput</pre>
      </div>

      <h2>AgentDB Schema for Swarm Coordination</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>-- agentdb_swarm_schema.sql - Extended for 100+ agents
CREATE TABLE sona_agents (
    id UUID PRIMARY KEY,
    swarm_id UUID NOT NULL,
    status VARCHAR(20) NOT NULL,
    model_preference VARCHAR(50),
    total_reward FLOAT DEFAULT 0,
    tasks_completed INTEGER DEFAULT 0,
    current_task_id UUID REFERENCES swarm_tasks(id),
    last_heartbeat TIMESTAMP NOT NULL DEFAULT NOW(),
    q_state JSONB  -- Q-Learning state
);

CREATE TABLE swarm_tasks (
    id UUID PRIMARY KEY,
    swarm_id UUID NOT NULL,
    assigned_agent_id UUID REFERENCES sona_agents(id),
    problem_signature vector(1536),  -- For ReasoningBank similarity
    status VARCHAR(20) NOT NULL,
    priority INTEGER DEFAULT 5,
    estimated_cost FLOAT,
    actual_cost FLOAT,
    reward FLOAT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TABLE reasoning_bank (
    id UUID PRIMARY KEY,
    problem_signature vector(1536),
    solution_pattern TEXT,
    reward_score FLOAT NOT NULL,
    application_count INTEGER DEFAULT 0,
    source_agent_id UUID REFERENCES sona_agents(id),
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Indexes for swarm-scale performance
CREATE INDEX sona_agents_swarm_idx ON sona_agents(swarm_id, status);
CREATE INDEX swarm_tasks_pending_idx ON swarm_tasks(swarm_id, status)
    WHERE status = 'pending';
CREATE INDEX reasoning_bank_similarity_idx ON reasoning_bank
    USING ivfflat (problem_signature vector_cosine_ops)
    WITH (lists = 100);  -- Tuned for ~61us queries at scale</pre>
      </div>

      <h2>Swarm Deployment Architecture</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+------------------------------------------------------------------------+
|                    SONA SWARM PRODUCTION STACK                          |
|                                                                         |
|  +------------------+    +------------------+    +------------------+   |
|  |   SONA Agent 1   |    |   SONA Agent 2   |    |   SONA Agent N   |   |
|  | (OpenCode+LSP)   |    | (OpenCode+LSP)   |    | (OpenCode+LSP)   |   |
|  +--------+---------+    +--------+---------+    +--------+---------+   |
|           |                       |                       |             |
|           +-------------------------------------------+             |
|                                   |                                     |
|                                   v                                     |
|                    +------------------------------+                     |
|                    |       LiteLLM Proxy          |                     |
|                    | - Per-agent budgets ($100/d) |                     |
|                    | - Qdrant semantic cache      |                     |
|                    | - Model routing (Q-Learn)    |                     |
|                    | - 50%, 75%, 90% alerts       |                     |
|                    +------------------------------+                     |
|                                   |                                     |
|           +-------------------------------------------+             |
|           |                       |                       |             |
|           v                       v                       v             |
|  +------------------+    +------------------+    +------------------+   |
|  |    AgentDB       |    |  ReasoningBank   |    |    Qdrant        |   |
|  | (PostgreSQL+     |    | (Pattern Store)  |    | (Vector Cache)   |   |
|  |  pgvector)       |    | - EWC++ (95%)    |    | - 16,400 QPS     |   |
|  | - 61us queries   |    | - MicroLoRA      |    | - 30%+ hit rate  |   |
|  +------------------+    +------------------+    +------------------+   |
|                                                                         |
+------------------------------------------------------------------------+</pre>
      </div>

      <h2>Swarm Scaling Guidelines</h2>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Scale</th>
              <th>LiteLLM Config</th>
              <th>AgentDB Config</th>
              <th>ReasoningBank Config</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>30-50 agents</td>
              <td>max_budget: $1500/day</td>
              <td>lists: 50 (ivfflat)</td>
              <td>minRewardScore: 0.7</td>
            </tr>
            <tr>
              <td>50-75 agents</td>
              <td>max_budget: $2500/day</td>
              <td>lists: 75</td>
              <td>minRewardScore: 0.75</td>
            </tr>
            <tr>
              <td>75-100 agents</td>
              <td>max_budget: $3500/day</td>
              <td>lists: 100</td>
              <td>minRewardScore: 0.8</td>
            </tr>
            <tr>
              <td>100+ agents</td>
              <td>max_budget: $5000/day + sharding</td>
              <td>Partitioned tables</td>
              <td>Sharded by domain</td>
            </tr>
          </tbody>
        </table>
      </div>

      <details class="troubleshoot">
        <summary>Swarm infrastructure problems</summary>
        <div class="troubleshoot-content">
          <table>
            <tr>
              <th>Symptom</th>
              <th>Cause</th>
              <th>Recovery</th>
            </tr>
            <tr>
              <td>Swarm exhausts budget in 2 hours</td>
              <td>Per-agent limits too high</td>
              <td>Reduce per-agent max_budget; add aggressive alerting</td>
            </tr>
            <tr>
              <td>ReasoningBank patterns degrade quality</td>
              <td>Bad patterns propagating</td>
              <td>Increase minRewardScore; purge low-reward entries</td>
            </tr>
            <tr>
              <td>AgentDB queries slow (&gt;100ms)</td>
              <td>Index not optimized</td>
              <td>Rebuild ivfflat index with more lists; check vacuum</td>
            </tr>
            <tr>
              <td>Agents stuck waiting for models</td>
              <td>LiteLLM rate limits</td>
              <td>Increase rpm_limit; add more fallback models</td>
            </tr>
            <tr>
              <td>Q-Learning not improving</td>
              <td>Exploration too low</td>
              <td>Increase explorationRate; reset Q-state periodically</td>
            </tr>
          </table>
        </div>
      </details>

      <h2>Hierarchical Queen/Worker (Enterprise Scale)</h2>

      <p>For true enterprise scale (64+ agents), the Queen/Worker pattern provides Byzantine fault tolerance.</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>                       +-----------------+
                       |      QUEEN      |
                       |  (Meta-orchestr)|
                       +--------+--------+
           +-------------------+|+-------------------+
           |                   ||                   |
           v                   vv                   v
     +----------+        +----------+        +----------+
     | WITNESS  |        | WITNESS  |        | WITNESS  |
     | (Rig 1)  |        | (Rig 2)  |        | (Rig 3)  |
     +----+-----+        +----+-----+        +----+-----+
          |                   |                   |
    +-----+-----+       +-----+-----+       +-----+-----+
    |     |     |       |     |     |       |     |     |
    v     v     v       v     v     v       v     v     v
   W1    W2    W3      W4    W5    W6      W7    W8    W9

   Scale: 64+ agents across multiple rigs
   Coordination: Queen -&gt; Witness -&gt; Workers (3-tier)
   Fault Tolerance: Byzantine (survives 33% failure)</pre>
      </div>

      <h3>Key Innovations</h3>

      <ul>
        <li><strong>3-Tier Hierarchy:</strong> Queen decomposes to Witnesses; Witnesses manage Workers</li>
        <li><strong>Rig Isolation:</strong> Each rig operates semi-independently (project-level)</li>
        <li><strong>Byzantine FT:</strong> 2/3 consensus with weighted voting (Queen = 3x weight)</li>
        <li><strong>Scale:</strong> Proven at 64+ agents in production</li>
      </ul>

      <h3>Coordination Protocol</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Queen                    Witness                  Worker
  |                        |                        |
  |---[convoy:tasks]------&gt;|                        |
  |                        |---[sling:task]--------&gt;|
  |                        |                        |--[execute]
  |                        |&lt;--[result:outcome]-----|
  |&lt;--[witness:summary]----|                        |
  |                        |                        |</pre>
      </div>

      <h3>Trade-offs</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Benefit</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>True enterprise scale (64+ agents)</td>
              <td>Complex infrastructure</td>
            </tr>
            <tr>
              <td>Byzantine fault tolerance</td>
              <td>3x resource overhead for consensus</td>
            </tr>
            <tr>
              <td>Rig-level isolation</td>
              <td>Coordination latency between rigs</td>
            </tr>
            <tr>
              <td>Self-healing (restarts failed agents)</td>
              <td>Requires deep expertise</td>
            </tr>
            <tr>
              <td>Multi-project parallelism</td>
              <td>Significant setup time (8-16 hours)</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Quick Reference: Enterprise Pattern Selection</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>COMPLIANCE?     SELF-LEARNING?     SCALE?           -&gt; USE THIS
--------------------------------------------------------------------
No              No                 &lt;30 agents       -&gt; Gas Town
No              Yes                30-100           -&gt; SONA Swarm
Yes             No                 Any              -&gt; BMAD-METHOD Enterprise
Yes             Yes                100+             -&gt; Full Enterprise Stack</pre>
      </div>

      <!-- Footer navigation -->
      <div class="footer-nav">
        <a href="core-patterns.html" class="nav-prev">
          <span class="nav-direction">Previous</span>
          <span class="nav-title">Core Patterns</span>
        </a>
        <a href="context-composition.html" class="nav-next">
          <span class="nav-direction">Next</span>
          <span class="nav-title">Context &amp; Composition</span>
        </a>
      </div>

    </main>
  </div>

  <!-- Mobile toggle button -->
  <button class="sidebar-toggle" aria-label="Open navigation">&#9776;</button>

  <script src="../../js/sidebar.js"></script>
</body>
</html>
