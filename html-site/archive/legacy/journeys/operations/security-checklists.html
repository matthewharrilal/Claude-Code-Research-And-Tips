<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta data-pagefind-meta="chapter" content="Journeys">
  <meta data-pagefind-meta="section" content="Operations">
  <title>Security + Operational Checklists - Operations Journey</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
</head>
<body>
  <div class="page-with-sidebar">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <button class="sidebar-close" aria-label="Close sidebar">&times;</button>
      <div class="sidebar-header">
        <h2 class="sidebar-title"><a href="../../index.html">Claude Code KB</a></h2>
      </div>
      <ul class="sidebar-nav">
        <li class="nav-section">
          <div class="nav-section-title">Start Here</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../../start-here/index.html">Overview</a></li>
            <li class="nav-page"><a href="../../start-here/master-playbook.html">Master Playbook</a></li>
            <li class="nav-page"><a href="../../start-here/judgment-guide.html">Judgment Guide</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Foundations</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../../foundations/index.html">Overview</a></li>
            <li class="nav-page"><a href="../../foundations/principles/core.html">Core Principles</a></li>
            <li class="nav-page"><a href="../../foundations/architecture/complexity-ladder.html">Complexity Ladder</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Mental Models Journey</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../mental-models/index.html">Overview</a></li>
            <li class="nav-page"><a href="../mental-models/core-models.html">Core Models (1-10)</a></li>
            <li class="nav-page"><a href="../mental-models/advanced-models.html">Advanced Models (11-16)</a></li>
            <li class="nav-page"><a href="../mental-models/practice-heuristics.html">Practice &amp; Heuristics</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Architecture Journey</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../architecture/index.html">Overview</a></li>
            <li class="nav-page"><a href="../architecture/decision-framework.html">Decision Framework</a></li>
            <li class="nav-page"><a href="../architecture/core-patterns.html">Core Patterns</a></li>
            <li class="nav-page"><a href="../architecture/enterprise-swarm.html">Enterprise &amp; Swarm</a></li>
            <li class="nav-page"><a href="../architecture/context-composition.html">Context &amp; Composition</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Implementation Journey</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../implementation/index.html">Overview</a></li>
            <li class="nav-page"><a href="../implementation/context-state.html">Context &amp; State</a></li>
            <li class="nav-page"><a href="../implementation/ralph-production.html">Ralph Production</a></li>
            <li class="nav-page"><a href="../implementation/hooks-enterprise.html">Hooks &amp; Enterprise</a></li>
          </ul>
        </li>
        <li class="nav-section open">
          <div class="nav-section-title">Operations Journey</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../operations/index.html">Overview</a></li>
            <li class="nav-page"><a href="../operations/monitoring-cost.html">Monitoring &amp; Cost</a></li>
            <li class="nav-page current"><a href="../operations/security-checklists.html">Security &amp; Checklists</a></li>
            <li class="nav-page"><a href="../operations/incident-response.html">Incident Response</a></li>
          </ul>
        </li>
        <li class="nav-section">
          <div class="nav-section-title">Reference</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../foundations/invariants-reference.html">Invariants Reference</a></li>
            <li class="nav-page"><a href="../../reference/index.html">Full Reference</a></li>
            <li class="nav-page"><a href="../../reference/cost-analysis.html">Cost Analysis</a></li>
          </ul>
        </li>
      </ul>
    </nav>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">
      <nav class="breadcrumb">
        <a href="../../index.html">Home</a>
        <span class="breadcrumb-separator">/</span>
        <a href="../index.html">Journeys</a>
        <span class="breadcrumb-separator">/</span>
        <a href="index.html">Operations</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">Security + Checklists</span>
      </nav>

      <div class="page-meta">
        <span class="page-meta-item">29 min read</span>
        <span class="page-meta-item">Security + Operations</span>
      </div>

      <h1>Security + Operational Checklists</h1>

      <div class="context-box you-are-here">
        <h3>You Are Here</h3>
        <p><strong>The Big Picture:</strong> You have Claude Code monitoring in place and understand cost management. Now you need to secure your setup - preventing dangerous commands, protecting credentials, and establishing operational checklists. Security is what makes autonomous operation safe.</p>
        <p><strong>What this covers:</strong></p>
        <ul>
          <li>Credential management and rotation policies</li>
          <li>Command and permission gating</li>
          <li>Human-in-the-loop security (12-factor agents Factor 7)</li>
          <li>Security Control Manifests (BMAD-METHOD)</li>
          <li>Pre-production, session startup, and end-of-run checklists</li>
          <li>Daily/weekly/monthly operational maintenance</li>
        </ul>
        <p><strong>Time estimate:</strong></p>
        <ul>
          <li>Skim for awareness: 15 minutes</li>
          <li>Full implementation: 1-2 hours</li>
          <li>Reference during setup: As needed</li>
        </ul>
        <p><strong>Prerequisites:</strong></p>
        <ul>
          <li>Completed <a href="monitoring-cost.html">Monitoring + Cost Management</a></li>
          <li>Access to your Claude configuration (<code>~/.claude/</code>)</li>
          <li>Understanding of hooks system</li>
        </ul>
        <p><strong>Coming from:</strong> <a href="monitoring-cost.html">Monitoring + Cost</a> | <strong>Going to:</strong> <a href="incident-response.html">Incident Response</a></p>
      </div>

      <p>This guide covers security controls, permission gating, and operational checklists for every phase of Claude Code operation. Security is not optional - it is the foundation that makes autonomous operation safe.</p>

      <hr class="section-divider">

      <h2 id="credential-management">Part 1: Credential Management</h2>

      <h3>The Golden Rules</h3>

      <p>The 12-factor-agents framework emphasizes controlling sensitive aspects of your agent workflow:</p>

      <ol>
        <li><strong>Never in code or config files</strong> - API keys do not belong in committed files</li>
        <li><strong>Environment variables for local dev</strong> - <code>export ANTHROPIC_API_KEY=...</code></li>
        <li><strong>Secrets manager for production</strong> - HashiCorp Vault, AWS Secrets Manager</li>
        <li><strong>Rotate on exposure</strong> - If a key might be compromised, rotate immediately</li>
      </ol>

      <h3>Credential Hierarchy</h3>

      <table>
        <thead>
          <tr>
            <th>Level</th>
            <th>Purpose</th>
            <th>Rotation</th>
            <th>Storage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Master Key</strong></td>
            <td>Admin operations</td>
            <td>Quarterly</td>
            <td>Secrets manager only</td>
          </tr>
          <tr>
            <td><strong>Team Keys</strong></td>
            <td>Department access</td>
            <td>Monthly</td>
            <td>Secrets manager</td>
          </tr>
          <tr>
            <td><strong>User Keys</strong></td>
            <td>Individual developers</td>
            <td>On exposure</td>
            <td>Environment variables</td>
          </tr>
          <tr>
            <td><strong>Virtual Keys</strong></td>
            <td>Project-specific, ephemeral</td>
            <td>On suspected exposure</td>
            <td>LiteLLM database</td>
          </tr>
        </tbody>
      </table>

      <h3>Compliance Ledger for Credentials</h3>

      <p>Every credential operation should be logged for audit purposes:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# ~/.claude/scripts/credential-ledger.sh
# Log credential operations for compliance

LEDGER_FILE="$HOME/.claude/audit/credential-ledger.jsonl"
mkdir -p "$(dirname "$LEDGER_FILE")"

log_credential_event() {
    local EVENT_TYPE="$1"
    local KEY_TYPE="$2"
    local DETAILS="$3"

    jq -n \
        --arg ts "$(date -Iseconds)" \
        --arg type "$EVENT_TYPE" \
        --arg key "$KEY_TYPE" \
        --arg user "$(whoami)" \
        --arg details "$DETAILS" \
        '{timestamp: $ts, event_type: $type, key_type: $key, user: $user, details: $details}' \
        >> "$LEDGER_FILE"
}

# Usage: log_credential_event "rotation" "team" "Monthly scheduled rotation"
# Usage: log_credential_event "revocation" "virtual" "Suspected compromise"</code></pre>
      </div>

      <hr class="section-divider">

      <!-- Woven Summary: Security Anti-Patterns -->
      <div class="woven-summary" style="background: linear-gradient(135deg, #fef6f5 0%, #fefcf3 100%); border-left: 4px solid #c97065; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
        <h3 style="color: #c97065; margin-top: 0; font-size: 1.1em;">Deep Dive: Security Anti-Patterns to Avoid</h3>
        <p>Security incidents with Claude Code follow predictable patterns. Understanding what NOT to do is as important as knowing what to do.</p>

        <h4>Critical Security Anti-Patterns</h4>
        <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
          <thead>
            <tr style="background: #f5e0de;">
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">Anti-Pattern</th>
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">What Happens</th>
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">Prevention</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;"><code>--dangerously-skip-permissions</code></td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Claude can execute ANY command including <code>rm -rf /</code></td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Granular permission whitelisting</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">.env files in context</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">API keys, passwords leak into conversation history</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Add to .claudeignore, use env vars</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Path traversal not blocked</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Claude accesses <code>~/.ssh/</code>, <code>~/.aws/</code></td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Deny patterns for sensitive paths</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Claude modifying its own instructions</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Prompt injection alters agent behavior</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;"><code>chmod 444 CLAUDE.md</code></td>
            </tr>
          </tbody>
        </table>

        <h4>Commands to NEVER Whitelist</h4>
        <div class="code-block" style="background: #f0ebe3; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
          <pre style="margin: 0; font-family: monospace; font-size: 0.9em;"><code># Destructive file operations
rm -rf, find . -delete

# Git destruction
git push --force, git reset --hard, git clean -fd

# System modification
sudo *, chmod -R 777

# Remote code execution
curl | bash, wget -O- | sh</code></pre>
        </div>

        <p style="margin-bottom: 0;"><a href="../../synthesis/principles-anti-patterns.html" style="color: #2a7d7d;">Full Anti-Pattern Catalog</a> - 11 anti-pattern categories with detection checklists and recovery strategies.</p>
      </div>

      <h2 id="command-gating">Part 2: Command and Permission Gating</h2>

      <h3>Stakes Classification</h3>

      <p>Not all operations need the same level of oversight. The 12-factor-agents framework classifies function stakes:</p>

      <table>
        <thead>
          <tr>
            <th>Stakes Level</th>
            <th>Examples</th>
            <th>Oversight Requirement</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Low</strong></td>
            <td>Read-only operations, public data</td>
            <td>None - autonomous OK</td>
          </tr>
          <tr>
            <td><strong>Medium</strong></td>
            <td>Private data access, templated output</td>
            <td>Audit logging, spot checks</td>
          </tr>
          <tr>
            <td><strong>High</strong></td>
            <td>User communications, sensitive writes</td>
            <td>Mandatory human approval</td>
          </tr>
        </tbody>
      </table>

      <h4>Applied to Claude Code Commands</h4>

      <table>
        <thead>
          <tr>
            <th>Command Type</th>
            <th>Stakes</th>
            <th>Required Gate</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>git status</code>, <code>ls</code>, <code>cat</code></td>
            <td>Low</td>
            <td>None</td>
          </tr>
          <tr>
            <td><code>git add</code>, file edits</td>
            <td>Medium</td>
            <td>Audit log</td>
          </tr>
          <tr>
            <td><code>git push</code>, <code>rm -rf</code>, <code>deploy</code></td>
            <td>High</td>
            <td>Human approval</td>
          </tr>
        </tbody>
      </table>

      <h3>Procedure: Configure Command Blocklist</h3>

      <p>Create file: <code>~/.claude/hooks/command-block.sh</code></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# ~/.claude/hooks/command-block.sh
# PreToolUse hook for dangerous command blocking

COMMAND="$1"

# Absolute blocklist - never execute
BLOCKED_PATTERNS=(
    "rm -rf /"
    "rm -rf ~"
    "rm -rf \$HOME"
    "git push --force"
    "git push -f origin main"
    "DROP DATABASE"
    "DELETE FROM .* WHERE 1"
    "chmod -R 777"
    "sudo rm"
)

for pattern in "${BLOCKED_PATTERNS[@]}"; do
    if [[ "$COMMAND" =~ $pattern ]]; then
        echo "=======================================================" >&2
        echo "BLOCKED: Dangerous command pattern detected" >&2
        echo "Command: $COMMAND" >&2
        echo "Pattern: $pattern" >&2
        echo "=======================================================" >&2
        echo "" >&2
        echo "If this command is actually needed:" >&2
        echo "  1. Execute manually in a separate terminal" >&2
        echo "  2. Double-check before running" >&2
        echo "  3. Have backups ready" >&2
        echo "=======================================================" >&2
        exit 1
    fi
done

exit 0</code></pre>
      </div>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>chmod +x ~/.claude/hooks/command-block.sh</code></pre>
      </div>

      <h3>Procedure: Configure Protected Paths</h3>

      <p>Add to command-block.sh:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># Protected paths - require extra confirmation
PROTECTED_PATHS=(
    "**/prod/**"
    "**/.env.prod*"
    "**/credentials.*"
    "**/secrets.*"
    "**/.ssh/**"
)

FILE_PATH="$2"

for pattern in "${PROTECTED_PATHS[@]}"; do
    if [[ "$FILE_PATH" == $pattern ]]; then
        echo "=======================================================" >&2
        echo "PROTECTED PATH: $FILE_PATH" >&2
        echo "This path requires manual operation." >&2
        echo "=======================================================" >&2
        exit 1
    fi
done</code></pre>
      </div>

      <h3>Permission Configuration YAML</h3>

      <p>For fine-grained control:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># permission-config.yaml

permissions:
  bash:
    - pattern: "rm -rf *"
      action: deny
      log: true

    - pattern: "git push --force *"
      action: deny
      log: true

    - pattern: "git *"
      action: allow

    - pattern: "npm *"
      action: allow

    - pattern: "*"
      action: ask  # Require confirmation

  file_edit:
    - pattern: "*.env*"
      action: deny
      log: true

    - pattern: "**/prod/**"
      action: deny
      log: true

    - pattern: "*"
      action: allow</code></pre>
      </div>

      <hr class="section-divider">

      <h2 id="hitl-security">Part 3: Human-in-the-Loop Security</h2>

      <h3>Why HITL Matters</h3>

      <p>The 12-factor-agents Factor 7 principle states: high-stakes operations require human approval as a structured tool call, not ad-hoc prompts. This provides:</p>

      <ul>
        <li><strong>Clear Instructions</strong> - Structured approval requests enable specific instructions</li>
        <li><strong>Audit Trails</strong> - Every approval decision is logged</li>
        <li><strong>Deterministic Guarantees</strong> - Function-level decorators guarantee oversight regardless of LLM behavior</li>
      </ul>

      <h3>HITL Approval Pattern</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># 12-factor-agents approval pattern for Claude Code integration

class RequestHumanApproval:
    """Tool for Claude to request human approval (12-factor Factor 7)"""
    intent: str = "request_human_approval"
    operation: str  # What operation needs approval
    context: str    # Why approval is needed
    urgency: str    # "low", "medium", "high"
    options: list   # Possible responses

def check_approval_required(command: str, stakes: str) -> bool:
    """
    Check if command requires human approval per 12-factor stakes.
    """
    high_stakes_patterns = [
        "deploy", "rm -rf", "git push", "DROP", "DELETE",
        "production", "credentials", "secrets"
    ]

    for pattern in high_stakes_patterns:
        if pattern in command.lower():
            log_to_compliance_ledger("APPROVAL_REQUIRED", command)
            return True
    return False</code></pre>
      </div>

      <h3>Tool Input Validation</h3>

      <p>Validate all tool inputs before execution to prevent injection:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>from typing import Any, Dict
import re

def validate_tool_input(tool_name: str, input_data: Dict[str, Any]) -> tuple[bool, str]:
    """
    Validate tool inputs per anthropic-cookbook patterns.
    Returns (is_valid, error_message).
    """
    # Prompt injection defense
    injection_patterns = [
        r'ignore\s+previous\s+instructions',
        r'disregard\s+all\s+prior',
        r'you\s+are\s+now',
        r'new\s+instructions?:',
    ]

    for key, value in input_data.items():
        if isinstance(value, str):
            for pattern in injection_patterns:
                if re.search(pattern, value, re.IGNORECASE):
                    return False, f"Potential injection in {key}"

    # Path traversal defense
    if 'path' in input_data or 'file' in input_data:
        path_value = input_data.get('path') or input_data.get('file', '')
        if '..' in path_value or path_value.startswith('/'):
            return False, "Path traversal attempt detected"

    return True, ""</code></pre>
      </div>

      <hr class="section-divider">

      <h2 id="control-manifest">Part 4: Security Control Manifest</h2>

      <p>Create a security Control Manifest to define protected zones and constraints:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># .claude/security-manifest.yaml
# Control Manifest for Claude Code

version: "1.0"
compliance_frameworks:
  - SOC2
  - HIPAA  # if applicable

protected_zones:
  # Files that CANNOT be modified by Claude
  read_only:
    - "**/.env*"
    - "**/secrets/**"
    - "**/credentials/**"
    - "**/auth/keys/**"

  # Files requiring human approval to modify
  approval_required:
    - "**/security/**"
    - "**/auth/**"
    - "**/production/**"
    - "Dockerfile*"
    - "docker-compose*.yml"

# Security constraints
constraints:
  - name: "no_hardcoded_secrets"
    check: "grep -rn 'password\\|secret\\|api_key' --include='*.py' --include='*.js'"
    fail_on_match: true

  - name: "no_eval_usage"
    check: "grep -rn 'eval(' --include='*.py' --include='*.js'"
    fail_on_match: true

  - name: "sql_injection_check"
    check: "grep -rn 'execute.*%s\\|execute.*f\"' --include='*.py'"
    fail_on_match: true

# Audit requirements
audit:
  log_all_edits: true
  log_all_commands: true
  retention_days: 90
  export_format: "jsonl"</code></pre>
      </div>

      <h3>Integrate Control Manifest with Hooks</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# ~/.claude/hooks/security-manifest-check.sh
# Control Manifest enforcement hook

MANIFEST="$PWD/.claude/security-manifest.yaml"
FILE_PATH="$1"
OPERATION="$2"

if [ ! -f "$MANIFEST" ]; then
    exit 0  # No manifest, allow operation
fi

# Check read_only zones
if yq e '.protected_zones.read_only[]' "$MANIFEST" 2>/dev/null | grep -q "$FILE_PATH"; then
    echo "SECURITY: File $FILE_PATH is in read_only zone" >&2
    echo "Control Manifest violation - operation blocked" >&2
    exit 1
fi

# Check approval_required zones
if yq e '.protected_zones.approval_required[]' "$MANIFEST" 2>/dev/null | grep -q "$FILE_PATH"; then
    echo "SECURITY: File $FILE_PATH requires human approval" >&2
    exit 2  # Special exit code for approval required
fi

exit 0</code></pre>
      </div>

      <div class="checkpoint">
        <div class="checkpoint-header">Checkpoint: Security Configuration</div>
        <div class="checkpoint-content">
          <ul>
            <li>Command blocklist hook installed</li>
            <li>Protected paths configured for production files</li>
            <li>API keys stored in environment variables (not config files)</li>
            <li>Security Control Manifest created</li>
            <li>You understand deny, allow, and ask actions</li>
          </ul>
        </div>
      </div>

      <details class="troubleshoot">
        <summary>Legitimate command blocked</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">Blocklist pattern too broad.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Refine the pattern in the blocklist or execute the command manually in a separate terminal.</p>
          </div>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>Protected path false positive</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">Work file in protected directory pattern.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Add an exception to the Control Manifest for legitimate paths.</p>
          </div>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>API key exposed in git</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">Committed by mistake.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Rotate the key immediately. Use <code>git filter-branch</code> or BFG Repo-Cleaner to remove from history.</p>
          </div>
        </div>
      </details>

      <hr class="section-divider">

      <!-- Woven Summary: Debugging Agent Failures -->
      <div class="woven-summary" style="background: linear-gradient(135deg, #f5f0e8 0%, #fefcf3 100%); border-left: 4px solid #c49052; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
        <h3 style="color: #c49052; margin-top: 0; font-size: 1.1em;">Deep Dive: Debugging Agent Security Issues</h3>
        <p>Security failures follow the same diagnosis framework as other agent failures: Observe, Hypothesize, Isolate, Verify (OHIV).</p>

        <h4>The 80-20 Rule of Security Failures</h4>
        <p><strong>80% of security incidents come from:</strong></p>
        <ol>
          <li><strong>Missing permission gating</strong> - Dangerous commands not blocked</li>
          <li><strong>Credentials in context</strong> - .env files loaded into conversation</li>
          <li><strong>No audit trail</strong> - Cannot determine what happened post-incident</li>
        </ol>

        <h4>Security Failure Detection Signals</h4>
        <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
          <thead>
            <tr style="background: #e0d5c5;">
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">Signal</th>
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">Detection</th>
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">Response</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Dangerous command attempted</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">PreToolUse hook exit 1</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Block + log to compliance ledger</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Protected path access</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Security manifest check</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Block + require human approval</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Credential exposure</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Pattern match in tool input</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Immediate stop + key rotation</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Prompt injection attempt</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Input validation hook</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Quarantine input + investigate</td>
            </tr>
          </tbody>
        </table>

        <p style="margin-bottom: 0;"><a href="../../synthesis/debugging-agent-failures.html" style="color: #2a7d7d;">Full Debugging Guide</a> - OHIV framework, case studies from production, and decision trees for diagnosis.</p>
      </div>

      <h2 id="checklists">Part 5: Operational Checklists</h2>

      <h3>Pre-Production Checklist</h3>

      <p><strong>Use before deploying Claude Code to production environments.</strong></p>

      <h4>Infrastructure</h4>
      <ul>
        <li>LiteLLM proxy deployed (2+ instances for HA if enterprise)</li>
        <li>PostgreSQL configured for persistent data (if enterprise)</li>
        <li>Redis configured for caching and rate limiting (if enterprise)</li>
        <li>Prometheus/Grafana monitoring stack deployed (if enterprise)</li>
        <li>Log aggregation configured (ELK, Loki, etc.)</li>
      </ul>

      <h4>Safety Configuration</h4>
      <ul>
        <li>Command blocklist hook installed</li>
        <li>Cost monitor hook installed</li>
        <li>Rate limit hook installed</li>
        <li>Context monitor hook installed</li>
        <li>CLAUDE.md exists with project context</li>
        <li>.claudeignore configured</li>
      </ul>

      <h4>Security</h4>
      <ul>
        <li>Master key stored in secrets manager (not in code)</li>
        <li>Virtual keys configured per team/project</li>
        <li>Permission patterns configured (allow/deny/ask)</li>
        <li>Security Control Manifest created</li>
        <li>Compliance Ledger logging enabled</li>
        <li>Protected zones defined</li>
      </ul>

      <h4>Cost Controls</h4>
      <ul>
        <li>Global budget cap configured</li>
        <li>Per-team budgets allocated (if enterprise)</li>
        <li>Per-user quotas set (if enterprise)</li>
        <li>Budget alert thresholds configured</li>
        <li><code>--max-iterations</code> set for all loops</li>
      </ul>

      <h4>Testing</h4>
      <ul>
        <li>Load testing completed</li>
        <li>Failover testing completed</li>
        <li>Cost limit testing completed</li>
        <li>Security scanning completed</li>
        <li>HITL approval flow tested</li>
      </ul>

      <hr class="section-divider">

      <h3>Session Startup Checklist</h3>

      <p><strong>Use before starting any Claude Code session.</strong></p>

      <h4>Quick Verification Script</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># Run this before every session
~/.claude/scripts/preflight.sh && claude</code></pre>
      </div>

      <p>Create <code>~/.claude/scripts/preflight.sh</code>:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# Pre-flight check script

echo "=== Claude Code Pre-Flight Check ==="

# Git state
echo -n "Git status: "
if git status --porcelain | grep -q .; then
    echo "UNCOMMITTED CHANGES (OK if intentional)"
else
    echo "Clean"
fi

# Branch
echo "Branch: $(git branch --show-current)"

# Rollback point
echo "Last commit: $(git log -1 --format='%h %s')"

# Resources
echo -n "Disk space: "
df -h . | tail -1 | awk '{print $4 " available"}'

# Debug directory size
DEBUG_SIZE=$(du -sh ~/.claude/debug 2>/dev/null | cut -f1)
echo "Debug dir: ${DEBUG_SIZE:-"empty"}"

# Zombie processes
ZOMBIE_COUNT=$(pgrep -f claude 2>/dev/null | wc -l | tr -d ' ')
if [ "$ZOMBIE_COUNT" -gt 0 ]; then
    echo "WARNING: $ZOMBIE_COUNT Claude processes already running"
else
    echo "No zombie processes"
fi

echo "=== Pre-flight complete ==="</code></pre>
      </div>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>chmod +x ~/.claude/scripts/preflight.sh</code></pre>
      </div>

      <h4>Full Checklist</h4>

      <p><strong>Environment Verification</strong></p>
      <ul>
        <li>Git status clean OR changes intentionally uncommitted</li>
        <li>On correct branch for work</li>
        <li>Recent commit exists as rollback point</li>
        <li>Working directory is correct project</li>
      </ul>

      <p><strong>Safety Configuration</strong></p>
      <ul>
        <li>Command blocklist hook installed</li>
        <li>Cost monitor hook installed (if autonomous)</li>
        <li>Rate limit hook installed (if heavy tool use expected)</li>
        <li>CLAUDE.md exists with project context</li>
      </ul>

      <p><strong>Resource Check</strong></p>
      <ul>
        <li>Disk space >5GB available</li>
        <li>Claude debug directory <1GB</li>
        <li>No zombie Claude processes: <code>pgrep -f claude</code></li>
        <li>No stale tmux sessions: <code>tmux ls</code></li>
      </ul>

      <p><strong>For Autonomous/Ralph Loops</strong></p>
      <ul>
        <li><code>--max-iterations</code> flag set</li>
        <li><code>timeout</code> wrapper configured</li>
        <li>Progress logging enabled</li>
        <li>Notification webhook configured</li>
        <li>Budget cap set and monitored</li>
      </ul>

      <hr class="section-divider">

      <h3>End-of-Run Verification</h3>

      <p><strong>Use after completing any Claude Code session.</strong></p>

      <h4>Quick Verification</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># Run after every session
npm test && npx tsc --noEmit && git status</code></pre>
      </div>

      <h4>Full Checklist</h4>

      <p><strong>Work Verification</strong></p>
      <ul>
        <li>Tests pass: <code>npm test</code> / <code>pytest</code></li>
        <li>Types check: <code>npx tsc --noEmit</code></li>
        <li>Lint clean: <code>npm run lint</code></li>
        <li>Changes committed (if work complete)</li>
        <li>Branch pushed (if ready for review)</li>
      </ul>

      <p><strong>State Verification</strong></p>
      <ul>
        <li>No uncommitted sensitive data: <code>git diff</code></li>
        <li>No .env files modified accidentally</li>
        <li>No credentials exposed</li>
        <li><code>thoughts/</code> directory updated with progress</li>
      </ul>

      <p><strong>Cost Verification</strong></p>
      <ul>
        <li>Review session cost: <code>cat /tmp/claude-session-cost.json</code></li>
        <li>Cost within expected range?</li>
        <li>If over budget: document why</li>
      </ul>

      <p><strong>Cleanup</strong></p>
      <ul>
        <li>Kill any background processes: <code>pkill -f claude</code></li>
        <li>Remove temporary files</li>
        <li>Clear session trackers: <code>rm /tmp/claude-*.json</code></li>
        <li>Optional: Clean debug directory</li>
      </ul>

      <hr class="section-divider">

      <h3>Daily Operations Checklist</h3>

      <h4>Solo Practitioner (5 minutes)</h4>
      <ul>
        <li>Check overnight session logs (if any)</li>
        <li>Review any alert notifications</li>
        <li>Verify no zombie processes: <code>pgrep -f claude</code></li>
        <li>Check disk space: <code>df -h ~/.claude</code></li>
      </ul>

      <h4>Team Operations (15 minutes)</h4>
      <ul>
        <li>Review overnight alerts (PagerDuty, Slack)</li>
        <li>Check LiteLLM dashboard: error rates, latency, cost</li>
        <li>Check budget utilization: any users near limits?</li>
        <li>Review security alerts: any blocked requests?</li>
        <li>Verify all proxy instances healthy</li>
      </ul>

      <h4>Weekly Maintenance</h4>
      <ul>
        <li>Review blocked command log: false positives?</li>
        <li>Analyze cost trends: optimization opportunities?</li>
        <li>Rotate virtual keys nearing expiration</li>
        <li>Test failover procedures</li>
        <li>Update runbooks with week's learnings</li>
        <li>Clean old log files: <code>find ~/.claude -name "*.log" -mtime +7 -delete</code></li>
      </ul>

      <h4>Monthly Review</h4>
      <ul>
        <li>Total spend vs. budget: variance analysis</li>
        <li>Incident report: frequency, severity, MTTR</li>
        <li>Security audit: access reviews, key rotation</li>
        <li>Capacity planning: scaling needs?</li>
        <li>Compliance audit extraction and review</li>
        <li>Update CLAUDE.md if needed</li>
      </ul>

      <hr class="section-divider">

      <!-- Woven Summary: Error Taxonomy for Security -->
      <div class="woven-summary" style="background: linear-gradient(135deg, #f5f0e8 0%, #fefcf3 100%); border-left: 4px solid #6b9b7a; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
        <h3 style="color: #6b9b7a; margin-top: 0; font-size: 1.1em;">Deep Dive: Security Error Categories</h3>
        <p>Security errors fall into predictable categories. Knowing the taxonomy helps you build systematic defenses.</p>

        <h4>Security Error Types</h4>
        <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
          <thead>
            <tr style="background: #e0d5c5;">
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">Error Type</th>
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">Characteristics</th>
              <th style="padding: 0.5rem; border: 1px solid #e0d5c5; text-align: left;">Prevention Layer</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;"><strong>Deterministic</strong></td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Same input always causes failure</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Command blocklist, path deny rules</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;"><strong>Non-deterministic</strong></td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Context-dependent, varies by session</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">HITL approval, audit logging</td>
            </tr>
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;"><strong>Cascading</strong></td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Small issue compounds into breach</td>
              <td style="padding: 0.5rem; border: 1px solid #e0d5c5;">Defense in depth, circuit breakers</td>
            </tr>
          </tbody>
        </table>

        <h4>The Failure Cascade Pattern</h4>
        <div class="code-block" style="background: #f0ebe3; padding: 1rem; border-radius: 6px; margin: 1rem 0;">
          <pre style="margin: 0; font-family: monospace; font-size: 0.9em;"><code>Initial Security Gap
        |
        v
    Exploited (credential loaded, path accessed)
        |
        v
    Ignored or undetected
        |
        v
    Compounds (used in subsequent operations)
        |
        v
    Recovery becomes expensive

KEY: Catch security issues at the FIRST layer.
The cost of recovery grows exponentially.</code></pre>
        </div>

        <p style="margin-bottom: 0;"><a href="../../synthesis/error-taxonomy-recovery.html" style="color: #2a7d7d;">Full Error Taxonomy</a> - 9 error categories, 35+ specific error types, and 6 recovery patterns.</p>
      </div>

      <h3>Cost Optimization Checklist</h3>

      <h4>Model Selection</h4>
      <ul>
        <li>Using Haiku for simple tasks (formatting, simple edits)</li>
        <li>Using Sonnet for standard development</li>
        <li>Reserving Opus for complex reasoning only</li>
        <li>Model explicitly specified (not defaulting to expensive)</li>
      </ul>

      <h4>Context Efficiency</h4>
      <ul>
        <li>CLAUDE.md is lean (<15KB)</li>
        <li>.claudeignore excludes irrelevant files</li>
        <li>Not loading large files unnecessarily</li>
        <li>Using subagents for isolated work</li>
      </ul>

      <h4>Loop Efficiency</h4>
      <ul>
        <li><code>--max-iterations</code> set appropriately</li>
        <li>Fresh context per iteration (Ralph pattern)</li>
        <li>Exit conditions clear and checkable</li>
        <li>Progress tracked per iteration</li>
      </ul>

      <h4>Tool Usage</h4>
      <ul>
        <li>Batching file operations (not one edit at a time)</li>
        <li>Caching search results where possible</li>
        <li>Rate limits preventing runaway tool calls</li>
        <li>Expensive tools (web search) used sparingly</li>
      </ul>

      <div class="checkpoint">
        <div class="checkpoint-header">Checkpoint: Checklists Complete</div>
        <div class="checkpoint-content">
          <ul>
            <li>You have copied or bookmarked the pre-flight script</li>
            <li>You understand which checklist to use when</li>
            <li>You know the emergency Ctrl+C kill switch</li>
            <li>You have a plan for what to do when things go wrong</li>
          </ul>
        </div>
      </div>

      <hr class="section-divider">

      <h2 id="next-steps">Next Steps</h2>

      <div class="related-pages">
        <h3>Continue the Operations Journey</h3>
        <ul>
          <li><a href="incident-response.html">Incident Response + Failure Mode Catalog</a> - Recovery procedures for when things go wrong</li>
        </ul>

        <h3>Related Topics</h3>
        <ul>
          <li><a href="monitoring-cost.html">Monitoring + Cost Management</a></li>
          <li><a href="../../techniques/security.html">Security Techniques Deep Dive</a></li>
          <li><a href="../../techniques/hooks.html">Hooks Reference</a></li>
        </ul>
      </div>

      <nav class="footer-nav">
        <a href="monitoring-cost.html" class="nav-prev">
          <span class="nav-direction">Previous</span>
          <span class="nav-title">Monitoring + Cost</span>
        </a>
        <a href="incident-response.html" class="nav-next">
          <span class="nav-direction">Next</span>
          <span class="nav-title">Incident Response</span>
        </a>
      </nav>
    </main>
  </div>

  <!-- Mobile Toggle Button -->
  <button class="sidebar-toggle" aria-label="Toggle navigation">&#9776;</button>

  <script src="../../js/sidebar.js"></script>
</body>
</html>
