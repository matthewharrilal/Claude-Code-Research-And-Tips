<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta data-pagefind-meta="chapter" content="Foundations">
  <meta data-pagefind-meta="section" content="Architecture">
  <title>Agent Pattern Primitives - Claude Code Architecture</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/search.css">
  <style>
    .bionic { font-weight: 700; }

    .you-are-here {
      background: linear-gradient(135deg, #f0ebe3 0%, #fefcf3 100%);
      border-left: 4px solid var(--accent);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .you-are-here h2 {
      margin: 0 0 12px 0;
      padding: 0;
      border: none;
      font-size: 1.1em;
      color: var(--accent);
    }

    .checkpoint {
      background: #f0ebe3;
      border-left: 4px solid var(--success);
      border-radius: 8px;
      padding: 20px 24px;
      margin: 24px 0;
    }

    .checkpoint-header {
      color: var(--success);
      font-weight: 600;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .primitive-category {
      margin: 40px 0;
      padding: 28px;
      background: white;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .primitive-category h2 {
      margin-top: 0;
      color: var(--heading);
    }

    .primitive-box {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid var(--accent);
    }

    .primitive-box h4 {
      margin: 0 0 12px 0;
      color: var(--heading);
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 0.75em;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .code-block-wrapper {
      position: relative;
    }

    .code-block-wrapper:hover .copy-btn {
      opacity: 1;
    }

    .composition-diagram {
      background: var(--code-bg);
      border-radius: 12px;
      padding: 24px;
      margin: 24px 0;
      font-family: 'SF Mono', monospace;
      font-size: 0.85em;
      line-height: 1.5;
      overflow-x: auto;
      white-space: pre;
    }

    .milestone {
      background: linear-gradient(90deg, #6b9b7a 0%, #2a7d7d 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      text-align: center;
      margin: 32px 0;
      font-weight: 600;
    }

    .key-properties {
      background: #e8f4f4;
      border-radius: 8px;
      padding: 16px 20px;
      margin: 16px 0;
    }

    .key-properties strong {
      color: var(--accent);
    }
  </style>
</head>
<body>
  <!-- Search Modal -->
  <div class="search-modal" id="searchModal" aria-hidden="true">
    <div class="search-overlay" onclick="closeSearch()"></div>
    <div class="search-content">
      <div class="search-header">
        <div class="search-input-wrapper">
          <span class="search-icon-input">&#128269;</span>
          <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off" />
          <kbd class="search-kbd">ESC</kbd>
        </div>
      </div>
      <div class="search-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="ch1">Chapter 1</button>
        <button class="filter-btn" data-filter="ch2">Chapter 2</button>
        <button class="filter-btn" data-filter="ch3">Chapter 3</button>
        <button class="filter-btn" data-filter="ch4">Chapter 4</button>
        <button class="filter-btn" data-filter="ref">Reference</button>
      </div>
      <div class="search-results" id="searchResults">
        <div class="search-empty"><p>Start typing to search... (Press Cmd+K anytime)</p></div>
      </div>
      <div class="search-footer">
        <span>&#8593;&#8595; Navigate</span><span>&#8629; Select</span><span>ESC Close</span>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Search Trigger Button -->
    <button class="search-trigger" onclick="openSearch()" aria-label="Search" style="float: right; margin-bottom: 1rem;">
      <span class="search-icon">Cmd+K</span>
      <span class="search-text">Search</span>
    </button>

    <!-- Breadcrumb Navigation -->
    <nav class="nav-breadcrumb">
      <a href="../../index.html">Home</a>
      <span>/</span>
      <a href="../index.html">Foundations</a>
      <span>/</span>
      <a href="index.html">Architecture</a>
      <span>/</span>
      <strong>Primitives</strong>
    </nav>

    <!-- You Are Here Box -->
    <div class="you-are-here">
      <h2>You Are Here</h2>
      <p><strong><span class="bionic">Pri</span>mitives</strong> are the atomic building blocks of Claude Code orchestration. Before understanding complex patterns like Ralph or Gas Town, you need to understand the <em>pieces</em> they're made of. This page catalogs every reusable unit so you can mix-and-match to build your own patterns.</p>
      <p><strong>Pre-requisite:</strong> <a href="complexity-ladder.html">Complexity Ladder</a> (know where patterns fit). <strong>Next:</strong> <a href="composition-rules.html">Composition Rules</a> (how to combine primitives).</p>
    </div>

    <h1><span class="bionic">Age</span>nt <span class="bionic">Pat</span>tern <span class="bionic">Pri</span>mitives</h1>

    <p class="conversational-lead">A comprehensive catalog of the atomic building blocks that compose complex AI agent orchestration patterns. These primitives are the smallest reusable units extracted from Ralph, Gas Town, CC Mirror, Panopticon, and other production agent architectures.</p>

    <!-- Table of Contents -->
    <nav class="toc">
      <h3 class="toc-title">On This Page</h3>
      <ul>
        <li><a href="#loop-primitives">Loop Primitives</a></li>
        <li><a href="#state-primitives">State Primitives</a></li>
        <li><a href="#control-primitives">Control Primitives</a></li>
        <li><a href="#quality-gate-primitives">Quality Gate Primitives</a></li>
        <li><a href="#coordination-primitives">Coordination Primitives</a></li>
        <li><a href="#memory-primitives">Memory Primitives</a></li>
        <li><a href="#hook-primitives">Hook Primitives</a></li>
        <li><a href="#communication-primitives">Communication Primitives</a></li>
        <li><a href="#how-primitives-compose">How Primitives Compose</a></li>
      </ul>
    </nav>

    <hr class="section-divider">

    <!-- Loop Primitives -->
    <section id="loop-primitives" class="primitive-category">
      <h2><span class="bionic">Loo</span>p <span class="bionic">Pri</span>mitives</h2>

      <div class="primitive-box">
        <h4>Basic While Loop</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>while :; do
  cat prompt.md | claude
done</code></pre>
        </div>
        <p><strong>What it does:</strong> Infinite loop that continuously spawns fresh Claude sessions with the same prompt.</p>
        <div class="key-properties">
          <strong>Key properties:</strong>
          <ul>
            <li>Each iteration gets a fresh context window</li>
            <li>No memory between iterations (relies on external state)</li>
            <li>Will run forever unless externally stopped</li>
          </ul>
        </div>
        <p><em>Used in:</em> Ralph (basic form), Panopticon cron jobs</p>
      </div>

      <div class="primitive-box">
        <h4>Iteration-Limited Loop</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>MAX_ITERATIONS=${1:-10}

for (( i=1; i<=$MAX_ITERATIONS; i++ )); do
  echo "Iteration $i / $MAX_ITERATIONS"

  claude "$PROMPT" | tee output.txt

  # Check for early exit condition
  if grep -q "COMPLETE" output.txt; then
    break
  fi
done</code></pre>
        </div>
        <p><strong>What it does:</strong> Runs a bounded number of iterations with an early exit condition.</p>
        <div class="key-properties">
          <strong>Key properties:</strong>
          <ul>
            <li>Prevents runaway costs</li>
            <li>Supports early exit on completion</li>
            <li>Logs iteration number for debugging</li>
          </ul>
        </div>
        <p><em>Used in:</em> Ralph (primary form), Marathon Ralph, Lisa</p>
      </div>

      <div class="primitive-box">
        <h4>jq-Based Conditional Loop</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>while jq '.tasks[] | select(.passes == false)' prd.json | grep -q .; do
  claude --chrome -p "$PROMPT"
done</code></pre>
        </div>
        <p><strong>What it does:</strong> Loops until all tasks in a JSON file are marked as passed.</p>
        <div class="key-properties">
          <strong>Key properties:</strong>
          <ul>
            <li>State-driven termination</li>
            <li>Relies on agent updating JSON file</li>
            <li>More semantic than grep for completion</li>
          </ul>
        </div>
        <p><em>Source:</em> @maurice_kleine in Matt Pocock's thread</p>
      </div>

      <div class="primitive-box">
        <h4>Self-Improvement Loop</h4>
        <div class="composition-diagram">+-----------------------------------------+
|  Central Orchestrator                   |
|  - Monitors idle + activity             |
|  - Triggers self-improvement            |
+-----------------------------------------+
          |
          v (when idle)
+-----------------------------------------+
|  "Improve yourself"                     |
|  -> Agents research and implement fixes |
+-----------------------------------------+</div>
        <p><strong>What it does:</strong> When idle, orchestrator triggers agents to improve the system itself.</p>
        <div class="key-properties">
          <strong>Key properties:</strong>
          <ul>
            <li>Recursive enhancement</li>
            <li>Requires isolation (Docker) for safety</li>
            <li>Goal-directed rather than task-directed</li>
          </ul>
        </div>
        <p><em>Source:</em> 0xSero's Orchestra</p>
      </div>
    </section>

    <div class="checkpoint">
      <div class="checkpoint-header">Checkpoint: Loop Primitives</div>
      <p>You should now understand the difference between:</p>
      <ul>
        <li><strong>Infinite loops</strong> - run forever, need external state</li>
        <li><strong>Bounded loops</strong> - prevent runaway costs</li>
        <li><strong>State-driven loops</strong> - terminate based on file content</li>
      </ul>
    </div>

    <!-- State Primitives -->
    <section id="state-primitives" class="primitive-category">
      <h2><span class="bionic">Sta</span>te <span class="bionic">Pri</span>mitives</h2>

      <div class="primitive-box">
        <h4>progress.txt (Append-Only Log)</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code># Ralph Progress Log
Started: 2026-01-09

## Codebase Patterns
- Migrations: Use IF NOT EXISTS
- Types: Export from actions.ts

## Key Files
- db/schema.ts
- app/auth/actions.ts

---

## 2026-01-09 - US-001
- What was implemented: Login endpoint
- Files changed: src/api/auth.ts
- **Learnings:**
  - bcrypt needs salt rounds of 12
  - JWT expiry should be configurable
---</code></pre>
        </div>
        <p><strong>Format:</strong> Markdown with dated sections. Append-only (never update previous entries). Two sections: "Codebase Patterns" at top (persistent learnings), entries below (per-iteration).</p>
        <div class="key-properties">
          <strong>Key properties:</strong>
          <ul>
            <li>Human-readable</li>
            <li>Git-tracked</li>
            <li>Cross-iteration memory</li>
            <li>Pattern accumulation over time</li>
          </ul>
        </div>
      </div>

      <div class="primitive-box">
        <h4>prd.json (Task Status Tracking)</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>{
  "project": "MyApp",
  "branchName": "ralph/feature-auth",
  "description": "User Authentication System",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create login endpoint",
      "description": "As a user, I need a login endpoint",
      "acceptanceCriteria": [
        "POST /api/auth/login accepts email + password",
        "Returns JWT on success",
        "npm run typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    }
  ]
}</code></pre>
        </div>
        <p><strong>Key fields:</strong></p>
        <table>
          <thead>
            <tr><th>Field</th><th>Purpose</th></tr>
          </thead>
          <tbody>
            <tr><td><code>branchName</code></td><td>Git branch for this feature set</td></tr>
            <tr><td><code>id</code></td><td>Unique story identifier</td></tr>
            <tr><td><code>priority</code></td><td>Lower number = execute first</td></tr>
            <tr><td><code>passes</code></td><td><code>false</code> = needs work, <code>true</code> = complete</td></tr>
            <tr><td><code>blockedBy</code></td><td>Dependencies (optional)</td></tr>
            <tr><td><code>acceptanceCriteria</code></td><td>Verifiable completion conditions</td></tr>
          </tbody>
        </table>
      </div>

      <div class="primitive-box">
        <h4>Checkpoint State</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>{
  "checkpoint": {
    "timestamp": "2026-01-09T10:30:00Z",
    "lastCompleted": "US-003",
    "currentAttempt": "US-004",
    "attemptCount": 2,
    "lastError": "TypeError: Cannot read property...",
    "gitCommit": "abc123f"
  }
}</code></pre>
        </div>
        <p><strong>What it does:</strong> Enables crash recovery by tracking exactly where the agent was.</p>
      </div>

      <div class="primitive-box">
        <h4>Archive Structure (Compounding Runs)</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>archives/
+-- run-2026-01-05/
|   +-- prd.json
|   +-- progress.txt
|   +-- learnings.md
+-- run-2026-01-06/
|   +-- prd.json
|   +-- progress.txt
|   +-- learnings.md
+-- run-2026-01-08/
    +-- ...</code></pre>
        </div>
        <p><strong>What it does:</strong> Preserves history of previous runs so future agents can learn from past successes and failures.</p>
        <p><em>Source:</em> Ryan Carson's "Compounding Ralph"</p>
      </div>
    </section>

    <!-- Control Primitives -->
    <section id="control-primitives" class="primitive-category">
      <h2><span class="bionic">Con</span>trol <span class="bionic">Pri</span>mitives</h2>

      <div class="primitive-box">
        <h4>Promise/Stop Condition</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>If ALL stories pass, reply with:
&lt;promise&gt;COMPLETE&lt;/promise&gt;

Otherwise end normally.</code></pre>
        </div>
        <p><strong>Detection:</strong></p>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>if grep -q "&lt;promise&gt;COMPLETE&lt;/promise&gt;" output.txt; then
  echo "All stories complete!"
  exit 0
fi</code></pre>
        </div>
        <div class="key-properties">
          <strong>Key properties:</strong>
          <ul>
            <li>Unambiguous signal (unlikely to appear in normal output)</li>
            <li>XML-style tags for reliability</li>
            <li>Searched via grep in shell wrapper</li>
          </ul>
        </div>
      </div>

      <div class="primitive-box">
        <h4>Max Iteration Guard</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>MAX_ITERATIONS=${1:-10}
CURRENT_ITERATION=1

while [ $CURRENT_ITERATION -le $MAX_ITERATIONS ]; do
  # ... do work ...

  CURRENT_ITERATION=$((CURRENT_ITERATION + 1))
done

echo "Max iterations reached"
exit 1</code></pre>
        </div>
        <p><strong>What it does:</strong> Prevents infinite loops and runaway costs.</p>
        <p><strong>Typical values:</strong> 10-25 for feature development, 50+ for large migrations.</p>
      </div>

      <div class="primitive-box">
        <h4>Story Selection Logic</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>## Your Task

1. Read `scripts/ralph/prd.json`
2. Read `scripts/ralph/progress.txt` (check Codebase Patterns first)
3. Pick highest priority story where `passes: false`
4. Implement that ONE story
5. Run typecheck and tests
6. Update prd.json: `passes: true`
7. Append learnings to progress.txt</code></pre>
        </div>
        <div class="key-properties">
          <strong>Key properties:</strong>
          <ul>
            <li>Priority-ordered selection</li>
            <li>Single story per iteration (prevents context overload)</li>
            <li>External state check before each iteration</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Quality Gate Primitives -->
    <section id="quality-gate-primitives" class="primitive-category">
      <h2><span class="bionic">Qua</span>lity <span class="bionic">Gat</span>e <span class="bionic">Pri</span>mitives</h2>

      <div class="primitive-box">
        <h4>Typecheck Gate</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>npm run typecheck
# or
tsc --noEmit
# or
pnpm typecheck</code></pre>
        </div>
        <p><strong>What it does:</strong> Verifies type safety before marking task complete.</p>
        <p><strong>Always include in acceptance criteria:</strong></p>
        <pre><code>"acceptanceCriteria": [
  "...",
  "npm run typecheck passes"
]</code></pre>
      </div>

      <div class="primitive-box">
        <h4>Test Gate</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>npm test
# or run only related tests
npm test -- --findRelatedTests $FILE
# or with coverage
npm test -- --coverage --coverageThreshold='{"global":{"lines":80}}'</code></pre>
        </div>
        <p><strong>What it does:</strong> Runs test suite to verify correctness.</p>
      </div>

      <div class="primitive-box">
        <h4>Browser Verification Gate</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code># Start browser server
~/.config/amp/skills/dev-browser/server.sh &

# Write verification script
cd ~/.config/amp/skills/dev-browser && npx tsx <<'EOF'
import { connect, waitForPageLoad } from "@/client.js";

const client = await connect();
const page = await client.page("test");
await page.setViewportSize({ width: 1280, height: 900 });
await page.goto(`http://localhost:${process.env.PORT}/your-page`);
await waitForPageLoad(page);
await page.screenshot({ path: "tmp/screenshot.png" });
await client.disconnect();
EOF</code></pre>
        </div>
        <p><strong>What it does:</strong> Visual verification for UI changes using Playwright MCP.</p>
        <blockquote>"Not complete until verified with screenshot."</blockquote>
      </div>
    </section>

    <div class="checkpoint">
      <div class="checkpoint-header">Checkpoint: Gates Are Non-Negotiable</div>
      <p>Key insight from Matt Pocock:</p>
      <blockquote>"If you don't do this, you're hamstringing future agent runs with bad code, and they'll need to bisect to find bugs."</blockquote>
      <p>Every Ralph loop should have at minimum: <strong>typecheck</strong> and <strong>tests</strong>.</p>
    </div>

    <!-- Coordination Primitives -->
    <section id="coordination-primitives" class="primitive-category">
      <h2><span class="bionic">Coo</span>rdination <span class="bionic">Pri</span>mitives</h2>

      <div class="primitive-box">
        <h4>TaskCreate / TaskUpdate (Native)</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>TaskCreate  -> Create with subject, description, acceptance criteria
TaskList    -> Filter: status='open', no owner, not blocked
TaskGet     -> Full context: description, comments, dependencies
TaskUpdate  -> Claim (set owner), add comments, resolve, link references

Dependency management:
addBlocks     -> This task blocks another
addBlockedBy  -> This task is blocked by another</code></pre>
        </div>
        <p><strong>Visual output:</strong></p>
        <pre><code>Tasks:
[x] #1 Design API architecture
[ ] #2 Create project structure
[ ] #3 Implement data models
[!] #4 Implement REST endpoints (blocked by #3)
[!] #5 Write integration tests (blocked by #4)</code></pre>
        <p><em>Source:</em> CC Mirror (beta feature enabled)</p>
      </div>

      <div class="primitive-box">
        <h4>Worker Preamble Template</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>CONTEXT: You are a WORKER agent, not an orchestrator.

RULES:
- Complete ONLY the task described below
- Use tools directly (Read, Write, Edit, Bash, etc.)
- Do NOT spawn sub-agents
- Do NOT call TaskCreate or TaskUpdate
- Report your results with absolute file paths

TASK:
[Your specific task here]</code></pre>
        </div>
        <p><strong>What it does:</strong> Constrains worker agents to execution only, prevents recursion.</p>
      </div>

      <div class="primitive-box">
        <h4>Model Selection Matrix</h4>
        <table>
          <thead>
            <tr><th>Model</th><th>Use Case</th><th>Parallel Capacity</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Haiku</strong></td><td>Errand runner: fetch files, grep, simple lookups</td><td>Spawn 5-10 in parallel</td></tr>
            <tr><td><strong>Sonnet</strong></td><td>Capable worker: structured implementation, following patterns</td><td>3-5 parallel</td></tr>
            <tr><td><strong>Opus</strong></td><td>Complex reasoning, architecture decisions, ambiguous tasks</td><td>1-2 (expensive)</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Memory Primitives -->
    <section id="memory-primitives" class="primitive-category">
      <h2><span class="bionic">Mem</span>ory <span class="bionic">Pri</span>mitives</h2>

      <div class="primitive-box">
        <h4>Git as Memory</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code># Future agent understands context from git history
git log --oneline -10
git diff HEAD~5</code></pre>
        </div>
        <p><strong>What it does:</strong> Code changes persist across iterations via version control.</p>
        <div class="key-properties">
          <strong>Key properties:</strong>
          <ul>
            <li>Immutable history</li>
            <li>Diff-based understanding</li>
            <li>Commit messages as documentation</li>
          </ul>
        </div>
      </div>

      <div class="primitive-box">
        <h4>Filesystem as Memory (Panopticon)</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>~/nox        # Company/product
~/metrics    # Analytics/data
~/email      # Communications
~/growth     # Marketing/acquisition
~/trades     # Personal finance/trading
~/health     # Fitness/sleep/wellness
~/writing    # Content creation
~/personal   # Life admin</code></pre>
        </div>
        <p><strong>What it does:</strong> Each domain has isolated directory that persists agent state.</p>
        <p>See <a href="domain-isolation.html">Domain Isolation</a> for the full Panopticon pattern.</p>
      </div>

      <div class="primitive-box">
        <h4>CLAUDE.md Hierarchy</h4>
        <div class="composition-diagram">+----------------------------------------------------------+
| Layer 1: Enterprise Policy                               |
| /Library/Application Support/ClaudeCode/CLAUDE.md        |
+----------------------------------------------------------+
| Layer 2: Project Memory                                  |
| ./CLAUDE.md or ./.claude/CLAUDE.md                       |
+----------------------------------------------------------+
| Layer 3: Modular Rules                                   |
| ./.claude/rules/*.md                                     |
+----------------------------------------------------------+
| Layer 4: Personal + Local                                |
| ~/.claude/CLAUDE.md (user global)                        |
| ./CLAUDE.local.md (project local, gitignored)            |
+----------------------------------------------------------+</div>
      </div>
    </section>

    <!-- Hook Primitives -->
    <section id="hook-primitives" class="primitive-category">
      <h2><span class="bionic">Hoo</span>k <span class="bionic">Pri</span>mitives</h2>

      <div class="primitive-box">
        <h4>Hook Events</h4>
        <table>
          <thead>
            <tr><th>Event</th><th>Trigger</th><th>Common Use Cases</th></tr>
          </thead>
          <tbody>
            <tr><td><code>PreToolUse</code></td><td>Before a tool runs</td><td>Validation, notifications, approval gates</td></tr>
            <tr><td><code>PostToolUse</code></td><td>After a tool completes</td><td>Formatting, linting, logging</td></tr>
            <tr><td><code>SessionStart</code></td><td>When session begins</td><td>Context loading, environment setup</td></tr>
            <tr><td><code>SessionEnd</code></td><td>When session ends</td><td>Cleanup, summary generation</td></tr>
            <tr><td><code>Stop</code></td><td>Exit/completion attempts</td><td>Loop continuation (Ralph)</td></tr>
          </tbody>
        </table>
      </div>

      <div class="primitive-box">
        <h4>Notification Hook</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>#!/bin/bash
# ~/.claude/hooks/poke-notify.sh

QUESTION=$(echo "$EVENT_DATA" | jq -r '.tool_input.questions[0].question')
MESSAGE="$PROJECT_NAME: Claude needs input - $QUESTION"
curl -X POST "$POKE_API_URL" -d "{\"message\": \"$MESSAGE\"}"</code></pre>
        </div>
        <p><strong>What it does:</strong> Sends push notification when Claude needs human input.</p>
      </div>

      <div class="primitive-box">
        <h4>Security Gate Hook</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>#!/bin/bash
# ~/.claude/hooks/security-gate.sh

COMMAND=$(echo "$EVENT_DATA" | jq -r '.tool_input.command')

DANGEROUS_PATTERNS=(
    "rm -rf /"
    "git push --force"
    "DROP TABLE"
    "sudo"
)

for pattern in "${DANGEROUS_PATTERNS[@]}"; do
    if [[ "$COMMAND" == *"$pattern"* ]]; then
        echo "BLOCKED: Dangerous command pattern detected" >&2
        exit 1  # Non-zero blocks the operation
    fi
done

exit 0  # Allow</code></pre>
        </div>
        <p><strong>Exit code behavior:</strong> <code>0</code> = Allow operation, Non-zero = Block operation, show stderr to user</p>
      </div>
    </section>

    <!-- Communication Primitives -->
    <section id="communication-primitives" class="primitive-category">
      <h2><span class="bionic">Com</span>munication <span class="bionic">Pri</span>mitives</h2>

      <div class="primitive-box">
        <h4>File-Based Handoffs</h4>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>~/shared/
  +-- handoff-agent1-to-agent2.json
  +-- status.json</code></pre>
        </div>
        <div class="code-block-wrapper">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>{
  "from": "agent1",
  "to": "agent2",
  "timestamp": "2026-01-09T10:30:00Z",
  "context": {
    "completed": ["API schema", "Database models"],
    "next_steps": ["Implement REST endpoints"],
    "blockers": [],
    "notes": "Using FastAPI, see docs in /api/README.md"
  }
}</code></pre>
        </div>
        <p><em>Source:</em> Panopticon pattern</p>
      </div>

      <div class="primitive-box">
        <h4>Git-Based Handoffs</h4>
        <p>Each iteration:</p>
        <ol>
          <li>Agent reads progress.txt (context from previous iterations)</li>
          <li>Agent does work</li>
          <li>Agent appends learnings to progress.txt</li>
          <li>Agent commits changes to git</li>
          <li>Next iteration starts fresh, reads progress.txt + git history</li>
        </ol>
      </div>

      <div class="primitive-box">
        <h4>MCP Agent Mail</h4>
        <p>Agents communicate via email-like interfaces:</p>
        <ul>
          <li>No training needed (natural behavior)</li>
          <li>Async by default</li>
          <li>Message queue abstraction</li>
        </ul>
        <p><em>Source:</em> github.com/Dicklesworthstone/mcp_agent_mail (used in Gas Town)</p>
      </div>
    </section>

    <div class="milestone">Milestone: Primitives Catalog Complete</div>

    <!-- How Primitives Compose -->
    <section id="how-primitives-compose" class="primitive-category">
      <h2>How <span class="bionic">Pri</span>mitives <span class="bionic">Com</span>pose</h2>

      <h3>Ralph Loop = Basic Composition</h3>
      <div class="composition-diagram">+----------------------------------------------------------+
|                       RALPH LOOP                         |
+----------------------------------------------------------+
|                                                          |
|  Iteration-Limited Loop                                  |
|       |                                                  |
|       +-- prd.json (State)                               |
|       |       +-- Tracks: passes: true/false             |
|       |                                                  |
|       +-- Story Selection Logic                          |
|       |       +-- Pick highest priority where passes == false
|       |                                                  |
|       +-- Quality Gates                                  |
|       |       +-- Typecheck                              |
|       |       +-- Tests                                  |
|       |                                                  |
|       +-- progress.txt (Memory)                          |
|       |       +-- Append learnings each iteration        |
|       |                                                  |
|       +-- Git Commit                                     |
|       |       +-- Persist code changes                   |
|       |                                                  |
|       +-- Promise/Stop Condition                         |
|               +-- &lt;promise&gt;COMPLETE&lt;/promise&gt;            |
|                                                          |
+----------------------------------------------------------+</div>

      <h3>Primitive Composition Matrix</h3>
      <table>
        <thead>
          <tr>
            <th>Pattern</th>
            <th>Loop</th>
            <th>State</th>
            <th>Control</th>
            <th>Quality</th>
            <th>Memory</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Ralph</strong></td>
            <td>Iteration-Limited</td>
            <td>prd.json + progress.txt</td>
            <td>Promise/Stop</td>
            <td>Typecheck + Tests</td>
            <td>Git + Files</td>
          </tr>
          <tr>
            <td><strong>CC Mirror</strong></td>
            <td>Event-driven</td>
            <td>TaskCreate native</td>
            <td>Task dependencies</td>
            <td>Per-task gates</td>
            <td>Task persistence</td>
          </tr>
          <tr>
            <td><strong>Gas Town</strong></td>
            <td>Continuous</td>
            <td>Beads (Git-backed)</td>
            <td>Role-based</td>
            <td>Dogs (watchdogs)</td>
            <td>MCP Agent Mail</td>
          </tr>
          <tr>
            <td><strong>Panopticon</strong></td>
            <td>Cron-scheduled</td>
            <td>Filesystem</td>
            <td>Domain isolation</td>
            <td>Domain-specific</td>
            <td>Dir per domain</td>
          </tr>
        </tbody>
      </table>
    </section>

    <hr class="section-divider">

    <!-- Related Pages -->
    <div class="related-pages">
      <h3>Continue Learning</h3>
      <ul>
        <li><a href="complexity-ladder.html">Complexity Ladder</a> - See where these primitives are used at each level</li>
        <li><a href="composition-rules.html">Composition Rules</a> - How to combine primitives correctly</li>
        <li><a href="domain-isolation.html">Domain Isolation</a> - Deep dive on the Panopticon pattern</li>
      </ul>
    </div>

    <!-- Footer Navigation -->
    <nav class="footer-nav">
      <a href="complexity-ladder.html">Previous: Complexity Ladder</a>
      <a href="composition-rules.html">Next: Composition Rules</a>
    </nav>
  </div>

  
  <script src="../../js/copy-code.js"></script>
  <script src="../../js/search.js"></script>
</body>
</html>
