<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta data-pagefind-meta="section" content="Synthesis">
  <meta data-pagefind-meta="category" content="Mastery">
  <title>Multi-Agent Architecture Mastery Guide - Claude Code Knowledge Base</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <link rel="stylesheet" href="../css/search.css">
</head>
<body>
  <nav class="left-nav" id="leftNav">
    <div class="px-4 mb-4">
      <a href="../index.html" class="text-xs font-semibold text-accent hover:text-accent-light uppercase tracking-wider">Claude Code KB</a>
    </div>
    <div class="nav-content"></div>
  </nav>

  <!-- Search Modal -->
  <div class="search-modal" id="searchModal" aria-hidden="true">
    <div class="search-overlay" onclick="closeSearch()"></div>
    <div class="search-content">
      <div class="search-header">
        <div class="search-input-wrapper">
          <span class="search-icon-input">&#128269;</span>
          <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off" />
          <kbd class="search-kbd">ESC</kbd>
        </div>
      </div>
      <div class="search-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="synthesis">Synthesis</button>
        <button class="filter-btn" data-filter="extractions">Extractions</button>
      </div>
      <div class="search-results" id="searchResults">
        <div class="search-empty"><p>Start typing to search... (Press Cmd+K anytime)</p></div>
      </div>
      <div class="search-footer">
        <span>Up/Down Navigate</span><span>Enter Select</span><span>ESC Close</span>
      </div>
    </div>
  </div>

  <button class="search-trigger" onclick="openSearch()" aria-label="Search" style="float: right; margin-bottom: 1rem;">
    <span class="search-icon">Cmd+K</span>
    <span class="search-text">Search</span>
  </button>

  <div class="wide-container">
    <!-- Breadcrumb Navigation -->
    <nav class="nav-breadcrumb">
      <a href="../index.html">Home</a>
      <span>/</span>
      <a href="synthesis-index.html">Synthesis</a>
      <span>/</span>
      <span>Mastery</span>
      <span>/</span>
      <span>Multi-Agent Architecture</span>
    </nav>

    <!-- You Are Here Context Box -->
    <div class="you-are-here" style="background: linear-gradient(135deg, #f0ebe3 0%, #fefcf3 100%); border-left: 4px solid #2a7d7d; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="color: #2a7d7d; margin-top: 0; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">You Are Here</h3>
      <p style="margin-bottom: 0;">This is the <strong>complete overview of multi-agent orchestration patterns</strong> - comparing Ralph loops, CC Mirror, Gas Town, and parallel swarms. Use this to understand the full landscape and choose the right architecture for your needs.</p>
    </div>

    <h1><span style="font-weight: 700;">Mul</span>ti-Agent Architecture: Complete Overview</h1>

    <p class="conversational-lead">
      <span style="font-weight: 700;">Orc</span>hestrators coordinate. Workers execute. <strong>Never mix.</strong> This is the foundational principle of all multi-agent architecture.
    </p>

    <!-- Table of Contents -->
    <div class="toc">
      <div class="toc-title">Contents</div>
      <ul>
        <li><a href="#iron-law">The Iron Law</a> - Orchestrator vs Worker separation</li>
        <li><a href="#architecture-spectrum">Architecture Spectrum</a> - Simple to complex</li>
        <li><a href="#ralph">Ralph Wiggum Loop</a> - Iterative single-agent</li>
        <li><a href="#cc-mirror">CC Mirror</a> - Native orchestration</li>
        <li><a href="#gas-town">Gas Town</a> - Factory-scale operations</li>
        <li><a href="#worktrees">Parallel Swarms</a> - Git worktree isolation</li>
        <li><a href="#selection-guide">Selection Guide</a> - Decision tree</li>
        <li><a href="#pitfalls">Common Pitfalls</a> - What goes wrong</li>
        <li><a href="#troubleshooting">Troubleshooting</a> - Common issues and recovery</li>
      </ul>
    </div>

    <hr class="section-divider divider-warning">

    <!-- Iron Law Section -->
    <section id="iron-law">
      <h2><span style="font-weight: 700;">The</span> Iron Law of Worker Separation</h2>

      <div class="callout callout-warning">
        <div class="callout-title">THE IRON LAW OF MULTI-AGENT ORCHESTRATION</div>
        <p><strong>ORCHESTRATORS COORDINATE. WORKERS EXECUTE. NEVER MIX.</strong></p>
        <p style="margin-bottom: 0;">You are the CONDUCTOR. Your agents play the instruments.</p>
      </div>

      <p>Violating this principle causes:</p>
      <ul>
        <li><strong>Worker recursion</strong> - Agents spawning infinite sub-agents</li>
        <li><strong>Context explosion</strong> - Workers consuming orchestrator context</li>
        <li><strong>Coordination failures</strong> - No central authority tracking state</li>
      </ul>

      <h3>The Separation in Practice</h3>
      <table class="comparison-table">
        <thead>
          <tr><th>Role</th><th>What They Do</th><th>What They DON'T Do</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Orchestrator</strong></td><td>Decompose tasks, assign workers, track progress, synthesize results</td><td>Write code, run commands, explore codebases</td></tr>
          <tr><td><strong>Workers</strong></td><td>Execute specific tasks using tools, report results</td><td>Spawn sub-agents, manage task graphs, make architectural decisions</td></tr>
        </tbody>
      </table>

      <h3>Tool Ownership</h3>
      <div class="ascii-diagram">
ORCHESTRATOR USES:                    WORKERS USE:
- Read (1-2 files max)                - Read, Write, Edit, Bash
- TaskCreate, TaskUpdate              - Glob, Grep, WebFetch
- TaskGet, TaskList                   - WebSearch, LSP
- AskUserQuestion
- Task (spawn workers)                WORKERS NEVER USE:
                                      - TaskCreate, TaskUpdate
                                      - Task (no sub-spawning!)
      </div>

      <h3>The Worker Preamble Template</h3>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>CONTEXT: You are a WORKER agent, not an orchestrator.

RULES:
- Complete ONLY the task described below
- Use tools directly (Read, Write, Edit, Bash, etc.)
- Do NOT spawn sub-agents
- Do NOT call TaskCreate or TaskUpdate
- Report your results with absolute file paths

TASK:
[Your specific task here]</code></pre>
      </div>
    </section>

    <hr class="section-divider divider-context">

    <!-- Architecture Spectrum Section -->
    <section id="architecture-spectrum">
      <h2><span style="font-weight: 700;">Arc</span>hitecture Spectrum</h2>

      <div class="ascii-diagram">
SIMPLE &lt;----------------------------------------&gt; COMPLEX

[Ralph Loop]    [CC Mirror]    [Orchestra]    [Gas Town]
     |               |              |              |
Single agent    Multi-agent    Self-improving  Agent factory
Retry loop      Task-based     Docker-based    Role-based
Bash script     Native CC      Specialized     Full system
      </div>

      <h3>Quick Comparison Matrix</h3>
      <table class="comparison-table">
        <thead>
          <tr><th>Architecture</th><th>Setup</th><th>Cost</th><th>Parallelism</th><th>Dependencies</th><th>Use Case</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Ralph Loop</strong></td><td>5 min</td><td>$</td><td>None (serial)</td><td>Via PRD</td><td>Overnight builds</td></tr>
          <tr><td><strong>CC Mirror</strong></td><td>5 min</td><td>$$</td><td>Native</td><td>TaskCreate</td><td>80% of projects</td></tr>
          <tr><td><strong>Worktrees</strong></td><td>10 min</td><td>$$$</td><td>Full isolation</td><td>Git branches</td><td>Parallel features</td></tr>
          <tr><td><strong>Orchestra</strong></td><td>1 hr</td><td>$$</td><td>Sequential*</td><td>Profiles</td><td>24/7 self-improvement</td></tr>
          <tr><td><strong>Gas Town</strong></td><td>Days</td><td>$$$$</td><td>Full factory</td><td>Role-based</td><td>Stage 7+ scale</td></tr>
        </tbody>
      </table>

      <div class="callout callout-insight">
        <div class="callout-title">The 80/20 Rule</div>
        <blockquote style="margin: 0; padding: 0; border: none;">
          "CC Mirror covers 80% of use cases with zero effort. Gas Town for the remaining 20%."
          <cite style="display: block; margin-top: 0.5rem; font-size: 0.9em;">-- @nummanali</cite>
        </blockquote>
      </div>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Ralph Section -->
    <section id="ralph">
      <h2><span style="font-weight: 700;">Ral</span>ph Wiggum Loop (Iterative Single-Agent)</h2>

      <p><strong>Source:</strong> Geoffrey Huntley (ghuntley.com/ralph/), popularized by @mattpocockuk, @ryancarson</p>

      <p>A bash loop that runs Claude Code repeatedly with fresh context until a completion condition is met. Named after Ralph Wiggum from The Simpsons.</p>

      <div class="ascii-diagram">
+---------------------------------------------+
|  1. Start with fresh context                |
|            |                                |
|  2. Read task state from files              |
|     (prd.json, progress.txt, git history)   |
|            |                                |
|  3. Pick highest priority incomplete task   |
|            |                                |
|  4. Implement task                          |
|            |                                |
|  5. Run verification (tests, typecheck)     |
|            |                                |
|  6. If pass: commit, update prd.json        |
|     If fail: log learnings, try again       |
|            |                                |
|  7. Append to progress.txt                  |
|            |                                |
|  8. Check completion condition              |
|     All done? -&gt; Output promise -&gt; EXIT     |
|     Not done? -&gt; Loop continues             |
+---------------------------------------------+
      </div>

      <h3>At Its Simplest</h3>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>while :; do cat PROMPT.md | claude ; done</code></pre>
      </div>

      <h3>When to Use Ralph</h3>
      <ul>
        <li><strong>Best for:</strong> Well-defined goals, mechanical tasks, overnight builds</li>
        <li><strong>Setup time:</strong> Minutes</li>
        <li><strong>Cost:</strong> Single agent (moderate)</li>
        <li><strong>Complexity:</strong> Low</li>
      </ul>

      <p><strong>See:</strong> <a href="architecture-complexity-ladder.html#level-3">Complexity Ladder Level 3-4</a> for full Ralph documentation.</p>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- CC Mirror Section -->
    <section id="cc-mirror">
      <h2><span style="font-weight: 700;">CC</span> Mirror (Native Hub-and-Spoke)</h2>

      <p><strong>Source:</strong> @nummanali (Numman Ali)</p>

      <p>CC Mirror unlocks Claude Code's disabled native multi-agent orchestration. Exposes hidden task management primitives in an isolated environment.</p>

      <div class="ascii-diagram">
           +------------------+
           |   Orchestrator   |
           +--------+---------+
                    |
    +---------------+---------------+
    |               |               |
    v               v               v
+-------+       +-------+       +-------+
| Coder |       | Tester|       | Docs  |
+-------+       +-------+       +-------+
      </div>

      <h3>Quick Start (3 Commands)</h3>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Step 1: Create isolated variant
npx cc-mirror quick --provider mirror --name mclaude

# Step 2: Launch it
mclaude

# Step 3: In the terminal
"Load the orchestration skill and initiate"</code></pre>
      </div>

      <h3>Task Management API</h3>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <pre style="margin: 0; overflow-x: auto;"><code>TaskCreate  -&gt; Create with subject, description, acceptance criteria
TaskList    -&gt; Filter: status='open', no owner, not blocked
TaskGet     -&gt; Full context: description, comments, dependencies
TaskUpdate  -&gt; Claim (set owner), add comments, resolve, link references

Dependency Management:
addBlocks     -&gt; This task blocks another
addBlockedBy  -&gt; This task is blocked by another</code></pre>
      </div>

      <h3>When to Use CC Mirror</h3>
      <ul>
        <li><strong>Best for:</strong> Task-based workflows with clear dependencies</li>
        <li><strong>Setup time:</strong> 5 minutes</li>
        <li><strong>Cost:</strong> Single provider account</li>
        <li><strong>Complexity:</strong> Medium</li>
        <li><strong>Coverage:</strong> "80% of use cases with zero effort"</li>
      </ul>

      <p><strong>See:</strong> <a href="mastery-ccmirror-complete.html">CC Mirror Complete Mastery Guide</a> for full documentation.</p>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Gas Town Section -->
    <section id="gas-town">
      <h2><span style="font-weight: 700;">Gas</span> Town (Agent Factory)</h2>

      <p><strong>Source:</strong> @steve_yegge (Steve Yegge) - 40-year veteran, ex-Google/Amazon/Sourcegraph</p>

      <p>Gas Town is a <strong>factory for agents</strong>, not a better single agent. Designed for Stage 7+ developers.</p>

      <blockquote style="border-left: 3px solid #2a7d7d; padding-left: 1rem; margin: 1.5rem 0; font-style: italic; color: #5c4b3a;">
        "Claude Code is the world's biggest fuckin' ant. Everyone is focused on making their ant run longer... when nature prefers colonies."
        <cite style="display: block; margin-top: 0.5rem; font-size: 0.9em;">-- Steve Yegge</cite>
      </blockquote>

      <h3>The 8 Roles</h3>
      <table class="comparison-table">
        <thead>
          <tr><th>Role</th><th>Level</th><th>Function</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Overseer</strong></td><td>Human</td><td>Product Manager, decision maker (you)</td></tr>
          <tr><td><strong>Mayor</strong></td><td>Town</td><td>Chief coordinator, concierge</td></tr>
          <tr><td><strong>Deacon</strong></td><td>Town</td><td>Monitoring, heartbeat, recycling</td></tr>
          <tr><td><strong>Dogs</strong></td><td>Town</td><td>Quality gates, maintenance</td></tr>
          <tr><td><strong>Refinery</strong></td><td>Rig</td><td>Merge queue, task decomposition</td></tr>
          <tr><td><strong>Witness</strong></td><td>Rig</td><td>Supervise polecats, unstick agents</td></tr>
          <tr><td><strong>Polecat</strong></td><td>Rig</td><td>Named workers, implementation</td></tr>
          <tr><td><strong>Crew</strong></td><td>Personal</td><td>Long-lived personal agents</td></tr>
        </tbody>
      </table>

      <h3>When to Use Gas Town</h3>
      <ul>
        <li><strong>Best for:</strong> Stage 7+ developers, maximum throughput, chaos tolerance</li>
        <li><strong>Setup time:</strong> Hours/days</li>
        <li><strong>Cost:</strong> Multiple Claude accounts, "expensive as hell"</li>
        <li><strong>Complexity:</strong> High</li>
        <li><strong>Prerequisites:</strong> tmux proficiency, Go environment</li>
      </ul>

      <div class="callout callout-warning">
        <div class="callout-title">Warning from the Creator</div>
        <p style="margin-bottom: 0;">"If you're not at Stage 7, you'll <strong>get your face ripped off</strong> by superintelligent chimpanzees."</p>
      </div>

      <p><strong>See:</strong> <a href="mastery-gastown-complete.html">Gas Town Complete Mastery Guide</a> for full documentation.</p>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Worktrees Section -->
    <section id="worktrees">
      <h2><span style="font-weight: 700;">Par</span>allel Swarms (Git Worktrees)</h2>

      <p>Running separate Claude Code instances in isolated git worktrees, each working on independent features.</p>

      <div class="ascii-diagram">
Main Repo
~/project/
  +-- .git/           # Shared git database
  +-- src/            # Main working directory

Worktrees (parallel agent checkouts)
~/project-worktrees/
  +-- feature-a/      # Agent 1's isolated directory
  +-- feature-b/      # Agent 2's isolated directory
  +-- bugfix-c/       # Agent 3's isolated directory
      </div>

      <h3>Setup</h3>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Create worktree for parallel agent
git worktree add ../feature-auth feature-auth

# Agent 1 works in main checkout
cd ~/project && claude

# Agent 2 works in worktree
cd ../feature-auth && claude</code></pre>
      </div>

      <h3>Worktree + Ralph Combination</h3>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Spawn parallel Ralph loops in worktrees
for feature in auth payments notifications; do
  git worktree add ../wt-$feature $feature-branch
  (cd ../wt-$feature && ./ralph.sh 20) &
done
wait</code></pre>
      </div>

      <h3>When to Use Worktrees</h3>
      <ul>
        <li><strong>Best for:</strong> Parallel feature development, team projects</li>
        <li><strong>Setup time:</strong> Quick</li>
        <li><strong>Cost:</strong> Multiplied by number of agents</li>
        <li><strong>Complexity:</strong> Low (if you know git)</li>
      </ul>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Selection Guide Section -->
    <section id="selection-guide">
      <h2><span style="font-weight: 700;">Sel</span>ection Guide: Decision Tree</h2>

      <div class="ascii-diagram">
START: What's your experience level?

Stage 1-4 (Single agent in IDE)
    -&gt; STOP. Use single Claude Code. Learn the basics first.

Stage 5 (CLI single agent, YOLO)
    |
    +-- Want overnight autonomous work?
    |   -&gt; Ralph Wiggum Loop
    |
    +-- Want quick multi-agent test?
        -&gt; CC Mirror (3 commands, done)

Stage 6 (3-5 parallel agents)
    |
    +-- Need task dependencies?
    |   -&gt; CC Mirror Native Orchestration
    |
    +-- Building a product?
    |   -&gt; Ralph + Playwright
    |
    +-- Self-improving system?
        -&gt; Infinite Orchestra

Stage 7+ (10+ agents, hand-managed)
    |
    +-- Cost-sensitive?
    |   -&gt; Enhanced Ralph with Haiku workers
    |
    +-- Want structure + chaos tolerance?
    |   -&gt; GAS TOWN
    |
    +-- Multiple clients/projects?
        -&gt; Gas Town + Roughneck
      </div>

      <h3>Choose Your Level</h3>
      <table class="comparison-table">
        <thead>
          <tr><th>If You Are...</th><th>Start With...</th></tr>
        </thead>
        <tbody>
          <tr><td>Learning Claude Code</td><td>Single agent, no orchestration</td></tr>
          <tr><td>Building one feature</td><td>Ralph Wiggum loop</td></tr>
          <tr><td>Managing small project</td><td>CC Mirror</td></tr>
          <tr><td>Running multiple projects</td><td>Gas Town</td></tr>
          <tr><td>Building the future</td><td>Your own orchestrator</td></tr>
        </tbody>
      </table>
    </section>

    <hr class="section-divider divider-warning">

    <!-- Pitfalls Section -->
    <section id="pitfalls">
      <h2><span style="font-weight: 700;">Com</span>mon Multi-Agent Pitfalls</h2>

      <h3>1. Worker Recursion</h3>
      <p><strong>Symptom:</strong> Infinite agent spawning, runaway costs</p>
      <p><strong>Cause:</strong> Workers not properly restricted from spawning sub-agents</p>
      <p><strong>Prevention:</strong> Always use the worker preamble template</p>

      <h3>2. Context Explosion</h3>
      <p><strong>Symptom:</strong> Agents get "stupider" over time, lose track of goals</p>
      <p><strong>Cause:</strong> Too much context accumulated, no compaction</p>
      <p><strong>Prevention:</strong> Enable auto-compact, use fresh context per iteration (Ralph pattern)</p>

      <blockquote style="border-left: 3px solid #c97065; padding-left: 1rem; margin: 1.5rem 0; font-style: italic; color: #5c4b3a;">
        "Context rot: LLMs get stupider with more tokens."
        <cite style="display: block; margin-top: 0.5rem; font-size: 0.9em;">-- @mattpocockuk</cite>
      </blockquote>

      <h3>3. Coordination Failures</h3>
      <p><strong>Symptom:</strong> Conflicting edits, lost work, race conditions</p>
      <p><strong>Cause:</strong> Multiple agents touching same files without locking</p>
      <p><strong>Prevention:</strong> Use git worktrees, implement file ownership per agent</p>

      <h3>4. Verification Bypass</h3>
      <p><strong>Symptom:</strong> "Complete" features that don't work</p>
      <p><strong>Cause:</strong> No verification in acceptance criteria</p>
      <p><strong>Prevention:</strong> Always include <code>npm run typecheck passes</code>, add browser automation</p>

      <h3>5. Model Mismatch</h3>
      <p><strong>Symptom:</strong> Expensive failures on simple tasks, weak output on complex tasks</p>
      <p><strong>Prevention:</strong> Match model to task complexity:</p>
      <table class="comparison-table">
        <thead>
          <tr><th>Task</th><th>Model</th></tr>
        </thead>
        <tbody>
          <tr><td>File lookup, grep</td><td>Haiku</td></tr>
          <tr><td>Implementation, testing</td><td>Sonnet</td></tr>
          <tr><td>Architecture, complex reasoning</td><td>Opus</td></tr>
        </tbody>
      </table>

      <h3>6. Cost Explosion</h3>
      <p><strong>Symptom:</strong> $500 bills for simple features</p>
      <p><strong>Prevention:</strong> Set <code>--max-iterations</code>, limit crew, track token usage</p>
    </section>

    <hr class="section-divider divider-warning">

    <!-- Troubleshooting Section -->
    <section id="troubleshooting">
      <h2><span style="font-weight: 700;">Tro</span>ubleshooting</h2>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Workers spawning infinite sub-agents</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptoms:</strong> Runaway costs, nested agent chains, resource exhaustion</p>
          <p><strong>Cause:</strong> Workers not restricted from spawning sub-agents</p>
          <p><strong>Solution:</strong> Add to EVERY worker preamble:</p>
          <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
            <pre style="margin: 0;"><code>RULES:
- Do NOT spawn sub-agents
- Do NOT call TaskCreate or TaskUpdate</code></pre>
          </div>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Orchestrator running out of context</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptoms:</strong> Orchestrator forgetting tasks, losing state</p>
          <p><strong>Cause:</strong> Too many worker outputs accumulated in context</p>
          <p><strong>Solution:</strong></p>
          <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
            <pre style="margin: 0;"><code># Have workers return summaries only
"Complete task and return: file paths modified, key decisions, next steps"

# Compact orchestrator when needed
/compact

# Or restart with fresh context
exit
mclaude
"Read task state from prd.json and resume orchestration"</code></pre>
          </div>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Agents modifying same files - conflicts</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptoms:</strong> Merge conflicts, overwritten changes, lost work</p>
          <p><strong>Cause:</strong> No file isolation between parallel agents</p>
          <p><strong>Solution:</strong></p>
          <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
            <pre style="margin: 0;"><code># Option 1: Git worktrees (recommended)
git worktree add ../agent-1 feature-1
git worktree add ../agent-2 feature-2

# Each agent works in complete isolation
cd ../agent-1 && claude
cd ../agent-2 && claude

# Merge when both complete
git merge agent-1 agent-2

# Option 2: File ownership rules
"Only modify files in src/api/ - do not touch other directories"</code></pre>
          </div>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Features marked complete that don't work</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptoms:</strong> Passing tests but broken functionality, false positives</p>
          <p><strong>Cause:</strong> Verification not actually running, or criteria too weak</p>
          <p><strong>Solution:</strong></p>
          <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
            <pre style="margin: 0;"><code># Always include explicit verification in acceptance criteria:
"npm run typecheck passes"
"npm run test passes"
"Verify at localhost:3000/feature using browser"

# Add hooks to enforce verification
{
  "hooks": {
    "PostToolUse": {
      "matcher": "Edit|Write",
      "command": "npm run typecheck && npm run test"
    }
  }
}</code></pre>
          </div>
        </div>
      </details>

      <h3>Emergency Recovery</h3>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Multi-agent system completely stuck
pkill -f claude

# For Gas Town
gt mayor down
gt deacon down
gt dogs down
gt status  # Should show all DOWN

# Restart from scratch
gt mayor up

# Lost track of which agent is doing what
# For CC Mirror:
"List all tasks with status and owner"

# For Gas Town:
gt status --verbose
gt inbox

# Need to stop everything and start over
git add -A && git commit -m "WIP: saving state before reset"
pkill -f claude
pkill -f mclaude
git status  # Assess what's done vs not done</code></pre>
      </div>
    </section>

    <hr class="section-divider">

    <!-- The Summary -->
    <section>
      <h2><span style="font-weight: 700;">Sum</span>mary: The Multi-Agent Mental Model</h2>

      <div class="ascii-diagram">
+===============================================================+
|                                                               |
|  Multi-agent orchestration is about:                          |
|                                                               |
|  1. SEPARATION - Orchestrators coordinate, workers execute    |
|  2. ISOLATION - Fresh context, worktrees, containers          |
|  3. VERIFICATION - Tests, typecheck, browser automation       |
|  4. PERSISTENCE - Git, PRD, progress.txt                      |
|  5. EVOLUTION - Ralph loops, self-improvement, iteration      |
|                                                               |
+===============================================================+
      </div>

      <blockquote style="border-left: 3px solid #2a7d7d; padding-left: 1rem; margin: 2rem 0; font-style: italic; color: #5c4b3a; font-size: 1.1em;">
        "View AI agents as persistent, file-memory-based loops where AI acts as an autonomous worker, breaking projects into small, verifiable stories that compound over iterations--emphasizing eventual consistency over perfect first attempts."
      </blockquote>
    </section>

    <!-- Related Pages -->
    <div class="related-pages" style="margin-top: 2rem; padding: 1rem; background: #f9f6f0; border-radius: 8px;">
      <h4 style="margin-top: 0;">Related Documents</h4>
      <ul>
        <li><a href="architecture-complexity-ladder.html">Complexity Ladder</a> - Full progression from Level 0-7</li>
        <li><a href="mastery-ccmirror-complete.html">CC Mirror Complete</a> - Level 4-5 orchestration</li>
        <li><a href="mastery-gastown-complete.html">Gas Town Complete</a> - Level 7 factory-scale</li>
        <li><a href="mastery-context-management.html">Context Management</a> - Preventing context rot</li>
        <li><a href="compare-orchestration.html">Orchestration Comparison</a> - Detailed feature comparison</li>
      </ul>
      <h4>External Resources</h4>
      <ul>
        <li><a href="https://github.com/numman-ali/cc-mirror">CC Mirror</a> - Native orchestration</li>
        <li><a href="https://github.com/steveyegge/gastown">Gas Town</a> - Agent factory</li>
        <li><a href="https://github.com/steveyegge/beads">Beads</a> - Agent memory</li>
        <li><a href="https://github.com/0xSero/orchestra">Orchestra</a> - Self-improving agents</li>
      </ul>
    </div>

    <!-- Footer Navigation -->
    <div class="footer-nav" style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e0d5c5;">
      <a href="mastery-context-management.html">Prev: Context Management</a>
      <a href="mastery-ccmirror-complete.html">Next: CC Mirror Complete</a>
    </div>

  </div>

  <script src="../js/copy-code.js"></script>
  <script src="../js/search.js"></script>
  <script src="../js/global-nav.js"></script>
  <script>
    function copyCode(button) {
      const codeBlock = button.parentElement.querySelector('code');
      navigator.clipboard.writeText(codeBlock.textContent);
      button.textContent = 'Copied!';
      setTimeout(() => button.textContent = 'Copy', 2000);
    }
  </script>
</body>
</html>
