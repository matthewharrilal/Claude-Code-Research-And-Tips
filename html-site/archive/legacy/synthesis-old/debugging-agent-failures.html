<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta data-pagefind-meta="section" content="Synthesis">
  <meta data-pagefind-meta="category" content="Debugging">
  <title>Debugging Agent Failures - Claude Code Knowledge Base</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <link rel="stylesheet" href="../css/search.css">
</head>
<body>
  <!-- Search Modal -->
  <div class="search-modal" id="searchModal" aria-hidden="true">
    <div class="search-overlay" onclick="closeSearch()"></div>
    <div class="search-content">
      <div class="search-header">
        <div class="search-input-wrapper">
          <span class="search-icon-input">&#128269;</span>
          <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off" />
          <kbd class="search-kbd">ESC</kbd>
        </div>
      </div>
      <div class="search-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="synthesis">Synthesis</button>
        <button class="filter-btn" data-filter="extractions">Extractions</button>
      </div>
      <div class="search-results" id="searchResults">
        <div class="search-empty"><p>Start typing to search... (Press Cmd+K anytime)</p></div>
      </div>
      <div class="search-footer">
        <span>Up/Down Navigate</span><span>Enter Select</span><span>ESC Close</span>
      </div>
    </div>
  </div>

  <button class="search-trigger" onclick="openSearch()" aria-label="Search" style="float: right; margin-bottom: 1rem;">
    <span class="search-icon">Cmd+K</span>
    <span class="search-text">Search</span>
  </button>

  <div class="container">
    <!-- Breadcrumb Navigation -->
    <nav class="nav-breadcrumb">
      <a href="../index.html">Home</a>
      <span>/</span>
      <a href="synthesis-index.html">Synthesis</a>
      <span>/</span>
      <span>Debugging Agent Failures</span>
    </nav>

    <!-- You Are Here Context Box -->
    <div class="you-are-here" style="background: linear-gradient(135deg, #f0ebe3 0%, #fefcf3 100%); border-left: 4px solid #2a7d7d; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="color: #2a7d7d; margin-top: 0; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">You Are Here</h3>
      <p style="margin-bottom: 0;">This is your <strong>comprehensive debugging reference</strong> for Claude Code agent failures. Something broke - you need to fix it. Or you want to prevent failures before they happen. This guide synthesizes production war stories, 4,677+ GitHub issues, and multi-agent failure research into systematic diagnosis workflows.</p>
    </div>

    <h1><span class="bionic">Deb</span>ugging <span class="bionic">Age</span>nt <span class="bionic">Fai</span>lures</h1>

    <p class="conversational-lead">
      Complete diagnostic and recovery guide for Claude Code agent failures. From simple sessions through factory-scale orchestration. Philosophy: Observe systematically, hypothesize deliberately, isolate precisely, verify completely.
    </p>

    <!-- Table of Contents -->
    <div class="toc">
      <div class="toc-title">Contents</div>
      <ul>
        <li><a href="#debugging-mindset">The Debugging Mindset</a></li>
        <li><a href="#ohiv-framework">The OHIV Diagnosis Framework</a></li>
        <li><a href="#wrong-output">When Agents Produce Wrong Output</a></li>
        <li><a href="#tool-selection">Tool Selection for Failure Types</a></li>
        <li><a href="#logging">Logging Best Practices</a></li>
        <li><a href="#multi-agent">Multi-Agent Debugging</a></li>
        <li><a href="#case-studies">Case Studies from Production</a></li>
        <li><a href="#mental-models">Mental Models for Debugging</a></li>
        <li><a href="#decision-trees">Decision Trees</a></li>
        <li><a href="#troubleshooting">Troubleshooting Reference</a></li>
      </ul>
    </div>

    <hr class="section-divider">

    <!-- Debugging Mindset -->
    <section id="debugging-mindset">
      <h2>The <span class="bionic">Deb</span>ugging <span class="bionic">Min</span>dset</h2>

      <div class="callout callout-insight">
        <div class="callout-title">Core Principle</div>
        <p><strong>"Agent failures are systematic, not random."</strong></p>
        <p>Every failure follows a pattern. Understanding the pattern allows you to predict, diagnose, and prevent failures.</p>
      </div>

      <h3>The Five Categories of Agent Failure</h3>

      <div class="ascii-diagram">
THE FIVE FAILURE CATEGORIES
===========================

1. CONTEXT FAILURES
   |-- Token exhaustion
   |-- Quality degradation
   |-- Instruction amnesia
   +-- Hallucination under pressure

2. STATE FAILURES
   |-- Memory not persisting
   |-- State divergence
   |-- Progress overwriting
   +-- Stale context injection

3. COORDINATION FAILURES
   |-- Role confusion (orchestrator writes code)
   |-- Recursive explosion (workers spawn workers)
   |-- Deadlock between agents
   +-- Error amplification (17x in independent agents)

4. VERIFICATION FAILURES
   |-- False positive test results
   |-- Optimistic completion marking
   |-- Missing integration tests
   +-- Visual verification gaps

5. RESOURCE FAILURES
   |-- Cost runaway
   |-- Rate limiting
   |-- Infinite loops
   +-- Destructive operations
      </div>

      <h3>The 80-20 Rule of Agent Failures</h3>

      <p><strong>80% of failures come from:</strong></p>
      <ol>
        <li><strong>Context exhaustion</strong> - Working too long without fresh context</li>
        <li><strong>Missing verification</strong> - Not confirming results before proceeding</li>
        <li><strong>Vague instructions</strong> - Unclear acceptance criteria</li>
      </ol>

      <p><strong>The remaining 20%:</strong></p>
      <ul>
        <li>Multi-agent coordination issues</li>
        <li>Platform/version-specific bugs</li>
        <li>Edge cases in tool behavior</li>
        <li>Security-related incidents</li>
      </ul>

      <h3>The Failure Cascade Pattern</h3>

      <div class="ascii-diagram">
                Initial Failure
                      |
                      v
              +---------------+
              |   Ignored     | <-- Most common mistake
              +-------+-------+
                      |
                      v
              +---------------+
              |   Compounds   |
              |   with next   |
              |   iteration   |
              +-------+-------+
                      |
                      v
              +---------------+
              |   Creates     |
              |    three      |
              |     new       |
              |   problems    |
              +-------+-------+
                      |
                      v
              +---------------+
              |   Recovery    |
              |    becomes    |
              |   expensive   |
              +---------------+

KEY INSIGHT: Catch failures early. The cost of recovery
grows exponentially with each iteration.
      </div>
    </section>

    <hr class="section-divider">

    <!-- OHIV Framework -->
    <section id="ohiv-framework">
      <h2>The <span class="bionic">OHI</span>V <span class="bionic">Dia</span>gnosis <span class="bionic">Fra</span>mework</h2>

      <p><strong>O</strong>bserve - <strong>H</strong>ypothesize - <strong>I</strong>solate - <strong>V</strong>erify</p>

      <h3>Step 1: Observe</h3>

      <p>Gather all available evidence before making assumptions.</p>

      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>Question</th><th>Command</th></tr>
          </thead>
          <tbody>
            <tr><td>What did you expect to happen?</td><td>(Your mental model)</td></tr>
            <tr><td>What actually happened?</td><td><code>cat output.txt | tail -50</code></td></tr>
            <tr><td>When did the behavior change?</td><td><code>git log --oneline -10</code></td></tr>
            <tr><td>What was the last successful operation?</td><td><code>cat progress.txt | tail -20</code></td></tr>
            <tr><td>What has changed since then?</td><td><code>git diff HEAD</code></td></tr>
          </tbody>
        </table>
      </div>

      <h3>Step 2: Hypothesize</h3>

      <p>Form a specific, testable hypothesis about the cause.</p>

      <p><strong>Good hypotheses are:</strong></p>
      <ul>
        <li><strong>Specific:</strong> "Context exceeded 80%" not "something wrong"</li>
        <li><strong>Testable:</strong> Can verify with a single check</li>
        <li><strong>Falsifiable:</strong> Can prove it's NOT the cause</li>
        <li><strong>Actionable:</strong> If true, you know what to do</li>
      </ul>

      <p><strong>Start with most common causes:</strong></p>
      <ol>
        <li>Context exhaustion (most likely)</li>
        <li>Missing verification (second most likely)</li>
        <li>Unclear instructions (third most likely)</li>
      </ol>

      <h3>Step 3: Isolate</h3>

      <p>Narrow down to the specific failure point.</p>

      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>Technique</th><th>When to Use</th><th>Command</th></tr>
          </thead>
          <tbody>
            <tr><td>Binary search</td><td>Unknown when it broke</td><td><code>git bisect start</code></td></tr>
            <tr><td>Component isolation</td><td>Multiple systems involved</td><td>Test each part separately</td></tr>
            <tr><td>Minimal reproduction</td><td>Complex failure</td><td>Create smallest failing case</td></tr>
            <tr><td>Rollback</td><td>Need working state fast</td><td><code>git checkout HEAD~5</code></td></tr>
          </tbody>
        </table>
      </div>

      <h3>Step 4: Verify</h3>

      <p>Confirm the fix actually resolves the issue.</p>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Verification requirements - ALL must pass
npm test
echo "Exit code: $?"

npm run typecheck
echo "Exit code: $?"

# Manual verification of fix
# Only mark resolved when ALL verification passes</code></pre>
      </div>

      <!-- Checkpoint -->
      <div class="checkpoint" style="background: #f0ebe3; border-left: 4px solid #6b9b7a; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
        <div class="checkpoint-header" style="color: #6b9b7a; font-weight: 600;">Quick Diagnosis Checklist</div>
        <p>When something breaks, run through this immediately:</p>
        <div class="code-block">
          <pre><code># 1. Check git state
git status
git log --oneline -5

# 2. Check for recent changes
git diff HEAD~1

# 3. Run verification
npm test 2>&1 | tail -20
echo "Exit code: $?"

# 4. Check progress state (if using Ralph)
cat progress.txt | tail -30

# 5. Check for error patterns
grep -i "error\|failed" output.txt | tail -20</code></pre>
        </div>
      </div>

      <h3>Diagnosis Speed Table</h3>

      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>Symptom</th><th>Most Likely Cause</th><th>Quick Check</th><th>Quick Fix</th></tr>
          </thead>
          <tbody>
            <tr><td>Quality degrading</td><td>Context exhaustion</td><td>Claude HUD %</td><td><code>/compact</code> or <code>/reset</code></td></tr>
            <tr><td>Instructions ignored</td><td>Context pressure</td><td>Check CLAUDE.md</td><td>Restart session</td></tr>
            <tr><td>Files hallucinated</td><td>Context overflow</td><td><code>ls -la</code> the files</td><td>Reset session</td></tr>
            <tr><td>Tasks never complete</td><td>No completion criteria</td><td>Check prd.json</td><td>Add <code>passes</code> tracking</td></tr>
            <tr><td>Same error 3+ times</td><td>Task too complex</td><td>Check task scope</td><td>Split into smaller tasks</td></tr>
            <tr><td>Costs spiking</td><td>Runaway loop</td><td>Anthropic dashboard</td><td><code>pkill -f claude</code></td></tr>
            <tr><td>Workers spawning workers</td><td>Missing preamble</td><td>Check Task() calls</td><td>Add worker restrictions</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <hr class="section-divider">

    <!-- Wrong Output -->
    <section id="wrong-output">
      <h2>When <span class="bionic">Age</span>nts <span class="bionic">Pro</span>duce <span class="bionic">Wro</span>ng <span class="bionic">Out</span>put</h2>

      <h3>Taxonomy of Wrong Output</h3>

      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>Type</th><th>Symptom</th><th>Cause</th><th>Fix</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Incorrect Logic</strong></td><td>Code runs but produces wrong results</td><td>Misunderstanding of requirements</td><td>Better acceptance criteria, examples in prompt</td></tr>
            <tr><td><strong>Incomplete Implementation</strong></td><td>Code partially works, missing edge cases</td><td>Context pressure, task too large</td><td>Split task smaller, explicit edge case requirements</td></tr>
            <tr><td><strong>Hallucinated Code</strong></td><td>References functions/files that don't exist</td><td>Context overflow, training data confusion</td><td>Reset session, explicit file reads before writing</td></tr>
            <tr><td><strong>Style Violations</strong></td><td>Code works but doesn't match conventions</td><td>CLAUDE.md not loaded or too vague</td><td>Reference specific patterns in CLAUDE.md</td></tr>
            <tr><td><strong>Circular Revisions</strong></td><td>Same code rewritten multiple times</td><td>Conflicting requirements, no clear "done"</td><td>Clear acceptance criteria, single source of truth</td></tr>
            <tr><td><strong>Working But Wrong</strong></td><td>Passes tests but architecture is wrong</td><td>No architectural constraints in prompt</td><td>Specify approach constraints, reference examples</td></tr>
          </tbody>
        </table>
      </div>

      <h3>Diagnostic Questions for Wrong Output</h3>

      <p><strong>Ask these in order:</strong></p>

      <ol>
        <li><strong>Is the context window healthy?</strong> If over 70%, this is likely the root cause. Solution: Compact or restart.</li>
        <li><strong>Are the requirements clear and testable?</strong> Can YOU verify success by running a command? Solution: Add specific acceptance criteria.</li>
        <li><strong>Has Claude read the relevant code?</strong> Don't assume memory from previous reads. Solution: Explicit read before edit.</li>
        <li><strong>Is the task appropriately sized?</strong> 2-3 sentence description, 100-500 line change. Solution: Split into smaller tasks.</li>
        <li><strong>Are there conflicting instructions?</strong> Check CLAUDE.md, prompt, and previous conversation. Solution: Consolidate to single source of truth.</li>
      </ol>

      <h3>Wrong Output Recovery Procedure</h3>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Step 1: Stop the agent
# Ctrl+C or:
pkill -f claude

# Step 2: Preserve the current state for analysis
git stash push -m "investigating-wrong-output-$(date +%Y%m%d-%H%M%S)"

# Step 3: Review what was produced
git diff HEAD~1
cat output.txt | tail -100

# Step 4: Identify the type of wrong output
# (Use taxonomy above)

# Step 5: Fix the root cause
# - If context: /reset
# - If requirements: Update prd.json/CLAUDE.md
# - If task size: Split into smaller tasks

# Step 6: Retry with fix applied
git stash pop</code></pre>
      </div>

      <h3>Prevention: The Verification Sandwich</h3>

      <p>Structure every task with verification at start AND end:</p>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code>## Task: Implement User Login

### Pre-Verification (before starting):
- [ ] Read auth.ts to understand current auth pattern
- [ ] Read login.tsx to see existing form structure
- [ ] Confirm database schema has users table

### Implementation:
1. Add login form component
2. Add form validation
3. Add API route handler
4. Add session management

### Post-Verification (before marking complete):
- [ ] npm run typecheck passes
- [ ] npm test passes
- [ ] Manually test login flow at localhost:3000/login
- [ ] No console errors in browser</code></pre>
      </div>
    </section>

    <hr class="section-divider">

    <!-- Tool Selection -->
    <section id="tool-selection">
      <h2><span class="bionic">Too</span>l <span class="bionic">Sel</span>ection for <span class="bionic">Fai</span>lure <span class="bionic">Typ</span>es</h2>

      <h3>The Tool Matrix</h3>

      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>Failure Type</th><th>Primary Tool</th><th>Secondary Tools</th><th>When to Use</th></tr>
          </thead>
          <tbody>
            <tr><td>Context overflow</td><td><code>/compact</code>, <code>/reset</code></td><td>Claude HUD</td><td>Quality degradation, amnesia</td></tr>
            <tr><td>Runaway costs</td><td>Anthropic Dashboard</td><td><code>pkill -f claude</code></td><td>Unexpected bills, long runs</td></tr>
            <tr><td>Test failures</td><td>npm test, exit codes</td><td>git diff</td><td>Code not working</td></tr>
            <tr><td>Type errors</td><td>npm run typecheck</td><td>LSP diagnostics</td><td>Type mismatches</td></tr>
            <tr><td>File corruption</td><td>git checkout, git stash</td><td>git diff</td><td>Unexpected changes</td></tr>
            <tr><td>Permission issues</td><td>/permissions</td><td>CLI flags</td><td>Blocked operations</td></tr>
            <tr><td>MCP failures</td><td>/mcp, server logs</td><td>Connection checks</td><td>Server not responding</td></tr>
            <tr><td>Loop detection</td><td>progress.txt, git log</td><td>Stuck detection script</td><td>No progress for 3+ iterations</td></tr>
            <tr><td>Multi-agent conflicts</td><td>git worktree</td><td>Merge resolution</td><td>Parallel agent conflicts</td></tr>
          </tbody>
        </table>
      </div>

      <h3>Context Management Tools</h3>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Claude HUD - Real-time context monitoring
/plugin install claude-hud
/claude-hud:setup

# Sample output:
# [Opus 4.5] 67% | 2 MCPs | 23m
#           ^-- Context usage percentage

# Warning levels:
# 60-70%: Yellow warning - consider compacting
# 70-85%: Orange warning - compact recommended
# 85-95%: Red warning - compact required
# 95%+:   Critical - session degraded</code></pre>
      </div>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Compaction - Reduce context without reset
/compact

# When to use:
# - Context > 60% and continuing same task
# - Quality degradation noticed
# - BEFORE hitting critical levels

# Limitations:
# - Lossy: May lose nuanced instructions
# - Review behavior after compaction</code></pre>
      </div>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Reset - Full context clear
/reset

# When to use:
# - Context > 85%
# - Quality severely degraded
# - Switching to completely different task
# - After compaction didn't help

# Note: Requires re-establishing context from files</code></pre>
      </div>

      <h3>Git Recovery Tools</h3>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Check current state
git status
git diff HEAD

# Discard all unstaged changes
git checkout -- .

# Discard specific file
git checkout -- path/to/file.ts

# Save current state for later
git stash push -m "description"

# Restore saved state
git stash pop

# Hard reset to specific commit (CAUTION)
git reset --hard HEAD~1

# Find which commit broke something
git bisect start
git bisect bad  # Current is broken
git bisect good HEAD~10  # This was working
# Git will binary search</code></pre>
      </div>

      <h3>Tool Selection Decision Tree</h3>

      <div class="ascii-diagram">
What's the symptom?
|
|-- Quality degradation, amnesia, hallucinations
|   +-- TOOL: Context management (/compact, /reset, Claude HUD)
|
|-- Unexpected costs, long-running processes
|   +-- TOOL: Cost monitoring (Dashboard, pkill)
|
|-- Tests failing, code broken
|   +-- TOOL: Git tools (diff, checkout, stash)
|
|-- Agent stuck, no progress
|   +-- TOOL: Loop detection (progress.txt, git log)
|
|-- Permission errors, blocked operations
|   +-- TOOL: Permission management (/permissions)
|
|-- MCP server not responding
|   +-- TOOL: MCP debugging (/mcp, server logs)
|
|-- System slowdown, memory issues
|   +-- TOOL: Process monitoring (htop, ps)
|
+-- Multiple agents conflicting
    +-- TOOL: Git worktree, merge tools
      </div>
    </section>

    <hr class="section-divider">

    <!-- Logging -->
    <section id="logging">
      <h2><span class="bionic">Log</span>ging <span class="bionic">Bes</span>t <span class="bionic">Pra</span>ctices</h2>

      <h3>The Three Levels of Logging</h3>

      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>Level</th><th>What</th><th>Storage</th><th>Use Case</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Minimal</strong></td><td>Key decisions, errors, completion status</td><td>progress.txt, git commits</td><td>Normal development, Ralph loops</td></tr>
            <tr><td><strong>Standard</strong></td><td>All Level 1 + tool calls, file operations</td><td>debug.log, output.txt</td><td>Active debugging, issue reproduction</td></tr>
            <tr><td><strong>Verbose</strong></td><td>All Level 2 + API calls, token counts, timing</td><td>Multiple log files</td><td>Complex multi-agent debugging</td></tr>
          </tbody>
        </table>
      </div>

      <div class="callout callout-warning">
        <div class="callout-title">Disk Space Alert</div>
        <p>GitHub Issue #16093 documented <strong>42GB of debug logs</strong> from just 481 conversations over 7 days. Individual debug files grew to 20GB+.</p>
        <p><strong>Always:</strong></p>
        <ul>
          <li>Set up log rotation</li>
          <li>Monitor disk space: <code>df -h ~/.claude/</code></li>
          <li>Clean old logs regularly</li>
        </ul>
      </div>

      <h3>progress.txt Structure (Append-Only)</h3>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Ralph Progress Log
Started: 2026-01-19

## Codebase Patterns
- Use IF NOT EXISTS for all migrations
- Export types from actions.ts files
- Use shadcn/ui for form components

---

## 2026-01-19 09:15 - US-001 (PASS)
- **Task:** Added tasks table schema with status enum
- **Files changed:** db/schema.ts, migrations/001_add_tasks.sql
- **Learnings:**
  - Use `sql<number>` template for numeric aggregations
  - Drizzle requires explicit enum definition
- **Verification:** npm run typecheck (0), npm test (0)

---

## 2026-01-19 09:48 - US-003 (FAIL - Attempt 1)
- **Task:** Implement task status toggle
- **Error:** Type error in action handler - StatusType not exported
- **Root cause:** Missing type export from schema.ts
- **Next:** Will add export and retry

## 2026-01-19 09:55 - US-003 (PASS - Attempt 2)
- **Task:** Implement task status toggle
- **Learnings:**
  - Always export types from schema files for actions
- **Verification:** npm run typecheck (0), npm test (0)</code></pre>
      </div>

      <h3>Log Analysis Commands</h3>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Find all errors in debug log
grep -i "error\|fail\|exception" ~/.claude/debug/*.log

# Count operations by type
cat ~/.claude/debug/*.log | grep "EVENT:" | cut -d':' -f2 | sort | uniq -c | sort -rn

# Find file operation patterns
cat ~/.claude/debug/*.log | grep -E "Read|Write|Edit" | cut -d':' -f3 | sort | uniq -c

# Check total log size
du -sh ~/.claude/debug/</code></pre>
      </div>
    </section>

    <hr class="section-divider">

    <!-- Multi-Agent -->
    <section id="multi-agent">
      <h2><span class="bionic">Mul</span>ti-Agent <span class="bionic">Deb</span>ugging</h2>

      <h3>The Coordination Tax</h3>

      <p>Multi-agent systems introduce exponentially more failure modes than single agents.</p>

      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>Research Finding</th><th>Value</th></tr>
          </thead>
          <tbody>
            <tr><td>Specification problems</td><td>41.77%</td></tr>
            <tr><td>Coordination failures</td><td>36.94%</td></tr>
            <tr><td>Error amplification (independent agents)</td><td>17.2x</td></tr>
            <tr><td>Error amplification (centralized coordination)</td><td>4.4x</td></tr>
            <tr><td>Total unique failure modes identified</td><td>14</td></tr>
          </tbody>
        </table>
      </div>

      <h3>The Merge Wall Problem</h3>

      <blockquote>
        <p>"Yegge ran up to a dozen agents working on the same project. 'It worked amazingly up to about 200k LOC, and now they've begun savagely overwriting each other's work rather than try to deal with merge conflicts.'"</p>
        <cite>-- Steve Yegge, Gas Town</cite>
      </blockquote>

      <h3>Solutions to Merge Wall</h3>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># SOLUTION 1: Git Worktrees (File Isolation)
# Each agent works in completely separate directory
git worktree add ../wt-agent1 feature1-branch
git worktree add ../wt-agent2 feature2-branch

# Agents can work simultaneously without conflict
# Merge happens AFTER individual work complete</code></pre>
      </div>

      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># SOLUTION 2: Directory Ownership (Domain Isolation)
# Agent A owns: src/auth/, src/user/
# Agent B owns: src/payment/, src/billing/
# Agent C owns: src/notifications/

# No overlap = no conflicts
# Requires upfront planning of directory assignments</code></pre>
      </div>

      <h3>Multi-Agent Debugging Checklist</h3>

      <ul>
        <li><strong>STEP 1:</strong> Identify all active agents - <code>git worktree list</code> or <code>ps aux | grep claude</code></li>
        <li><strong>STEP 2:</strong> Check each agent's status - What task, current state, modified files?</li>
        <li><strong>STEP 3:</strong> Map file ownership - Were multiple agents editing the same file?</li>
        <li><strong>STEP 4:</strong> Check handoff points - Did Agent A's output reach Agent B?</li>
        <li><strong>STEP 5:</strong> Verify consensus (if applicable) - Did all agents agree?</li>
        <li><strong>STEP 6:</strong> Check for cascading failures - How far did the error spread?</li>
      </ul>

      <h3>CC Mirror Debugging (Iron Law)</h3>

      <div class="callout callout-insight">
        <div class="callout-title">The Iron Law</div>
        <p>"YOU DO NOT WRITE CODE. YOU DO NOT RUN COMMANDS. YOU DO NOT EXPLORE CODEBASES. You are the CONDUCTOR. Your agents play the instruments."</p>
      </div>

      <p><strong>Symptoms of Iron Law Violation:</strong></p>
      <ul>
        <li>Orchestrator context filling with file contents</li>
        <li>Orchestrator getting distracted by implementation details</li>
        <li>Worker spawning sub-workers (recursive explosion)</li>
        <li>Role confusion between planning and execution</li>
      </ul>

      <p><strong>Diagnosis:</strong></p>
      <ol>
        <li>Check orchestrator's tool usage - Should see: TaskCreate, TaskList, TaskGet, TaskUpdate, Task</li>
        <li>Should NOT see: Read (more than 1-2 files), Write, Edit, Bash</li>
        <li>Check worker preambles - Workers should NEVER call Task()</li>
      </ol>
    </section>

    <hr class="section-divider">

    <!-- Case Studies -->
    <section id="case-studies">
      <h2><span class="bionic">Cas</span>e <span class="bionic">Stu</span>dies from <span class="bionic">Pro</span>duction</h2>

      <h3>Case Study 1: The $47,000 Recursive Loop</h3>

      <div class="callout callout-warning">
        <div class="callout-title">What Happened</div>
        <p>A multi-agent research tool slipped into a recursive loop that ran for <strong>11 days</strong> before anyone noticed, accumulating <strong>$47,000</strong> in API costs.</p>
      </div>

      <p><strong>Root Cause:</strong></p>
      <ol>
        <li>Agents misinterpreted uncertainty as failure</li>
        <li>"Failure" triggered correction attempts</li>
        <li>Corrections created new uncertainties</li>
        <li>New uncertainties triggered more corrections</li>
        <li>Self-reinforcing loop with no exit condition</li>
      </ol>

      <p><strong>Prevention Measures:</strong></p>
      <ul>
        <li><code>MAX_ITERATIONS=25</code> in all scripts</li>
        <li>Budget limits in Anthropic console</li>
        <li>Daily cost alerts</li>
        <li>Stuck detection: Exit if no commit for 3+ iterations</li>
        <li>Timeout: <code>timeout 3600 ./ralph.sh 50</code></li>
      </ul>

      <h3>Case Study 2: The Home Directory Deletion</h3>

      <div class="callout callout-warning">
        <div class="callout-title">What Happened</div>
        <p>Claude executed: <code>rm -rf tests/ patches/ plan/ ~/</code></p>
        <p>That trailing <code>~/</code> deleted the user's <strong>entire home folder</strong>.</p>
      </div>

      <p><strong>Why It Happened:</strong></p>
      <ul>
        <li>User had <code>--dangerously-skip-permissions</code> enabled</li>
        <li>No blocklist for rm -rf patterns</li>
        <li>Claude constructed command without safety review</li>
      </ul>

      <p><strong>Mandatory Prevention:</strong></p>
      <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code>{
  "permissions": {
    "blockedPatterns": [
      "rm -rf",
      "rm -r",
      "find . -delete",
      "sudo rm",
      "git push --force",
      "git reset --hard"
    ]
  }
}</code></pre>
      </div>

      <h3>Case Study 3: The 3.2 Million Token Circular Revision</h3>

      <div class="callout callout-warning">
        <div class="callout-title">What Happened</div>
        <p>"Nine senior engineers debugged the same authentication module for <strong>72 hours straight</strong>. Their Claude Code agents had rewritten the OAuth flow <strong>seventeen times</strong>, each iteration drifting further from the original architecture."</p>
        <p><strong>Token Consumption:</strong> 3.2 million tokens</p>
        <p><strong>Time Wasted:</strong> 648 engineer-hours</p>
        <p><strong>Result:</strong> Code worse than when they started</p>
      </div>

      <p><strong>Detection Signals:</strong></p>
      <ul>
        <li>Same file edited 5+ times</li>
        <li>Oscillating changes (add then remove)</li>
        <li>Quality degradation despite "fixes"</li>
        <li>Growing token consumption without progress</li>
      </ul>

      <p><strong>Prevention:</strong></p>
      <ul>
        <li>Fresh context each iteration (Ralph pattern)</li>
        <li>External state that persists correct decisions</li>
        <li>Verification BEFORE marking complete</li>
        <li>Never work > 30 minutes without context refresh</li>
        <li>Git commits as checkpoints to return to</li>
      </ul>
    </section>

    <hr class="section-divider">

    <!-- Mental Models -->
    <section id="mental-models">
      <h2><span class="bionic">Men</span>tal <span class="bionic">Mod</span>els for <span class="bionic">Deb</span>ugging</h2>

      <h3>Mental Model 1: The Context Horizon</h3>

      <p>Like a ship's horizon, there's a limit to what Claude can "see." Content beyond the horizon is invisible - it might as well not exist.</p>

      <div class="ascii-diagram">
                              +---------------+
                              |  Your Task    |
                              +-------+-------+
                                      |
        +-----------------------------+-----------------------------+
        |                             |                             |
        |       VISIBLE HORIZON       |                             |
        |       (Context Window)      |                             |
        |                             |                             |
        |  +-----+ +-----+ +------+   |   +-----+ +-----+           |
        |  |File1| |File2| |CLAUDE|   |   |Prev | |Tool |           |
        |  +-----+ +-----+ | .md  |   |   |Conv | |Out  |           |
        |                  +------+   |   +-----+ +-----+           |
        +-----------------------------+-----------------------------+
~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~  ~
              BEYOND THE HORIZON (Invisible, forgotten)
        +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
        |Old  | |Prune| |Early| |Stale| |Forgot| |Gone | |Lost |
        +-----+ +-----+ +-----+ +-----+ +-----+ +-----+ +-----+
      </div>

      <p><strong>Debugging Implication:</strong> When Claude "forgets" something, it hasn't forgotten - it was pushed beyond the horizon. The solution is NOT to remind it (that adds more content), but to:</p>
      <ol>
        <li>Compact the context (raise the horizon)</li>
        <li>Reset and reload essential content only</li>
        <li>Use external files that can be re-read</li>
      </ol>

      <h3>Mental Model 2: The Verification Triangle</h3>

      <p>Every claim of "done" must pass through three verification gates. Skipping any gate allows bugs to pass through undetected.</p>

      <div class="ascii-diagram">
                           +------------------+
                           |      "DONE"      |
                           +--------+---------+
                                    |
                    +---------------+---------------+
                    |               |               |
                    v               v               v
            +---------------+ +---------------+ +---------------+
            |   STATIC      | |   RUNTIME     | |   VISUAL      |
            | VERIFICATION  | | VERIFICATION  | | VERIFICATION  |
            +---------------+ +---------------+ +---------------+
            | npm run       | | npm test      | | Browser       |
            | typecheck     | |               | | screenshot    |
            |               | | Exit code 0   | | or Playwright |
            | No type       | | All tests     | | Looks correct |
            | errors        | | pass          | |               |
            +-------+-------+ +-------+-------+ +-------+-------+
                    |               |               |
                    +---------------+---------------+
                                    |
                                    v
                           +------------------+
                           |  ACTUALLY DONE   |
                           +------------------+
      </div>

      <p><strong>When a "done" task fails later, trace back through the triangle:</strong></p>
      <ul>
        <li>Did types pass? If not, interface mismatch</li>
        <li>Did tests pass? If not, logic error</li>
        <li>Did visual pass? If not, UI/UX issue</li>
      </ul>

      <h3>Mental Model 3: The Cascade Amplifier</h3>

      <p>Each unaddressed error creates 3 new problems. Errors don't stay constant - they multiply.</p>

      <div class="ascii-diagram">
ITERATION 1:  1 error
               |
               +--- not fixed --->

ITERATION 2:  1 --> 3 errors
                     |
                     +--- not fixed --->

ITERATION 3:  3 --> 9 errors
                     |
                     +--- not fixed --->

ITERATION 4:  9 --> 27 errors
                     |
                     +--- not fixed --->

ITERATION 5:  27 --> 81 errors

COST OF FIX BY ITERATION:
--------------------------
Iteration 1: Fix 1 error     = 1 unit of work
Iteration 2: Fix 3 errors    = 3 units of work
Iteration 3: Fix 9 errors    = 9 units of work
Iteration 4: Fix 27 errors   = 27 units of work
Iteration 5: Fix 81 errors   = 81 units of work

Total if caught at Iteration 1: 1 unit
Total if caught at Iteration 5: 121 units
      </div>

      <p><strong>Application:</strong></p>
      <ul>
        <li>Stop as soon as you detect an issue</li>
        <li>NEVER continue iterating with known problems</li>
        <li>Verification after EVERY iteration, not just at the end</li>
        <li>"Push through" mentality is the enemy</li>
      </ul>
    </section>

    <hr class="section-divider">

    <!-- Decision Trees -->
    <section id="decision-trees">
      <h2><span class="bionic">Dec</span>ision <span class="bionic">Tre</span>es</h2>

      <h3>Master Decision Tree</h3>

      <div class="ascii-diagram">
                         ERROR ENCOUNTERED
                               |
                               v
            +------------------------------------------+
            |         Is this an emergency?             |
            |  (data loss, runaway costs, security)     |
            +--------------------+---------------------+
                       |                    |
                      YES                  NO
                       |                    |
                       v                    v
              +----------------+   +------------------------+
              | EMERGENCY STOP |   | Identify error category |
              | pkill -f claude|   +-----------+------------+
              | Check damage   |               |
              +----------------+               v
                               +------------------------------+
                               | Is the error deterministic?   |
                               +-------------+----------------+
                                      |           |
                                     YES         NO
                                      |           |
                                      v           v
                           +-------------+ +-----------------+
                           | Fix root    | | Add defense     |
                           | cause       | | layers          |
                           +------+------+ +--------+--------+
                                  |                 |
                                  +--------+--------+
                                           |
                                           v
                               +------------------------------+
                               | Can you continue this session?|
                               +-------------+----------------+
                                      |           |
                                     YES         NO
                                      |           |
                                      v           v
                           +-------------+ +-----------------+
                           | Apply fix,  | | Save state,     |
                           | continue    | | fresh session   |
                           +-------------+ +-----------------+
      </div>

      <h3>Quick Reference: Error to Recovery Mapping</h3>

      <div class="table-responsive">
        <table>
          <thead>
            <tr><th>Error Symptom</th><th>Category</th><th>Recovery Pattern</th></tr>
          </thead>
          <tbody>
            <tr><td>"API Error 400"</td><td>Context Overflow</td><td>Restart with fresh context</td></tr>
            <tr><td>Quality degrading</td><td>Context Rot</td><td>/compact or fresh session</td></tr>
            <tr><td>Same file edited 5+ times</td><td>Verification Loop</td><td>Decompose further</td></tr>
            <tr><td>Tests pass but shouldn't</td><td>Validation</td><td>Add exit code verification</td></tr>
            <tr><td>$500+ bill unexpected</td><td>Cost Runaway</td><td>Circuit breaker, kill process</td></tr>
            <tr><td>rate_limit errors</td><td>Rate Limit</td><td>Exponential backoff</td></tr>
            <tr><td>Files deleted</td><td>Security</td><td>Restore from git, add blocklist</td></tr>
            <tr><td>Credentials visible</td><td>Security</td><td>Rotate immediately, add .claudeignore</td></tr>
            <tr><td>Agents spawning agents</td><td>Orchestration</td><td>Add worker preamble</td></tr>
            <tr><td>Merge conflicts</td><td>Multi-Agent</td><td>Use git worktrees</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <hr class="section-divider">

    <!-- Troubleshooting -->
    <section id="troubleshooting">
      <h2><span class="bionic">Tro</span>ubleshooting <span class="bionic">Ref</span>erence</h2>

      <details class="troubleshoot">
        <summary>Context Overflow - API Error 400</summary>
        <div>
          <p><strong>Symptoms:</strong> <code>API Error 400</code> messages, Claude becomes "completely unusable"</p>
          <p><strong>Cause:</strong> Conversation has exceeded maximum context window (200K tokens)</p>
          <p><strong>Solution:</strong></p>
          <ol>
            <li>You cannot continue this session</li>
            <li>Save any uncommitted work: <code>git stash</code></li>
            <li>Exit Claude Code: <code>exit</code></li>
            <li>Start fresh session</li>
            <li>Load essential context only</li>
          </ol>
          <p><strong>Prevention:</strong> Never work more than 2-3 hours without fresh context. Use Ralph pattern for long-running work.</p>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>Infinite Loop - No Progress</summary>
        <div>
          <p><strong>Symptoms:</strong> Same file edited repeatedly, no commits for 3+ iterations</p>
          <p><strong>Cause:</strong> Task is blocked, broken, or has unsatisfiable criteria</p>
          <p><strong>Solution:</strong></p>
          <div class="code-block">
            <pre><code># 1. Interrupt
Ctrl+C

# 2. If that doesn't work
Ctrl+\

# 3. If still running
pkill -9 -f claude

# 4. Check what was accomplished
git log --oneline -5

# 5. Fix the stuck task by simplifying it</code></pre>
          </div>
          <p><strong>Prevention:</strong> Always set <code>MAX_ITERATIONS</code>. Include timeout: <code>timeout 3600 ./ralph.sh 50</code></p>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>Cost Runaway</summary>
        <div>
          <p><strong>Symptoms:</strong> API costs far exceed expectations, token usage in millions</p>
          <p><strong>Cause:</strong> No iteration limits, using Opus for everything, runaway loops</p>
          <p><strong>Solution:</strong></p>
          <div class="code-block">
            <pre><code># 1. Kill all Claude processes immediately
pkill -f claude

# 2. Check Anthropic dashboard
open https://console.anthropic.com/

# 3. Set hard budget limit in console

# 4. Review what caused high usage
cat output.txt | tail -100
cat progress.txt | tail -50</code></pre>
          </div>
          <p><strong>Prevention:</strong> Always set iteration limits. Use timeouts. Match model to task complexity.</p>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>File Corruption or Deletion</summary>
        <div>
          <p><strong>Symptoms:</strong> Files contain partial content, syntax invalid, files deleted unexpectedly</p>
          <p><strong>Cause:</strong> Session interrupted mid-write, destructive command executed</p>
          <p><strong>Solution:</strong></p>
          <div class="code-block">
            <pre><code># 1. Stop immediately
Ctrl+C

# 2. Check what changed
git status
git diff

# 3. Discard changes to specific file
git checkout -- path/to/file.ts

# 4. Or revert all changes
git checkout -- .

# 5. If uncommitted work was stashed
git stash pop</code></pre>
          </div>
          <p><strong>Prevention:</strong> Commit before long operations. Add destructive commands to blocklist.</p>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>Workers Spawning Workers (Recursive Explosion)</summary>
        <div>
          <p><strong>Symptoms:</strong> Subagent depth exceeds 2-3 levels, context usage spikes, runaway costs</p>
          <p><strong>Cause:</strong> Workers not properly restricted</p>
          <p><strong>Solution:</strong></p>
          <div class="code-block">
            <pre><code># 1. Kill all Claude processes
pkill -f claude

# 2. Revert incomplete changes
git checkout -- .

# 3. Restart with proper worker preamble</code></pre>
          </div>
          <p><strong>Prevention - Always use worker preamble:</strong></p>
          <div class="code-block">
            <pre><code>CONTEXT: You are a WORKER agent, not an orchestrator.

RULES:
- Complete ONLY the task described below
- Use tools directly (Read, Write, Edit, Bash, etc.)
- Do NOT spawn sub-agents
- Do NOT call TaskCreate or TaskUpdate
- Report your results with absolute file paths</code></pre>
          </div>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>Tests Pass But Shouldn't</summary>
        <div>
          <p><strong>Symptoms:</strong> Claude reports tests pass but tests are actually broken or not running</p>
          <p><strong>Cause:</strong> Claude saw output and assumed success without verifying exit code</p>
          <p><strong>Solution:</strong></p>
          <div class="code-block">
            <pre><code># 1. Run tests and capture exit code
npm test 2>&1 | tail -20
echo "Exit code: $?"

# 2. Verify test framework exists
npm list jest || npm list vitest

# 3. Check test file count
find . -name "*.test.*" -o -name "*.spec.*" | wc -l</code></pre>
          </div>
          <p><strong>Prevention:</strong> Always include exit code verification in acceptance criteria.</p>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>Merge Conflicts Between Parallel Agents</summary>
        <div>
          <p><strong>Symptoms:</strong> Git conflicts at merge time, file corruption, work overwritten</p>
          <p><strong>Cause:</strong> Multiple agents editing same files without isolation</p>
          <p><strong>Prevention:</strong></p>
          <div class="code-block">
            <pre><code># Use git worktrees for complete isolation
git worktree add ../wt-feature1 feature1-branch
git worktree add ../wt-feature2 feature2-branch

# Each agent works in isolated worktree
# Merge only after both complete</code></pre>
          </div>
        </div>
      </details>
    </section>

    <!-- Related Pages -->
    <div class="related-pages">
      <h3>Related Documents</h3>
      <ul>
        <li><a href="error-taxonomy-recovery.html">Error Taxonomy</a> - Complete error classification and recovery patterns</li>
        <li><a href="principles-anti-patterns.html">Anti-Patterns</a> - What NOT to do and why</li>
        <li><a href="cross-pattern-migration.html">Migration Guide</a> - When things break during migration</li>
        <li><a href="architecture-complexity-ladder.html">Complexity Ladder</a> - Match complexity to your needs</li>
      </ul>
    </div>

    <!-- Footer Navigation -->
    <nav class="footer-nav">
      <a href="error-taxonomy-recovery.html" class="nav-prev">
        <span class="nav-direction">Previous</span>
        <span class="nav-title">Error Taxonomy</span>
      </a>
      <a href="principles-anti-patterns.html" class="nav-next">
        <span class="nav-direction">Next</span>
        <span class="nav-title">Anti-Patterns</span>
      </a>
    </nav>

    <!-- Tags -->
    <div style="margin-top: 2rem;">
      <span class="tag">#debugging</span>
      <span class="tag">#troubleshooting</span>
      <span class="tag">#failure-modes</span>
      <span class="tag">#recovery</span>
      <span class="tag">#diagnostics</span>
      <span class="tag">#context-management</span>
      <span class="tag">#multi-agent</span>
      <span class="tag">#verification</span>
    </div>
  </div>

  <script src="../js/copy-code.js"></script>
  <script src="../js/search.js"></script>
<script src="../js/global-nav.js"></script>
</body>
</html>
