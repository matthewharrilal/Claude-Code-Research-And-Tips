<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta data-pagefind-meta="section" content="Synthesis">
  <meta data-pagefind-meta="category" content="Architecture">
  <title>Agent Pattern Primitives - Claude Code Knowledge Base</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <link rel="stylesheet" href="../css/search.css">
</head>
<body>
  <nav class="left-nav" id="leftNav">
    <div class="px-4 mb-4">
      <a href="../index.html" class="text-xs font-semibold text-accent hover:text-accent-light uppercase tracking-wider">Claude Code KB</a>
    </div>
    <div class="nav-content"></div>
  </nav>

  <!-- Search Modal -->
  <div class="search-modal" id="searchModal" aria-hidden="true">
    <div class="search-overlay" onclick="closeSearch()"></div>
    <div class="search-content">
      <div class="search-header">
        <div class="search-input-wrapper">
          <span class="search-icon-input">&#128269;</span>
          <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off" />
          <kbd class="search-kbd">ESC</kbd>
        </div>
      </div>
      <div class="search-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="synthesis">Synthesis</button>
        <button class="filter-btn" data-filter="extractions">Extractions</button>
      </div>
      <div class="search-results" id="searchResults">
        <div class="search-empty"><p>Start typing to search... (Press Cmd+K anytime)</p></div>
      </div>
      <div class="search-footer">
        <span>Up/Down Navigate</span><span>Enter Select</span><span>ESC Close</span>
      </div>
    </div>
  </div>

  <button class="search-trigger" onclick="openSearch()" aria-label="Search" style="float: right; margin-bottom: 1rem;">
    <span class="search-icon">Cmd+K</span>
    <span class="search-text">Search</span>
  </button>

  <div class="wide-container">
    <!-- Breadcrumb Navigation -->
    <nav class="nav-breadcrumb">
      <a href="../index.html">Home</a>
      <span>/</span>
      <a href="synthesis-index.html">Synthesis</a>
      <span>/</span>
      <span>Architecture</span>
      <span>/</span>
      <span>Primitives</span>
    </nav>

    <!-- You Are Here Context Box -->
    <div class="you-are-here" style="background: linear-gradient(135deg, #f0ebe3 0%, #fefcf3 100%); border-left: 4px solid #2a7d7d; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="color: #2a7d7d; margin-top: 0; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">You Are Here</h3>
      <p style="margin-bottom: 0;">This is the <strong><span style="font-weight: 700;">ato</span>mic building block catalog</strong> - the LEGO bricks that compose all orchestration patterns. Read this first to understand the individual pieces, then see <a href="architecture-composition-rules.html">Composition Rules</a> for how they combine into complete patterns like Ralph and CC Mirror.</p>
    </div>

    <h1><span style="font-weight: 700;">Age</span>nt Pattern Primitives</h1>

    <p class="conversational-lead">
      A <span style="font-weight: 700;">com</span>prehensive catalog of the atomic building blocks that compose complex AI agent orchestration patterns. These primitives are the smallest reusable units extracted from Ralph, Gas Town, CC Mirror, Panopticon, and other production agent architectures.
    </p>

    <!-- Table of Contents -->
    <div class="toc">
      <div class="toc-title">Contents</div>
      <ul>
        <li><a href="#loop-primitives">Loop Primitives</a> - The iteration patterns</li>
        <li><a href="#state-primitives">State Primitives</a> - External memory files</li>
        <li><a href="#control-primitives">Control Primitives</a> - Termination and flow</li>
        <li><a href="#quality-gate-primitives">Quality Gate Primitives</a> - Verification checks</li>
        <li><a href="#coordination-primitives">Coordination Primitives</a> - Multi-agent patterns</li>
        <li><a href="#memory-primitives">Memory Primitives</a> - Persistence strategies</li>
        <li><a href="#hook-primitives">Hook Primitives</a> - Event-driven automation</li>
        <li><a href="#communication-primitives">Communication Primitives</a> - Agent handoffs</li>
        <li><a href="#how-primitives-compose">How Primitives Compose</a> - Pattern examples</li>
        <li><a href="#troubleshooting">Troubleshooting</a> - Common issues</li>
      </ul>
    </div>

    <hr class="section-divider divider-procedure">

    <!-- Loop Primitives Section -->
    <section id="loop-primitives">
      <h2><span style="font-weight: 700;">Loo</span>p Primitives</h2>

      <h3>Basic While Loop</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>while :; do
  cat prompt.md | claude
done</code></pre>
      </div>

      <p><strong>What it does:</strong> Infinite loop that continuously spawns fresh Claude sessions with the same prompt.</p>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>Each iteration gets a fresh context window</li>
        <li>No memory between iterations (relies on external state)</li>
        <li>Will run forever unless externally stopped</li>
      </ul>

      <p><strong>Variations:</strong></p>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Simple infinite loop
while :; do claude @prompt.md ; done

# With sleep between iterations
while :; do claude @prompt.md; sleep 2; done</code></pre>
      </div>

      <p><strong>Used in:</strong> Ralph (basic form), Panopticon cron jobs</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Iteration-Limited Loop</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>MAX_ITERATIONS=${1:-10}

for (( i=1; i&lt;=$MAX_ITERATIONS; i++ )); do
  echo "Iteration $i / $MAX_ITERATIONS"

  claude "$PROMPT" | tee output.txt

  # Check for early exit condition
  if grep -q "COMPLETE" output.txt; then
    break
  fi
done</code></pre>
      </div>

      <p><strong>What it does:</strong> Runs a bounded number of iterations with an early exit condition.</p>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>Prevents runaway costs</li>
        <li>Supports early exit on completion</li>
        <li>Logs iteration number for debugging</li>
      </ul>

      <p><strong>Used in:</strong> Ralph (primary form), Marathon Ralph, Lisa</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>jq-Based Conditional Loop</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>while jq '.tasks[] | select(.passes == false)' prd.json | grep -q .; do
  claude --chrome -p "$PROMPT"
done</code></pre>
      </div>

      <p><strong>What it does:</strong> Loops until all tasks in a JSON file are marked as passed.</p>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>State-driven termination</li>
        <li>Relies on agent updating JSON file</li>
        <li>More semantic than grep for completion</li>
      </ul>

      <p><strong>Source:</strong> @maurice_kleine in Matt Pocock's thread</p>

      <!-- Checkpoint Box -->
      <div class="checkpoint" style="background: #f0ebe3; border-left: 4px solid #6b9b7a; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
        <div class="checkpoint-header" style="color: #6b9b7a; font-weight: 600;">Checkpoint: Loop Primitives</div>
        <p><strong>You should now understand:</strong></p>
        <ul>
          <li>The difference between infinite (<code>while :;</code>) and bounded loops</li>
          <li>How jq can drive conditional loop termination</li>
          <li>When to use self-improvement loops (experimental/advanced)</li>
          <li>The importance of fresh context per iteration</li>
        </ul>
        <p><strong>Terminal verification:</strong></p>
        <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
          <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
          <pre style="margin: 0; overflow-x: auto;"><code># Test basic loop syntax:
for i in 1 2 3; do echo "Iteration $i"; done
# Expected output: Iteration 1, Iteration 2, Iteration 3</code></pre>
        </div>
      </div>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- State Primitives Section -->
    <section id="state-primitives">
      <h2><span style="font-weight: 700;">Sta</span>te Primitives</h2>

      <h3>progress.txt (Append-Only Log)</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Ralph Progress Log
Started: 2026-01-09

## Codebase Patterns
- Migrations: Use IF NOT EXISTS
- Types: Export from actions.ts

## Key Files
- db/schema.ts
- app/auth/actions.ts

---

## 2026-01-09 - US-001
- What was implemented: Login endpoint
- Files changed: src/api/auth.ts
- **Learnings:**
  - bcrypt needs salt rounds of 12
  - JWT expiry should be configurable
---</code></pre>
      </div>

      <p><strong>Format:</strong></p>
      <ul>
        <li>Markdown with dated sections</li>
        <li>Append-only (never update previous entries)</li>
        <li>Two sections: "Codebase Patterns" at top (persistent learnings), entries below (per-iteration)</li>
      </ul>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>Human-readable</li>
        <li>Git-tracked</li>
        <li>Cross-iteration memory</li>
        <li>Pattern accumulation over time</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>prd.json (Task Status Tracking)</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>{
  "project": "MyApp",
  "branchName": "ralph/feature-auth",
  "description": "User Authentication System",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create login endpoint",
      "description": "As a user, I need a login endpoint",
      "acceptanceCriteria": [
        "POST /api/auth/login accepts email + password",
        "Returns JWT on success",
        "npm run typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Add password hashing",
      "priority": 2,
      "blockedBy": ["US-001"],
      "passes": false,
      "notes": ""
    }
  ]
}</code></pre>
      </div>

      <p><strong>Key fields:</strong></p>
      <table class="comparison-table">
        <thead>
          <tr><th>Field</th><th>Purpose</th></tr>
        </thead>
        <tbody>
          <tr><td><code>branchName</code></td><td>Git branch for this feature set</td></tr>
          <tr><td><code>id</code></td><td>Unique story identifier</td></tr>
          <tr><td><code>priority</code></td><td>Lower number = execute first</td></tr>
          <tr><td><code>passes</code></td><td><code>false</code> = needs work, <code>true</code> = complete</td></tr>
          <tr><td><code>blockedBy</code></td><td>Dependencies (optional)</td></tr>
          <tr><td><code>acceptanceCriteria</code></td><td>Verifiable completion conditions</td></tr>
        </tbody>
      </table>

      <!-- Checkpoint Box -->
      <div class="checkpoint" style="background: #f0ebe3; border-left: 4px solid #6b9b7a; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
        <div class="checkpoint-header" style="color: #6b9b7a; font-weight: 600;">Checkpoint: State Primitives</div>
        <p><strong>You should now understand:</strong></p>
        <ul>
          <li>progress.txt format: append-only log with Codebase Patterns section</li>
          <li>prd.json format: userStories array with passes, acceptanceCriteria, priority</li>
          <li>Why checkpoint state enables crash recovery</li>
          <li>The difference between session state (progress.txt) and task state (prd.json)</li>
        </ul>
        <p><strong>If unclear:</strong> Create a sample prd.json with 2-3 user stories and verify it parses correctly with <code>jq . prd.json</code>.</p>
      </div>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Control Primitives Section -->
    <section id="control-primitives">
      <h2><span style="font-weight: 700;">Con</span>trol Primitives</h2>

      <h3>Promise/Stop Condition</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>If ALL stories pass, reply with:
&lt;promise&gt;COMPLETE&lt;/promise&gt;

Otherwise end normally.</code></pre>
      </div>

      <p><strong>Detection:</strong></p>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>if grep -q "&lt;promise&gt;COMPLETE&lt;/promise&gt;" output.txt; then
  echo "All stories complete!"
  exit 0
fi</code></pre>
      </div>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>Unambiguous signal (unlikely to appear in normal output)</li>
        <li>XML-style tags for reliability</li>
        <li>Searched via grep in shell wrapper</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Max Iteration Guard</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>MAX_ITERATIONS=${1:-10}
CURRENT_ITERATION=1

while [ $CURRENT_ITERATION -le $MAX_ITERATIONS ]; do
  # ... do work ...

  CURRENT_ITERATION=$((CURRENT_ITERATION + 1))
done

echo "Max iterations reached"
exit 1</code></pre>
      </div>

      <p><strong>What it does:</strong> Prevents infinite loops and runaway costs.</p>

      <p><strong>Typical values:</strong></p>
      <ul>
        <li>10-25 for feature development</li>
        <li>50+ for large migrations</li>
        <li>Cost scales linearly with iterations</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Story Selection Logic</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>## Your Task

1. Read `scripts/ralph/prd.json`
2. Read `scripts/ralph/progress.txt` (check Codebase Patterns first)
3. Pick highest priority story where `passes: false`
4. Implement that ONE story
5. Run typecheck and tests
6. Update prd.json: `passes: true`
7. Append learnings to progress.txt</code></pre>
      </div>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>Priority-ordered selection</li>
        <li>Single story per iteration (prevents context overload)</li>
        <li>External state check before each iteration</li>
      </ul>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Quality Gate Primitives Section -->
    <section id="quality-gate-primitives">
      <h2><span style="font-weight: 700;">Qua</span>lity Gate Primitives</h2>

      <h3>Typecheck Gate</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>npm run typecheck
# or
tsc --noEmit
# or
pnpm typecheck</code></pre>
      </div>

      <p><strong>What it does:</strong> Verifies type safety before marking task complete.</p>

      <p><strong>Always include in acceptance criteria:</strong></p>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>"acceptanceCriteria": [
  "...",
  "npm run typecheck passes"
]</code></pre>
      </div>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Test Gate</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>npm test
# or
npm run test -- --related
# or
pytest</code></pre>
      </div>

      <p><strong>What it does:</strong> Runs test suite to verify correctness.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>CI Green Gate</h3>

      <div class="callout callout-insight">
        <div class="callout-title">Key insight from Matt Pocock:</div>
        <blockquote style="margin: 0; padding-left: 1rem; border-left: 2px solid #2a7d7d;">
          "If you don't do this, you're hamstringing future agent runs with bad code, and they'll need to bisect to find bugs."
        </blockquote>
      </div>

      <p>Every commit must pass all checks:</p>
      <ol>
        <li><code>npm run typecheck</code></li>
        <li><code>npm run test</code></li>
        <li><code>npm run lint</code></li>
      </ol>
      <p>If ANY fail, do NOT mark story as passed.</p>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Coordination Primitives Section -->
    <section id="coordination-primitives">
      <h2><span style="font-weight: 700;">Coo</span>rdination Primitives</h2>

      <h3>TaskCreate / TaskUpdate (Native)</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>TaskCreate  -> Create with subject, description, acceptance criteria
TaskList    -> Filter: status='open', no owner, not blocked
TaskGet     -> Full context: description, comments, dependencies
TaskUpdate  -> Claim (set owner), add comments, resolve, link references</code></pre>
      </div>

      <p><strong>Visual output:</strong></p>
      <div class="ascii-diagram">
Tasks:
&#9745; #1 Design API architecture
&#9744; #2 Create project structure
&#9744; #3 Implement data models
&#128992; #4 Implement REST endpoints (blocked by #3)
&#128992; #5 Write integration tests (blocked by #4)
      </div>

      <p><strong>Source:</strong> CC Mirror (beta feature enabled)</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Worker Preamble Template</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>CONTEXT: You are a WORKER agent, not an orchestrator.

RULES:
- Complete ONLY the task described below
- Use tools directly (Read, Write, Edit, Bash, etc.)
- Do NOT spawn sub-agents
- Do NOT call TaskCreate or TaskUpdate
- Report your results with absolute file paths

TASK:
[Your specific task here]</code></pre>
      </div>

      <p><strong>What it does:</strong> Constrains worker agents to execution only, prevents recursion.</p>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>Explicit tool ownership</li>
        <li>No meta-operations allowed</li>
        <li>Must report with absolute paths</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Model Selection Matrix</h3>

      <table class="comparison-table">
        <thead>
          <tr><th>Model</th><th>Use Case</th><th>Parallel Capacity</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Haiku</strong></td><td>Errand runner: fetch files, grep, simple lookups</td><td>Spawn 5-10 in parallel</td></tr>
          <tr><td><strong>Sonnet</strong></td><td>Capable worker: structured implementation, following patterns</td><td>3-5 parallel</td></tr>
          <tr><td><strong>Opus</strong></td><td>Complex reasoning, architecture decisions, ambiguous tasks</td><td>1-2 (expensive)</td></tr>
        </tbody>
      </table>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Memory Primitives Section -->
    <section id="memory-primitives">
      <h2><span style="font-weight: 700;">Mem</span>ory Primitives</h2>

      <h3>Git as Memory</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Future agent understands context from git history
git log --oneline -10
git diff HEAD~5</code></pre>
      </div>

      <p><strong>What it does:</strong> Code changes persist across iterations via version control.</p>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>Immutable history</li>
        <li>Diff-based understanding</li>
        <li>Commit messages as documentation</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Filesystem as Memory (Panopticon)</h3>

      <div class="ascii-diagram">
~/nox        # Company/product
~/metrics    # Analytics/data
~/email      # Communications
~/growth     # Marketing/acquisition
~/trades     # Personal finance/trading
~/health     # Fitness/sleep/wellness
~/writing    # Content creation
~/personal   # Life admin
      </div>

      <p><strong>What it does:</strong> Each domain has isolated directory that persists agent state.</p>

      <p><strong>Key properties:</strong></p>
      <ul>
        <li>Domain isolation (no cross-contamination)</li>
        <li>Read/write to directory as persistent memory</li>
        <li>Handoffs through explicit file exchanges</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>CLAUDE.md Hierarchy</h3>

      <div class="ascii-diagram">
+-------------------------------------------------------------+
| Layer 1: Enterprise Policy                                  |
| /Library/Application Support/ClaudeCode/CLAUDE.md           |
+-------------------------------------------------------------+
| Layer 2: Project Memory                                     |
| ./CLAUDE.md or ./.claude/CLAUDE.md                          |
+-------------------------------------------------------------+
| Layer 3: Modular Rules                                      |
| ./.claude/rules/*.md                                        |
+-------------------------------------------------------------+
| Layer 4: Personal + Local                                   |
| ~/.claude/CLAUDE.md (user global)                           |
| ./CLAUDE.local.md (project local, gitignored)               |
+-------------------------------------------------------------+
      </div>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Hook Primitives Section -->
    <section id="hook-primitives">
      <h2><span style="font-weight: 700;">Hoo</span>k Primitives</h2>

      <h3>Hook Events</h3>

      <table class="comparison-table">
        <thead>
          <tr><th>Event</th><th>Trigger</th><th>Common Use Cases</th></tr>
        </thead>
        <tbody>
          <tr><td><code>PreToolUse</code></td><td>Before a tool runs</td><td>Validation, notifications, approval gates</td></tr>
          <tr><td><code>PostToolUse</code></td><td>After a tool completes</td><td>Formatting, linting, logging</td></tr>
          <tr><td><code>SessionStart</code></td><td>When session begins</td><td>Context loading, environment setup</td></tr>
          <tr><td><code>SessionEnd</code></td><td>When session ends</td><td>Cleanup, summary generation</td></tr>
          <tr><td><code>Stop</code></td><td>Exit/completion attempts</td><td>Loop continuation (Ralph)</td></tr>
        </tbody>
      </table>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Stop Hook (Loop Continuation)</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>#!/bin/bash
# .claude/hooks/stop-hook.sh

# Check if completion promise found
if grep -q "COMPLETE" ./progress.txt; then
    exit 0  # Allow exit
else
    # Restart with prompt
    cat PROMPT.md | claude-code
fi</code></pre>
      </div>

      <p><strong>hooks.json:</strong></p>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>{
  "SessionEnd": [{
    "type": "command",
    "command": "./.claude/hooks/stop-hook.sh"
  }]
}</code></pre>
      </div>

      <p><strong>What it does:</strong> Intercepts session exit and restarts if not complete.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Auto-Format Hook</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Edit",
        "command": "prettier --write $FILE"
      },
      {
        "matcher": "Write",
        "command": "black $FILE"
      }
    ]
  }
}</code></pre>
      </div>

      <p><strong>What it does:</strong> Automatically formats files after Claude edits them.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Security Gate Hook</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>#!/bin/bash
# ~/.claude/hooks/security-gate.sh

COMMAND=$(echo "$EVENT_DATA" | jq -r '.tool_input.command')

DANGEROUS_PATTERNS=(
    "rm -rf /"
    "git push --force"
    "DROP TABLE"
    "sudo"
)

for pattern in "${DANGEROUS_PATTERNS[@]}"; do
    if [[ "$COMMAND" == *"$pattern"* ]]; then
        echo "BLOCKED: Dangerous command pattern detected" >&2
        exit 1  # Non-zero blocks the operation
    fi
done

exit 0  # Allow</code></pre>
      </div>

      <p><strong>Exit code behavior:</strong></p>
      <ul>
        <li><code>0</code> = Allow operation</li>
        <li>Non-zero = Block operation, show stderr to user</li>
      </ul>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Communication Primitives Section -->
    <section id="communication-primitives">
      <h2><span style="font-weight: 700;">Com</span>munication Primitives</h2>

      <h3>File-Based Handoffs</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>{
  "from": "agent1",
  "to": "agent2",
  "timestamp": "2026-01-09T10:30:00Z",
  "context": {
    "completed": ["API schema", "Database models"],
    "next_steps": ["Implement REST endpoints"],
    "blockers": [],
    "notes": "Using FastAPI, see docs in /api/README.md"
  }
}</code></pre>
      </div>

      <p><strong>Source:</strong> Panopticon pattern</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Git-Based Handoffs</h3>

      <p>Each iteration:</p>
      <ol>
        <li>Agent reads progress.txt (context from previous iterations)</li>
        <li>Agent does work</li>
        <li>Agent appends learnings to progress.txt</li>
        <li>Agent commits changes to git</li>
        <li>Next iteration starts fresh, reads progress.txt + git history</li>
      </ol>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Cron-Based Scheduling</h3>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Cron job for scheduled agent runs
0 6 * * * cd ~/trades && claude "Generate morning brief" > brief.md

# Keep system awake during long runs
caffeinate -i

# Simple alias for natural language CLI
alias c='claude'</code></pre>
      </div>

      <p><strong>Source:</strong> Panopticon pattern</p>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- How Primitives Compose Section -->
    <section id="how-primitives-compose">
      <h2><span style="font-weight: 700;">How</span> Primitives Compose</h2>

      <h3>Ralph Loop = Basic Composition</h3>

      <div class="ascii-diagram">
+-------------------------------------------------------------+
|                       RALPH LOOP                             |
+-------------------------------------------------------------+
|                                                              |
|  Iteration-Limited Loop                                      |
|       |                                                      |
|       +-- prd.json (State)                                   |
|       |       +-- Tracks: passes: true/false                 |
|       |                                                      |
|       +-- Story Selection Logic                              |
|       |       +-- Pick highest priority where passes == false|
|       |                                                      |
|       +-- Quality Gates                                      |
|       |       +-- Typecheck                                  |
|       |       +-- Tests                                      |
|       |                                                      |
|       +-- progress.txt (Memory)                              |
|       |       +-- Append learnings each iteration            |
|       |                                                      |
|       +-- Git Commit                                         |
|       |       +-- Persist code changes                       |
|       |                                                      |
|       +-- Promise/Stop Condition                             |
|               +-- &lt;promise&gt;COMPLETE&lt;/promise&gt;                |
|                                                              |
+-------------------------------------------------------------+
      </div>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Primitive Composition Matrix</h3>

      <div style="overflow-x: auto;">
        <table class="comparison-table">
          <thead>
            <tr><th>Pattern</th><th>Loop</th><th>State</th><th>Control</th><th>Quality</th><th>Coordination</th><th>Memory</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Ralph</strong></td><td>Iteration-Limited</td><td>prd.json + progress.txt</td><td>Promise/Stop</td><td>Typecheck + Tests</td><td>Single-agent</td><td>Git + Files</td></tr>
            <tr><td><strong>CC Mirror</strong></td><td>Event-driven</td><td>TaskCreate native</td><td>Task dependencies</td><td>Per-task gates</td><td>Hub-and-spoke</td><td>Task persistence</td></tr>
            <tr><td><strong>Gas Town</strong></td><td>Continuous</td><td>Beads (Git-backed)</td><td>Role-based</td><td>Dogs (watchdogs)</td><td>Factory model</td><td>MCP Agent Mail</td></tr>
            <tr><td><strong>Panopticon</strong></td><td>Cron-scheduled</td><td>Filesystem</td><td>Domain isolation</td><td>Domain-specific</td><td>File handoffs</td><td>Dir per domain</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <hr class="section-divider divider-warning">

    <!-- Troubleshooting Section -->
    <section id="troubleshooting">
      <h2><span style="font-weight: 700;">Tro</span>ubleshooting</h2>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">progress.txt Gets Overwritten Instead of Appended</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Previous iteration learnings disappear; file contains only latest entry</p>
          <p><strong>Cause:</strong> Using <code>&gt;</code> (overwrite) instead of <code>&gt;&gt;</code> (append) in shell commands</p>
          <p><strong>Fix:</strong></p>
          <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
            <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
            <pre style="margin: 0; overflow-x: auto;"><code># WRONG - overwrites:
echo "New learning" > progress.txt

# CORRECT - appends:
echo "New learning" >> progress.txt</code></pre>
          </div>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">prd.json Becomes Invalid JSON</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> jq fails to parse; agent can't read task state</p>
          <p><strong>Cause:</strong> Manual editing introduced syntax errors, or agent output malformed JSON</p>
          <p><strong>Fix:</strong></p>
          <ol>
            <li>Validate JSON syntax: <code>jq . prd.json</code> (will show error location)</li>
            <li>Keep a backup before each iteration: <code>cp prd.json prd.json.bak</code></li>
            <li>Use jq for updates instead of manual editing</li>
          </ol>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Hook Doesn't Fire</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Expected automation doesn't run; no notification sent</p>
          <p><strong>Cause:</strong> Hook configuration in wrong location or incorrect event name</p>
          <p><strong>Fix:</strong></p>
          <ol>
            <li>Verify hook is in correct settings file (<code>~/.claude/settings.json</code> for global)</li>
            <li>Check event name matches exactly: <code>PreToolUse</code>, <code>PostToolUse</code>, <code>SessionStart</code>, <code>SessionEnd</code></li>
            <li>Test hook script independently: <code>bash ~/.claude/hooks/your-hook.sh</code></li>
            <li>Check script has execute permissions: <code>chmod +x ~/.claude/hooks/your-hook.sh</code></li>
          </ol>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Completion Signal Not Detected</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Loop runs indefinitely even though agent outputs completion signal</p>
          <p><strong>Cause:</strong> Signal format mismatch or grep not searching correct file</p>
          <p><strong>Fix:</strong></p>
          <ol>
            <li>Verify exact signal format matches between prompt and grep</li>
            <li>Ensure output is captured to the file grep is searching</li>
            <li>Test manually: <code>echo "&lt;promise&gt;COMPLETE&lt;/promise&gt;" | grep -q "COMPLETE" && echo "Found"</code></li>
          </ol>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Worker Preamble Ignored</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Worker behaves like orchestrator; spawns subagents; uses wrong tools</p>
          <p><strong>Cause:</strong> Preamble placed after task description or too weak</p>
          <p><strong>Fix:</strong></p>
          <ol>
            <li>Place preamble at the VERY START of worker prompt</li>
            <li>Use explicit prohibition language with strong emphasis</li>
          </ol>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Model Selection Causing Cost Overruns</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> API bills 5-10x higher than expected</p>
          <p><strong>Cause:</strong> Using Opus for tasks that Haiku/Sonnet could handle</p>
          <p><strong>Fix:</strong> Apply model selection matrix:</p>
          <ul>
            <li><strong>Haiku:</strong> File lookups, simple grep, transforms (spawn 5-10 parallel)</li>
            <li><strong>Sonnet:</strong> Implementation, test writing, following patterns (main workhorse)</li>
            <li><strong>Opus:</strong> Architecture decisions, ambiguous tasks (reserve for complex)</li>
          </ul>
        </div>
      </details>
    </section>

    <hr class="section-divider">

    <!-- Milestone -->
    <div class="milestone" style="background: linear-gradient(90deg, #6b9b7a 0%, #2a7d7d 100%); color: white; padding: 1rem 1.5rem; border-radius: 8px; text-align: center; margin: 2rem 0;">
      Understanding these primitives gives you the building blocks to construct any orchestration pattern.
    </div>

    <!-- Related Pages -->
    <div class="related-pages" style="margin-top: 2rem; padding: 1rem; background: #f9f6f0; border-radius: 8px;">
      <h4 style="margin-top: 0;">Related Architecture Documents</h4>
      <ul>
        <li><a href="architecture-composition-rules.html">Composition Rules</a> - How primitives combine into patterns</li>
        <li><a href="architecture-domain-isolation.html">Domain Isolation</a> - Running parallel isolated instances</li>
        <li><a href="architecture-complexity-ladder.html">Complexity Ladder</a> - Progression from Level 0 to Level 7</li>
        <li><a href="architecture-swarm-topologies.html">Swarm Topologies</a> - Advanced multi-agent structures</li>
      </ul>
    </div>

    <!-- Footer Navigation -->
    <div class="footer-nav" style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e0d5c5;">
      <span style="color: #999;">First in Architecture series</span>
      <a href="architecture-composition-rules.html">Next: Composition Rules</a>
    </div>

  </div>

  <script src="../js/copy-code.js"></script>
  <script src="../js/search.js"></script>
  <script src="../js/global-nav.js"></script>
  <script>
    function copyCode(button) {
      const codeBlock = button.parentElement.querySelector('code');
      navigator.clipboard.writeText(codeBlock.textContent);
      button.textContent = 'Copied!';
      setTimeout(() => button.textContent = 'Copy', 2000);
    }
  </script>
</body>
</html>
