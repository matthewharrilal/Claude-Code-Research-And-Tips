<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta data-pagefind-meta="section" content="Synthesis">
  <meta data-pagefind-meta="category" content="Architecture">
  <title>Pattern Composition Rules - Claude Code Knowledge Base</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  <link rel="stylesheet" href="../css/search.css">
</head>
<body>
  <nav class="left-nav" id="leftNav">
    <div class="px-4 mb-4">
      <a href="../index.html" class="text-xs font-semibold text-accent hover:text-accent-light uppercase tracking-wider">Claude Code KB</a>
    </div>
    <div class="nav-content"></div>
  </nav>

  <!-- Search Modal -->
  <div class="search-modal" id="searchModal" aria-hidden="true">
    <div class="search-overlay" onclick="closeSearch()"></div>
    <div class="search-content">
      <div class="search-header">
        <div class="search-input-wrapper">
          <span class="search-icon-input">&#128269;</span>
          <input type="text" id="searchInput" placeholder="Search documentation..." autocomplete="off" />
          <kbd class="search-kbd">ESC</kbd>
        </div>
      </div>
      <div class="search-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="synthesis">Synthesis</button>
        <button class="filter-btn" data-filter="extractions">Extractions</button>
      </div>
      <div class="search-results" id="searchResults">
        <div class="search-empty"><p>Start typing to search... (Press Cmd+K anytime)</p></div>
      </div>
      <div class="search-footer">
        <span>Up/Down Navigate</span><span>Enter Select</span><span>ESC Close</span>
      </div>
    </div>
  </div>

  <button class="search-trigger" onclick="openSearch()" aria-label="Search" style="float: right; margin-bottom: 1rem;">
    <span class="search-icon">Cmd+K</span>
    <span class="search-text">Search</span>
  </button>

  <div class="wide-container">
    <!-- Breadcrumb Navigation -->
    <nav class="nav-breadcrumb">
      <a href="../index.html">Home</a>
      <span>/</span>
      <a href="synthesis-index.html">Synthesis</a>
      <span>/</span>
      <span>Architecture</span>
      <span>/</span>
      <span>Composition Rules</span>
    </nav>

    <!-- You Are Here Context Box -->
    <div class="you-are-here" style="background: linear-gradient(135deg, #f0ebe3 0%, #fefcf3 100%); border-left: 4px solid #2a7d7d; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="color: #2a7d7d; margin-top: 0; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">You Are Here</h3>
      <p style="margin-bottom: 0;">This document shows how <strong><span style="font-weight: 700;">ato</span>mic primitives</strong> (loops, state files, hooks) combine into complete orchestration patterns like Ralph, CC Mirror, and Gas Town. Read this after understanding individual primitives (see <a href="architecture-primitives.html">Architecture Primitives</a>) and before attempting to build custom patterns.</p>
    </div>

    <h1><span style="font-weight: 700;">Pat</span>tern Composition Rules</h1>

    <p class="conversational-lead">
      <span style="font-weight: 700;">Doc</span>umenting how primitives COMPOSE into complex orchestration patterns for Claude Code. Compiled from 50+ extraction files documenting real-world orchestration patterns.
    </p>

    <!-- Table of Contents -->
    <div class="toc">
      <div class="toc-title">Contents</div>
      <ul>
        <li><a href="#primitive-inventory">Primitive Inventory</a> - The building blocks</li>
        <li><a href="#composition-equations">Composition Equations</a> - How patterns are built</li>
        <li><a href="#composition-operators">Composition Operators</a> - Sequential, parallel, nested</li>
        <li><a href="#valid-compositions">Valid Compositions</a> - Synergy combinations</li>
        <li><a href="#invalid-compositions">Invalid Compositions</a> - Anti-patterns to avoid</li>
        <li><a href="#composition-examples">Composition Examples</a> - Real-world applications</li>
        <li><a href="#composition-decision-tree">Decision Tree</a> - When to use what</li>
        <li><a href="#troubleshooting">Troubleshooting</a> - Common issues</li>
      </ul>
    </div>

    <hr class="section-divider divider-procedure">

    <!-- Primitive Inventory Section -->
    <section id="primitive-inventory">
      <h2><span style="font-weight: 700;">Pri</span>mitive Inventory</h2>

      <h3>Core Primitives</h3>

      <table class="comparison-table">
        <thead>
          <tr><th>Primitive</th><th>Type</th><th>Function</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Bash Loop</strong></td><td>Control Flow</td><td><code>while :; do ... done</code> - Repeats until condition</td></tr>
          <tr><td><strong>Fresh Context</strong></td><td>Memory Strategy</td><td>New Claude instance per iteration</td></tr>
          <tr><td><strong>JSON Tasks</strong></td><td>State Management</td><td><code>prd.json</code> with <code>passes: true/false</code></td></tr>
          <tr><td><strong>File State</strong></td><td>Persistence</td><td><code>progress.txt</code> for append-only learnings</td></tr>
          <tr><td><strong>Git Memory</strong></td><td>Durability</td><td>Commits persist across context resets</td></tr>
          <tr><td><strong>Stop Hook</strong></td><td>Control Flow</td><td>Intercepts session exit, restarts</td></tr>
          <tr><td><strong>Completion Promise</strong></td><td>Termination</td><td><code>&lt;promise&gt;COMPLETE&lt;/promise&gt;</code> signals done</td></tr>
        </tbody>
      </table>

      <h3>Agent Primitives</h3>

      <table class="comparison-table">
        <thead>
          <tr><th>Primitive</th><th>Type</th><th>Function</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Orchestrator</strong></td><td>Role</td><td>Coordinates without tools, delegates</td></tr>
          <tr><td><strong>Worker</strong></td><td>Role</td><td>Executes with tools, no spawning</td></tr>
          <tr><td><strong>Subagent</strong></td><td>Spawning</td><td><code>Task()</code> call for isolated context work</td></tr>
          <tr><td><strong>TaskCreate/Update</strong></td><td>Coordination</td><td>Native task management with dependencies</td></tr>
          <tr><td><strong>BlockedBy</strong></td><td>Dependency</td><td>Task dependency graph</td></tr>
        </tbody>
      </table>

      <h3>Infrastructure Primitives</h3>

      <table class="comparison-table">
        <thead>
          <tr><th>Primitive</th><th>Type</th><th>Function</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Isolated Directory</strong></td><td>Isolation</td><td>Separate filesystem per domain</td></tr>
          <tr><td><strong>Git Worktree</strong></td><td>Isolation</td><td>Parallel branches without conflicts</td></tr>
          <tr><td><strong>tmux Pane</strong></td><td>Visibility</td><td>Visual monitoring of parallel agents</td></tr>
          <tr><td><strong>Docker Container</strong></td><td>Isolation</td><td>Full process isolation</td></tr>
          <tr><td><strong>Hooks</strong></td><td>Automation</td><td>Event-driven shell commands</td></tr>
        </tbody>
      </table>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Composition Equations Section -->
    <section id="composition-equations">
      <h2><span style="font-weight: 700;">Com</span>position Equations</h2>

      <h3>Ralph = Loop + JSON Tasks + File State + Git Memory</h3>

      <div class="ascii-diagram">
RALPH PATTERN
+-- Bash while loop         # Repeats until completion
+-- prd.json                # Task tracking (passes: true/false)
+-- progress.txt            # Learnings across iterations
+-- Git commits             # Durability per iteration
+-- Fresh context           # Clean slate each iteration
+-- Completion promise      # Explicit termination signal
      </div>

      <p><strong>Composition Formula:</strong></p>
      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>Ralph = while(!complete) {
  FreshContext()
  + ReadState(prd.json, progress.txt, git.log)
  + Execute(next_task)
  + Verify(tests, typecheck)
  + UpdateState(prd.json, progress.txt)
  + Commit()
  + CheckCompletion()
}</code></pre>
      </div>

      <p><strong>Why it works:</strong> External memory (files, git) compensates for context reset. Each iteration benefits from accumulated learnings without context rot.</p>

      <!-- Checkpoint Box -->
      <div class="checkpoint" style="background: #f0ebe3; border-left: 4px solid #6b9b7a; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
        <div class="checkpoint-header" style="color: #6b9b7a; font-weight: 600;">Checkpoint: Ralph Composition</div>
        <p><strong>You should now understand:</strong></p>
        <ul>
          <li>The five core components: loop, JSON tasks, file state, git memory, completion signal</li>
          <li>Why fresh context per iteration prevents rot</li>
          <li>How progress.txt accumulates learnings</li>
          <li>The role of git commits as durability checkpoints</li>
        </ul>
        <p><strong>If unclear:</strong> See mastery-ralph-complete.html for step-by-step implementation.</p>
      </div>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>CC Mirror = Orchestrator + Workers + Task API</h3>

      <div class="ascii-diagram">
CC MIRROR PATTERN
+-- Central Orchestrator    # No tools, pure coordination
|   +-- Uses: TaskCreate, TaskUpdate, Task()
+-- Worker Agents           # Tools only, no spawning
|   +-- Uses: Read, Write, Edit, Bash
+-- Task Dependency Graph   # blockedBy/addBlocks
+-- Native CLI Monitor      # Arrow keys navigate agents
+-- Auto-compact            # Context management
      </div>

      <p><strong>Why it works:</strong> Clear separation between coordination (orchestrator) and execution (workers). Workers can't spawn, preventing recursion. Task dependencies auto-schedule work.</p>

      <!-- Checkpoint Box -->
      <div class="checkpoint" style="background: #f0ebe3; border-left: 4px solid #6b9b7a; border-radius: 8px; padding: 1.5rem; margin: 2rem 0;">
        <div class="checkpoint-header" style="color: #6b9b7a; font-weight: 600;">Checkpoint: CC Mirror Composition</div>
        <p><strong>You should now understand:</strong></p>
        <ul>
          <li>The orchestrator-worker separation principle</li>
          <li>Why workers cannot spawn subagents (prevents recursion)</li>
          <li>How TaskCreate/TaskUpdate provide coordination</li>
          <li>The role of blockedBy in dependency management</li>
        </ul>
        <p><strong>If unclear:</strong> Re-read the "Orchestrator uses" vs "Workers use" tool lists above.</p>
      </div>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Gas Town = Factory + Specialized Roles + tmux</h3>

      <div class="ascii-diagram">
GAS TOWN PATTERN
+-- Town (~/.gt)            # HQ managing all rigs
+-- Rig                     # Individual project repo
+-- 7 Worker Roles
|   +-- Mayor               # Town-level coordination
|   +-- Deacon              # Monitoring/handshakes
|   +-- Dogs                # Quality gates
|   +-- Refinery            # Task decomposition
|   +-- Polecat             # Named persistent workers
|   +-- Witness             # Per-rig observer
|   +-- Crew                # Ephemeral workers
+-- Beads                   # Git-backed data plane
+-- MCP Agent Mail          # Email-like inter-agent comms
+-- tmux                    # Primary UI
+-- Human Overseer          # Inbox for decisions
      </div>

      <p><strong>Why it works:</strong> Role specialization prevents overload. Factory can scale workers indefinitely. Beads provides shared context. Human stays in loop via inbox.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Panopticon = Isolated Directories + Cron + Subagents</h3>

      <div class="ascii-diagram">
PANOPTICON PATTERN
+-- 8 Isolated Directories  # Domain separation
|   +-- ~/nox               # Company/product
|   +-- ~/metrics           # Analytics
|   +-- ~/email             # Communications
|   +-- ~/growth            # Marketing
|   +-- ~/trades            # Finance
|   +-- ~/health            # Wellness
|   +-- ~/writing           # Content
|   +-- ~/personal          # Life admin
+-- Cron Jobs               # Scheduled data pulls
+-- Subagents               # Short-lived task execution
+-- File Handoffs           # Inter-domain communication
+-- Checkpointing           # Text notifications on completion
+-- GUI Fallback            # Mouse/keyboard injection when no API
      </div>

      <p><strong>Why it works:</strong> Domain isolation prevents context pollution. Cron provides automation. File handoffs enable cross-domain awareness without context bloat.</p>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Composition Operators Section -->
    <section id="composition-operators">
      <h2><span style="font-weight: 700;">Com</span>position Operators</h2>

      <h3>Sequential (A then B)</h3>

      <p><strong>Symbol:</strong> <code>A -> B</code></p>
      <p><strong>Pattern:</strong> Complete A before starting B.</p>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Example: Ralph iteration
Read_State() -> Execute_Task() -> Verify() -> Commit() -> Update_State()</code></pre>
      </div>

      <p><strong>When to use:</strong></p>
      <ul>
        <li>Dependencies between operations</li>
        <li>State must be consistent</li>
        <li>Order matters</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Parallel (A and B simultaneously)</h3>

      <p><strong>Symbol:</strong> <code>A || B</code></p>
      <p><strong>Pattern:</strong> Execute A and B concurrently.</p>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Bash parallel
(task_a) &amp; (task_b) &amp; wait

# Git worktrees
for feature in a b c; do
  (cd wt-$feature &amp;&amp; ./ralph.sh) &amp;
done
wait</code></pre>
      </div>

      <p><strong>When to use:</strong></p>
      <ul>
        <li>Independent tasks</li>
        <li>No shared file access</li>
        <li>Throughput is priority</li>
      </ul>

      <p><strong>Constraints:</strong></p>
      <ul>
        <li>Requires isolation (worktrees, containers, directories)</li>
        <li>May cause merge conflicts</li>
        <li>Increases cost (multiple contexts)</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Nested (A contains B)</h3>

      <p><strong>Symbol:</strong> <code>A { B }</code></p>
      <p><strong>Pattern:</strong> B runs within A's context or scope.</p>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code># Task tool spawn
Task(
  subagent_type="general-purpose",
  description="Handle Playwright verification",
  prompt="...",
  run_in_background=True
)</code></pre>
      </div>

      <p><strong>When to use:</strong></p>
      <ul>
        <li>Isolate expensive operations</li>
        <li>Specialize a subtask</li>
        <li>Protect main context window</li>
      </ul>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Delegation (A spawns B)</h3>

      <p><strong>Symbol:</strong> <code>A -> spawn(B)</code></p>
      <p><strong>Pattern:</strong> A creates B to handle subtask.</p>

      <p><strong>Constraints:</strong></p>
      <ul>
        <li>Parent can't see child's context</li>
        <li>Child can't spawn (prevents infinite recursion)</li>
        <li>Results returned via Task output</li>
      </ul>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Valid Compositions Section -->
    <section id="valid-compositions">
      <h2><span style="font-weight: 700;">Val</span>id Compositions</h2>

      <h3>High Synergy Combinations</h3>

      <table class="comparison-table">
        <thead>
          <tr><th>Composition</th><th>Components</th><th>Synergy Reason</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Ralph + Playwright</strong></td><td>Loop + Browser Automation</td><td>Visual verification closes feedback loop</td></tr>
          <tr><td><strong>CC Mirror + Git Worktrees</strong></td><td>Task API + Isolation</td><td>Dependencies + conflict-free parallel</td></tr>
          <tr><td><strong>Gas Town + Beads</strong></td><td>Roles + Shared Context</td><td>Specialization + coordination</td></tr>
          <tr><td><strong>Ralph + Claude-Mem</strong></td><td>Fresh Context + Memory</td><td>Context reset + cross-session learning</td></tr>
          <tr><td><strong>Panopticon + Hooks</strong></td><td>Domain Isolation + Automation</td><td>Schedule + notification</td></tr>
        </tbody>
      </table>

      <h3>Composition Tiers</h3>

      <div class="callout callout-success">
        <div class="callout-title">Tier 1: Solo Developer (Quick Win)</div>
        <pre style="margin: 0.5rem 0;"><code>Ralph = Loop + JSON + Git
Effort: 1 hour setup
Cost: Single agent</code></pre>
      </div>

      <div class="callout callout-insight">
        <div class="callout-title">Tier 2: Power User (Medium Lift)</div>
        <pre style="margin: 0.5rem 0;"><code>Ralph + Playwright = Loop + Browser + Subagents
CC Mirror = Orchestrator + Workers + Tasks
Effort: Half-day setup
Cost: Moderate (subagent overhead)</code></pre>
      </div>

      <div class="callout callout-warning">
        <div class="callout-title">Tier 3: Agent Factory (Deep Dive)</div>
        <pre style="margin: 0.5rem 0;"><code>Gas Town = 7 Roles + Beads + tmux + Mail
Parallel Ralph = Worktrees + Multiple Loops
Effort: Days of setup
Cost: High (multiple accounts)</code></pre>
      </div>
    </section>

    <hr class="section-divider divider-warning">

    <!-- Invalid Compositions Section -->
    <section id="invalid-compositions">
      <h2><span style="font-weight: 700;">Inv</span>alid Compositions (Anti-patterns)</h2>

      <h3>Subagent Recursion</h3>

      <div class="code-block" style="background: #fef6f5; border: 1px solid #c97065; border-radius: 6px; padding: 1rem; margin: 1rem 0;">
        <pre style="margin: 0; overflow-x: auto; color: #c97065;"><code>ANTI-PATTERN: Worker spawning workers

Worker {
  Subagent {
    Subagent {    # INFINITE RECURSION RISK
      ...
    }
  }
}</code></pre>
      </div>

      <p><strong>Why it breaks:</strong> Unbounded context growth. Each level spawns more. Eventually hits limits or costs explode.</p>
      <p><strong>Fix:</strong> Workers NEVER spawn. Only orchestrators spawn.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Context Pollution</h3>

      <div class="code-block" style="background: #fef6f5; border: 1px solid #c97065; border-radius: 6px; padding: 1rem; margin: 1rem 0;">
        <pre style="margin: 0; overflow-x: auto; color: #c97065;"><code>ANTI-PATTERN: Multiple domains in single context

claude "
  Fix the auth bug AND
  Update the marketing copy AND
  Analyze financial data AND
  Generate workout plan
"</code></pre>
      </div>

      <p><strong>Why it breaks:</strong> Unrelated concerns bloat context. Model gets confused. Quality degrades.</p>
      <p><strong>Fix:</strong> Isolate domains (directories, sessions). One domain per context.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Parallel Without Isolation</h3>

      <div class="code-block" style="background: #fef6f5; border: 1px solid #c97065; border-radius: 6px; padding: 1rem; margin: 1rem 0;">
        <pre style="margin: 0; overflow-x: auto; color: #c97065;"><code>ANTI-PATTERN: Multiple agents editing same files

Terminal 1: claude "Edit src/auth.ts"
Terminal 2: claude "Edit src/auth.ts"  # CONFLICT</code></pre>
      </div>

      <p><strong>Why it breaks:</strong> Race conditions. Overwrites. Broken state.</p>
      <p><strong>Fix:</strong> Use git worktrees. Or serialize access. Or file-level locking.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Loop Without External Memory</h3>

      <div class="code-block" style="background: #fef6f5; border: 1px solid #c97065; border-radius: 6px; padding: 1rem; margin: 1rem 0;">
        <pre style="margin: 0; overflow-x: auto; color: #c97065;"><code>ANTI-PATTERN: Loop with no persistence

while true; do
  claude "Continue working"  # NO STATE BETWEEN ITERATIONS
done</code></pre>
      </div>

      <p><strong>Why it breaks:</strong> Each iteration starts from zero. No learning. No progress tracking. Repeats same mistakes.</p>
      <p><strong>Fix:</strong> Add prd.json, progress.txt, git commits. External memory compensates for context reset.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Orchestrator With Tools</h3>

      <div class="code-block" style="background: #fef6f5; border: 1px solid #c97065; border-radius: 6px; padding: 1rem; margin: 1rem 0;">
        <pre style="margin: 0; overflow-x: auto; color: #c97065;"><code>ANTI-PATTERN: Orchestrator doing implementation

Orchestrator {
  Write(file)     # WRONG - should delegate
  Edit(file)      # WRONG - should delegate
  spawn(Worker)
}</code></pre>
      </div>

      <p><strong>Why it breaks:</strong> Orchestrator context fills with tool output. Loses coordination capacity. Becomes unfocused.</p>
      <p><strong>Fix:</strong> Orchestrator ONLY uses TaskCreate, TaskUpdate, Task(). Workers do implementation.</p>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Composition Examples Section -->
    <section id="composition-examples">
      <h2><span style="font-weight: 700;">Com</span>position Examples</h2>

      <h3>Example 1: Overnight Feature Shipping</h3>

      <p><strong>Goal:</strong> Ship a feature while you sleep.</p>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>Ralph + Playwright + Mobile Notifications

= while(!complete):
    FreshContext()
    + ReadState(prd.json, git)
    + Execute(next_task)
    + if(ui_task):
        Subagent(Playwright.verify())
      else:
        Bash(npm test)
    + Commit()
    + UpdateState()
  + Hook(AskUserQuestion) -> PushNotification(phone)</code></pre>
      </div>

      <p><strong>Result:</strong> Wake up to completed feature. Phone notification if human input needed.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Example 2: Parallel API Development</h3>

      <p><strong>Goal:</strong> Build multiple API endpoints simultaneously.</p>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>#!/bin/bash
ENDPOINTS="auth users products orders"

for ep in $ENDPOINTS; do
  git worktree add ../wt-$ep $ep-branch 2>/dev/null || true
  (cd ../wt-$ep &amp;&amp; ./ralph.sh 15) &amp;
done

wait
echo "All endpoints complete"

for ep in $ENDPOINTS; do
  git merge --no-edit $ep-branch
done</code></pre>
      </div>

      <p><strong>Result:</strong> 4x parallelization without merge conflicts.</p>

      <hr style="border: 0; border-top: 1px solid #e0d5c5; margin: 2rem 0;">

      <h3>Example 3: Full-Stack Team Simulation</h3>

      <p><strong>Goal:</strong> Simulate a development team with specialized roles.</p>

      <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
        <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
        <pre style="margin: 0; overflow-x: auto;"><code>CC Mirror Orchestration + Model Selection

= Orchestrator(Opus) {
    TaskCreate([
      {title: "Design database schema", type: "architecture"},
      {title: "Implement API", type: "backend"},
      {title: "Build UI", type: "frontend"},
      {title: "Write tests", type: "testing"}
    ])
    + SetDependencies([
        "API blockedBy schema",
        "UI blockedBy API",
        "tests blockedBy UI"
      ])
    + for task in unblocked:
        Worker(
          model = task.type == "architecture" ? Opus : Sonnet,
          task = task
        )
  }</code></pre>
      </div>

      <p><strong>Result:</strong> Automated task scheduling with dependency awareness.</p>
    </section>

    <hr class="section-divider divider-procedure">

    <!-- Decision Tree Section -->
    <section id="composition-decision-tree">
      <h2><span style="font-weight: 700;">Com</span>position Decision Tree</h2>

      <div class="ascii-diagram">
START: What are you building?
  |
  +-- Single feature, well-defined completion
  |    |
  |    +-- Use: RALPH LOOP
  |         Components: Loop + JSON + Git
  |         Effort: Quick Win
  |
  +-- Multiple features, need parallelization
  |    |
  |    +-- Same repo, no file conflicts?
  |    |    |
  |    |    +-- Use: PARALLEL RALPH
  |    |         Components: Worktrees + Multiple Loops
  |    |
  |    +-- Need task dependencies?
  |         |
  |         +-- Use: CC MIRROR
  |              Components: Orchestrator + Workers + Task API
  |
  +-- UI-heavy work
  |    |
  |    +-- Use: RALPH + PLAYWRIGHT
  |         Components: Loop + Browser Subagent
  |         Note: Subagent isolates high token cost
  |
  +-- Multi-domain life automation
  |    |
  |    +-- Use: PANOPTICON
  |         Components: Isolated Dirs + Cron + Handoffs
  |         Note: Domain isolation prevents context pollution
  |
  +-- Maximum throughput, cost no object
       |
       +-- Stage 7+ developer?
       |    |
       |    +-- Use: GAS TOWN
       |         Components: Factory + Roles + Beads + tmux
       |
       +-- Stage 5-6 developer?
            |
            +-- Use: CC MIRROR (80% of value, 10% of effort)
      </div>

      <h3>Quick Reference: Composition Formulas</h3>

      <table class="comparison-table">
        <thead>
          <tr><th>Pattern</th><th>Formula</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Ralph</strong></td><td><code>while(!complete) { Fresh + State + Execute + Verify + Commit }</code></td></tr>
          <tr><td><strong>CC Mirror</strong></td><td><code>Orchestrator(TaskAPI) { spawn(Workers) }</code></td></tr>
          <tr><td><strong>Gas Town</strong></td><td><code>Factory { Mayor + Roles[] + Beads + Mail + Human }</code></td></tr>
          <tr><td><strong>Panopticon</strong></td><td><code>Domains[] { Cron + Claude + Handoffs }</code></td></tr>
          <tr><td><strong>Ralph+Play</strong></td><td><code>Ralph { Subagent(Playwright.verify()) }</code></td></tr>
          <tr><td><strong>Parallel Ralph</strong></td><td><code>Worktrees[] { Ralph(worktree) } + Merge</code></td></tr>
        </tbody>
      </table>
    </section>

    <hr class="section-divider divider-warning">

    <!-- Troubleshooting Section -->
    <section id="troubleshooting">
      <h2><span style="font-weight: 700;">Tro</span>ubleshooting</h2>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Ralph Loop Doesn't Learn Across Iterations</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Each iteration makes the same mistakes; no improvement over time</p>
          <p><strong>Cause:</strong> Agent not reading progress.txt or patterns not being accumulated</p>
          <p><strong>Fix:</strong></p>
          <ol>
            <li>Ensure prompt explicitly instructs: "Read progress.txt Codebase Patterns section FIRST"</li>
            <li>Verify agent appends learnings after each iteration</li>
            <li>Check that progress.txt is not being overwritten (must be append-only)</li>
          </ol>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">CC Mirror Workers Go Rogue</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Workers attempt orchestration, spawn subagents, or ignore task boundaries</p>
          <p><strong>Cause:</strong> Missing or incomplete worker preamble</p>
          <p><strong>Fix:</strong> Always include this preamble at the start of every worker task:</p>
          <div class="code-block" style="background: #f0ebe3; border-radius: 6px; padding: 1rem; position: relative; font-family: 'SF Mono', Monaco, monospace; margin: 1rem 0;">
            <button class="copy-btn" onclick="copyCode(this)" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #2a7d7d; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer;">Copy</button>
            <pre style="margin: 0; overflow-x: auto;"><code>CONTEXT: You are a WORKER agent, not an orchestrator.
RULES:
- Complete ONLY the task described below
- Use tools directly (Read, Write, Edit, Bash)
- Do NOT spawn sub-agents
- Do NOT call TaskCreate or TaskUpdate
TASK: [specific task]</code></pre>
          </div>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Parallel Compositions Create File Conflicts</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Multiple agents overwrite each other's work; corrupted state</p>
          <p><strong>Cause:</strong> Using parallel without proper isolation</p>
          <p><strong>Fix:</strong></p>
          <ol>
            <li>Use git worktrees for true filesystem isolation</li>
            <li>Assign explicit directory ownership per agent</li>
            <li>Use file-based handoffs instead of shared files</li>
          </ol>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Composition Termination Fails</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Pattern runs indefinitely even when tasks complete</p>
          <p><strong>Cause:</strong> Completion signal mismatch or missing termination condition</p>
          <p><strong>Fix:</strong></p>
          <ol>
            <li>For Ralph: Verify <code>&lt;promise&gt;COMPLETE&lt;/promise&gt;</code> appears in output</li>
            <li>For CC Mirror: Check all TaskUpdate statuses are "completed"</li>
            <li>Add a timeout/max-iterations as safety: <code>timeout 3600 ./your-composition.sh</code></li>
          </ol>
        </div>
      </details>

      <details class="troubleshoot" style="border: 1px solid #c97065; border-radius: 8px; margin: 1rem 0;">
        <summary style="background: #fef6f5; padding: 1rem; cursor: pointer; color: #c97065; font-weight: 600;">Too Much Context Used by Composition</summary>
        <div style="padding: 1rem;">
          <p><strong>Symptom:</strong> Quality degrades during composition execution</p>
          <p><strong>Cause:</strong> Orchestrator context filling with execution details</p>
          <p><strong>Fix:</strong></p>
          <ol>
            <li>Ensure orchestrator delegates ALL implementation to workers</li>
            <li>Workers should return summaries, not full outputs</li>
            <li>Use subagent isolation for expensive operations (like Playwright)</li>
          </ol>
        </div>
      </details>
    </section>

    <hr class="section-divider">

    <!-- Milestone -->
    <div class="milestone" style="background: linear-gradient(90deg, #6b9b7a 0%, #2a7d7d 100%); color: white; padding: 1rem 1.5rem; border-radius: 8px; text-align: center; margin: 2rem 0;">
      Understanding composition rules lets you build custom orchestration patterns tailored to your specific needs.
    </div>

    <!-- Related Pages -->
    <div class="related-pages" style="margin-top: 2rem; padding: 1rem; background: #f9f6f0; border-radius: 8px;">
      <h4 style="margin-top: 0;">Related Architecture Documents</h4>
      <ul>
        <li><a href="architecture-primitives.html">Architecture Primitives</a> - The atomic building blocks</li>
        <li><a href="architecture-domain-isolation.html">Domain Isolation</a> - Running parallel isolated instances</li>
        <li><a href="architecture-complexity-ladder.html">Complexity Ladder</a> - Progression from Level 0 to Level 7</li>
        <li><a href="architecture-swarm-topologies.html">Swarm Topologies</a> - Advanced multi-agent structures</li>
      </ul>
    </div>

    <!-- Footer Navigation -->
    <div class="footer-nav" style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e0d5c5;">
      <a href="architecture-primitives.html">Prev: Primitives</a>
      <a href="architecture-domain-isolation.html">Next: Domain Isolation</a>
    </div>

  </div>

  <script src="../js/copy-code.js"></script>
  <script src="../js/search.js"></script>
  <script src="../js/global-nav.js"></script>
  <script>
    function copyCode(button) {
      const codeBlock = button.parentElement.querySelector('code');
      navigator.clipboard.writeText(codeBlock.textContent);
      button.textContent = 'Copied!';
      setTimeout(() => button.textContent = 'Copy', 2000);
    }
  </script>
</body>
</html>
