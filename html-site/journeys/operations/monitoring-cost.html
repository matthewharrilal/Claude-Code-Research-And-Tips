<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta data-pagefind-meta="chapter" content="Journeys">
  <meta data-pagefind-meta="section" content="Operations">
  <title>Monitoring + Cost Management - Operations Journey</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
</head>
<body>
  <div class="page-with-sidebar">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h1 class="sidebar-title"><a href="../../index.html">Claude Code KB</a></h1>
      </div>
      <button class="sidebar-close" aria-label="Close sidebar">&times;</button>

      <ul class="sidebar-nav">
        <!-- Architecture Section -->
        <li class="nav-section">
          <div class="nav-section-title">Architecture</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../architecture/core-patterns.html">Architecture Patterns</a></li>
            <li class="nav-page"><a href="../architecture/composition.html">Pattern Composition</a></li>
            <li class="nav-page"><a href="../architecture/decision-trees.html">Decision Trees</a></li>
          </ul>
        </li>

        <!-- Implementation Section -->
        <li class="nav-section">
          <div class="nav-section-title">Implementation</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../implementation/ralph-pattern.html">Ralph Pattern</a></li>
            <li class="nav-page"><a href="../implementation/multi-agent.html">Multi-Agent Setup</a></li>
            <li class="nav-page"><a href="../implementation/hooks-tools.html">Hooks + Tools</a></li>
          </ul>
        </li>

        <!-- Operations Section (Current) -->
        <li class="nav-section open">
          <div class="nav-section-title">Operations</div>
          <ul class="nav-subsections">
            <li class="nav-page current"><a href="monitoring-cost.html">Monitoring + Cost</a></li>
            <li class="nav-page"><a href="security-checklists.html">Security + Checklists</a></li>
            <li class="nav-page"><a href="incident-response.html">Incident Response</a></li>
          </ul>
        </li>

        <!-- Mental Models Section -->
        <li class="nav-section">
          <div class="nav-section-title">Mental Models</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../mental-models/context-management.html">Context Management</a></li>
            <li class="nav-page"><a href="../mental-models/fresh-context.html">Fresh Context Principle</a></li>
            <li class="nav-page"><a href="../mental-models/verification.html">Verification Loops</a></li>
          </ul>
        </li>

        <!-- Foundations Section -->
        <li class="nav-section">
          <div class="nav-section-title">Foundations</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../../foundations/principles/core.html">Core Principles</a></li>
            <li class="nav-page"><a href="../../foundations/architecture/complexity-ladder.html">Complexity Ladder</a></li>
            <li class="nav-page"><a href="../../philosophy/creator-workflow.html">Creator Workflow</a></li>
          </ul>
        </li>
      </ul>
    </nav>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">
      <nav class="breadcrumb">
        <a href="../../index.html">Home</a>
        <span class="breadcrumb-separator">/</span>
        <a href="../index.html">Journeys</a>
        <span class="breadcrumb-separator">/</span>
        <a href="index.html">Operations</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">Monitoring + Cost</span>
      </nav>

      <div class="page-meta">
        <span class="page-meta-item">53 min read</span>
        <span class="page-meta-item">Operations Guide</span>
      </div>

      <h1>Monitoring + Cost Management</h1>

      <div class="context-box you-are-here">
        <h3>You Are Here</h3>
        <p><strong>The Big Picture:</strong> You have Claude Code working. Maybe you have run a few successful sessions, or even set up autonomous loops. Now you need to keep it running reliably without burning money, corrupting state, or accidentally executing destructive commands. This is the operations guide.</p>
        <p><strong>What this covers:</strong></p>
        <ul>
          <li>Monitoring context usage, progress, and health</li>
          <li>Managing costs from solo to enterprise scale</li>
          <li>Security controls and permission gating</li>
          <li>Checklists for every phase of operation</li>
          <li>Incident response: what to do when things go wrong</li>
          <li>The full failure mode catalog with recovery procedures</li>
        </ul>
        <p><strong>Time estimate:</strong></p>
        <ul>
          <li>Skim for awareness: 30 minutes</li>
          <li>Full read with setup: 2-3 hours</li>
          <li>Reference during incidents: As needed</li>
        </ul>
        <p><strong>Prerequisites:</strong></p>
        <ul>
          <li>You have run Claude Code at least a few times</li>
          <li>You understand basic git operations (commit, checkout, stash)</li>
          <li>You have access to your Claude configuration (<code>~/.claude/</code>)</li>
          <li>For enterprise sections: familiarity with LiteLLM, Prometheus, Docker</li>
        </ul>
        <p><strong>This document links to:</strong></p>
        <ul>
          <li><a href="../architecture/core-patterns.html">Architecture Patterns</a> - Pattern selection before operations</li>
          <li><a href="../implementation/ralph-pattern.html">Implementation Guide</a> - Building what you operate</li>
          <li><a href="../mental-models/context-management.html">Mental Models</a> - Why these practices matter</li>
        </ul>
      </div>

      <p>This guide covers how to monitor Claude Code sessions effectively and manage costs from solo to enterprise scale. Context is your primary constraint. Cost is your secondary constraint. Without visibility into both, you are operating blind.</p>

      <h2 id="before-you-start">Before You Start</h2>

      <h3 id="47k-rule">The $47K Rule</h3>

      <p>Every war story in this document traces back to a missing prevention layer. One team spent $47,000 over 11 days on a recursive loop without iteration limits. Another lost their home directory to an unblocked <code>rm -rf</code> command.</p>

      <p>The costs of prevention (time to set up hooks, slight friction in workflow) are <strong>trivial</strong> compared to the costs of failure (data loss, runaway spending, hours of debugging).</p>

      <p><strong>Install the safety rails before you need them.</strong></p>

      <div class="checkpoint">
        <div class="checkpoint-header">Checkpoint: Prerequisites</div>
        <div class="checkpoint-content">
          <p>Verify your environment before proceeding:</p>
          <div class="code-block">
            <button class="copy-btn">Copy</button>
            <pre><code># Check Claude configuration exists
ls -la ~/.claude/

# Check git is available (your safety net)
git --version

# Check you're in a git repository for your work
git status

# Check available disk space (need >5GB)
df -h ~/.claude</code></pre>
          </div>
          <p><strong>You should see:</strong></p>
          <ul>
            <li>A <code>.claude</code> directory with your settings</li>
            <li>Git version 2.x or higher</li>
            <li>Either a clean git status or intentionally uncommitted changes</li>
            <li>At least 5GB available on your disk</li>
          </ul>
        </div>
      </div>

      <details class="troubleshoot">
        <summary><code>~/.claude/</code> does not exist</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">You have never configured Claude Code.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Run <code>claude</code> once to initialize the configuration directory.</p>
          </div>
        </div>
      </details>

      <details class="troubleshoot">
        <summary><code>git: command not found</code></summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">Git is not installed on your system.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Install git:</p>
            <ul>
              <li>macOS: <code>brew install git</code></li>
              <li>Linux: <code>apt install git</code> or <code>yum install git</code></li>
            </ul>
          </div>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>Not in a git repository</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">You are in the wrong directory or the project is not git-initialized.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p><code>cd</code> to your project directory or run <code>git init</code> to initialize.</p>
          </div>
        </div>
      </details>

      <hr class="section-divider">

      <h2 id="context-monitoring">Part 1: Context Usage Monitoring</h2>

      <h3 id="why-context">Why Context Monitoring Matters</h3>

      <p>Context is the <strong>primary constraint</strong> on Claude Code operation. When context fills up, quality degrades predictably. By the time you notice behavioral problems, you are already in trouble.</p>

      <h4>The Context Degradation Curve</h4>

      <table>
        <thead>
          <tr>
            <th>Context Level</th>
            <th>Quality State</th>
            <th>What You Will Observe</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>&lt;40%</strong></td>
            <td>Excellent</td>
            <td>Sharp responses, follows instructions precisely</td>
          </tr>
          <tr>
            <td><strong>40-60%</strong></td>
            <td>Good</td>
            <td>Normal operation, occasional verbosity</td>
          </tr>
          <tr>
            <td><strong>60-70%</strong></td>
            <td>Degrading</td>
            <td>Slight repetition, instruction drift beginning</td>
          </tr>
          <tr>
            <td><strong>70-80%</strong></td>
            <td>Poor</td>
            <td>Forgetting earlier context, circular suggestions</td>
          </tr>
          <tr>
            <td><strong>80-85%</strong></td>
            <td>Bad</td>
            <td>Contradictions, ignoring explicit instructions</td>
          </tr>
          <tr>
            <td><strong>&gt;85%</strong></td>
            <td>Critical</td>
            <td>Hallucinations, unrelated changes, session corrupted</td>
          </tr>
        </tbody>
      </table>

      <h3 id="claude-hud">Procedure: Install Claude HUD for Visual Monitoring</h3>

      <p>The Claude HUD plugin provides real-time context visibility directly in your terminal.</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># Step 1: Add the plugin from marketplace
/plugin marketplace add jarrodwatts/claude-hud

# Step 2: Install the plugin
/plugin install claude-hud

# Step 3: Run setup with "Full" preset
/claude-hud:setup</code></pre>
      </div>

      <p>When prompted, select <strong>"Full"</strong> preset for maximum visibility.</p>

      <div class="checkpoint">
        <div class="checkpoint-header">Checkpoint: HUD Installation</div>
        <div class="checkpoint-content">
          <p>You should see a HUD like this:</p>
          <div class="code-block">
            <pre><code>+===================================================================+
| [Opus 4.5] |||||||||| 89% | myapp | main | HIGH                   |
+===================================================================+
| Token Breakdown:                                                   |
|   Input:  145,234 / 200,000 (73%)                                 |
|   Output:  32,451 /  50,000 (65%)                                 |
|   Cache:   21,000 tokens cached                                   |
|                                                                    |
| Consider: /compact or starting fresh session                      |
+===================================================================+</code></pre>
          </div>
        </div>
      </div>

      <details class="troubleshoot">
        <summary>HUD not appearing after installation</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">Plugin may not be enabled.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Run <code>/plugin enable claude-hud</code> in your Claude session.</p>
          </div>
        </div>
      </details>

      <h3 id="automated-context-hook">Procedure: Set Up Automated Context Monitoring Hook</h3>

      <p>For autonomous or headless operation, you need automated alerts before context becomes critical.</p>

      <p><strong>Step 1: Create the hook directory</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>mkdir -p ~/.claude/hooks</code></pre>
      </div>

      <p><strong>Step 2: Create the hook script</strong></p>

      <p>Create file: <code>~/.claude/hooks/context-monitor.sh</code></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# ~/.claude/hooks/context-monitor.sh
# PreToolUse hook for context warning

CONTEXT_TRACKER="/tmp/claude-context-state.json"

# Estimate context from tool call accumulation
TOOL_COUNT=$(jq -r '.tool_count // 0' "$CONTEXT_TRACKER" 2>/dev/null || echo 0)
TOOL_COUNT=$((TOOL_COUNT + 1))

# Rough heuristic: ~1000 tokens per tool call average
ESTIMATED_CONTEXT=$((TOOL_COUNT * 1000))
MAX_CONTEXT=200000
CONTEXT_PCT=$((ESTIMATED_CONTEXT * 100 / MAX_CONTEXT))

# Update tracker
jq -n --argjson count "$TOOL_COUNT" --argjson pct "$CONTEXT_PCT" \
  '{tool_count: $count, estimated_percent: $pct, updated: now}' > "$CONTEXT_TRACKER"

# Alert thresholds
if [ "$CONTEXT_PCT" -gt 90 ]; then
    echo "CRITICAL: Estimated context at ${CONTEXT_PCT}%. Reset required." >&2
    exit 1  # Block operation
elif [ "$CONTEXT_PCT" -gt 80 ]; then
    echo "WARNING: Estimated context at ${CONTEXT_PCT}%. Checkpoint recommended." >&2
elif [ "$CONTEXT_PCT" -gt 70 ]; then
    echo "NOTICE: Context at ${CONTEXT_PCT}%. Plan for reset." >&2
fi

exit 0</code></pre>
      </div>

      <p><strong>Step 3: Make it executable and configure</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>chmod +x ~/.claude/hooks/context-monitor.sh</code></pre>
      </div>

      <p>Add to your Claude settings (<code>~/.claude/settings.json</code>):</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>{
  "hooks": {
    "preToolUse": ["~/.claude/hooks/context-monitor.sh"]
  }
}</code></pre>
      </div>

      <h4>Alert Thresholds Quick Reference</h4>

      <table>
        <thead>
          <tr>
            <th>Metric</th>
            <th>Green</th>
            <th>Yellow</th>
            <th>Red</th>
            <th>Critical</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Context %</strong></td>
            <td>&lt;60%</td>
            <td>60-80%</td>
            <td>80-90%</td>
            <td>&gt;90%</td>
          </tr>
          <tr>
            <td><strong>Session Duration (complex)</strong></td>
            <td>&lt;30 min</td>
            <td>30-45 min</td>
            <td>45-60 min</td>
            <td>&gt;60 min</td>
          </tr>
          <tr>
            <td><strong>Single File Edit Count</strong></td>
            <td>1-3</td>
            <td>4-5</td>
            <td>6-9</td>
            <td>10+</td>
          </tr>
          <tr>
            <td><strong>Iterations Without Commits</strong></td>
            <td>0-1</td>
            <td>2</td>
            <td>3</td>
            <td>4+</td>
          </tr>
        </tbody>
      </table>

      <details class="troubleshoot">
        <summary>Context-monitor.sh not running</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">Hook not registered in settings.json.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Verify the settings.json configuration includes the hook path and restart Claude.</p>
          </div>
        </div>
      </details>

      <details class="troubleshoot">
        <summary>jq command not found</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">jq is not installed.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Install jq:</p>
            <ul>
              <li>macOS: <code>brew install jq</code></li>
              <li>Linux: <code>apt install jq</code></li>
            </ul>
          </div>
        </div>
      </details>

      <h3 id="lsp-grounding">LSP Grounding for Real-Time Error Detection</h3>

      <p>Context pollution often stems from accumulated compilation errors that Claude attempts to fix repeatedly. The <strong>opencode</strong> pattern provides LSP grounding that catches these at the source.</p>

      <div class="ascii-diagram">LSP GROUNDING ARCHITECTURE (opencode)
===================================================================

  EDIT CYCLE WITH LSP FEEDBACK
  ============================

  1. Claude makes file edit
     |
     v
  2. LSP Server queries diagnostics
     |-- TypeScript: tsserver
     |-- Python: pyright/pylsp
     |-- Go: gopls
     +-- Rust: rust-analyzer
     |
     v
  3. Compiler errors returned in <50ms
     |
     +-> NO ERRORS: Continue to next operation
     |
     +-> ERRORS FOUND: Feed errors back to Claude IMMEDIATELY
         +-> Claude fixes in SAME iteration
         +-> No context pollution from multi-iteration fix loops

===================================================================</div>

      <p>Create file: <code>~/.claude/hooks/lsp-grounding.sh</code></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# ~/.claude/hooks/lsp-grounding.sh
# PostToolUse hook for Edit operations - opencode LSP pattern

FILE_PATH="$1"
EXTENSION="${FILE_PATH##*.}"
LSP_METRICS="/tmp/opencode-lsp-metrics.json"

# Track LSP call metrics
LSP_CALLS=$(jq -r '.lsp_calls // 0' "$LSP_METRICS" 2>/dev/null || echo 0)
LSP_CALLS=$((LSP_CALLS + 1))

case "$EXTENSION" in
    ts|tsx)
        # TypeScript - use tsserver diagnostics
        ERRORS=$(npx tsc --noEmit --pretty 2>&1 | head -20)
        ;;
    py)
        # Python - use pyright
        ERRORS=$(pyright "$FILE_PATH" 2>&1 | head -20)
        ;;
    go)
        # Go - use go vet
        ERRORS=$(go vet "$FILE_PATH" 2>&1 | head -20)
        ;;
esac

# Update metrics
ERROR_COUNT=$(echo "$ERRORS" | grep -c "error" || echo 0)
jq -n --argjson calls "$LSP_CALLS" --argjson errors "$ERROR_COUNT" \
  '{lsp_calls: $calls, last_error_count: $errors, updated: now}' > "$LSP_METRICS"

# Output goes to Claude as feedback for immediate correction
echo "$ERRORS"</code></pre>
      </div>

      <h4>LSP Grounding Trade-offs</h4>

      <table>
        <thead>
          <tr>
            <th>Benefit</th>
            <th>Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Catches errors at source before context accumulation</td>
            <td>Adds 50-200ms latency per edit</td>
          </tr>
          <tr>
            <td>Language-agnostic (works for any LSP-supported language)</td>
            <td>Requires LSP server setup per language</td>
          </tr>
          <tr>
            <td>Reduces total iterations by 30-50% for type-heavy codebases</td>
            <td>May produce noise for intentionally incomplete code</td>
          </tr>
        </tbody>
      </table>

      <hr class="section-divider">

      <h2 id="progress-tracking">Part 2: Progress Tracking</h2>

      <h3>What to Log</h3>

      <p>Every agent session should produce observable progress. If you cannot answer "what did this session accomplish?", you are operating blind.</p>

      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Metric</th>
            <th>Storage</th>
            <th>Query Method</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Progress</strong></td>
            <td>Commits per iteration</td>
            <td>Git</td>
            <td><code>git rev-list --count</code></td>
          </tr>
          <tr>
            <td><strong>Progress</strong></td>
            <td>Files modified</td>
            <td>Git</td>
            <td><code>git diff --name-only</code></td>
          </tr>
          <tr>
            <td><strong>Progress</strong></td>
            <td>Tests passing/failing</td>
            <td>Test runner</td>
            <td><code>npm test --json</code></td>
          </tr>
          <tr>
            <td><strong>Cost</strong></td>
            <td>Tokens consumed</td>
            <td>Session file</td>
            <td>Langfuse/AgentOps</td>
          </tr>
          <tr>
            <td><strong>Health</strong></td>
            <td>Last activity timestamp</td>
            <td>Heartbeat file</td>
            <td>File mtime</td>
          </tr>
        </tbody>
      </table>

      <h3>Procedure: Set Up Session Progress Logging</h3>

      <p><strong>Step 1: Create the log directory</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>mkdir -p ~/.claude/logs</code></pre>
      </div>

      <p><strong>Step 2: Create the logging hook</strong></p>

      <p>Create file: <code>~/.claude/hooks/progress-logger.sh</code></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# ~/.claude/hooks/progress-logger.sh
# PostToolUse hook for progress logging

LOG_FILE="$HOME/.claude/logs/session-$(date +%Y%m%d).jsonl"
TOOL_NAME="$1"
FILE_PATH="${2:-unknown}"

# Log event
jq -n \
  --arg ts "$(date -Iseconds)" \
  --arg tool "$TOOL_NAME" \
  --arg file "$FILE_PATH" \
  '{ts: $ts, event: "tool_call", tool: $tool, file: $file}' >> "$LOG_FILE"</code></pre>
      </div>

      <p><strong>Step 3: Make executable and register</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>chmod +x ~/.claude/hooks/progress-logger.sh</code></pre>
      </div>

      <h4>Query Progress</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># How many commits this session?
grep '"event":"commit"' ~/.claude/logs/session-*.jsonl | wc -l

# What files were modified?
grep '"event":"tool_call"' ~/.claude/logs/session-*.jsonl | jq -r '.file' | sort -u

# Total estimated cost?
grep '"event":"iteration_complete"' ~/.claude/logs/session-*.jsonl | jq -s 'map(.cost_usd) | add'

# Time since last activity (macOS)?
stat -f %m ~/.claude/heartbeat.json</code></pre>
      </div>

      <hr class="section-divider">

      <h2 id="stuck-detection">Part 3: Stuck Detection</h2>

      <p>An agent can spin without making progress. Without detection, this wastes money and time.</p>

      <div class="ascii-diagram">STUCK DETECTION SIGNALS
===================================================================

SIGNAL 1: No Progress
|-- Iterations without commits: 3+
|-- Same file edited repeatedly: 5+ times
+-- Tests passing/failing unchanged across iterations

SIGNAL 2: Circular Patterns
|-- Similar diffs (>80% overlap): 3+ times
|-- Undo-redo patterns: A->B->A->B
+-- Same error message appearing repeatedly

SIGNAL 3: Resource Exhaustion
|-- Context usage: >90%
|-- Iteration rate: >20/hour
+-- Tool calls/iteration: >100

SIGNAL 4: Behavioral Degradation
|-- Claude referencing non-existent files
|-- Contradicting previous decisions
+-- Ignoring explicit CLAUDE.md instructions

===================================================================</div>

      <h3>Procedure: Install Stuck Detection Hook</h3>

      <p>Create file: <code>~/.claude/hooks/stuck-detector.sh</code></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# ~/.claude/hooks/stuck-detector.sh
# Run between Ralph iterations

STUCK_FILE="/tmp/ralph-stuck-state.json"
MAX_STUCK_ITERATIONS=3

# Get current commit count
CURRENT_COMMITS=$(git rev-list --count HEAD 2>/dev/null || echo "0")

# Load previous state
if [ -f "$STUCK_FILE" ]; then
    PREV_COMMITS=$(jq -r '.commits // 0' "$STUCK_FILE")
    STUCK_COUNT=$(jq -r '.stuck_count // 0' "$STUCK_FILE")
else
    PREV_COMMITS=0
    STUCK_COUNT=0
fi

# Check if progress was made
if [ "$CURRENT_COMMITS" -eq "$PREV_COMMITS" ]; then
    STUCK_COUNT=$((STUCK_COUNT + 1))
    echo "WARNING: No commits this iteration (stuck count: $STUCK_COUNT/$MAX_STUCK_ITERATIONS)" >&2
else
    STUCK_COUNT=0
    echo "Progress: $((CURRENT_COMMITS - PREV_COMMITS)) new commit(s)" >&2
fi

# Save state
jq -n --argjson commits "$CURRENT_COMMITS" --argjson stuck "$STUCK_COUNT" \
  '{commits: $commits, stuck_count: $stuck, updated: now}' > "$STUCK_FILE"

# Exit if stuck too long
if [ "$STUCK_COUNT" -ge "$MAX_STUCK_ITERATIONS" ]; then
    echo "=======================================================" >&2
    echo "ERROR: Agent stuck for $STUCK_COUNT iterations" >&2
    echo "No commits made in $MAX_STUCK_ITERATIONS consecutive iterations." >&2
    echo "" >&2
    echo "Possible causes:" >&2
    echo "  - Context pollution (try fresh session)" >&2
    echo "  - Task too complex (break into smaller pieces)" >&2
    echo "  - Circular dependency (needs human review)" >&2
    echo "=======================================================" >&2
    exit 42  # Special exit code for stuck detection
fi

exit 0</code></pre>
      </div>

      <div class="checkpoint">
        <div class="checkpoint-header">Checkpoint: Stuck Detection</div>
        <div class="checkpoint-content">
          <ul>
            <li>Stuck detector hook installed and executable</li>
            <li>Exit code 42 indicates stuck condition</li>
            <li>3-iteration threshold before triggering</li>
          </ul>
        </div>
      </div>

      <details class="troubleshoot">
        <summary>False positive stuck detection</summary>
        <div class="troubleshoot-content">
          <div class="troubleshoot-cause">Task legitimately needs many iterations without commits.</div>
          <div class="troubleshoot-fix">
            <div class="troubleshoot-fix-label">Fix</div>
            <p>Increase <code>MAX_STUCK_ITERATIONS</code> in the hook script for your use case.</p>
          </div>
        </div>
      </details>

      <hr class="section-divider">

      <h2 id="cost-model">Part 4: Cost Management</h2>

      <h3>Understanding the Cost Model</h3>

      <div class="ascii-diagram">COST ESTIMATION MODEL (as of 2026)
===================================================================

Per-Token Costs (approximate):
|-- Haiku:  $0.25 / 1M input tokens, $1.25 / 1M output
|-- Sonnet: $3.00 / 1M input tokens, $15.00 / 1M output
+-- Opus:   $15.00 / 1M input tokens, $75.00 / 1M output

Per-Iteration Estimates (conservative, 50K tokens):
|-- Haiku iteration:  ~$0.15
|-- Sonnet iteration: ~$1.25
+-- Opus iteration:   ~$3.00

Tool Overhead:
|-- WebSearch: ~$0.01 per search
|-- WebFetch:  ~$0.005 per fetch
+-- MCP tools: Varies by provider

===================================================================</div>

      <h3>Three-Tier Model Strategy</h3>

      <p>Not all tasks require Opus. Use the right model for the job.</p>

      <table>
        <thead>
          <tr>
            <th>Tier</th>
            <th>Model</th>
            <th>Use Case</th>
            <th>Cost</th>
            <th>Target %</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>TIER 1: CRITICAL</strong></td>
            <td>Claude Opus</td>
            <td>Architecture, complex debugging, security</td>
            <td>$$$</td>
            <td>&lt;5%</td>
          </tr>
          <tr>
            <td><strong>TIER 2: COMPLEX</strong></td>
            <td>Claude Sonnet</td>
            <td>Feature implementation, code review</td>
            <td>$$</td>
            <td>40%</td>
          </tr>
          <tr>
            <td><strong>TIER 3: FAST</strong></td>
            <td>Claude Haiku</td>
            <td>Simple edits, status checks, formatting</td>
            <td>$</td>
            <td>55%</td>
          </tr>
        </tbody>
      </table>

      <h3>Session-Level Cost Tracking</h3>

      <p>Create file: <code>~/.claude/hooks/cost-monitor.sh</code></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>#!/bin/bash
# ~/.claude/hooks/cost-monitor.sh
# Run between iterations

COST_FILE="/tmp/claude-session-cost.json"
WARN_THRESHOLD_USD=10.00
HARD_LIMIT_USD=50.00

# Load accumulated cost
if [ -f "$COST_FILE" ]; then
    ACCUMULATED=$(jq -r '.total_usd // 0' "$COST_FILE")
    ITERATION=$(jq -r '.iteration // 0' "$COST_FILE")
else
    ACCUMULATED=0
    ITERATION=0
fi

# Estimate current iteration cost
MODEL=${ANTHROPIC_MODEL:-"sonnet"}
case "$MODEL" in
    *haiku*)  ITER_COST=0.15 ;;
    *sonnet*) ITER_COST=1.25 ;;
    *opus*)   ITER_COST=3.00 ;;
    *)        ITER_COST=1.25 ;;
esac

NEW_TOTAL=$(echo "$ACCUMULATED + $ITER_COST" | bc)
NEW_ITERATION=$((ITERATION + 1))

# Save state
jq -n --argjson total "$NEW_TOTAL" --argjson iter "$NEW_ITERATION" \
  '{total_usd: $total, iteration: $iter, updated: now}' > "$COST_FILE"

# Check thresholds
if (( $(echo "$NEW_TOTAL >= $HARD_LIMIT_USD" | bc -l) )); then
    echo "=======================================================" >&2
    echo "HARD LIMIT: Session cost \$${NEW_TOTAL} >= \$${HARD_LIMIT_USD}" >&2
    echo "Session terminated to prevent runaway costs." >&2
    echo "=======================================================" >&2
    exit 1  # Block further operations
fi

if (( $(echo "$NEW_TOTAL >= $WARN_THRESHOLD_USD" | bc -l) )); then
    echo "WARNING: Session cost \$${NEW_TOTAL} approaching limit \$${HARD_LIMIT_USD}" >&2
fi

echo "Cost tracking: Iteration $NEW_ITERATION, Total \$${NEW_TOTAL}" >&2
exit 0</code></pre>
      </div>

      <h4>Cost Alerting Levels</h4>

      <table>
        <thead>
          <tr>
            <th>Cost Level</th>
            <th>Action</th>
            <th>Notification</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>$0-5</strong></td>
            <td>Normal operation</td>
            <td>None</td>
          </tr>
          <tr>
            <td><strong>$5-10</strong></td>
            <td>Awareness</td>
            <td>Console warning</td>
          </tr>
          <tr>
            <td><strong>$10-25</strong></td>
            <td>Caution</td>
            <td>Console + push notification</td>
          </tr>
          <tr>
            <td><strong>$25-50</strong></td>
            <td>Critical</td>
            <td>Push notification + block new iterations</td>
          </tr>
          <tr>
            <td><strong>&gt;$50</strong></td>
            <td>Emergency</td>
            <td>Hard stop + immediate notification</td>
          </tr>
        </tbody>
      </table>

      <hr class="section-divider">

      <h2 id="enterprise-monitoring">Part 5: Enterprise Monitoring Architecture</h2>

      <p><em>Skip this section if you are a solo practitioner. Return when scaling to team or enterprise.</em></p>

      <h3>Three-Layer Observability Stack</h3>

      <div class="ascii-diagram">ENTERPRISE MONITORING ARCHITECTURE
===================================================================

LAYER 1: API GATEWAY (LiteLLM Proxy)
|-- Request/response logging
|-- Cost per request
|-- Latency metrics (P50, P95, P99)
|-- Error rates by provider
|-- Rate limit status
+-- Budget utilization

LAYER 2: ORCHESTRATION (claude-flow / Claude Squad)
|-- Agent spawn events
|-- Task claim/release lifecycle
|-- Consensus voting results
|-- Swarm topology changes
|-- Memory sync operations
+-- Byzantine failure detection

LAYER 3: EXECUTION (Claude Code / OpenCode)
|-- Tool calls and results
|-- File edits (LSP metrics)
|-- Bash commands
|-- Test executions
|-- Context usage
+-- Session duration

===================================================================</div>

      <h3>Configure LiteLLM Callbacks</h3>

      <p>Create file: <code>litellm_config.yaml</code></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>litellm_settings:
  callbacks:
    - langfuse       # LLM observability platform
    - prometheus     # Metrics scraping
    - custom_callback  # Enterprise logging

  success_callback:
    - langfuse
    - s3            # Archive to S3 for compliance

  failure_callback:
    - langfuse
    - alerting_webhook  # PagerDuty, Slack, etc.</code></pre>
      </div>

      <h3>Prometheus Alerting Rules</h3>

      <p>Create file: <code>claude-operations-alerts.yaml</code></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code>groups:
- name: claude-operations-alerts
  rules:

  - alert: HighErrorRate
    expr: rate(litellm_requests_total{status="error"}[5m]) > 0.1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "LLM error rate above 10%"

  - alert: BudgetNearExhaustion
    expr: litellm_budget_remaining < 100
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Budget remaining below $100"

  - alert: HighLatency
    expr: histogram_quantile(0.95, litellm_request_duration_seconds) > 30
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "P95 latency above 30 seconds"</code></pre>
      </div>

      <h3>Enterprise Budget Control</h3>

      <div class="ascii-diagram">ENTERPRISE BUDGET HIERARCHY
===================================================================

LEVEL 1: GLOBAL CAP
|-- Total organization spend cap
|-- Configuration: litellm.max_budget = 50000  # USD/month
+-- Enforcement: Hard stop at limit

LEVEL 2: PER-TEAM BUDGETS
|-- Engineering: $10,000/month
|-- Research: $15,000/month
|-- ML/AI: $20,000/month
+-- Enforcement: Team API key limits

LEVEL 3: PER-USER QUOTAS
|-- Individual developer: $500/week
|-- Senior engineer: $1,000/week
|-- Lead: $2,000/week
+-- Enforcement: Virtual key system

===================================================================</div>

      <h3>LiteLLM Budget Configuration</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># litellm_config.yaml - Enterprise Budget Control

litellm_settings:
  max_budget: 50000  # Global monthly cap

general_settings:
  database_url: postgresql://...  # Persistent budget tracking

# Team-level virtual keys
virtual_keys:
  - key: sk-team-engineering
    max_budget: 10000
    budget_duration: monthly
    team_id: engineering
    allowed_models: ["claude-sonnet-*", "claude-haiku-*"]

  - key: sk-team-research
    max_budget: 15000
    budget_duration: monthly
    team_id: research
    allowed_models: ["claude-opus-*", "claude-sonnet-*"]

# Per-user enforcement
user_config:
  budget_per_user:
    default: 500
    duration: weekly</code></pre>
      </div>

      <h3>Cost Optimization Strategies</h3>

      <h4>Strategy 1: Semantic Caching</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre><code># LiteLLM semantic caching configuration

cache: True
cache_config:
  type: qdrant_semantic  # Vector-based similarity matching
  similarity_threshold: 0.8  # 80% similarity = cache hit
  ttl: 600  # 10 minute TTL
  supported_call_types:
    - completion
    - embedding</code></pre>
      </div>

      <table>
        <thead>
          <tr>
            <th>Metric</th>
            <th>Target</th>
            <th>Action if Below</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Cache hit rate</td>
            <td>&gt;30%</td>
            <td>Review query diversity, adjust threshold</td>
          </tr>
          <tr>
            <td>Cost savings</td>
            <td>&gt;20%</td>
            <td>Increase TTL, lower similarity threshold</td>
          </tr>
          <tr>
            <td>Cache latency</td>
            <td>&lt;10ms</td>
            <td>Upgrade Qdrant instance, add replicas</td>
          </tr>
        </tbody>
      </table>

      <h4>Strategy 2: Context Efficiency</h4>

      <table>
        <thead>
          <tr>
            <th>Optimization</th>
            <th>Savings</th>
            <th>Implementation</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Lean CLAUDE.md</td>
            <td>10-20%</td>
            <td>Keep &lt;15KB, remove verbose instructions</td>
          </tr>
          <tr>
            <td>.claudeignore</td>
            <td>5-15%</td>
            <td>Exclude node_modules, build artifacts</td>
          </tr>
          <tr>
            <td>Subagent isolation</td>
            <td>15-30%</td>
            <td>Spawn subagents for isolated work</td>
          </tr>
          <tr>
            <td>Fresh context per iteration</td>
            <td>20-40%</td>
            <td>Use Ralph pattern instead of extended sessions</td>
          </tr>
        </tbody>
      </table>

      <div class="checkpoint">
        <div class="checkpoint-header">Checkpoint: Monitoring + Cost Complete</div>
        <div class="checkpoint-content">
          <ul>
            <li>At least ONE monitoring method active (HUD or hook)</li>
            <li>Cost monitor hook installed</li>
            <li>You understand the 60/70/80/90% context thresholds</li>
            <li>You have a mental budget for your work</li>
            <li>You know which model tier to use for different tasks</li>
            <li>(Enterprise) LiteLLM budget controls configured</li>
          </ul>
        </div>
      </div>

      <hr class="section-divider">

      <h2 id="next-steps">Next Steps</h2>

      <div class="related-pages">
        <h3>Continue the Operations Journey</h3>
        <ul>
          <li><a href="security-checklists.html">Security + Operational Checklists</a> - Permission gating, checklists for every phase</li>
          <li><a href="incident-response.html">Incident Response + Failure Modes</a> - When things go wrong</li>
        </ul>

        <h3>Related Topics</h3>
        <ul>
          <li><a href="../mental-models/context-management.html">Context Management Mental Model</a></li>
          <li><a href="../../reference/cost-analysis.html">Cost Analysis Reference</a></li>
          <li><a href="../../reference/failure-modes.html">Failure Mode Catalog</a></li>
        </ul>
      </div>

      <nav class="footer-nav">
        <a href="index.html" class="nav-prev">
          <span class="nav-direction">Previous</span>
          <span class="nav-title">Operations Overview</span>
        </a>
        <a href="security-checklists.html" class="nav-next">
          <span class="nav-direction">Next</span>
          <span class="nav-title">Security + Checklists</span>
        </a>
      </nav>
    </main>
  </div>

  <!-- Mobile Toggle Button -->
  <button class="sidebar-toggle" aria-label="Toggle navigation">&#9776;</button>

  <script src="../../js/sidebar.js"></script>
</body>
</html>
