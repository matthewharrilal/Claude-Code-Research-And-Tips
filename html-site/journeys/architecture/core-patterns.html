<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Core Patterns - Claude Code Knowledge Base</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
</head>
<body>
  <div class="page-with-sidebar">
    <!-- Sidebar navigation -->
    <nav class="sidebar">
      <button class="sidebar-close" aria-label="Close menu">&times;</button>
      <div class="sidebar-header">
        <h1 class="sidebar-title"><a href="../../index.html">Claude Code KB</a></h1>
      </div>
      <ul class="sidebar-nav">
        <!-- Architecture section (open when on architecture pages) -->
        <li class="nav-section open">
          <div class="nav-section-title">Architecture</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="decision-framework.html">Decision Framework</a></li>
            <li class="nav-page current"><a href="core-patterns.html">Core Patterns</a></li>
            <li class="nav-page"><a href="enterprise-swarm.html">Enterprise &amp; Swarm</a></li>
            <li class="nav-page"><a href="context-composition.html">Context &amp; Composition</a></li>
          </ul>
        </li>
        <!-- Implementation section -->
        <li class="nav-section">
          <div class="nav-section-title">Implementation</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../implementation/context-state.html">Context &amp; State</a></li>
            <li class="nav-page"><a href="../implementation/ralph-production.html">Ralph Production</a></li>
            <li class="nav-page"><a href="../implementation/hooks-enterprise.html">Hooks &amp; Enterprise</a></li>
          </ul>
        </li>
        <!-- Operations section -->
        <li class="nav-section">
          <div class="nav-section-title">Operations</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../operations/monitoring-cost.html">Monitoring &amp; Cost</a></li>
            <li class="nav-page"><a href="../operations/security-checklists.html">Security &amp; Checklists</a></li>
            <li class="nav-page"><a href="../operations/incident-response.html">Incident Response</a></li>
          </ul>
        </li>
        <!-- Mental Models section -->
        <li class="nav-section">
          <div class="nav-section-title">Mental Models</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../mental-models/core-models.html">Core Models</a></li>
            <li class="nav-page"><a href="../mental-models/advanced-models.html">Advanced Models</a></li>
            <li class="nav-page"><a href="../mental-models/practice-heuristics.html">Practice &amp; Heuristics</a></li>
          </ul>
        </li>
        <!-- Foundations section -->
        <li class="nav-section">
          <div class="nav-section-title">Foundations</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../foundations/invariants-reference.html">Invariants Reference</a></li>
          </ul>
        </li>
      </ul>
    </nav>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay"></div>

    <!-- Main content -->
    <main class="main-content">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href="../../index.html">Home</a>
        <span class="breadcrumb-separator">/</span>
        <a href="decision-framework.html">Architecture</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">Core Patterns</span>
      </nav>

      <!-- Page meta -->
      <div class="page-meta">
        <span class="page-meta-item">~25 min read</span>
      </div>

      <h1>Core Architecture Patterns</h1>

      <div class="context-box you-are-here">
        <h3>You Are Here</h3>
        <p><strong>What this covers:</strong> Deep documentation of each core architecture pattern with architecture diagrams, mechanisms, code scaffolding, and trade-off analysis.</p>
        <p><strong>Patterns covered:</strong> Ralph Wiggum Loop, CC Mirror Hub-and-Spoke, Claude Squad, Gas Town Factory, Architect/Editor Split, and Two-Phase Orchestration.</p>
        <p><strong>Where this fits:</strong></p>
        <pre class="ascii-diagram">ARCHITECTURE JOURNEY
    |
    +-- Decision Framework (which pattern?)
    |
    +-- **YOU ARE HERE: Core Patterns** (how they work)
    |
    +-- Enterprise &amp; Swarm (scaling up)
    |
    +-- Context &amp; Composition (combining patterns)</pre>
      </div>

      <p>This page provides deep documentation of each core architecture pattern: Ralph Wiggum Loop, CC Mirror Hub-and-Spoke, Claude Squad, and Gas Town Factory. Each section includes architecture diagrams, mechanisms, code scaffolding, and trade-off analysis.</p>

      <h2>Ralph Wiggum Loop (Autonomous Loop)</h2>

      <p><strong>Source Attribution:</strong> Matt Pocock, Ryan Carson</p>

      <h3>Architecture Diagram</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------------------+
|                        RALPH WIGGUM LOOP                                 |
|                                                                          |
|   +------------------------------------------------------------------+  |
|   |                        EXTERNAL STATE                             |  |
|   |                                                                   |  |
|   |  +-------------+   +-------------+   +-------------------------+ |  |
|   |  |  prd.json   |   |progress.txt |   |    Git Repository       | |  |
|   |  |             |   |             |   |                         | |  |
|   |  | stories[]:  |   | 14:32 Task1 |   | +---------------------+ | |  |
|   |  |  - passes   |   | completed   |   | | Source code         | | |  |
|   |  |  - criteria |   | 14:45 Task2 |   | | + Commit history    | | |  |
|   |  |  - status   |   | in progress |   | | + Branch state      | | |  |
|   |  +-------------+   +-------------+   | +---------------------+ | |  |
|   |        ^                 ^           +-------------------------+ |  |
|   |        |                 |                      ^                |  |
|   +--------+-----------------+----------------------+----------------+  |
|            |                 |                      |                    |
|   +--------+-----------------+----------------------+----------------+  |
|   |                    ITERATION LOOP                                 |  |
|   |                                                                   |  |
|   |   +---------+    +-------------------------+    +-------------+  |  |
|   |   |  START  |---&gt;|  cat PROMPT.md | claude |---&gt;|  EXECUTE    |  |  |
|   |   |         |    |  (fresh context)        |    |  TASK       |  |  |
|   |   +---------+    +-------------------------+    +------+------+  |  |
|   |        ^                                               |         |  |
|   |        |                                               v         |  |
|   |   +----+----+    +-------------------------+    +-------------+  |  |
|   |   | ITERATE |&lt;---|  Check prd.json OR      |&lt;---|  VERIFY     |  |  |
|   |   |  or     |    |  &lt;promise&gt;COMPLETE      |    |  (tests,    |  |  |
|   |   | STOP    |    |  &lt;/promise&gt; signal      |    |  typecheck) |  |  |
|   |   +---------+    +-------------------------+    +-------------+  |  |
|   |                                                                   |  |
|   +-------------------------------------------------------------------+  |
|                                                                          |
|   LOOP MECHANICS: while :; do cat PROMPT.md | claude-code ; done        |
|   TERMINATION: prd.json all passes:true OR MAX_ITERATIONS reached       |
|                                                                          |
+-------------------------------------------------------------------------+</pre>
      </div>

      <h3>Core Mechanism</h3>

      <p>The Ralph Wiggum Loop operates on a simple principle: <strong>fresh context per iteration with external state persistence.</strong></p>

      <p><strong>Each Iteration:</strong></p>
      <ol>
        <li>Read PROMPT.md for task context</li>
        <li>Query prd.json for next incomplete story</li>
        <li>Execute exactly ONE story (atomic task)</li>
        <li>Run verification gates (typecheck, tests)</li>
        <li>Update prd.json (mark passes: true/false)</li>
        <li>Append to progress.txt (learning capture)</li>
        <li>Commit to git (state persistence)</li>
        <li>Loop checks termination condition</li>
      </ol>

      <p><strong>Termination Conditions:</strong></p>
      <ul>
        <li>All stories in prd.json have <code>passes: true</code></li>
        <li>Agent outputs <code>&lt;promise&gt;COMPLETE&lt;/promise&gt;</code> signal</li>
        <li>MAX_ITERATIONS exceeded (safety limit)</li>
        <li>Stuck detection: 3+ iterations with no commits</li>
      </ul>

      <h3>Code Scaffolding</h3>

      <p><strong>ralph.sh (Battle-Tested Implementation):</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>#!/bin/bash
set -euo pipefail

MAX_ITERATIONS=${1:-50}
ITERATION=0
STUCK_COUNT=0
LAST_COMMIT=""

while [ $ITERATION -lt $MAX_ITERATIONS ]; do
    ITERATION=$((ITERATION + 1))
    echo "=== Ralph Iteration $ITERATION ==="

    # Execute with fresh context (piped, not interactive)
    cat PROMPT.md | claude-code --print 2&gt;&amp;1 | tee "iteration-$ITERATION.log"

    # Check for completion signal
    if grep -q '&lt;promise&gt;COMPLETE&lt;/promise&gt;' "iteration-$ITERATION.log"; then
        echo "Explicit completion signal received"
        break
    fi

    # Check prd.json for all passes
    if jq -e '.stories | all(.passes == true)' prd.json &gt; /dev/null 2&gt;&amp;1; then
        echo "All stories pass in prd.json"
        break
    fi

    # Stuck detection
    CURRENT_COMMIT=$(git rev-parse HEAD 2&gt;/dev/null || echo "none")
    if [ "$CURRENT_COMMIT" = "$LAST_COMMIT" ]; then
        STUCK_COUNT=$((STUCK_COUNT + 1))
        echo "Warning: No commit this iteration (stuck count: $STUCK_COUNT)"
        if [ $STUCK_COUNT -ge 3 ]; then
            echo "Error: Agent stuck for 3 iterations, exiting"
            exit 1
        fi
    else
        STUCK_COUNT=0
        LAST_COMMIT="$CURRENT_COMMIT"
    fi

    sleep 2  # Rate limiting
done

echo "Ralph complete after $ITERATION iterations"</pre>
      </div>

      <p><strong>PROMPT.md Template:</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre># Current Task Context

## Project Reference
Read prd.json for current stories and their status.
Read progress.txt for learning from previous iterations.

## Your Objective
1. Find the FIRST story in prd.json where passes is false
2. Implement ONLY that story
3. Run verification: npm run typecheck &amp;&amp; npm test
4. If tests pass: update prd.json, set passes: true
5. If tests fail: debug and fix before marking complete
6. Append to progress.txt what you learned
7. Commit your changes with descriptive message

## Completion Signal
When ALL stories have passes: true, output:
&lt;promise&gt;COMPLETE&lt;/promise&gt;

## Critical Rules
- ONE story per iteration (atomic tasks)
- NEVER mark a story as passing if tests fail
- ALWAYS append to progress.txt (never overwrite)
- Commit after each completed story</pre>
      </div>

      <p><strong>prd.json Schema:</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>{
  "project": "feature-auth",
  "stories": [
    {
      "id": "story-1",
      "title": "Create User model with email/password",
      "acceptance_criteria": [
        "User model exists in src/models/user.ts",
        "Email validation enforced",
        "Password hashing with bcrypt"
      ],
      "passes": false,
      "iteration_completed": null
    },
    {
      "id": "story-2",
      "title": "Implement POST /auth/login endpoint",
      "acceptance_criteria": [
        "Returns JWT on valid credentials",
        "Returns 401 on invalid credentials",
        "Rate limited to 5 attempts per minute"
      ],
      "passes": false,
      "iteration_completed": null,
      "depends_on": ["story-1"]
    }
  ]
}</pre>
      </div>

      <h3>Trade-offs</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Benefit</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Completely autonomous (walk away)</td>
              <td>Sequential (one story at a time)</td>
            </tr>
            <tr>
              <td>Fresh context each iteration (no rot)</td>
              <td>Cold start overhead per iteration</td>
            </tr>
            <tr>
              <td>Explicit verification gates</td>
              <td>Slower than extended session for small tasks</td>
            </tr>
            <tr>
              <td>Learning compounds (progress.txt)</td>
              <td>Requires upfront PRD investment</td>
            </tr>
            <tr>
              <td>Crash-resistant (git state)</td>
              <td>No real-time human intervention</td>
            </tr>
            <tr>
              <td>Predictable costs ($0.50-2 per iteration)</td>
              <td>MAX_ITERATIONS needed for runaway prevention</td>
            </tr>
          </tbody>
        </table>
      </div>

      <details class="troubleshoot">
        <summary>Ralph loop not completing tasks</summary>
        <div class="troubleshoot-content">
          <table>
            <tr>
              <th>Symptom</th>
              <th>Cause</th>
              <th>Recovery</th>
            </tr>
            <tr>
              <td>Agent marks stories complete but tests fail</td>
              <td>Verification gate bypassed</td>
              <td>Add explicit <code>npm test</code> gate in PROMPT.md</td>
            </tr>
            <tr>
              <td>Agent stuck for 3+ iterations</td>
              <td>Story too large or unclear</td>
              <td>Decompose story; add hints in progress.txt</td>
            </tr>
            <tr>
              <td>progress.txt keeps getting overwritten</td>
              <td>Agent using <code>&gt;</code> instead of <code>&gt;&gt;</code></td>
              <td>Add "ALWAYS append, never overwrite" in PROMPT.md</td>
            </tr>
            <tr>
              <td>prd.json has syntax errors</td>
              <td>Agent malformed JSON</td>
              <td>Validate JSON in script before next iteration</td>
            </tr>
          </table>
        </div>
      </details>

      <h2>CC Mirror Hub-and-Spoke</h2>

      <p><strong>Source Attribution:</strong> Numman Ali</p>

      <h3>Architecture Diagram</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------------------+
|                    CC MIRROR HUB-AND-SPOKE                               |
|                                                                          |
|   +------------------------------------------------------------------+  |
|   |                       ORCHESTRATOR (Conductor)                    |  |
|   |                                                                   |  |
|   |   ALLOWED TOOLS:          FORBIDDEN:                             |  |
|   |   + Read (max 2 files)    x Bash                                 |  |
|   |   + TaskCreate            x Write                                |  |
|   |   + TaskList              x Edit                                 |  |
|   |   + TaskGet               x Glob                                 |  |
|   |   + TaskUpdate            x Grep                                 |  |
|   |   + AskUserQuestion       x TaskCreate (from workers)            |  |
|   |                                                                   |  |
|   |   RESPONSIBILITIES:                                              |  |
|   |   - Analyze user request                                         |  |
|   |   - Load domain reference (1-2 files max)                        |  |
|   |   - Decompose into atomic tasks                                  |  |
|   |   - Create tasks with dependencies                               |  |
|   |   - Route to appropriate model tier                              |  |
|   |   - Monitor completion, synthesize results                       |  |
|   +-------------------------------+----------------------------------+  |
|                                   |                                      |
|                TaskCreate         |                                      |
|          +------------------------+------------------------+            |
|          |                        |                        |            |
|          v                        v                        v            |
|   +-----------------+     +-----------------+     +-----------------+  |
|   |    WORKER 1     |     |    WORKER 2     |     |    WORKER 3     |  |
|   |   (Architect)   |     |  (Implementer)  |     |    (Tester)     |  |
|   |                 |     |                 |     |                 |  |
|   | Model: Opus     |     | Model: Sonnet   |     | Model: Haiku    |  |
|   |                 |     |                 |     |                 |  |
|   | ALLOWED TOOLS:  |     | ALLOWED TOOLS:  |     | ALLOWED TOOLS:  |  |
|   | + Read          |     | + Read/Write    |     | + Read          |  |
|   | + Write/Edit    |     | + Edit          |     | + Bash (test)   |  |
|   | + Bash          |     | + Bash          |     |                 |  |
|   | + Glob/Grep     |     | + Glob/Grep     |     | FORBIDDEN:      |  |
|   |                 |     |                 |     | x Write/Edit    |  |
|   | FORBIDDEN:      |     | FORBIDDEN:      |     | x TaskCreate    |  |
|   | x TaskCreate    |     | x TaskCreate    |     |                 |  |
|   | x TaskUpdate    |     | x TaskUpdate    |     |                 |  |
|   +--------+--------+     +--------+--------+     +--------+--------+  |
|            |                       |                       |            |
|            +-------------------------------------------+            |
|                                    |                                     |
|                                    v                                     |
|                           +---------------+                             |
|                           |    RESULT     |                             |
|                           |  (Merged PR)  |                             |
|                           +---------------+                             |
|                                                                          |
|   THE IRON LAW: Orchestrators NEVER touch tools.                        |
|                 Workers NEVER spawn sub-agents.                          |
|                                                                          |
+-------------------------------------------------------------------------+</pre>
      </div>

      <h3>The Iron Law (Non-Negotiable)</h3>

      <ul>
        <li><strong>Orchestrator:</strong> Reads 1-2 files for context, spawns workers, tracks dependencies. NEVER executes Bash, Write, Edit directly.</li>
        <li><strong>Workers:</strong> Execute isolated tasks, report back. NEVER call TaskCreate, TaskUpdate, or spawn sub-agents.</li>
      </ul>

      <p><strong>Why The Iron Law Exists:</strong></p>
      <ol>
        <li><strong>Context Preservation:</strong> Orchestrator context explodes if it executes tools</li>
        <li><strong>Recursion Prevention:</strong> Workers spawning workers leads to infinite recursion</li>
        <li><strong>Role Clarity:</strong> Conductor doesn't play instruments; instruments don't conduct</li>
        <li><strong>Parallelism:</strong> Workers can run in parallel because they don't coordinate</li>
      </ol>

      <h3>Worker Spawn Pattern</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>TaskCreate({
  subject: "Implement User authentication endpoint",
  description: "Create POST /auth/login with JWT",
  acceptanceCriteria: [
    "Email/password validation",
    "JWT token returned on success",
    "Rate limiting (5 attempts/minute)"
  ],
  addBlocks: ["task-frontend-login-form"],  // This blocks frontend
  model: "opus"  // For complex implementation
})</pre>
      </div>

      <h3>Model Routing</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Task Type</th>
              <th>Model</th>
              <th>Rationale</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Architecture decisions</td>
              <td>Opus</td>
              <td>Deep reasoning required</td>
            </tr>
            <tr>
              <td>Multi-file refactoring</td>
              <td>Opus</td>
              <td>Coordination complexity</td>
            </tr>
            <tr>
              <td>Standard implementation</td>
              <td>Sonnet</td>
              <td>Cost-effective, reliable</td>
            </tr>
            <tr>
              <td>Bug fixes</td>
              <td>Sonnet</td>
              <td>Focused, verifiable</td>
            </tr>
            <tr>
              <td>Code lookups</td>
              <td>Haiku</td>
              <td>Fast, cheap</td>
            </tr>
            <tr>
              <td>Test execution</td>
              <td>Haiku</td>
              <td>Mechanical task</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3>Trade-offs</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Benefit</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>True parallelism (3-8 workers)</td>
              <td>Orchestrator context grows with task graph</td>
            </tr>
            <tr>
              <td>Right model for each task (cost savings)</td>
              <td>Coordination overhead per spawn</td>
            </tr>
            <tr>
              <td>Clear separation (thinking vs. doing)</td>
              <td>Workers isolated from each other</td>
            </tr>
            <tr>
              <td>Native Task API integration</td>
              <td>Merge complexity from parallel changes</td>
            </tr>
            <tr>
              <td>Dependency tracking built-in</td>
              <td>Needs good initial decomposition</td>
            </tr>
            <tr>
              <td>Scales to project complexity</td>
              <td>Setup time (~2 hours)</td>
            </tr>
          </tbody>
        </table>
      </div>

      <details class="troubleshoot">
        <summary>CC Mirror coordination problems</summary>
        <div class="troubleshoot-content">
          <table>
            <tr>
              <th>Symptom</th>
              <th>Cause</th>
              <th>Recovery</th>
            </tr>
            <tr>
              <td>Orchestrator context bloating rapidly</td>
              <td>Orchestrator reading too many files</td>
              <td>Enforce 2-file maximum; remove forbidden tools</td>
            </tr>
            <tr>
              <td>Workers are spawning sub-workers</td>
              <td>Iron Law violated</td>
              <td>Add explicit "FORBIDDEN: TaskCreate" to worker preamble</td>
            </tr>
            <tr>
              <td>Tasks keep blocking each other</td>
              <td>Circular dependencies</td>
              <td>Map dependency graph before spawning; detect cycles</td>
            </tr>
            <tr>
              <td>Merge conflicts between workers</td>
              <td>Workers modifying same files</td>
              <td>Redesign task boundaries; add git worktree isolation</td>
            </tr>
          </table>
        </div>
      </details>

      <h2>Claude Squad (Human-Mediated)</h2>

      <h3>Architecture Diagram</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------------------+
|                     CLAUDE SQUAD (Human-Mediated)                        |
|                                                                          |
|   +------------------------------------------------------------------+  |
|   |                  HUMAN OPERATOR (Decision Hub)                    |  |
|   |                                                                   |  |
|   |   +------------------------------------------------------------+ |  |
|   |   | - Observes all sessions via TUI dashboard                  | |  |
|   |   | - Provides instructions to each instance manually          | |  |
|   |   | - Coordinates by switching attention across instances      | |  |
|   |   | - Resolves conflicts through human judgment                | |  |
|   |   | - Routes work based on expertise and priority              | |  |
|   |   +------------------------------------------------------------+ |  |
|   +-------------------------------+----------------------------------+  |
|                                   |                                      |
|      +----------+-----------------+-----------------+----------+        |
|      |          |                 |                 |          |        |
|      v          v                 v                 v          v        |
|  +--------+ +--------+       +--------+       +--------+ +--------+    |
|  | Inst 1 | | Inst 2 |  ...  | Inst N |  ...  | Inst 9 | |Inst 10 |    |
|  |        | |        |       |        |       |        | | (max)  |    |
|  | tmux   | | tmux   |       | tmux   |       | tmux   | | tmux   |    |
|  |session | |session |       |session |       |session | |session |    |
|  +---+----+ +---+----+       +---+----+       +---+----+ +---+----+    |
|      |          |                |                |          |          |
|  +---+----+ +---+----+       +---+----+       +---+----+ +---+----+    |
|  |  git   | |  git   |       |  git   |       |  git   | |  git   |    |
|  |worktree| |worktree|       |worktree|       |worktree| |worktree|    |
|  |        | |        |       |        |       |        | |        |    |
|  |feature-| |feature-|       |bugfix- |       |refactor| |docs-   |    |
|  |  auth  | |payments|       |  123   |       |  api   | |update  |    |
|  +--------+ +--------+       +--------+       +--------+ +--------+    |
|                                                                          |
|   KEY CONSTRAINT: No inter-agent communication.                          |
|                   Human is the ONLY coordinator.                         |
|   HARD LIMIT: N &lt;= 10 (prevents resource exhaustion)                    |
|                                                                          |
+-------------------------------------------------------------------------+</pre>
      </div>

      <h3>Core Mechanism</h3>

      <p>Claude Squad is fundamentally different from Hub-and-Spoke: <strong>there is no orchestrating agent.</strong> The human is the brain; instances are hands.</p>

      <p><strong>Key Characteristics:</strong></p>
      <ol>
        <li><strong>Terminal Isolation:</strong> Each Claude instance runs in separate tmux session</li>
        <li><strong>Filesystem Isolation:</strong> Each instance gets its own git worktree (prevents file conflicts)</li>
        <li><strong>No Agent Communication:</strong> Instances never talk to each other</li>
        <li><strong>Human Context Switching:</strong> Operator attaches, instructs, observes, moves on</li>
        <li><strong>Hard Limit N=10:</strong> Prevents cognitive and resource exhaustion</li>
      </ol>

      <h3>Instance Setup Script</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>#!/bin/bash
# Create isolated Claude Squad instance

SESSION_NAME="cs_${1:-feature}"
BRANCH_NAME="${SESSION_NAME}-$(date +%s)"
WORKTREE_PATH="$(pwd)/worktrees/${SESSION_NAME}"

# Cleanup stale worktree if exists
git worktree remove -f "$WORKTREE_PATH" 2&gt;/dev/null || true

# Create fresh worktree with unique branch
git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH" HEAD

# Launch Claude in detached tmux session
tmux new-session -d -s "$SESSION_NAME" -c "$WORKTREE_PATH" "claude"

echo "Instance ready: tmux attach -t $SESSION_NAME"
echo "Worktree at: $WORKTREE_PATH"
echo "Branch: $BRANCH_NAME"</pre>
      </div>

      <h3>Trade-offs</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Benefit</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>No coordination complexity</td>
              <td>Human becomes bottleneck</td>
            </tr>
            <tr>
              <td>Full isolation (no conflict detection needed)</td>
              <td>Limited to 10 instances</td>
            </tr>
            <tr>
              <td>Human judgment at every decision point</td>
              <td>Cannot scale beyond single operator</td>
            </tr>
            <tr>
              <td>Simple infrastructure (tmux + worktrees)</td>
              <td>Sequential instance updates (polling)</td>
            </tr>
            <tr>
              <td>Predictable resource usage</td>
              <td>No automation of task routing</td>
            </tr>
            <tr>
              <td>No orchestrator cost</td>
              <td>Human attention is the scarce resource</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Gas Town Factory</h2>

      <p><strong>Source Attribution:</strong> Steve Yegge</p>

      <h3>Architecture Diagram</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------------------+
|                        GAS TOWN FACTORY                                  |
|                                                                          |
|  TOWN LEVEL (~/.gt/)                           RIG LEVEL (per-project)  |
|  ---------------------                         -------------------------|
|                                                                          |
|  +-------------------------+                                            |
|  |         MAYOR           |              +---------------------+       |
|  |  +-------------------+  |              |      WITNESS        |       |
|  |  | Chief coordinator |  |        +----&gt;| Per-rig supervisor  |       |
|  |  | Creates convoys   |--+--------+     | Monitors Polecats   |       |
|  |  | Routes work       |  |              | Health checks       |       |
|  |  +-------------------+  |              +----------+----------+       |
|  +-----------+-------------+                         |                  |
|              |                                       |                  |
|  +-----------v-------------+              +----------v----------+       |
|  |        DEACON           |              |      REFINERY       |       |
|  |  +-------------------+  |              | Merge queue proc.   |       |
|  |  | Watchdog beacon   |  |              | Conflict handling   |       |
|  |  | Receives heartbeats|&lt;-+-------------| Sequential merges   |       |
|  |  | Runs plugins      |  |              +----------+----------+       |
|  |  +-------------------+  |                         |                  |
|  +-----------+-------------+                         |                  |
|              |                            +----------v----------+       |
|  +-----------v-------------+              |      POLECATS       |       |
|  |         BOOT            |              | (Ephemeral workers) |       |
|  |  +-------------------+  |              | +-----+ +-----+    |       |
|  |  | Intelligent triage|  |              | | PC1 | | PC2 |... |       |
|  |  | Spawned every 3min|  |              | +--+--+ +--+--+    |       |
|  |  | Decides Deacon    |  |              |    |       |       |       |
|  |  | wake              |  |              |    v       v       |       |
|  |  +-------------------+  |              | [WORK]  [WORK]     |       |
|  +-----------+-------------+              |    |       |       |       |
|              |                            |    v       v       |       |
|  +-----------v-------------+              | [MERGE_READY]      |       |
|  |         DOGS            |              +---------------------+       |
|  |  +-------------------+  |                                            |
|  |  | Background batch  |  |              +---------------------+       |
|  |  | Long-running tasks|  |              |        CREW         |       |
|  |  | Fixed pool (5-20) |  |              | Human workspace     |       |
|  |  +-------------------+  |              | Long-lived context  |       |
|  +-------------------------+              | Manual development  |       |
|                                            +---------------------+       |
|                                                                          |
|  Communication Flow:                                                     |
|  Mayor --[convoy]---&gt; Witness --[sling]---&gt; Polecat                     |
|                          |                    |                          |
|                      [POLECAT_DONE]     [MERGE_READY]                   |
|                          |                    |                          |
|                          v                    v                          |
|                      Witness &lt;----------- Refinery                      |
|                                                                          |
+-------------------------------------------------------------------------+</pre>
      </div>

      <h3>Core Mechanism</h3>

      <p>Gas Town is a <strong>three-tier structure</strong> mirroring organizational hierarchy:</p>

      <p><strong>Town Level</strong> (Cross-project infrastructure):</p>
      <ul>
        <li><strong>Mayor:</strong> Chief coordinator. Creates convoys, routes work to rigs. Single entry point.</li>
        <li><strong>Deacon:</strong> Watchdog daemon. Receives heartbeats, runs plugins, monitors health.</li>
        <li><strong>Boot:</strong> Intelligent triage. Ephemeral, spawned every 3 minutes, decides if Deacon needs wake.</li>
        <li><strong>Dogs:</strong> Background batch workers. Long-running tasks, fixed pool (5-20).</li>
      </ul>

      <p><strong>Rig Level</strong> (Per-project workers):</p>
      <ul>
        <li><strong>Witness:</strong> Per-rig supervisor. Monitors Polecats, health checks, escalates issues.</li>
        <li><strong>Refinery:</strong> Merge queue processor. Serializes all merges, handles conflicts.</li>
        <li><strong>Polecat:</strong> Ephemeral task workers. One task then terminate. Fresh context per task.</li>
        <li><strong>Crew:</strong> Human workspace. Long-lived context for manual development.</li>
      </ul>

      <p><strong>GUPP (Gas Town Universal Propulsion Principle):</strong></p>
      <blockquote>
        "If there is work on your Hook, YOU MUST RUN IT."
      </blockquote>
      <p>Agents are explicitly forbidden from pausing for confirmation. This prevents deadlocks in multi-agent systems.</p>

      <h3>Trade-offs</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Benefit</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Maximum parallelism (10-30+ agents)</td>
              <td>Complex infrastructure setup</td>
            </tr>
            <tr>
              <td>Self-managing (factory learns)</td>
              <td>4-8 hours initial setup</td>
            </tr>
            <tr>
              <td>Specialized roles (Mayor, Dogs, Refinery)</td>
              <td>High daily cost ($50-200)</td>
            </tr>
            <tr>
              <td>Resilient (survives individual failures)</td>
              <td>Hard to debug across agents</td>
            </tr>
            <tr>
              <td>Git-backed persistence (survives crashes)</td>
              <td>tmux proficiency required</td>
            </tr>
            <tr>
              <td>Three-tier fault tolerance</td>
              <td>Single Mayor coordination bottleneck</td>
            </tr>
            <tr>
              <td>Horizontal scaling via multiple rigs</td>
              <td>Need Stage 7+ experience</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Architect/Editor Split (aider Pattern)</h2>

      <p><strong>Source Attribution:</strong> aider (paul-gauthier/aider - 40K+ GitHub stars)</p>

      <h3>Architecture Diagram</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+--------------------------------------------------------------+
|                 ARCHITECT/EDITOR SPLIT                        |
|            (aider's Breakthrough Innovation)                  |
|                                                               |
|  [User Request]                                               |
|       |                                                       |
|       v                                                       |
|  +--------------------+          +--------------------+      |
|  |     ARCHITECT      |          |       EDITOR       |      |
|  |                    |          |                    |      |
|  |  Model: o1-preview |          |  Model: DeepSeek   |      |
|  |       or Opus      |   Plan   |     or Sonnet      |      |
|  |                    |--------&gt;|                    |      |
|  |  RESPONSIBILITIES: |          |  RESPONSIBILITIES: |      |
|  |  - Analyze problem |          |  - Apply changes   |      |
|  |  - Plan approach   |          |  - Format code     |      |
|  |  - Identify files  |          |  - Handle syntax   |      |
|  |  - Design changes  |          |  - Verify edits    |      |
|  |                    |          |                    |      |
|  |  Output:           |          |  Output:           |      |
|  |  - Pseudocode      |          |  - Actual diffs    |      |
|  |  - File list       |          |  - Modified files  |      |
|  +--------------------+          +--------------------+      |
|       |                                                       |
|       v                                                       |
|  [Git Commit]  &lt;- Automatic with descriptive messages        |
|                                                               |
|  METRICS (aider benchmarks):                                  |
|  - 85% SWE-Bench solve rate (o1-preview + DeepSeek)          |
|  - 3x reduction in "lazy coding" via udiff format            |
|  - 88% "Singularity" rating (code written by aider itself)   |
+--------------------------------------------------------------+</pre>
      </div>

      <h3>Why This Works</h3>

      <ul>
        <li>Reasoning models (o1, Opus) excel at problem-solving but struggle with edit format compliance</li>
        <li>Traditional LLMs excel at formatting but may lack deep reasoning</li>
        <li>Separation allows each model to specialize in its strength</li>
        <li>Plan acts as an explicit contract between phases</li>
      </ul>

      <h3>aider CLI Usage</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>aider --architect                    # Enable architect mode
aider --sonnet --architect           # Claude as architect
aider --o1-preview --architect       # o1 as architect</pre>
      </div>

      <h2>Two-Phase Orchestration (Session Resumable)</h2>

      <p><strong>Source Attribution:</strong> BMAD-METHOD (30K+ stars), humanlayer/12-factor-agents</p>

      <h3>Architecture Diagram</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|              TWO-PHASE ORCHESTRATION                         |
|      (BMAD-METHOD + humanlayer/12-factor-agents pattern)    |
|                                                              |
|  PHASE 1: INITIALIZATION (One-time, expensive model)        |
|  =======================================                     |
|  +------------------+                                        |
|  | Initializer Agent |                                       |
|  |                   |                                       |
|  | Inputs:          |     Outputs:                          |
|  | - Requirements   |----&gt;- feature_list.json               |
|  | - Spec document  |     - Git repository initialized      |
|  | - Architecture   |     - Task manifest created           |
|  +------------------+     - Hyper-detailed story files      |
|                                                              |
|  -------------- SESSION BOUNDARY --------------              |
|                                                              |
|  PHASE 2+: EXECUTION (Resumable, cheaper model)             |
|  =======================================                     |
|  +------------------+                                        |
|  | Execution Agent  |                                        |
|  |                  |                                        |
|  | On each run:     |                                        |
|  | - Read manifest  |  &lt;- 12-factor: Stateless reducer     |
|  | - Find next task |     (thread, context) -&gt; new_thread  |
|  | - Implement      |                                        |
|  | - Update status  |                                        |
|  | - Commit         |                                        |
|  +------------------+                                        |
|                                                              |
|  RESUME CAPABILITY:                                          |
|  - Execution can stop/restart at any time                   |
|  - Picks up from last_completed in manifest                 |
|  - No context loss between sessions                         |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h3>Core Mechanism</h3>

      <p><strong>Intent:</strong> Separate task generation from task execution across sessions.</p>

      <p><strong>humanlayer/12-factor-agents Principles Applied:</strong></p>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Factor</th>
              <th>Application</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Factor 5: Unify Execution State</strong></td>
              <td>Single manifest as source of truth</td>
            </tr>
            <tr>
              <td><strong>Factor 6: Launch/Pause/Resume</strong></td>
              <td>ThreadStore serializes state; respects iteration limits</td>
            </tr>
            <tr>
              <td><strong>Factor 10: Small, Focused Agents</strong></td>
              <td>3-10 steps max per execution; bounded scope</td>
            </tr>
            <tr>
              <td><strong>Factor 12: Stateless Reducer</strong></td>
              <td>Pattern: <code>(thread, context) -&gt; new_thread</code></td>
            </tr>
          </tbody>
        </table>
      </div>

      <p><strong>BMAD-METHOD Story File Pattern (Zero Context Loss):</strong></p>

      <p>BMAD-METHOD's Scrum Master creates <strong>hyper-detailed story files</strong> that embed all context:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre># Story: Implement User Authentication

## Full Context
[PRD excerpt, architecture decisions, dependencies]

## Implementation Details
1. Create User model in src/models/user.ts
2. Email validation using zod schema
3. Password hashing with bcrypt (12 rounds)

## Architectural Guidance
- Use repository pattern for data access
- JWT tokens with 1-hour expiry
- Refresh tokens stored in httpOnly cookies

## Testing Criteria
- [ ] User model passes unit tests
- [ ] Email validation rejects invalid formats
- [ ] Passwords are never stored in plaintext</pre>
      </div>

      <p><strong>Why This Works (BMAD insight):</strong> Each story is a complete knowledge package. The developer agent receives full context - no ambiguity, no re-explaining project structure.</p>

      <p><strong>Manifest Schema:</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>{
  "metadata": {
    "version": "1.0",
    "created": "2026-01-18",
    "last_completed": 5
  },
  "features": [
    {
      "id": 1,
      "name": "User authentication",
      "status": "complete",
      "notes": "JWT implementation",
      "story_file": "stories/001-user-auth.md"
    },
    {
      "id": 2,
      "name": "Profile page",
      "status": "pending",
      "dependencies": [1],
      "story_file": "stories/002-profile-page.md"
    }
  ]
}</pre>
      </div>

      <p><strong>Resume Protocol (12-factor compliant):</strong></p>
      <ol>
        <li>Read <code>feature_list.json</code></li>
        <li>Find first feature where <code>status !== "complete"</code></li>
        <li>Check dependencies are satisfied</li>
        <li>Load story file for full context (BMAD pattern)</li>
        <li>Execute feature as stateless reducer (12-factor)</li>
        <li>Update manifest</li>
        <li>Commit both code and manifest</li>
        <li>Repeat or exit</li>
      </ol>

      <h3>BMAD Scale-Adaptive Levels</h3>

      <p>BMAD-METHOD automatically adjusts planning depth based on project complexity:</p>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Level</th>
              <th>Project Type</th>
              <th>Planning Time</th>
              <th>Output</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Level 0</td>
              <td>Bug fix</td>
              <td>~5 min</td>
              <td>Quick Spec only</td>
            </tr>
            <tr>
              <td>Level 1</td>
              <td>Simple feature (1-15 stories)</td>
              <td>~5 min</td>
              <td>Tech-spec only</td>
            </tr>
            <tr>
              <td>Level 2</td>
              <td>Product (10-50+ stories)</td>
              <td>~15 min</td>
              <td>PRD + Architecture + UX</td>
            </tr>
            <tr>
              <td>Level 3</td>
              <td>Platform</td>
              <td>Full</td>
              <td>Complete documentation</td>
            </tr>
            <tr>
              <td>Level 4</td>
              <td>Enterprise</td>
              <td>~30 min</td>
              <td>PRD + Arch + Security + DevOps</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3>Trade-offs</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Benefit</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Clean separation of concerns</td>
              <td>Two-phase coordination</td>
            </tr>
            <tr>
              <td>Resume-capable (12-factor F6)</td>
              <td>Manifest must be maintained</td>
            </tr>
            <tr>
              <td>Session-independent</td>
              <td>Upfront planning required</td>
            </tr>
            <tr>
              <td>Git-backed progress</td>
              <td>More files to manage</td>
            </tr>
            <tr>
              <td>Long-running project support</td>
              <td>Initial setup overhead</td>
            </tr>
            <tr>
              <td>Zero context loss (BMAD stories)</td>
              <td>Story file creation overhead</td>
            </tr>
            <tr>
              <td>Stateless reducer pattern</td>
              <td>Discipline required</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="checkpoint">
        <h4>Checkpoint: All Core Patterns</h4>
        <p>After studying all 8 patterns, you should be able to:</p>
        <ul>
          <li>Name all 8 patterns and their primary use case</li>
          <li>Identify which pattern matches your current project needs</li>
          <li>Explain the key mechanism of at least 3 patterns in depth</li>
          <li>Recognize the trade-offs for each pattern</li>
        </ul>
      </div>

      <!-- Footer navigation -->
      <div class="footer-nav">
        <a href="decision-framework.html" class="nav-prev">
          <span class="nav-direction">Previous</span>
          <span class="nav-title">Decision Framework</span>
        </a>
        <a href="enterprise-swarm.html" class="nav-next">
          <span class="nav-direction">Next</span>
          <span class="nav-title">Enterprise &amp; Swarm</span>
        </a>
      </div>

    </main>
  </div>

  <!-- Mobile toggle button -->
  <button class="sidebar-toggle" aria-label="Open navigation">&#9776;</button>

  <script src="../../js/sidebar.js"></script>
</body>
</html>
