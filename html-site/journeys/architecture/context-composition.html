<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Context &amp; Composition - Claude Code Knowledge Base</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/sidebar.css">
</head>
<body>
  <div class="page-with-sidebar">
    <!-- Sidebar navigation -->
    <nav class="sidebar">
      <button class="sidebar-close" aria-label="Close menu">&times;</button>
      <div class="sidebar-header">
        <h1 class="sidebar-title"><a href="../../index.html">Claude Code KB</a></h1>
      </div>
      <ul class="sidebar-nav">
        <!-- Architecture section (open when on architecture pages) -->
        <li class="nav-section open">
          <div class="nav-section-title">Architecture</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="decision-framework.html">Decision Framework</a></li>
            <li class="nav-page"><a href="core-patterns.html">Core Patterns</a></li>
            <li class="nav-page"><a href="enterprise-swarm.html">Enterprise &amp; Swarm</a></li>
            <li class="nav-page current"><a href="context-composition.html">Context &amp; Composition</a></li>
          </ul>
        </li>
        <!-- Implementation section -->
        <li class="nav-section">
          <div class="nav-section-title">Implementation</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../implementation/context-state.html">Context &amp; State</a></li>
            <li class="nav-page"><a href="../implementation/ralph-production.html">Ralph Production</a></li>
            <li class="nav-page"><a href="../implementation/hooks-enterprise.html">Hooks &amp; Enterprise</a></li>
          </ul>
        </li>
        <!-- Operations section -->
        <li class="nav-section">
          <div class="nav-section-title">Operations</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../operations/monitoring-cost.html">Monitoring &amp; Cost</a></li>
            <li class="nav-page"><a href="../operations/security-checklists.html">Security &amp; Checklists</a></li>
            <li class="nav-page"><a href="../operations/incident-response.html">Incident Response</a></li>
          </ul>
        </li>
        <!-- Mental Models section -->
        <li class="nav-section">
          <div class="nav-section-title">Mental Models</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../mental-models/core-models.html">Core Models</a></li>
            <li class="nav-page"><a href="../mental-models/advanced-models.html">Advanced Models</a></li>
            <li class="nav-page"><a href="../mental-models/practice-heuristics.html">Practice &amp; Heuristics</a></li>
          </ul>
        </li>
        <!-- Foundations section -->
        <li class="nav-section">
          <div class="nav-section-title">Foundations</div>
          <ul class="nav-subsections">
            <li class="nav-page"><a href="../foundations/invariants-reference.html">Invariants Reference</a></li>
          </ul>
        </li>
      </ul>
    </nav>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay"></div>

    <!-- Main content -->
    <main class="main-content">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href="../../index.html">Home</a>
        <span class="breadcrumb-separator">/</span>
        <a href="decision-framework.html">Architecture</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">Context &amp; Composition</span>
      </nav>

      <!-- Page meta -->
      <div class="page-meta">
        <span class="page-meta-item">~28 min read</span>
      </div>

      <h1>Context-Centric Architecture &amp; Pattern Composition</h1>

      <div class="context-box you-are-here">
        <h3>You Are Here</h3>
        <p><strong>What this covers:</strong> Context management for large codebases (FIC methodology), progressive skill loading, and the rules for combining architecture patterns effectively.</p>
        <p><strong>Key insight:</strong> On 300K+ LOC codebases, standard approaches fail. FIC enables "one week's work shipped in a single day."</p>
        <p><strong>Where this fits:</strong></p>
        <pre class="ascii-diagram">ARCHITECTURE JOURNEY
    |
    +-- Decision Framework (which pattern?)
    |
    +-- Core Patterns (basic patterns)
    |
    +-- Enterprise &amp; Swarm (scaling up)
    |
    +-- **YOU ARE HERE: Context &amp; Composition** (combining patterns)</pre>
      </div>

      <p>This page covers the Frequent Intentional Compaction (FIC) methodology for large codebases, progressive skill loading, and the rules for combining architecture patterns effectively.</p>

      <h2>Frequent Intentional Compaction (FIC)</h2>

      <p>On 300K+ LOC codebases, standard approaches fail: a single research phase consumes 50-80% of context, leaving no room for implementation reasoning. FIC solves this.</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|           FREQUENT INTENTIONAL COMPACTION (FIC)              |
|                                                              |
|  THE PROBLEM:                                                |
|  ===========                                                 |
|  On 300K+ LOC codebase:                                     |
|  - Single research phase: 50-80% context consumed           |
|  - No room left for implementation reasoning                |
|  - Results: shallow, mistake-prone implementations          |
|                                                              |
|  THE SOLUTION:                                               |
|  ============                                                |
|                                                              |
|  +-------------+    Compact    +-------------+    Compact   |
|  |  RESEARCH   |--------------&gt;|  PLANNING   |-------------&gt;|
|  |  (30-40%)   |  research.md  |  (20-30%)   |  plan.md     |
|  +-------------+               +-------------+              |
|                                                              |
|         |                                                    |
|         |                      +-----------------+           |
|         +---------------------&gt;| IMPLEMENTATION  |           |
|                research.md +   |  (60-70%)       |           |
|                plan.md         +-----------------+           |
|                                                              |
|  PHASE TARGETS:                                              |
|  ==============                                              |
|  | Phase         | Context Used | Output Size    |           |
|  |---------------|--------------|----------------|           |
|  | Research      | 30-40%       | 100-200 lines  |           |
|  | Planning      | 20-30%       | 150-250 lines  |           |
|  | Implementation| 60-70%       | Code changes   |           |
|  | NEVER exceed  | 80%          | -              |           |
|                                                              |
|  VALIDATED RESULT:                                           |
|  =================                                           |
|  "One week's work shipped in a single day"                  |
|  - HumanLayer team on 300K+ LOC Rust codebase               |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h3>Phase Boundary Protocol</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>1. COMPLETE phase work (stay within context target)
2. CREATE compacted artifact (research.md or plan.md)
3. CLEAR working context (/clear or new session)
4. START new phase with artifact as input

CRITICAL: The compacted artifact must capture ALL decisions.
         Information not in the artifact is LOST.</pre>
      </div>

      <h2>Context Utilization Monitoring</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|           CONTEXT UTILIZATION TARGETS                        |
|                                                              |
|  +------------------------------------------------------+   |
|  |                                                       |   |
|  |  0%        30%       50%       70%       100%        |   |
|  |  |          |         |         |          |         |   |
|  |  |----------|---------|---------|----------|         |   |
|  |  |   SAFE   |  IDEAL  | WARNING |  DANGER  |         |   |
|  |  |          |         |         |          |         |   |
|  |  Research   Planning  Implement  RESET!             |   |
|  |  30-40%     20-30%    60-70%    &gt;80%                 |   |
|  |                                                       |   |
|  +------------------------------------------------------+   |
|                                                              |
|  MONITORING COMMANDS:                                        |
|  - /context - Show current utilization                      |
|  - Watch for quality degradation                            |
|  - Reset at 70% if degradation observed                     |
|                                                              |
|  WARNING SIGNS:                                              |
|  - Agent ignores directives                                 |
|  - Repetitive/circular behavior                             |
|  - Hallucinations about code that doesn't exist            |
|  - Quality visibly degrading                                |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h2>Progressive Skill Loading (Three-Tier)</h2>

      <p>Minimize baseline context while maintaining capability access.</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>+-------------------------------------------------------------+
|           PROGRESSIVE SKILL LOADING                          |
|                                                              |
|  +-----------------------------------------------------+    |
|  |  TIER 1: METADATA (~100 words) - ALWAYS LOADED      |    |
|  |                                                      |    |
|  |  - Skill name                                        |    |
|  |  - Brief description                                 |    |
|  |  - Trigger phrases                                   |    |
|  |                                                      |    |
|  |  Example: "youtube-research: Fetch video transcripts|    |
|  |           and perform deep research analysis"       |    |
|  +------------------------+----------------------------+    |
|                           |                                  |
|                    ON TRIGGER                               |
|                           |                                  |
|  +------------------------v----------------------------+    |
|  |  TIER 2: SKILL.md (1-2K tokens) - LOADED ON DEMAND  |    |
|  |                                                      |    |
|  |  - Full instructions                                 |    |
|  |  - Procedures and workflows                         |    |
|  |  - Edge case handling                               |    |
|  |  - Error recovery patterns                          |    |
|  +------------------------+----------------------------+    |
|                           |                                  |
|                    IF NEEDED                                |
|                           |                                  |
|  +------------------------v----------------------------+    |
|  |  TIER 3: RESOURCES (variable) - LOADED ON DEMAND    |    |
|  |                                                      |    |
|  |  - Templates                                         |    |
|  |  - Examples                                          |    |
|  |  - Data files                                        |    |
|  |  - External documentation                           |    |
|  +-----------------------------------------------------+    |
|                                                              |
|  PHILOSOPHY: Context window is a "public good"              |
|              Minimize baseline overhead                      |
|                                                              |
+-------------------------------------------------------------+</pre>
      </div>

      <h2>Infrastructure-Level Context Management</h2>

      <p>Context management at scale requires infrastructure support from OpenCode, LiteLLM, and claude-flow.</p>

      <h3>OpenCode Context Tracking</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>// opencode_context.go - Context-aware editing with LSP feedback
func ContextAwareConfig() *context.Config {
    return &amp;context.Config{
        // Context budget per phase (FIC methodology)
        PhaseBudgets: map[string]float64{
            "research":       0.35,  // 30-40%
            "planning":       0.25,  // 20-30%
            "implementation": 0.65,  // 60-70%
        },

        // LSP integration for efficient file loading
        LSPOptimization: context.LSPConfig{
            LazySymbolLoading: true,
            CacheEnabled: true,
            CacheTTL:     5 * time.Minute,
        },

        // Automatic compaction triggers
        Compaction: context.CompactionConfig{
            WarnThreshold:  0.60,
            ForceThreshold: 0.80,
            AutoArtifact: true,
            ArtifactPath: ".opencode/artifacts/",
        },
    }
}</pre>
      </div>

      <h3>LiteLLM Semantic Caching for Context Efficiency</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre># litellm_context_cache.yaml
litellm_settings:
  cache: true
  cache_params:
    type: qdrant
    host: ${QDRANT_HOST}
    port: 6333

    # Semantic similarity for cache hits
    similarity_threshold: 0.93  # High threshold for code precision

    # Cache TTL aligned with FIC phases
    ttl: 3600  # 1 hour (typical research phase duration)

    # Namespace by phase for targeted invalidation
    namespace_key: "phase"

  # Cache analytics for optimization
  cache_analytics: true
  cache_hit_callback: "log_cache_hit"</pre>
      </div>

      <h3>Cache Impact on Context Budget</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Scenario</th>
              <th>Without Cache</th>
              <th>With Cache (30% hit)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Research queries</td>
              <td>50% context</td>
              <td>35% context</td>
            </tr>
            <tr>
              <td>Symbol lookups</td>
              <td>20% context</td>
              <td>14% context</td>
            </tr>
            <tr>
              <td>Pattern searches</td>
              <td>15% context</td>
              <td>10% context</td>
            </tr>
            <tr>
              <td><strong>Total Research</strong></td>
              <td><strong>85% (OVERFLOW)</strong></td>
              <td><strong>59% (OK)</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3>Context Efficiency Metrics</h3>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Tool</th>
              <th>Context Savings</th>
              <th>Mechanism</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>OpenCode LSP</td>
              <td>15-25%</td>
              <td>Lazy symbol loading, caching</td>
            </tr>
            <tr>
              <td>LiteLLM cache</td>
              <td>30%+</td>
              <td>Semantic query deduplication</td>
            </tr>
            <tr>
              <td>claude-flow artifacts</td>
              <td>20-40%</td>
              <td>Shared compacted context</td>
            </tr>
            <tr>
              <td>Combined stack</td>
              <td>50-60%</td>
              <td>Full integration</td>
            </tr>
          </tbody>
        </table>
      </div>

      <details class="troubleshoot">
        <summary>Context management problems</summary>
        <div class="troubleshoot-content">
          <table>
            <tr>
              <th>Symptom</th>
              <th>Cause</th>
              <th>Recovery</th>
            </tr>
            <tr>
              <td>Agent starts hallucinating code</td>
              <td>Context &gt;80% full</td>
              <td>Use /clear + /catchup immediately</td>
            </tr>
            <tr>
              <td>Implementation phase runs out of context</td>
              <td>Research phase consumed too much</td>
              <td>Revisit research.md; condense further</td>
            </tr>
            <tr>
              <td>research.md is 500+ lines</td>
              <td>Failed to compact</td>
              <td>Force 200-line limit; extract key decisions only</td>
            </tr>
            <tr>
              <td>Agent ignores recent instructions</td>
              <td>Older context crowding out new</td>
              <td>Reset with /clear; reload only essential context</td>
            </tr>
            <tr>
              <td>LiteLLM cache not helping</td>
              <td>similarity_threshold too high</td>
              <td>Lower from 0.93 to 0.90</td>
            </tr>
          </table>
        </div>
      </details>

      <h2>Pattern Composition Rules</h2>

      <p>Understanding how patterns combine is as important as understanding the patterns themselves. Some combinations amplify each other; others create chaos.</p>

      <h3>High-ROI Combinations (5/5 Recommended)</h3>

      <h4>1. Ralph + Hooks</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Ralph Loop
    |
    +-- Hooks (event automation)
            +-- PreToolUse: Rate limiting, security gates
            +-- PostToolUse: Auto-format, lint, notifications
            +-- SessionStart: Load context from git state
            +-- Stop: Completion detection, cleanup</pre>
      </div>

      <p><strong>Why:</strong> Ralph provides the iteration loop; Hooks add automation without consuming context. Hooks are stateless (don't pollute agent context).</p>

      <h4>2. CC Mirror + Git Worktrees</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Orchestrator
    |
    +-- Worker 1 (worktree-1/feature-a)
    +-- Worker 2 (worktree-2/feature-b)
    +-- Worker 3 (worktree-3/feature-c)</pre>
      </div>

      <p><strong>Why:</strong> True filesystem isolation. Workers can't accidentally conflict. Each has full checkout, shared git database.</p>

      <h4>3. progress.txt + AGENTS.md</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>progress.txt (per-run learning)
    |
    +-- Periodically promote to AGENTS.md (permanent patterns)</pre>
      </div>

      <p><strong>Why:</strong> Short-term memory (this run) compounds into long-term memory (all runs). Future sessions learn from past successes.</p>

      <h4>4. Ralph + Claude-Mem</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Ralph Loop (fresh context per iteration)
    |
    +-- Claude-Mem (semantic memory queries)
            +-- Inject relevant past knowledge at start of each iteration</pre>
      </div>

      <p><strong>Why:</strong> Fresh context eliminates rot; semantic search brings back relevant past knowledge. Best of both worlds.</p>

      <h4>5. FIC + Ralph Loop</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Ralph Loop (per iteration):
    |
    +-- FIC Phase Boundaries
            +-- Research Phase (30-40%) -&gt; research.md
            +-- Planning Phase (20-30%) -&gt; plan.md
            +-- Implementation Phase (60-70%) -&gt; code

UNLOCK: Enables Ralph on 300K+ LOC codebases</pre>
      </div>

      <p><strong>Why:</strong> Ralph provides iteration loop; FIC enables work on massive codebases.</p>

      <h4>6. LiteLLM Gateway + Any Pattern</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Any Architecture Pattern
    |
    +-- LiteLLM Proxy Layer
            +-- Provider failover (Anthropic -&gt; Bedrock -&gt; Vertex)
            +-- Budget enforcement
            +-- Semantic caching (30%+ hit rate)
            +-- Observability (Langfuse integration)

UNLOCK: Production-readiness for any pattern</pre>
      </div>

      <p><strong>Why:</strong> LiteLLM abstracts provider concerns from orchestration logic.</p>

      <h3>Medium-ROI Combinations (3-4/5 Recommended)</h3>

      <h4>7. Parallel Ralph + Human Merge</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Worktree 1 -- Ralph Loop --+
                           |
Worktree 2 -- Ralph Loop --+-- Human reviews, merges
                           |
Worktree 3 -- Ralph Loop --+</pre>
      </div>

      <p><strong>Why:</strong> Independent features run in parallel. Human handles merge conflicts (judgment required).</p>

      <h4>8. CC Mirror + Playwright MCP</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Orchestrator
    |
    +-- Implementation Worker (Sonnet)
    +-- Visual Verification Worker (Haiku + Playwright)
            +-- Screenshots, DOM assertions, E2E tests</pre>
      </div>

      <p><strong>Why:</strong> Verification worker can't break code (read-only + Playwright). Catches visual regressions.</p>

      <h4>9. Architect/Editor + CC Mirror (aider pattern)</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>CC Mirror:
    |
    +-- Architect Worker (Opus): Plan approach using aider's reasoning phase
    +-- Editor Worker (DeepSeek/Sonnet): Implement using aider edit formats

RESULT: 85% SWE-Bench solve rate, 3x less lazy coding</pre>
      </div>

      <p><strong>Why:</strong> CC Mirror provides orchestration; aider's Architect/Editor split optimizes per-task quality.</p>

      <h4>10. BMAD-METHOD + Any Claude Code Pattern</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>BMAD-METHOD (Process Layer)
    |
    +-- Analyst (Mary): Requirements gathering
    +-- PM (John): PRD creation
    +-- Architect: System design
    +-- Scrum Master: Hyper-detailed story files
           |
           v
Any Claude Code Pattern (Execution Layer)
    +-- Ralph Loop, CC Mirror, or Gas Town
    +-- Developer (James): Story implementation
    +-- QA (Quinn): Validation

RESULT: Zero context loss + structured development lifecycle</pre>
      </div>

      <p><strong>Why:</strong> BMAD-METHOD provides the "what/when/who/why"; Claude Code patterns provide the "how."</p>

      <h4>11. Gas Town + SONA</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Gas Town Factory (with SONA Learning)
    |
    +-- Mayor (with Q-Learning router)
    +-- Polecats (as SONA agents)
    +-- ReasoningBank (cross-agent learning)

RESULT: Self-improving factory</pre>
      </div>

      <p><strong>Why:</strong> Gas Town provides structure; SONA provides learning.</p>

      <h4>12. BMAD-METHOD + Any Claude Code Pattern (Extended)</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>BMAD-METHOD (Process Layer)
    |
    +-- Analyst (Mary): Requirements gathering
    +-- PM (John): PRD creation
    +-- Architect: System design
    +-- Scrum Master: Hyper-detailed story files
           |
           v
Any Claude Code Pattern (Execution Layer)
    +-- Ralph Loop, CC Mirror, or Gas Town
    +-- Developer (James): Story implementation
    +-- QA (Quinn): Validation
    +-- TEA: Test strategy

RESULT: Zero context loss + structured development lifecycle</pre>
      </div>

      <p><strong>Why:</strong> BMAD-METHOD provides the "what/when/who/why"; Claude Code patterns provide the "how." BMAD's 21-agent QA layer ensures every phase has specialized oversight.</p>

      <h4>13. humanlayer/12-factor + Ralph Loop</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Ralph Loop (with 12-factor principles):
    |
    +-- Factor 5: Unified state in prd.json
    +-- Factor 6: Launch/Pause/Resume via manifest
    +-- Factor 7: Contact Humans as tool calls
    +-- Factor 10: Small focused iterations (3-10 steps)
    +-- Factor 12: Stateless reducer pattern

RESULT: Production-ready autonomous loop with HITL gates</pre>
      </div>

      <p><strong>Why:</strong> The 12 factors transform Ralph from a developer tool into a production-grade agent pattern. Factor 7 (Contact Humans with Tool Calls) adds missing HITL capabilities.</p>

      <h4>14. aider + BMAD-METHOD</h4>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>BMAD-METHOD Planning Phase
    |
    +-- Analyst + PM + Architect (expensive model)
    +-- Scrum Master creates story files
           |
           v
aider Implementation Phase
    +-- Architect mode (o1/Opus): Reason about story
    +-- Editor mode (DeepSeek/Sonnet): Implement precisely
    +-- Repository map for codebase context
    +-- Automatic git commits

RESULT: Zero context loss + 85% SWE-Bench quality + cost optimization</pre>
      </div>

      <p><strong>Why:</strong> BMAD-METHOD's hyper-detailed stories solve aider's context problem. aider's dual-model architecture solves BMAD's execution quality problem.</p>

      <h3>What to NEVER Combine (Anti-Patterns)</h3>

      <h4>CATASTROPHIC (System Failure)</h4>

      <p><strong>1. CC Mirror + Gas Town (Dual Orchestrators)</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>!! NEVER: Two orchestrators in same system
    Orchestrator A (CC Mirror)
                X
    Mayor (Gas Town)</pre>
      </div>

      <p><strong>Why:</strong> Competing task graphs, conflicting work distribution, context explosion. Pick ONE coordination strategy.</p>

      <p><strong>2. Workers Spawning Workers (Recursive Spawning)</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>!! NEVER: Recursive agent spawning
    Worker 1
        +-- Spawns Worker 1.1
                +-- Spawns Worker 1.1.1
                        +-- ... (infinite)</pre>
      </div>

      <p><strong>Why:</strong> Uncontrolled cost explosion, context loss at each level, coordination impossible. Workers NEVER spawn.</p>

      <p><strong>3. Orchestrator Using Tools Directly</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>!! NEVER: Orchestrator executes code
    Orchestrator
        +-- Bash: npm install
        +-- Write: src/feature.ts</pre>
      </div>

      <p><strong>Why:</strong> Breaks role separation. Orchestrator context bloats. Can't parallelize if orchestrator is busy executing.</p>

      <p><strong>4. FIC Without Handoffs</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>!! NEVER: Use FIC phases without compaction artifacts

    Research Phase
            X
    Implementation Phase  &lt;- Lost all research context!

FIX: ALWAYS create research.md/plan.md at phase boundaries</pre>
      </div>

      <p><strong>Why:</strong> Context is cleared between phases. Without artifacts, all reasoning is lost.</p>

      <p><strong>5. Enterprise Stack Without Budget Controls</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>!! NEVER: 64+ agents without LiteLLM budget enforcement

    Queen spawns 64 agents
            X
    No cost tracking -&gt; $10,000+ surprise bill

FIX: ALWAYS configure per-agent and global budgets</pre>
      </div>

      <p><strong>Why:</strong> Agent storms can exhaust budgets in hours.</p>

      <h4>SEVERE (Degraded Performance)</h4>

      <p><strong>6. Deep Subagent Nesting (&gt;3 levels)</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>!! AVOID: More than 3 levels deep
    Agent 1
        +-- Agent 2
                +-- Agent 3
                        +-- Agent 4 (context loss severe)</pre>
      </div>

      <p><strong>Why:</strong> Each level loses context. By level 4, original intent is distorted. Cost scales exponentially.</p>

      <p><strong>7. Long Sessions + Multi-Agent</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>!! AVOID: Extended sessions with parallel agents
    Agent 1 (8 hours continuous)
            X
    Agent 2 (8 hours continuous)</pre>
      </div>

      <p><strong>Why:</strong> Context rot affects all agents. Quality degrades unpredictably. Use fresh context loops instead.</p>

      <p><strong>8. No Iteration Limits</strong></p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>!! AVOID: Unbounded loops
    while true; do
        claude-code
    done</pre>
      </div>

      <p><strong>Why:</strong> Runaway costs, no stuck detection. Always set MAX_ITERATIONS.</p>

      <h2>The Graduation Path</h2>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>START: Single Claude Code session
    |
    | TRIGGER: "I need to walk away while it runs"
    v
LEVEL 2: Ralph Wiggum Loop
    |
    | TRIGGER: "I have 2-3 independent features"
    v
LEVEL 3: Parallel Ralph (Worktrees)
    |
    | TRIGGER: "I need human judgment at each step"
    v
LEVEL 4: Claude Squad (Human-Mediated)
    |
    | TRIGGER: "I need automated orchestration"
    v
LEVEL 5: CC Mirror (Hub-and-Spoke)
    |
    | TRIGGER: "I need 10+ agents, specialized roles"
    v
LEVEL 7: Gas Town (Factory)
    |
    | TRIGGER: "I need 30+ agents with self-learning"
    v
LEVEL 8: SONA Swarm
    |
    | TRIGGER: "I need compliance, multi-provider"
    v
LEVEL 9: Enterprise Stack</pre>
      </div>

      <h2>Composition Operators</h2>

      <p>Use these operators to describe pattern combinations:</p>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Sequential (-&gt;)     A completes fully, then B starts
                   Example: Architecture -&gt; Implementation -&gt; Tests

Parallel (||)       A and B execute simultaneously
                   Example: Frontend || Backend || Tests

Nested ({})        A contains B; B operates within A's context
                   Example: Ralph { Adversarial per iteration }

Conditional (?:)   If X then A else B
                   Example: Tests pass ? commit : debug

Loop (while)       Repeat until condition
                   Example: while !complete { iterate }

Fork-Join (&gt;&gt;&lt;&lt;)   Split into parallel, merge with strategy
                   Example: &gt;&gt; (Worker1, Worker2, Worker3) &lt;&lt; git merge</pre>
      </div>

      <h3>Example: Full Production Stack</h3>

      <div class="code-block">
        <button class="copy-btn">Copy</button>
        <pre>Ralph {
    while !prd.all_pass {
        story = next_incomplete(prd)

        result = CC_Mirror {
            architect: Opus -&gt; design
            &gt;&gt; (
                implementer: Sonnet -&gt; code,
                tester: Haiku -&gt; tests
            ) &lt;&lt; merge_worktrees

            adversarial: Sonnet -&gt; break_it ? fix : pass
        }

        verify ? mark_pass : mark_fail
    }
}</pre>
      </div>

      <h2>The humanlayer/12-factor-agents 12 Factors</h2>

      <p>Production-grade agent principles that apply to all patterns:</p>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Factor</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>Natural Language to Tool Calls</td>
              <td>Convert intent to structured JSON</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Own Your Prompts</td>
              <td>Custom templates, no vendor lock-in</td>
            </tr>
            <tr>
              <td>3</td>
              <td>Own Your Context Window</td>
              <td>Custom serialization, smaller prompts</td>
            </tr>
            <tr>
              <td>4</td>
              <td>Tools Are Structured Outputs</td>
              <td>Machine-readable JSON outputs</td>
            </tr>
            <tr>
              <td>5</td>
              <td>Unify Execution/Business State</td>
              <td>Single source of truth (Thread)</td>
            </tr>
            <tr>
              <td>6</td>
              <td>Launch/Pause/Resume</td>
              <td>Simple APIs for durable workflows</td>
            </tr>
            <tr>
              <td>7</td>
              <td>Contact Humans with Tool Calls</td>
              <td>HITL as standard tool call</td>
            </tr>
            <tr>
              <td>8</td>
              <td>Own Your Control Flow</td>
              <td>Explicit switch logic, termination</td>
            </tr>
            <tr>
              <td>9</td>
              <td>Compact Errors into Context</td>
              <td>Structured error condensation</td>
            </tr>
            <tr>
              <td>10</td>
              <td>Small, Focused Agents</td>
              <td>3-10 steps max, bounded scope</td>
            </tr>
            <tr>
              <td>11</td>
              <td>Trigger From Anywhere</td>
              <td>CLI, HTTP, Slack, webhooks</td>
            </tr>
            <tr>
              <td>12</td>
              <td>Stateless Reducer</td>
              <td><code>(thread, context) -> new_thread</code></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>Quick Reference: FIC Phase Targets</h2>

      <div class="decision-table">
        <table>
          <thead>
            <tr>
              <th>Phase</th>
              <th>Context Target</th>
              <th>Output</th>
              <th>Max Lines</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Research</td>
              <td>30-40%</td>
              <td>research.md</td>
              <td>200</td>
            </tr>
            <tr>
              <td>Planning</td>
              <td>20-30%</td>
              <td>plan.md</td>
              <td>250</td>
            </tr>
            <tr>
              <td>Implementation</td>
              <td>60-70%</td>
              <td>Code</td>
              <td>-</td>
            </tr>
            <tr class="warning">
              <td><strong>NEVER exceed</strong></td>
              <td><strong>80%</strong></td>
              <td>-</td>
              <td>-</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Footer navigation -->
      <div class="footer-nav">
        <a href="enterprise-swarm.html" class="nav-prev">
          <span class="nav-direction">Previous</span>
          <span class="nav-title">Enterprise &amp; Swarm</span>
        </a>
        <a href="../implementation/context-state.html" class="nav-next">
          <span class="nav-direction">Next</span>
          <span class="nav-title">Context &amp; State (Implementation)</span>
        </a>
      </div>

    </main>
  </div>

  <!-- Mobile toggle button -->
  <button class="sidebar-toggle" aria-label="Open navigation">&#9776;</button>

  <script src="../../js/sidebar.js"></script>
</body>
</html>
