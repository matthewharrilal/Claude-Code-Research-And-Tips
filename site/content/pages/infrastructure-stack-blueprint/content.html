
<!--
═══════════════════════════════════════════════════════════════════════════════
INLINE THREADING HEADER — Phase 2B
File: docs-spa/content/pages/infrastructure-stack-blueprint/content.html
Tier: C | Batch: 12 | Generated: 2026-02-06

1. WHY THIS EXISTS
Rendered HTML content page for the infrastructure-stack-blueprint synthesis document.

3. STATUS
ACTIVE

5. BUILT ON
Extracted from synthesis/infrastructure-stack-blueprint.md by content extraction scripts.

8. CONSUMED BY
docs-spa/app/(docs)/synthesis/infrastructure-stack-blueprint/page.tsx renders this content via dangerouslySetInnerHTML.

═══════════════════════════════════════════════════════════════════════════════
END INLINE THREADING HEADER
═══════════════════════════════════════════════════════════════════════════════
-->

      <!-- Section 1: ESSENCE -->
      <section id="essence" data-activity="essence">
        <div class="essence-box">
          <div class="essence-label">Essence (15 words)</div>
          <div class="essence-text">Roughneck provisions cloud VMs, Station provides NATS messaging, Agentic-Flow runs production-grade agent swarms.</div>
        </div>
      </section>

      <!-- Section 2: CORE ABSTRACTION -->
      <section id="core-abstraction" data-activity="core">
        <h2 class="section-title">
          <span class="section-number">2</span>
          The 5-Layer Stack
        </h2>

        <div class="core-abstraction">
          <div class="core-philosophy">"Each layer has one job. Compose them for your scale."</div>
          <div class="core-anchor">The complete path from cloud provider to user interface.</div>
        </div>

        <div class="layer-diagram">
          <pre>+=====================================================================================+
|                    THE COMPLETE INFRASTRUCTURE STACK                                 |
+=====================================================================================+
|                                                                                      |
|   LAYER 5: USER INTERFACES                                                           |
|   +-------------------------------------------------------------------------+        |
|   |  Kimaki (Discord) | Web UIs | Terminal CLI | Mobile Apps                |        |
|   |  Human interaction layer - how users talk to agents                     |        |
|   +-------------------------------------------------------------------------+        |
|                                       |                                              |
|   LAYER 4: ORCHESTRATION PLATFORM                                                    |
|   +-------------------------------------------------------------------------+        |
|   |  Gas Town (Mayor, Dogs, Refinery) | Agentic-Flow Swarms                 |        |
|   |  Agent coordination, task distribution, workflow management              |        |
|   +-------------------------------------------------------------------------+        |
|                                       |                                              |
|   LAYER 3: MESSAGING BACKBONE                                                        |
|   +-------------------------------------------------------------------------+        |
|   |  Station NATS | JetStream Persistence | Lattice Mesh Network            |        |
|   |  Pub/sub messaging, service discovery, event sourcing                    |        |
|   +-------------------------------------------------------------------------+        |
|                                       |                                              |
|   LAYER 2: COMPUTE INFRASTRUCTURE                                                    |
|   +-------------------------------------------------------------------------+        |
|   |  Roughneck Terraform | Ansible Configuration | Docker Containers        |        |
|   |  IaC provisioning, multi-cloud abstraction, environment isolation        |        |
|   +-------------------------------------------------------------------------+        |
|                                       |                                              |
|   LAYER 1: CLOUD PROVIDERS                                                           |
|   +-------------------------------------------------------------------------+        |
|   |  Hetzner (~$4-8/mo) | DigitalOcean (~$24/mo) | AWS EC2 (~$30/mo)        |        |
|   |  The raw compute resources where everything runs                         |        |
|   +-------------------------------------------------------------------------+        |
|                                                                                      |
+=====================================================================================+
          </pre>
        </div>

        <h3 class="font-semibold text-lg mb-4">Cloud Provider Pricing</h3>

        <div class="provider-grid">
          <div class="provider-card">
            <div class="provider-name">Hetzner Cloud</div>
            <div class="provider-price">~$4/mo</div>
            <div class="provider-specs">2 vCPU, 4GB RAM (cx21)<br>Best for: Budget, EU-based</div>
          </div>
          <div class="provider-card">
            <div class="provider-name">DigitalOcean</div>
            <div class="provider-price">~$24/mo</div>
            <div class="provider-specs">2 vCPU, 4GB RAM<br>Best for: Simplicity</div>
          </div>
          <div class="provider-card">
            <div class="provider-name">AWS EC2</div>
            <div class="provider-price">~$30/mo</div>
            <div class="provider-specs">2 vCPU, 4GB RAM (t3.medium)<br>Best for: Enterprise</div>
          </div>
        </div>

        <p class="text-text-secondary mb-6">
          This stack integrates four major tools: <strong>Roughneck</strong> for infrastructure provisioning, <strong>Station</strong> for NATS messaging, <strong>Agentic-Flow</strong> for production agent orchestration, and <strong>Kimaki</strong> for Discord interface. Each layer is optional - use what you need.
        </p>
      </section>

      <!-- Section 3: DESIGN DECISIONS -->
      <section id="why-roughneck" data-activity="decisions">
        <h2 class="section-title">
          <span class="section-number">3</span>
          Design Decisions
        </h2>

        <div class="decision-box">
          <div class="decision-why">WHY ROUGHNECK?</div>
          <div class="decision-reasoning">
            Roughneck is infrastructure-as-code that provisions cloud VMs preconfigured with Gas Town, Beads, and AI coding assistants. Think of it as the construction company that builds the factory where your agents work.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              One command (<code>./roughneck new my-factory</code>) gives you a fully configured VM with Docker, Claude Code CLI, Gas Town, and browser IDE. No manual setup required.
            </div>
          </div>
        </div>

        <div class="decision-box" id="why-nats">
          <div class="decision-why">WHY NATS?</div>
          <div class="decision-reasoning">
            NATS isn't just "another message queue." It's purpose-built for sub-millisecond latency, built-in clustering, and JetStream persistence with exactly-once semantics. Perfect for real-time agent coordination.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              Agents across multiple machines can coordinate with sub-millisecond latency. JetStream gives you audit trails and exactly-once delivery without external databases.
            </div>
          </div>
        </div>

        <div class="decision-box" id="why-isolation">
          <div class="decision-why">WHY DEPLOYMENT ISOLATION?</div>
          <div class="decision-reasoning">
            Each Roughneck deployment is fully isolated with independent Terraform state, SSH keys, and inventory. Updates to Roughneck itself won't affect existing deployments.
          </div>
          <div class="decision-implication">
            <div class="decision-implication-label">What this means for you</div>
            <div class="text-text-secondary text-sm">
              You can run <code>gastown-prod</code>, <code>gastown-dev</code>, and <code>gastown-eu</code> simultaneously without state conflicts. Destroy one without touching others.
            </div>
          </div>
        </div>
      </section>

      <!-- Section 4: ROUGHNECK -->
      <section id="roughneck" data-activity="roughneck">
        <h2 class="section-title">
          <span class="section-number">4</span>
          Roughneck Provisioning
        </h2>

        <p class="text-text-secondary mb-6">
          Roughneck combines Terraform for cloud provisioning with Ansible for configuration management. The Python CLI orchestrates both.
        </p>

        <h3 class="font-semibold text-lg mb-4">CLI Commands Reference</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre><span class="comment"># Deployment lifecycle</span>
./roughneck new [name]          <span class="comment"># Create new deployment (interactive)</span>
./roughneck deploy [name]       <span class="comment"># Deploy existing configuration</span>
./roughneck destroy [name]      <span class="comment"># Tear down infrastructure</span>
./roughneck list                <span class="comment"># Show all deployments</span>

<span class="comment"># Management</span>
./roughneck provision [name]    <span class="comment"># Re-run Ansible (no Terraform)</span>
./roughneck update [name]       <span class="comment"># Update packages/tools</span>
./roughneck validate [name]     <span class="comment"># Run health checks</span>
./roughneck ssh [name]          <span class="comment"># SSH into deployment</span>

<span class="comment"># Credentials</span>
./roughneck credentials         <span class="comment"># Manage stored credentials</span></pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="roughneck-files">Directory Structure</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre>roughneck/
+-- roughneck                    <span class="comment"># Main Python CLI entrypoint</span>
+-- lib/                         <span class="comment"># Python library modules</span>
|   +-- cli.py                   <span class="comment"># CLI utilities</span>
|   +-- terraform.py             <span class="comment"># Terraform/OpenTofu operations</span>
|   +-- ansible.py               <span class="comment"># Ansible playbook execution</span>
|
+-- terraform/
|   +-- modules/
|   |   +-- hetzner/             <span class="comment"># Hetzner Cloud module</span>
|   |   +-- aws/                 <span class="comment"># AWS EC2 module</span>
|   |   +-- digitalocean/        <span class="comment"># DigitalOcean module</span>
|
+-- ansible/
|   +-- playbook.yml             <span class="comment"># Main deployment playbook</span>
|   +-- roles/
|       +-- common/              <span class="comment"># Base system setup</span>
|       +-- docker/              <span class="comment"># Docker installation</span>
|       +-- claude/              <span class="comment"># Claude Code CLI</span>
|       +-- roughneck/           <span class="comment"># Gas Town installation</span>
|
+-- deployments/                 <span class="comment"># Per-deployment isolation</span>
    +-- &lt;name&gt;/
        +-- terraform.tfvars     <span class="comment"># Deployment configuration</span>
        +-- terraform.tfstate    <span class="comment"># Infrastructure state</span>
        +-- inventory.ini        <span class="comment"># Ansible inventory</span>
        +-- generated_key        <span class="comment"># SSH keypair</span></pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8">Configuration (terraform.tfvars)</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre><span class="comment"># deployments/&lt;name&gt;/terraform.tfvars</span>

<span class="comment"># Core settings</span>
project_name = <span class="string">"my-gastown"</span>
provider = <span class="string">"hetzner"</span>
region = <span class="string">"fsn1"</span>
instance_type = <span class="string">"cx21"</span>

<span class="comment"># AI Assistants</span>
enable_claude = <span class="keyword">true</span>
enable_codex = <span class="keyword">true</span>

<span class="comment"># Gas Town Ecosystem</span>
enable_gastown = <span class="keyword">true</span>          <span class="comment"># Install Gas Town (gt CLI)</span>
enable_beads = <span class="keyword">true</span>            <span class="comment"># Install Beads (bd CLI)</span>
enable_systemd_services = <span class="keyword">true</span> <span class="comment"># Start Mayor/Deacon on boot</span></pre>
        </div>
      </section>

      <!-- Section 5: NATS/STATION -->
      <section id="nats" data-activity="nats">
        <h2 class="section-title">
          <span class="section-number">5</span>
          Station NATS Backbone
        </h2>

        <p class="text-text-secondary mb-6">
          Station is an open-source runtime that uses NATS as the coordination backbone. The Lattice mesh network enables station-to-station discovery, agent manifest sharing, and remote agent invocation.
        </p>

        <h3 class="font-semibold text-lg mb-4">Three Operating Modes</h3>

        <table class="port-table">
          <thead>
            <tr>
              <th>Mode</th>
              <th>Command</th>
              <th>Use Case</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Standalone</strong></td>
              <td><code>stn serve</code></td>
              <td>Development, testing (no mesh)</td>
            </tr>
            <tr>
              <td><strong>Orchestrator</strong></td>
              <td><code>stn serve --orchestration</code></td>
              <td>Runs embedded NATS (port 4222)</td>
            </tr>
            <tr>
              <td><strong>Member</strong></td>
              <td><code>stn serve --lattice &lt;url&gt;</code></td>
              <td>Joins orchestrator mesh</td>
            </tr>
          </tbody>
        </table>

        <h3 class="font-semibold text-lg mb-4 mt-8" id="nats-subjects">NATS Subject Hierarchy</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre>lattice.
+-- presence.
|   +-- announce        <span class="comment"># Station startup</span>
|   +-- heartbeat       <span class="comment"># Health signals</span>
|   +-- goodbye         <span class="comment"># Graceful shutdown</span>
+-- station.{id}.
|   +-- agent.invoke    <span class="comment"># Agent invocation</span>
+-- work.
|   +-- {stationID}.assign  <span class="comment"># Work assignment</span>
|   +-- {workID}.response   <span class="comment"># Work responses</span>
+-- events.
    +-- StationJoined
    +-- StationLeft
    +-- AgentRegistered
    +-- WorkAssigned
    +-- WorkCompleted</pre>
        </div>

        <h3 class="font-semibold text-lg mb-4 mt-8">Key Ports</h3>

        <table class="port-table">
          <thead>
            <tr>
              <th>Port</th>
              <th>Service</th>
              <th>Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>4222</code></td>
              <td>NATS</td>
              <td>Client connections</td>
            </tr>
            <tr>
              <td><code>8222</code></td>
              <td>NATS HTTP</td>
              <td>Monitoring endpoints</td>
            </tr>
            <tr>
              <td><code>8585</code></td>
              <td>Station Web UI</td>
              <td>Configuration interface</td>
            </tr>
            <tr>
              <td><code>8586</code></td>
              <td>MCP Server</td>
              <td>Primary tool endpoint</td>
            </tr>
            <tr>
              <td><code>16686</code></td>
              <td>Jaeger UI</td>
              <td>Distributed tracing</td>
            </tr>
          </tbody>
        </table>

        <h3 class="font-semibold text-lg mb-4 mt-8">Quick Start</h3>

        <div class="code-block">
          <button class="copy-btn" onclick="copyCodeBlock(this)">
            <i data-lucide="copy" class="w-3 h-3"></i>
            Copy
          </button>
          <pre><span class="comment"># Install Station CLI</span>
curl -fsSL https://raw.githubusercontent.com/cloudshipai/station/main/install.sh | bash

<span class="comment"># Initialize with provider</span>
<span class="keyword">export</span> ANTHROPIC_API_KEY=<span class="string">"sk-ant-api03-..."</span>
stn init --provider anthropic

<span class="comment"># Start services</span>
stn jaeger up           <span class="comment"># Tracing backend</span>
stn up                  <span class="comment"># Station server</span>
stn status              <span class="comment"># Verify status</span>

<span class="comment"># Orchestrator mode (run embedded NATS)</span>
stn serve --orchestration

<span class="comment"># Member mode (connect to orchestrator)</span>
stn serve --lattice nats://orchestrator:4222</pre>
        </div>
      </section>

      <!-- Section 6: GOTCHAS -->
      <section id="gotchas" data-activity="gotchas">
        <h2 class="section-title">
          <span class="section-number">6</span>
          Gotchas
        </h2>

        <p class="text-text-secondary mb-6">
          Real problems you'll hit with infrastructure deployment:
        </p>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Terraform init fails with provider errors
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> "Failed to query available provider packages"</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Network issues or outdated Terraform version</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Try OpenTofu: <code>brew install opentofu</code>. Clear cache: <code>rm -rf .terraform*</code></div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Ansible connection refused
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> "UNREACHABLE! Failed to connect to host"</div>
          <div class="gotcha-detail"><strong>Cause:</strong> VM still booting or firewall blocking SSH</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Wait 2-3 minutes for VM boot. Verify: <code>ssh -i deployments/&lt;name&gt;/generated_key root@&lt;ip&gt;</code></div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            NATS connection refused
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> "failed to connect to NATS: connection refused"</div>
          <div class="gotcha-detail"><strong>Cause:</strong> Orchestrator not running or wrong URL format</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Verify orchestrator: <code>stn status</code>. Check port: <code>nc -zv localhost 4222</code>. Use <code>nats://</code> not <code>http://</code></div>
        </div>

        <div class="gotcha-box">
          <div class="gotcha-title">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Gas Town not found after deployment
          </div>
          <div class="gotcha-detail"><strong>Symptom:</strong> <code>gt: command not found</code></div>
          <div class="gotcha-detail"><strong>Cause:</strong> PATH not updated or feature flag disabled</div>
          <div class="gotcha-detail"><strong>Fix:</strong> Run <code>source ~/.bashrc</code>. Check <code>enable_gastown = true</code> in terraform.tfvars</div>
        </div>
      </section>

      <!-- Section 7: WHAT'S HARD -->
      <section id="hard" data-activity="hard">
        <h2 class="section-title">
          <span class="section-number">7</span>
          What's Hard
        </h2>

        <p class="text-text-secondary mb-6">
          Fundamental tensions in infrastructure deployment:
        </p>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Cost vs. Performance Trade-off
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Hetzner is 6x cheaper than AWS but lacks enterprise integrations. AWS has everything but costs $30/mo for minimal specs.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> Use Hetzner for development/staging, AWS for production with enterprise requirements. Use geographic cost optimization - EU workloads on Hetzner, US workloads on AWS.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            State Management Complexity
          </div>
          <div class="hard-detail"><strong>The tension:</strong> Terraform state must be stored somewhere. Local state is simple but not shareable. Remote state (S3, etc.) adds complexity and cost.</div>
          <div class="hard-detail"><strong>Mitigation:</strong> For solo developers, local state in <code>deployments/&lt;name&gt;/</code> is fine. For teams, set up S3 backend with DynamoDB locking before first deployment.</div>
        </div>

        <div class="hard-box">
          <div class="hard-title">
            <i data-lucide="flame" class="w-4 h-4"></i>
            Multi-Region Coordination
          </div>
          <div class="hard-detail"><strong>The tension:</strong> NATS is fast locally but adds latency across regions. Do you run one orchestrator or multiple?</div>
          <div class="hard-detail"><strong>Mitigation:</strong> For most use cases, single orchestrator in your primary region is sufficient. Only distribute if you have strict latency requirements (&lt;50ms) for geographically distributed agents.</div>
        </div>
      </section>

      <!-- Section 8: WHEN TO USE -->
      <section id="when" data-activity="when">
        <h2 class="section-title">
          <span class="section-number">8</span>
          When to Use / When Not
        </h2>

        <div class="when-grid">
          <div class="when-use">
            <div class="when-title">
              <i data-lucide="check" class="w-5 h-5"></i>
              USE THIS STACK WHEN
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Moving from laptop to cloud deployment</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Need multiple isolated environments (prod/dev/staging)</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Running Gas Town or Ralph loops overnight</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Need real-time agent coordination across machines</span>
            </div>
            <div class="when-item">
              <i data-lucide="check" class="w-4 h-4 flex-shrink-0"></i>
              <span>Want team collaboration via Discord</span>
            </div>
          </div>

          <div class="when-not">
            <div class="when-title">
              <i data-lucide="x" class="w-5 h-5"></i>
              DON'T USE WHEN
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Single developer, single machine is sufficient</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Zero infrastructure budget (stay local)</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Just learning Claude Code basics</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Air-gapped environments with no cloud access</span>
            </div>
            <div class="when-item">
              <i data-lucide="x" class="w-4 h-4 flex-shrink-0"></i>
              <span>Need sub-10ms latency (use local deployment)</span>
            </div>
          </div>
        </div>

        <h3 class="font-semibold text-lg mb-4">Complexity Ladder Position</h3>

        <p class="text-text-secondary mb-4">
          This infrastructure stack corresponds to <strong>Level 6-7</strong> on the architecture complexity ladder:
        </p>

        <div class="layer-diagram">
          <pre>Level 0: Single session, manual prompts          &lt;- Start here
Level 1: CLAUDE.md, structured context
Level 2: Hooks, external verification
Level 3: Session chaining (Ralph basic)
Level 4: Multi-agent orchestration
Level 5: Full Gas Town / CC Mirror
Level 6: Multi-region deployment                &lt;- THIS DOCUMENT
Level 7: Factory-scale autonomous               &lt;- THIS DOCUMENT
          </pre>
        </div>
      </section>

    